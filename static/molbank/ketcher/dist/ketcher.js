/****************************************************************************
 * Copyright (C) 2009-2018. EPAM Systems.
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/

(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.ketcher = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/* FileSaver.js
 * A saveAs() FileSaver implementation.
 * 1.1.20150716
 *
 * By Eli Grey, http://eligrey.com
 * License: X11/MIT
 *   See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 */

/*global self */
/*jslint bitwise: true, indent: 4, laxbreak: true, laxcomma: true, smarttabs: true, plusplus: true */

/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */

var saveAs = saveAs || (function(view) {
	"use strict";
	// IE <10 is explicitly unsupported
	if (typeof navigator !== "undefined" && /MSIE [1-9]\./.test(navigator.userAgent)) {
		return;
	}
	var
		  doc = view.document
		  // only get URL when necessary in case Blob.js hasn't overridden it yet
		, get_URL = function() {
			return view.URL || view.webkitURL || view;
		}
		, save_link = doc.createElementNS("http://www.w3.org/1999/xhtml", "a")
		, can_use_save_link = "download" in save_link
		, click = function(node) {
			var event = new MouseEvent("click");
			node.dispatchEvent(event);
		}
		, webkit_req_fs = view.webkitRequestFileSystem
		, req_fs = view.requestFileSystem || webkit_req_fs || view.mozRequestFileSystem
		, throw_outside = function(ex) {
			(view.setImmediate || view.setTimeout)(function() {
				throw ex;
			}, 0);
		}
		, force_saveable_type = "application/octet-stream"
		, fs_min_size = 0
		// See https://code.google.com/p/chromium/issues/detail?id=375297#c7 and
		// https://github.com/eligrey/FileSaver.js/commit/485930a#commitcomment-8768047
		// for the reasoning behind the timeout and revocation flow
		, arbitrary_revoke_timeout = 500 // in ms
		, revoke = function(file) {
			var revoker = function() {
				if (typeof file === "string") { // file is an object URL
					get_URL().revokeObjectURL(file);
				} else { // file is a File
					file.remove();
				}
			};
			if (view.chrome) {
				revoker();
			} else {
				setTimeout(revoker, arbitrary_revoke_timeout);
			}
		}
		, dispatch = function(filesaver, event_types, event) {
			event_types = [].concat(event_types);
			var i = event_types.length;
			while (i--) {
				var listener = filesaver["on" + event_types[i]];
				if (typeof listener === "function") {
					try {
						listener.call(filesaver, event || filesaver);
					} catch (ex) {
						throw_outside(ex);
					}
				}
			}
		}
		, auto_bom = function(blob) {
			// prepend BOM for UTF-8 XML and text/* types (including HTML)
			if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
				return new Blob(["\ufeff", blob], {type: blob.type});
			}
			return blob;
		}
		, FileSaver = function(blob, name, no_auto_bom) {
			if (!no_auto_bom) {
				blob = auto_bom(blob);
			}
			// First try a.download, then web filesystem, then object URLs
			var
				  filesaver = this
				, type = blob.type
				, blob_changed = false
				, object_url
				, target_view
				, dispatch_all = function() {
					dispatch(filesaver, "writestart progress write writeend".split(" "));
				}
				// on any filesys errors revert to saving with object URLs
				, fs_error = function() {
					// don't create more object URLs than needed
					if (blob_changed || !object_url) {
						object_url = get_URL().createObjectURL(blob);
					}
					if (target_view) {
						target_view.location.href = object_url;
					} else {
						var new_tab = view.open(object_url, "_blank");
						if (new_tab == undefined && typeof safari !== "undefined") {
							//Apple do not allow window.open, see http://bit.ly/1kZffRI
							view.location.href = object_url
						}
					}
					filesaver.readyState = filesaver.DONE;
					dispatch_all();
					revoke(object_url);
				}
				, abortable = function(func) {
					return function() {
						if (filesaver.readyState !== filesaver.DONE) {
							return func.apply(this, arguments);
						}
					};
				}
				, create_if_not_found = {create: true, exclusive: false}
				, slice
			;
			filesaver.readyState = filesaver.INIT;
			if (!name) {
				name = "download";
			}
			if (can_use_save_link) {
				object_url = get_URL().createObjectURL(blob);
				save_link.href = object_url;
				save_link.download = name;
				setTimeout(function() {
					click(save_link);
					dispatch_all();
					revoke(object_url);
					filesaver.readyState = filesaver.DONE;
				});
				return;
			}
			// Object and web filesystem URLs have a problem saving in Google Chrome when
			// viewed in a tab, so I force save with application/octet-stream
			// http://code.google.com/p/chromium/issues/detail?id=91158
			// Update: Google errantly closed 91158, I submitted it again:
			// https://code.google.com/p/chromium/issues/detail?id=389642
			if (view.chrome && type && type !== force_saveable_type) {
				slice = blob.slice || blob.webkitSlice;
				blob = slice.call(blob, 0, blob.size, force_saveable_type);
				blob_changed = true;
			}
			// Since I can't be sure that the guessed media type will trigger a download
			// in WebKit, I append .download to the filename.
			// https://bugs.webkit.org/show_bug.cgi?id=65440
			if (webkit_req_fs && name !== "download") {
				name += ".download";
			}
			if (type === force_saveable_type || webkit_req_fs) {
				target_view = view;
			}
			if (!req_fs) {
				fs_error();
				return;
			}
			fs_min_size += blob.size;
			req_fs(view.TEMPORARY, fs_min_size, abortable(function(fs) {
				fs.root.getDirectory("saved", create_if_not_found, abortable(function(dir) {
					var save = function() {
						dir.getFile(name, create_if_not_found, abortable(function(file) {
							file.createWriter(abortable(function(writer) {
								writer.onwriteend = function(event) {
									target_view.location.href = file.toURL();
									filesaver.readyState = filesaver.DONE;
									dispatch(filesaver, "writeend", event);
									revoke(file);
								};
								writer.onerror = function() {
									var error = writer.error;
									if (error.code !== error.ABORT_ERR) {
										fs_error();
									}
								};
								"writestart progress write abort".split(" ").forEach(function(event) {
									writer["on" + event] = filesaver["on" + event];
								});
								writer.write(blob);
								filesaver.abort = function() {
									writer.abort();
									filesaver.readyState = filesaver.DONE;
								};
								filesaver.readyState = filesaver.WRITING;
							}), fs_error);
						}), fs_error);
					};
					dir.getFile(name, {create: false}, abortable(function(file) {
						// delete file if it already exists
						file.remove();
						save();
					}), abortable(function(ex) {
						if (ex.code === ex.NOT_FOUND_ERR) {
							save();
						} else {
							fs_error();
						}
					}));
				}), fs_error);
			}), fs_error);
		}
		, FS_proto = FileSaver.prototype
		, saveAs = function(blob, name, no_auto_bom) {
			return new FileSaver(blob, name, no_auto_bom);
		}
	;
	// IE 10+ (native saveAs)
	if (typeof navigator !== "undefined" && navigator.msSaveOrOpenBlob) {
		return function(blob, name, no_auto_bom) {
			if (!no_auto_bom) {
				blob = auto_bom(blob);
			}
			return navigator.msSaveOrOpenBlob(blob, name || "download");
		};
	}

	FS_proto.abort = function() {
		var filesaver = this;
		filesaver.readyState = filesaver.DONE;
		dispatch(filesaver, "abort");
	};
	FS_proto.readyState = FS_proto.INIT = 0;
	FS_proto.WRITING = 1;
	FS_proto.DONE = 2;

	FS_proto.error =
	FS_proto.onwritestart =
	FS_proto.onprogress =
	FS_proto.onwrite =
	FS_proto.onabort =
	FS_proto.onerror =
	FS_proto.onwriteend =
		null;

	return saveAs;
}(
	   typeof self !== "undefined" && self
	|| typeof window !== "undefined" && window
	|| this.content
));
// `self` is undefined in Firefox for Android content script context
// while `this` is nsIContentFrameMessageManager
// with an attribute `content` that corresponds to the window

if (typeof module !== "undefined" && module.exports) {
  module.exports.saveAs = saveAs;
} else if ((typeof define !== "undefined" && define !== null) && (define.amd != null)) {
  define([], function() {
    return saveAs;
  });
}

},{}],2:[function(require,module,exports){
/// keymage.js - Javascript keyboard bindings handling
/// http://github.com/piranha/keymage
///
/// (c) 2012-2016 Alexander Solovyov under terms of ISC License

(function(define, undefined) {
define(function() {
    var VERSION = '1.1.3';
    var isOsx = typeof navigator !== 'undefined' &&
        ~navigator.userAgent.indexOf('Mac OS X');

    // Defining all keys
    var MODPROPS = ['shiftKey', 'ctrlKey', 'altKey', 'metaKey'];
    var MODS = {
        'shift': 'shift',
        'ctrl': 'ctrl', 'control': 'ctrl',
        'alt': 'alt', 'option': 'alt',
        'win': 'meta', 'cmd': 'meta', 'super': 'meta',
                          'meta': 'meta',
        // default modifier for os x is cmd and for others is ctrl
        'defmod':  isOsx ? 'meta' : 'ctrl'
        };
    var MODORDER = ['shift', 'ctrl', 'alt', 'meta'];
    var MODNUMS = [16, 17, 18, 91];

    var KEYS = {
        'backspace': 8,
        'tab': 9,
        'enter': 13, 'return': 13,
        'pause': 19,
        'caps': 20, 'capslock': 20,
        'escape': 27, 'esc': 27,
        'space': 32,
        'pgup': 33, 'pageup': 33,
        'pgdown': 34, 'pagedown': 34,
        'end': 35,
        'home': 36,
        'ins': 45, 'insert': 45,
        'del': 46, 'delete': 46,

        'left': 37,
        'up': 38,
        'right': 39,
        'down': 40,

        '*': 106,
        '+': 107, 'plus': 107,
        'minus': 109,
        ';': 186,
        '=': 187,
        ',': 188,
        '-': 189,
        '.': 190,
        '/': 191,
        '`': 192,
        '[': 219,
        '\\': 220,
        ']': 221,
        "'": 222
    };

    var i;
    // numpad
    for (i = 0; i < 10; i++) {
        KEYS['num-' + i] = i + 95;
    }
    // top row 0-9
    for (i = 0; i < 10; i++) {
        KEYS[i.toString()] = i + 48;
    }
    // f1-f24
    for (i = 1; i < 25; i++) {
        KEYS['f' + i] = i + 111;
    }
    // alphabet
    for (i = 65; i < 91; i++) {
        KEYS[String.fromCharCode(i).toLowerCase()] = i;
    }

    // Reverse key codes
    var KEYREV = {};
    for (var k in KEYS) {
        var val = KEYS[k];
        if (!KEYREV[val] || KEYREV[val].length < k.length) {
            KEYREV[val] = k;
        }
    }

    // -----------------------
    // Actual work is done here

    var currentScope = '';
    var allChains = {};

    function parseKeyString(keystring) {
        var bits = keystring.split(/-(?!$)/);
        var button = bits[bits.length - 1];
        var key = {code: KEYS[button]};

        if (!key.code) {
            throw 'Unknown key "' + button + '" in keystring "' +
                keystring + '"';
        }

        var mod;
        for (var i = 0; i < bits.length - 1; i++) {
            button = bits[i];
            mod = MODS[button];
            if (!mod) {
                    throw 'Unknown modifier "' + button + '" in keystring "' +
                        keystring + '"';
            }
            key[mod] = true;
        }

        return key;
    }

    function stringifyKey(key) {
        var s = '';
        for (var i = 0; i < MODORDER.length; i++) {
            if (key[MODORDER[i]]) {
                s += MODORDER[i] + '-';
            }
        }
        s += KEYREV[key.code];
        return s;
    }

    function normalizeKeyChain(keychainString) {
        var keychain = [];
        var keys = keychainString.split(' ');

        for (var i = 0; i < keys.length; i++) {
            var key = parseKeyString(keys[i]);
            key = stringifyKey(key);
            keychain.push(key);
        }

        keychain.original = keychainString;
        return keychain;
    }

    function eventKeyString(e) {
        var key = {code: e.keyCode};
        for (var i = 0; i < MODPROPS.length; i++) {
            var mod = MODPROPS[i];
            if (e[mod]) {
                key[mod.slice(0, mod.length - 3)] = true;
            }
        }
        return stringifyKey(key);
    }

    function getNestedChains(chains, scope) {
        for (var i = 0; i < scope.length; i++) {
            var bit = scope[i];

            if (bit) {
                chains = chains[bit];
            }

            if (!chains) {
                break;
            }
        }
        return chains;
    }

    var sequence = [];
    function dispatch(e) {
        // Skip all modifiers
        if (~MODNUMS.indexOf(e.keyCode)) {
            return;
        }

        var seq = sequence.slice();
        seq.push(eventKeyString(e));
        var scope = currentScope.split('.');
        var matched, chains, key;

        for (var i = scope.length; i >= 0; i--) {
            chains = getNestedChains(allChains, scope.slice(0, i));
            if (!chains) {
                continue;
            }
            matched = true;
            for (var j = 0; j < seq.length; j++) {
                key = seq[j];
                if (!chains[key]) {
                    matched = false;
                    break;
                }
                chains = chains[key];
            }

            if (matched) {
                break;
            }
        }

        var definitionScope = scope.slice(0, i).join('.');
        var preventDefault = chains.preventDefault;

        // partial match, save the sequence
        if (matched && !chains.handlers) {
            sequence = seq;
            if (preventDefault) {
                e.preventDefault();
            }
            return;
        }

        if (matched) {
            for (i = 0; i < chains.handlers.length; i++) {
                var handler = chains.handlers[i];
                var options = handler._keymage;

                var res = handler.call(options.context, e, {
                    shortcut: options.original,
                    scope: currentScope,
                    definitionScope: definitionScope
                });

                if (res === false || preventDefault) {
                    e.preventDefault();
                }
            }
        }

        // either matched or not, drop the sequence
        sequence = [];
    }

    function getHandlers(scope, keychain, fn) {
        var bits = scope.split('.');
        var chains = allChains;
        bits = bits.concat(keychain);

        for (var i = 0, l = bits.length; i < l; i++) {
            var bit = bits[i];
            if (!bit) continue;

            chains = chains[bit] || (chains[bit] = {});
            if (fn && fn._keymage.preventDefault) {
                chains.preventDefault = true;
            }

            if (i === l - 1) {
                var handlers = chains.handlers || (chains.handlers = []);
                return handlers;
            }
        }
    }

    function assignKey(scope, keychain, fn) {
        var handlers = getHandlers(scope, keychain, fn);
        handlers.push(fn);
    }

    function unassignKey(scope, keychain, fn) {
        var handlers = getHandlers(scope, keychain);
        var idx = handlers.indexOf(fn);
        if (~idx) {
            handlers.splice(idx, 1);
        }
    }

    function parsed(scope, keychain, fn, options) {
        if (keychain === undefined && fn === undefined) {
            return function(keychain, fn) {
                return keymage(scope, keychain, fn);
            };
        }

        if (typeof keychain === 'function') {
            options = fn;
            fn = keychain;
            keychain = scope;
            scope = '';
        }

        var normalized = normalizeKeyChain(keychain);

        return [scope, normalized, fn, options];
    }

    // optional arguments: scope, options.
    function keymage(scope, keychain, fn, options) {
        var args = parsed(scope, keychain, fn, options);
        fn = args[2];
        options = args[3];
        fn._keymage = options || {};
        fn._keymage.original = keychain;
        assignKey.apply(null, args);

        return function () {
            unassignKey.apply(null, args);
        };
    }

    keymage.unbind = function(scope, keychain, fn) {
        var args = parsed(scope, keychain, fn);
        unassignKey.apply(null, args);
    };

    keymage.parse = parseKeyString;
    keymage.stringify = stringifyKey;

    keymage.bindings = allChains;

    keymage.setScope = function(scope) {
        currentScope = scope ? scope : '';
    };

    keymage.getScope = function() { return currentScope; };

    keymage.pushScope = function(scope) {
        currentScope = (currentScope ? currentScope + '.' : '') + scope;
        return currentScope;
    };

    keymage.popScope = function(scope) {
        var i;

        if (!scope) {
            i = currentScope.lastIndexOf('.');
            scope = currentScope.slice(i + 1);
            currentScope = i == -1 ? '' : currentScope.slice(0, i);
            return scope;
        }

        currentScope = currentScope.replace(
            new RegExp('(^|\\.)' + scope + '(\\.|$).*'), '');
        return scope;
    };

    keymage.version = VERSION;

    window.addEventListener('keydown', dispatch, false);

    return keymage;
});
})(typeof define !== 'undefined' ? define : function(factory) {
    if (typeof module !== 'undefined') {
        module.exports = factory();
    } else {
        window.keymage = factory();
    }
});

},{}],3:[function(require,module,exports){
(function(root) {

	// Use polyfill for setImmediate for performance gains
	var asap = (typeof setImmediate === 'function' && setImmediate) ||
		function(fn) { setTimeout(fn, 1); };

	// Polyfill for Function.prototype.bind
	function bind(fn, thisArg) {
		return function() {
			fn.apply(thisArg, arguments);
		}
	}

	var isArray = Array.isArray || function(value) { return Object.prototype.toString.call(value) === "[object Array]" };

	function Promise(fn) {
		if (typeof this !== 'object') throw new TypeError('Promises must be constructed via new');
		if (typeof fn !== 'function') throw new TypeError('not a function');
		this._state = null;
		this._value = null;
		this._deferreds = []

		doResolve(fn, bind(resolve, this), bind(reject, this))
	}

	function handle(deferred) {
		var me = this;
		if (this._state === null) {
			this._deferreds.push(deferred);
			return
		}
		asap(function() {
			var cb = me._state ? deferred.onFulfilled : deferred.onRejected
			if (cb === null) {
				(me._state ? deferred.resolve : deferred.reject)(me._value);
				return;
			}
			var ret;
			try {
				ret = cb(me._value);
			}
			catch (e) {
				deferred.reject(e);
				return;
			}
			deferred.resolve(ret);
		})
	}

	function resolve(newValue) {
		try { //Promise Resolution Procedure: https://github.com/promises-aplus/promises-spec#the-promise-resolution-procedure
			if (newValue === this) throw new TypeError('A promise cannot be resolved with itself.');
			if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
				var then = newValue.then;
				if (typeof then === 'function') {
					doResolve(bind(then, newValue), bind(resolve, this), bind(reject, this));
					return;
				}
			}
			this._state = true;
			this._value = newValue;
			finale.call(this);
		} catch (e) { reject.call(this, e); }
	}

	function reject(newValue) {
		this._state = false;
		this._value = newValue;
		finale.call(this);
	}

	function finale() {
		for (var i = 0, len = this._deferreds.length; i < len; i++) {
			handle.call(this, this._deferreds[i]);
		}
		this._deferreds = null;
	}

	function Handler(onFulfilled, onRejected, resolve, reject){
		this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;
		this.onRejected = typeof onRejected === 'function' ? onRejected : null;
		this.resolve = resolve;
		this.reject = reject;
	}

	/**
	 * Take a potentially misbehaving resolver function and make sure
	 * onFulfilled and onRejected are only called once.
	 *
	 * Makes no guarantees about asynchrony.
	 */
	function doResolve(fn, onFulfilled, onRejected) {
		var done = false;
		try {
			fn(function (value) {
				if (done) return;
				done = true;
				onFulfilled(value);
			}, function (reason) {
				if (done) return;
				done = true;
				onRejected(reason);
			})
		} catch (ex) {
			if (done) return;
			done = true;
			onRejected(ex);
		}
	}

	Promise.prototype['catch'] = function (onRejected) {
		return this.then(null, onRejected);
	};

	Promise.prototype.then = function(onFulfilled, onRejected) {
		var me = this;
		return new Promise(function(resolve, reject) {
			handle.call(me, new Handler(onFulfilled, onRejected, resolve, reject));
		})
	};

	Promise.all = function () {
		var args = Array.prototype.slice.call(arguments.length === 1 && isArray(arguments[0]) ? arguments[0] : arguments);

		return new Promise(function (resolve, reject) {
			if (args.length === 0) return resolve([]);
			var remaining = args.length;
			function res(i, val) {
				try {
					if (val && (typeof val === 'object' || typeof val === 'function')) {
						var then = val.then;
						if (typeof then === 'function') {
							then.call(val, function (val) { res(i, val) }, reject);
							return;
						}
					}
					args[i] = val;
					if (--remaining === 0) {
						resolve(args);
					}
				} catch (ex) {
					reject(ex);
				}
			}
			for (var i = 0; i < args.length; i++) {
				res(i, args[i]);
			}
		});
	};

	Promise.resolve = function (value) {
		if (value && typeof value === 'object' && value.constructor === Promise) {
			return value;
		}

		return new Promise(function (resolve) {
			resolve(value);
		});
	};

	Promise.reject = function (value) {
		return new Promise(function (resolve, reject) {
			reject(value);
		});
	};

	Promise.race = function (values) {
		return new Promise(function (resolve, reject) {
			for(var i = 0, len = values.length; i < len; i++) {
				values[i].then(resolve, reject);
			}
		});
	};

	/**
	 * Set the immediate function to execute callbacks
	 * @param fn {function} Function to execute
	 * @private
	 */
	Promise._setImmediateFn = function _setImmediateFn(fn) {
		asap = fn;
	};

	if (typeof module !== 'undefined' && module.exports) {
		module.exports = Promise;
	} else if (!root.Promise) {
		root.Promise = Promise;
	}

})(this);
},{}],4:[function(require,module,exports){
'use strict';
var strictUriEncode = require('strict-uri-encode');

exports.extract = function (str) {
	return str.split('?')[1] || '';
};

exports.parse = function (str) {
	if (typeof str !== 'string') {
		return {};
	}

	str = str.trim().replace(/^(\?|#|&)/, '');

	if (!str) {
		return {};
	}

	return str.split('&').reduce(function (ret, param) {
		var parts = param.replace(/\+/g, ' ').split('=');
		// Firefox (pre 40) decodes `%3D` to `=`
		// https://github.com/sindresorhus/query-string/pull/37
		var key = parts.shift();
		var val = parts.length > 0 ? parts.join('=') : undefined;

		key = decodeURIComponent(key);

		// missing `=` should be `null`:
		// http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
		val = val === undefined ? null : decodeURIComponent(val);

		if (!ret.hasOwnProperty(key)) {
			ret[key] = val;
		} else if (Array.isArray(ret[key])) {
			ret[key].push(val);
		} else {
			ret[key] = [ret[key], val];
		}

		return ret;
	}, {});
};

exports.stringify = function (obj) {
	return obj ? Object.keys(obj).sort().map(function (key) {
		var val = obj[key];

		if (Array.isArray(val)) {
			return val.sort().map(function (val2) {
				return strictUriEncode(key) + '=' + strictUriEncode(val2);
			}).join('&');
		}

		return strictUriEncode(key) + '=' + strictUriEncode(val);
	}).filter(function (x) {
		return x.length > 0;
	}).join('&') : '';
};

},{"strict-uri-encode":5}],5:[function(require,module,exports){
'use strict';
module.exports = function (str) {
	return encodeURIComponent(str).replace(/[!'()*]/g, function (c) {
		return '%' + c.charCodeAt(0).toString(16).toUpperCase();
	});
};

},{}],6:[function(require,module,exports){
var xhrFactory = (function getXHRfactory (factories) {
  for (var i=0, xhr, X, len=factories.length; i<len; i++) {
    try {
      X = factories[i]
      xhr = X()
      return window.XMLHttpRequest ? X : window.XMLHttpRequest = X
    } catch (e) { continue }
  }
})([
  function () {return new XMLHttpRequest()}, // IE10+,FF,Chrome,Opera,Safari
  function () {return new ActiveXObject("Msxml3.")},            // IE9
  function () {return new ActiveXObject("Msxml2.XMLHTTP.6.0")}, // IE8
  function () {return new ActiveXObject("Msxml2.XMLHTTP.3.0")}, // IE7
  function () {return new ActiveXObject("Msxml2.XMLHTTP")},     // IE6
  function () {return new ActiveXObject("Microsoft.XMLHTTP")},  // IE5
  function () {return null}
])
module.exports = function getXHR() { return xhrFactory() }

},{}],7:[function(require,module,exports){
function formEncodeString(e){return e.replace(/[^ !'()~\*]*/g,encodeURIComponent).replace(/ /g,"+").replace(/[!'()~\*]/g,function(e){return"%"+("0"+e.charCodeAt(0).toString(16)).slice(-2).toUpperCase()})}function formEncode(e){var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push(encodeURIComponent(n)+"="+formEncodeString(e[n]));return r.join("&")}function unwrap(e){var r=e.responseText,n=r.substring(r.indexOf("\n")+1);if(r.startsWith("Ok."))return n;throw Error("Unknown server error: "+r)}function api(e){function r(r,n){function t(e,n,t){return{method:r,url:o.url,sync:t,params:n,data:e&&formEncode(e),headers:e&&{"Content-Type":"application/x-www-form-urlencoded"}}}var o=function(e,r){return ajax(t(e,r)).then(unwrap)};return o.sync=function(e,r){return unwrap(ajax(t(e,r,!0)))},o.url=e+n,o}return{inchi:r("POST","getinchi"),molfile:r("POST","getmolfile"),aromatize:r("POST","aromatize"),dearomatize:r("POST","dearomatize"),calculateCip:r("POST","calculate_cip"),automap:r("POST","automap"),layout_smiles:r("GET","layout"),layout:r("POST","layout"),smiles:r("POST","smiles"),save:r("POST","save"),knocknock:function(){return ajax(e+"knocknock").then(function(e){if("You are welcome!"!==e.responseText)throw Error("Server is not compatible")})}}}var ajax=require("./util/ajax.js");module.exports=api;

},{"./util/ajax.js":37}],8:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Vec2=require("../util/vec2");require("./element"),require("./struct");var chem=global.chem=global.chem||{};chem.CisTrans=function(e,t,o){this.molecule=e,this.bonds=new Map,this.getNeighbors=t,this.context=o},chem.CisTrans.PARITY={NONE:0,CIS:1,TRANS:2},chem.CisTrans.prototype.each=function(e,t){this.bonds.each(e,t)},chem.CisTrans.prototype.getParity=function(e){return this.bonds.get(e).parity},chem.CisTrans.prototype.getSubstituents=function(e){return this.bonds.get(e).substituents},chem.CisTrans.prototype.sameside=function(e,t,o,n){var r=Vec2.diff(e,t),i=new Vec2(-r.y,r.x);if(!i.normalize())return 0;var a=Vec2.diff(o,e),s=Vec2.diff(n,t);if(!a.normalize())return 0;if(!s.normalize())return 0;var l=Vec2.dot(a,i),d=Vec2.dot(s,i);return Math.abs(l)<.001||Math.abs(d)<.001?0:l*d>0?1:-1},chem.CisTrans.prototype._sameside=function(e,t,o,n){return this.sameside(this.molecule.atoms.get(e).pp,this.molecule.atoms.get(t).pp,this.molecule.atoms.get(o).pp,this.molecule.atoms.get(n).pp)},chem.CisTrans.prototype._sortSubstituents=function(e){var t=this.molecule.atoms.get(e[0]).pureHydrogen(),o=e[1]<0||this.molecule.atoms.get(e[1]).pureHydrogen(),n=this.molecule.atoms.get(e[2]).pureHydrogen(),r=e[3]<0||this.molecule.atoms.get(e[3]).pureHydrogen();return t&&o?!1:n&&r?!1:(o?e[1]=-1:t?(e[0]=e[1],e[1]=-1):e[0]>e[1]&&e.swap(0,1),r?e[3]=-1:n?(e[2]=e[3],e[3]=-1):e[2]>e[3]&&e.swap(2,3),!0)},chem.CisTrans.prototype.isGeomStereoBond=function(e,t){var o=this.molecule.bonds.get(e);if(o.type!=chem.Struct.BOND.TYPE.DOUBLE)return!1;var n=this.molecule.atoms.get(o.begin).label,r=this.molecule.atoms.get(o.end).label;if("C"!=n&&"N"!=n&&"Si"!=n&&"Ge"!=n)return!1;if("C"!=r&&"N"!=r&&"Si"!=r&&"Ge"!=r)return!1;var i=this.getNeighbors.call(this.context,o.begin),a=this.getNeighbors.call(this.context,o.end);if(i.length<2||i.length>3||a.length<2||a.length>3)return!1;t[0]=-1,t[1]=-1,t[2]=-1,t[3]=-1;var s,l;for(s=0;s<i.length;s++)if(l=i[s],l.bid!=e){if(this.molecule.bonds.get(l.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==t[0]?t[0]=l.aid:t[1]=l.aid}for(s=0;s<a.length;s++)if(l=a[s],l.bid!=e){if(this.molecule.bonds.get(l.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==t[2]?t[2]=l.aid:t[3]=l.aid}return-1!=t[1]&&-1!=this._sameside(o.begin,o.end,t[0],t[1])?!1:-1!=t[3]&&-1!=this._sameside(o.begin,o.end,t[2],t[3])?!1:!0},chem.CisTrans.prototype.build=function(e){this.molecule.bonds.each(function(t,o){var n=this.bonds.set(t,{parity:0,substituents:new Array(4)});if((!Object.isArray(e)||!e[t])&&this.isGeomStereoBond(t,n.substituents)&&this._sortSubstituents(n.substituents)){var r=this._sameside(o.begin,o.end,n.substituents[0],n.substituents[2]);1==r?n.parity=chem.CisTrans.PARITY.CIS:-1==r&&(n.parity=chem.CisTrans.PARITY.TRANS)}},this)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util/map":40,"../util/vec2":43,"./element":10,"./struct":16}],9:[function(require,module,exports){
(function (global){
var Set=require("../util/set");require("../util/"),require("./element");var chem=global.chem=global.chem||{},util=global.util;chem.Dfs=function(e,t,o,n){this.molecule=e,this.atom_data=t,this.components=o,this.nComponentsInReactants=-1,this.nReactants=n,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(e){this.vertices[e]=new chem.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(e){this.edges[e]=new chem.Dfs.EdgeDesc},this),this.v_seq=[]},chem.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},chem.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},chem.Dfs.SeqElem=function(e,t,o){this.idx=e,this.parent_vertex=t,this.parent_edge=o},chem.Dfs.prototype.walk=function(){for(var e,t,o=[],n=0,r=0;;){if(o.length<1){for(var i=-1,a=function(e){return 0==this.vertices[e].dfs_state?(i=e,!0):!1};n<this.components.length&&-1==i;)i=Set.find(this.components[n],a,this),null===i&&(i=-1,n++,n==this.nReactants&&(this.nComponentsInReactants=r));if(-1>i&&this.molecule.atoms.find(a,this),-1==i)break;this.vertices[i].parent_vertex=-1,this.vertices[i].parent_edge=-1,o.push(i),r++}var s=o.pop(),l=this.vertices[s].parent_vertex,d=new chem.Dfs.SeqElem(s,l,this.vertices[s].parent_edge);this.v_seq.push(d),this.vertices[s].dfs_state=2;var c=this.atom_data[s];for(e=0;e<c.neighbours.length;e++){var u=c.neighbours[e].aid,h=c.neighbours[e].bid;if(u!=l)if(2==this.vertices[u].dfs_state){for(this.edges[h].closing_cycle=1,t=s;-1!=t&&this.vertices[t].parent_vertex!=u;)t=this.vertices[t].parent_vertex;if(-1==t)throw new Error("cycle unwind error");this.edges[this.vertices[t].parent_edge].opening_cycles++,this.vertices[s].branches++,d=new chem.Dfs.SeqElem(u,s,h),this.v_seq.push(d)}else{if(1==this.vertices[u].dfs_state){if(t=o.indexOf(u),-1==t)throw new Error("internal: removing vertex from stack");o.splice(t,1);var p=this.vertices[u].parent_vertex;p>=0&&this.vertices[p].branches--}this.vertices[s].branches++,this.vertices[u].parent_vertex=s,this.vertices[u].parent_edge=h,this.vertices[u].dfs_state=1,o.push(u)}}}},chem.Dfs.prototype.edgeClosingCycle=function(e){return 0!=this.edges[e].closing_cycle},chem.Dfs.prototype.numBranches=function(e){return this.vertices[e].branches},chem.Dfs.prototype.numOpeningCycles=function(e){return this.edges[e].opening_cycles},chem.Dfs.prototype.toString=function(){var e="";return this.v_seq.each(function(t){e+=t.idx+" -> "}),e+="*"};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util/":39,"../util/set":42,"./element":10}],10:[function(require,module,exports){
function el(e,t,r,n,o){return{label:e,period:t,group:r,putHydrogenOnTheLeft:n,color:o||"#000000"}}var Map=require("../util/map"),element=new Map({1:el("H",1,1,!1,"#000000"),2:el("He",1,8,!1,"#d9ffff"),3:el("Li",2,1,!1,"#cc80ff"),4:el("Be",2,2,!1,"#c2ff00"),5:el("B",2,3,!1,"#ffb5b5"),6:el("C",2,4,!1,"#000000"),7:el("N",2,5,!1,"#304ff7"),8:el("O",2,6,!0,"#ff0d0d"),9:el("F",2,7,!0,"#8fe04f"),10:el("Ne",2,8,!1,"#b3e3f5"),11:el("Na",3,1,!1,"#ab5cf2"),12:el("Mg",3,2,!1,"#8aff00"),13:el("Al",3,3,!1,"#bfa6a6"),14:el("Si",3,4,!1,"#f0c7a1"),15:el("P",3,5,!1,"#ff8000"),16:el("S",3,6,!0,"#d9a61a"),17:el("Cl",3,7,!0,"#1fd01f"),18:el("Ar",3,8,!1,"#80d1e3"),19:el("K",4,1,!1,"#8f40d4"),20:el("Ca",4,2,!1,"#3dff00"),21:el("Sc",4,3,!1,"#e6e6e6"),22:el("Ti",4,4,!1,"#bfc2c7"),23:el("V",4,5,!1,"#a6a6ab"),24:el("Cr",4,6,!1,"#8a99c7"),25:el("Mn",4,7,!1,"#9c7ac7"),26:el("Fe",4,8,!1,"#e06633"),27:el("Co",4,8,!1,"#f08fa1"),28:el("Ni",4,8,!1,"#4fd14f"),29:el("Cu",4,1,!1,"#c78033"),30:el("Zn",4,2,!1,"#7d80b0"),31:el("Ga",4,3,!1,"#c28f8f"),32:el("Ge",4,4,!1,"#668f8f"),33:el("As",4,5,!1,"#bd80e3"),34:el("Se",4,6,!0,"#ffa100"),35:el("Br",4,7,!0,"#a62929"),36:el("Kr",4,8,!1,"#5cb8d1"),37:el("Rb",5,1,!1,"#702eb0"),38:el("Sr",5,2,!1,"#00ff00"),39:el("Y",5,3,!1,"#94ffff"),40:el("Zr",5,4,!1,"#94e0e0"),41:el("Nb",5,5,!1,"#73c2c9"),42:el("Mo",5,6,!1,"#54b5b5"),43:el("Tc",5,7,!1,"#3b9e9e"),44:el("Ru",5,8,!1,"#248f8f"),45:el("Rh",5,8,!1,"#0a7d8c"),46:el("Pd",5,8,!1,"#006985"),47:el("Ag",5,1,!1,"#bfbfbf"),48:el("Cd",5,2,!1,"#ffd98f"),49:el("In",5,3,!1,"#a67573"),50:el("Sn",5,4,!1,"#668080"),51:el("Sb",5,5,!1,"#9e63b5"),52:el("Te",5,6,!1,"#d47a00"),53:el("I",5,7,!0,"#940094"),54:el("Xe",5,8,!1,"#429eb0"),55:el("Cs",6,1,!1,"#57178f"),56:el("Ba",6,2,!1,"#00c900"),57:el("La",6,3,!1,"#70d4ff"),58:el("Ce",6,3,!1,"#ffffc7"),59:el("Pr",6,3,!1,"#d9ffc7"),60:el("Nd",6,3,!1,"#c7ffc7"),61:el("Pm",6,3,!1,"#a3ffc7"),62:el("Sm",6,3,!1,"#8fffc7"),63:el("Eu",6,3,!1,"#61ffc7"),64:el("Gd",6,3,!1,"#45ffc7"),65:el("Tb",6,3,!1,"#30ffc7"),66:el("Dy",6,3,!1,"#1fffc7"),67:el("Ho",6,3,!1,"#00ff9c"),68:el("Er",6,3,!1,"#00e675"),69:el("Tm",6,3,!1,"#00d452"),70:el("Yb",6,3,!1,"#00bf38"),71:el("Lu",6,3,!1,"#00ab24"),72:el("Hf",6,4,!1,"#4dc2ff"),73:el("Ta",6,5,!1,"#4da6ff"),74:el("W",6,6,!1,"#2194d6"),75:el("Re",6,7,!1,"#267dab"),76:el("Os",6,8,!1,"#266696"),77:el("Ir",6,8,!1,"#175487"),78:el("Pt",6,8,!1,"#d1d1e0"),79:el("Au",6,1,!1,"#ffd124"),80:el("Hg",6,2,!1,"#b8b8d1"),81:el("Tl",6,3,!1,"#a6544d"),82:el("Pb",6,4,!1,"#575961"),83:el("Bi",6,5,!1,"#9e4fb5"),84:el("Po",6,6,!1,"#ab5c00"),85:el("At",6,7,!1,"#754f45"),86:el("Rn",6,8,!1,"#428296"),87:el("Fr",7,1,!1,"#420066"),88:el("Ra",7,2,!1,"#007d00"),89:el("Ac",7,3,!1,"#70abfa"),90:el("Th",7,3,!1,"#00baff"),91:el("Pa",7,3,!1,"#00a1ff"),92:el("U",7,3,!1,"#008fff"),93:el("Np",7,3,!1,"#0080ff"),94:el("Pu",7,3,!1,"#006bff"),95:el("Am",7,3,!1,"#545cf2"),96:el("Cm",7,3,!1,"#785ce3"),97:el("Bk",7,3,!1,"#8a4fe3"),98:el("Cf",7,3,!1,"#a136d4"),99:el("Es",7,3,!1,"#b31fd4"),100:el("Fm",7,3,!1,"#000000"),101:el("Md",7,3,!1,"#000000"),102:el("No",7,3,!1,"#000000"),103:el("Lr",7,3,!1,"#000000"),104:el("Rf",7,4,!1,"#4dc2ff"),105:el("Db",7,5,!1,"#4da6ff"),106:el("Sg",7,6,!1,"#2194d6"),107:el("Bh",7,7,!1,"#267dab"),108:el("Hs",7,8,!1,"#266696"),109:el("Mt",7,8,!1,"#175487"),110:el("Ds",7,8,!1,"#d1d1e0"),111:el("Rg",7,1,!1,"#ffd124"),112:el("Cn",7,2,!1,"#b8b8d1"),113:el("Uut",7,3,!1),114:el("Fl",7,4,!1),115:el("Uup",7,5,!1),116:el("Lv",7,6,!1),117:el("Uus",7,7,!1),118:el("Uuo",7,8,!1)}),labelMap=null;element.getElementByLabel=function(e){return labelMap||(labelMap={},element.each(function(e,t){labelMap[t.label]=e-0})),labelMap[e]||null},module.exports=element;

},{"../util/map":40}],11:[function(require,module,exports){
(function (global){
require("./struct"),require("./cis_trans"),require("./dfs"),require("./molfile"),require("./sgroup"),require("./smiles"),require("./stereocenters"),require("./struct_valence"),global.chem=global.chem||{};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./cis_trans":8,"./dfs":9,"./molfile":12,"./sgroup":13,"./smiles":14,"./stereocenters":15,"./struct":16,"./struct_valence":17}],12:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Set=require("../util/set"),Vec2=require("../util/vec2"),element=require("./element"),util=require("../util"),chem=global.chem=global.chem||{};chem.Molfile=function(){},chem.Molfile.loadRGroupFragments=!0,chem.Molfile.parseDecimalInt=function(e){var t=parseInt(e,10);return isNaN(t)?0:t},chem.Molfile.partitionLine=function(e,t,r){for(var o=[],n=0,i=0;n<t.length;++n)o.push(e.slice(i,i+t[n])),r&&i++,i+=t[n];return o},chem.Molfile.partitionLineFixed=function(e,t,r){for(var o=[],n=0;n<e.length;n+=t)o.push(e.slice(n,n+t)),r&&n++;return o},chem.Molfile.parseCTFile=function(e){var t=Array.isArray(e)?e:util.splitNewlines(e),r=null;return r=0==t[0].search("\\$RXN")?chem.Molfile.parseRxn(t):chem.Molfile.parseMol(t),r.initHalfBonds(),r.initNeighbors(),r.markFragments(),r},chem.Molfile.fmtInfo={bondTypeMap:{1:chem.Struct.BOND.TYPE.SINGLE,2:chem.Struct.BOND.TYPE.DOUBLE,3:chem.Struct.BOND.TYPE.TRIPLE,4:chem.Struct.BOND.TYPE.AROMATIC,5:chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE,6:chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC,7:chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC,8:chem.Struct.BOND.TYPE.ANY},bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,4:chem.Struct.BOND.STEREO.EITHER,6:chem.Struct.BOND.STEREO.DOWN,3:chem.Struct.BOND.STEREO.CIS_TRANS},v30bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,2:chem.Struct.BOND.STEREO.EITHER,3:chem.Struct.BOND.STEREO.DOWN},bondTopologyMap:{0:chem.Struct.BOND.TOPOLOGY.EITHER,1:chem.Struct.BOND.TOPOLOGY.RING,2:chem.Struct.BOND.TOPOLOGY.CHAIN},countsLinePartition:[3,3,3,3,3,3,3,3,3,3,3,6],atomLinePartition:[10,10,10,1,3,2,3,3,3,3,3,3,3,3,3,3,3],bondLinePartition:[3,3,3,3,3,3,3],atomListHeaderPartition:[3,1,1,4,1,1],atomListHeaderLength:11,atomListHeaderItemLength:4,chargeMap:[0,3,2,1,0,-1,-2,-3],valenceMap:[void 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,0],implicitHydrogenMap:[void 0,0,1,2,3,4],v30atomPropMap:{CHG:"charge",RAD:"radical",MASS:"isotope",VAL:"explicitValence",HCOUNT:"hCount",INVRET:"invRet",SUBST:"substitutionCount",UNSAT:"unsaturatedAtom",RBCNT:"ringBondCount"},rxnItemsPartition:[3,3,3]},chem.Molfile.parseAtomLine=function(e){var t=chem.Molfile,r=t.partitionLine(e,t.fmtInfo.atomLinePartition),o={pp:new Vec2(parseFloat(r[0]),-parseFloat(r[1])),label:r[4].strip(),explicitValence:t.fmtInfo.valenceMap[t.parseDecimalInt(r[10])],massDifference:t.parseDecimalInt(r[5]),charge:t.fmtInfo.chargeMap[t.parseDecimalInt(r[6])],hCount:t.parseDecimalInt(t.parseDecimalInt(r[8])),stereoCare:0!=t.parseDecimalInt(r[9]),aam:t.parseDecimalInt(r[14]),invRet:t.parseDecimalInt(r[15]),exactChangeFlag:0!=t.parseDecimalInt(r[16])};return new chem.Struct.Atom(o)},chem.Molfile.stripV30=function(e){if("M  V30 "!=e.slice(0,7))throw Error("Prefix invalid");return e.slice(7)},chem.Molfile.parseAtomLineV3000=function(e){var t,r,o,n,i,a=chem.Molfile;t=a.spaceparsplit(e);var s={pp:new Vec2(parseFloat(t[2]),-parseFloat(t[3])),aam:t[5].strip()},l=t[1].strip();if('"'==l.charAt(0)&&'"'==l.charAt(l.length-1)&&(l=l.substr(1,l.length-2)),"]"==l.charAt(l.length-1)){l=l.substr(0,l.length-1);var d={};if(d.notList=!1,"NOT ["==l.substr(0,5))d.notList=!0,l=l.substr(5);else{if("["!=l.charAt(0))throw"Error: atom list expected, found '"+l+"'";l=l.substr(1)}d.ids=a.labelsListToIds(l.split(",")),s.atomList=new chem.Struct.AtomList(d),s.label="L#"}else s.label=l;for(t.splice(0,6),i=0;i<t.length;++i)if(r=a.splitonce(t[i],"="),o=r[0],n=r[1],o in a.fmtInfo.v30atomPropMap){var c=a.parseDecimalInt(n);if("VAL"==o){if(0==c)continue;-1==c&&(c=0)}s[a.fmtInfo.v30atomPropMap[o]]=c}else if("RGROUPS"==o){n=n.strip().substr(1,n.length-2);var u=n.split(" ").slice(1);s.rglabel=0;for(var h=0;h<u.length;++h)s.rglabel|=1<<u[h]-1}else"ATTCHPT"==o&&(s.attpnt=n.strip()-0);return new chem.Struct.Atom(s)},chem.Molfile.parseBondLineV3000=function(e){var t,r,o,n,i,a=chem.Molfile;t=a.spaceparsplit(e);var s={begin:a.parseDecimalInt(t[2])-1,end:a.parseDecimalInt(t[3])-1,type:a.fmtInfo.bondTypeMap[a.parseDecimalInt(t[1])]};for(t.splice(0,4),i=0;i<t.length;++i)r=a.splitonce(t[i],"="),o=r[0],n=r[1],"CFG"==o?(s.stereo=a.fmtInfo.v30bondStereoMap[a.parseDecimalInt(n)],s.type==chem.Struct.BOND.TYPE.DOUBLE&&s.stereo==chem.Struct.BOND.STEREO.EITHER&&(s.stereo=chem.Struct.BOND.STEREO.CIS_TRANS)):"TOPO"==o?s.topology=a.fmtInfo.bondTopologyMap[a.parseDecimalInt(n)]:"RXCTR"==o?s.reactingCenterStatus=a.parseDecimalInt(n):"STBOX"==o&&(s.stereoCare=a.parseDecimalInt(n));return new chem.Struct.Bond(s)},chem.Molfile.parseBondLine=function(e){var t=chem.Molfile,r=t.partitionLine(e,t.fmtInfo.bondLinePartition),o={begin:t.parseDecimalInt(r[0])-1,end:t.parseDecimalInt(r[1])-1,type:t.fmtInfo.bondTypeMap[t.parseDecimalInt(r[2])],stereo:t.fmtInfo.bondStereoMap[t.parseDecimalInt(r[3])],topology:t.fmtInfo.bondTopologyMap[t.parseDecimalInt(r[5])],reactingCenterStatus:t.parseDecimalInt(r[6])};return new chem.Struct.Bond(o)},chem.Molfile.parseAtomListLine=function(e){for(var t=chem.Molfile,r=t.partitionLine(e,t.fmtInfo.atomListHeaderPartition),o=t.parseDecimalInt(r[0])-1,n="T"==r[2].strip(),i=t.parseDecimalInt(r[4].strip()),a=e.slice(t.fmtInfo.atomListHeaderLength),s=[],l=t.fmtInfo.atomListHeaderItemLength,d=0;i>d;++d)s[d]=t.parseDecimalInt(a.slice(d*l,(d+1)*l-1));return{aid:o,atomList:new chem.Struct.AtomList({notList:n,ids:s})}},chem.Molfile.readKeyValuePairs=function(e,t){for(var r=chem.Molfile,o={},n=r.partitionLineFixed(e,3,!0),i=r.parseDecimalInt(n[0]),a=0;i>a;++a)o[r.parseDecimalInt(n[2*a+1])-1]=t?n[2*a+2].strip():r.parseDecimalInt(n[2*a+2]);return o},chem.Molfile.readKeyMultiValuePairs=function(e,t){for(var r=chem.Molfile,o=[],n=r.partitionLineFixed(e,3,!0),i=r.parseDecimalInt(n[0]),a=0;i>a;++a)o.push([r.parseDecimalInt(n[2*a+1])-1,t?n[2*a+2].strip():r.parseDecimalInt(n[2*a+2])]);return o},chem.Molfile.labelsListToIds=function(e){for(var t=[],r=0;r<e.length;++r)t.push(element.getElementByLabel(e[r].strip()));return t},chem.Molfile.parsePropertyLineAtomList=function(e,t){var r=chem.Molfile,o=r.parseDecimalInt(e[1])-1,n=r.parseDecimalInt(e[2]),i="T"==e[4].strip(),a=r.labelsListToIds(t.slice(0,n)),s={};return s[o]=new chem.Struct.AtomList({notList:i,ids:a}),s},chem.Molfile.initSGroup=function(e,t){var r=chem.Molfile,o=r.readKeyValuePairs(t,!0);for(var n in o){var i=o[n];if(!(i in chem.SGroup.TYPES))throw new Error("Unsupported S-group type");var a=new chem.SGroup(i);a.number=n,e[n]=a}},chem.Molfile.applySGroupProp=function(e,t,r,o,n){var i=chem.Molfile,a=i.readKeyValuePairs(r,!o);for(var s in a)(n?e[s]:e[s].data)[t]=a[s]},chem.Molfile.toIntArray=function(e){for(var t=chem.Molfile,r=[],o=0;o<e.length;++o)r[o]=t.parseDecimalInt(e[o]);return r},chem.Molfile.applySGroupArrayProp=function(e,t,r,o){var n=chem.Molfile,i=n.parseDecimalInt(r.slice(1,4))-1,a=n.parseDecimalInt(r.slice(4,8)),s=n.toIntArray(n.partitionLineFixed(r.slice(8),3,!0));if(s.length!=a)throw new Error("File format invalid");o&&util.apply(s,function(e){return e+o}),e[i][t]=e[i][t].concat(s)},chem.Molfile.applyDataSGroupName=function(e,t){e.data.fieldName=t},chem.Molfile.applyDataSGroupQuery=function(e,t){e.data.query=t},chem.Molfile.applyDataSGroupQueryOp=function(e,t){e.data.queryOp=t},chem.Molfile.applyDataSGroupDesc=function(e,t){var r=chem.Molfile,o=r.partitionLine(t,[4,31,2,20,2,3],!1),n=r.parseDecimalInt(o[0])-1,i=o[1].strip(),a=o[2].strip(),s=o[3].strip(),l=o[4].strip(),d=o[5].strip(),c=e[n];c.data.fieldType=a,c.data.fieldName=i,c.data.units=s,c.data.query=l,c.data.queryOp=d},chem.Molfile.applyDataSGroupInfo=function(e,t){var r=chem.Molfile,o=r.partitionLine(t,[10,10,4,1,1,1,3,3,3,3,2,3,2],!1),n=parseFloat(o[0]),i=parseFloat(o[1]),a="A"==o[3].strip(),s="A"==o[4].strip(),l="U"==o[5].strip(),d=o[7].strip();d="ALL"==d?-1:r.parseDecimalInt(d);var c=o[10].strip(),u=r.parseDecimalInt(o[11].strip());e.pp=new Vec2(n,-i),e.data.attached=a,e.data.absolute=s,e.data.showUnits=l,e.data.nCharsToDisplay=d,e.data.tagChar=c,e.data.daspPos=u},chem.Molfile.applyDataSGroupInfoLine=function(e,t){var r=chem.Molfile,o=r.parseDecimalInt(t.substr(0,4))-1,n=e[o];r.applyDataSGroupInfo(n,t.substr(5))},chem.Molfile.applyDataSGroupData=function(e,t,r){e.data.fieldValue=(e.data.fieldValue||"")+t,r&&(e.data.fieldValue=util.stripRight(e.data.fieldValue),e.data.fieldValue.startsWith('"')&&e.data.fieldValue.endsWith('"')&&(e.data.fieldValue=e.data.fieldValue.substr(1,e.data.fieldValue.length-2)))},chem.Molfile.applyDataSGroupDataLine=function(e,t,r){var o=chem.Molfile,n=o.parseDecimalInt(t.substr(0,5))-1,i=t.substr(5),a=e[n];o.applyDataSGroupData(a,i,r)},chem.Molfile.parsePropertyLines=function(e,t,r,o,n,i){for(var a=chem.Molfile,s=new Map;o>r;){var l=t[r];if("A"==l.charAt(0))s.get("label")||s.set("label",new Map),s.get("label").set(a.parseDecimalInt(l.slice(3,6))-1,t[++r]);else if("M"==l.charAt(0)){var d=l.slice(3,6),c=l.slice(6);if("END"==d)break;if("CHG"==d)s.get("charge")||s.set("charge",new Map),s.get("charge").update(a.readKeyValuePairs(c));else if("RAD"==d)s.get("radical")||s.set("radical",new Map),s.get("radical").update(a.readKeyValuePairs(c));else if("ISO"==d)s.get("isotope")||s.set("isotope",new Map),s.get("isotope").update(a.readKeyValuePairs(c));else if("RBC"==d)s.get("ringBondCount")||s.set("ringBondCount",new Map),s.get("ringBondCount").update(a.readKeyValuePairs(c));else if("SUB"==d)s.get("substitutionCount")||s.set("substitutionCount",new Map),s.get("substitutionCount").update(a.readKeyValuePairs(c));else if("UNS"==d)s.get("unsaturatedAtom")||s.set("unsaturatedAtom",new Map),s.get("unsaturatedAtom").update(a.readKeyValuePairs(c));else if("RGP"==d){s.get("rglabel")||s.set("rglabel",new Map);for(var u=s.get("rglabel"),h=a.readKeyMultiValuePairs(c),p=0;p<h.length;p++){var f=h[p];u.set(f[0],(u.get(f[0])||0)|1<<f[1]-1)}}else if("LOG"==d){c=c.slice(4);var m=a.parseDecimalInt(c.slice(0,3).strip()),g=a.parseDecimalInt(c.slice(4,7).strip()),v=a.parseDecimalInt(c.slice(8,11).strip()),b=c.slice(12).strip(),y={};g>0&&(y.ifthen=g),y.resth=1==v,y.range=b,i[m]=y}else if("APO"==d)s.get("attpnt")||s.set("attpnt",new Map),s.get("attpnt").update(a.readKeyValuePairs(c));else if("ALS"==d){s.get("atomList")||s.set("atomList",new Map);var S=a.parsePropertyLineAtomList(a.partitionLine(c,[1,3,3,1,1,1]),a.partitionLineFixed(c.slice(10),4,!1));s.get("atomList").update(S),s.get("label")||s.set("label",new Map);for(var x in S)s.get("label").set(x,"L#")}else if("STY"==d)a.initSGroup(n,c);else if("SST"==d)a.applySGroupProp(n,"subtype",c);else if("SLB"==d)a.applySGroupProp(n,"label",c,!0);else if("SPL"==d)a.applySGroupProp(n,"parent",c,!0,!0);else if("SCN"==d)a.applySGroupProp(n,"connectivity",c);else if("SAL"==d)a.applySGroupArrayProp(n,"atoms",c,-1);else if("SBL"==d)a.applySGroupArrayProp(n,"bonds",c,-1);else if("SPA"==d)a.applySGroupArrayProp(n,"patoms",c,-1);else if("SMT"==d){var w=a.parseDecimalInt(c.slice(0,4))-1;n[w].data.subscript=c.slice(4).strip()}else"SDT"==d?a.applyDataSGroupDesc(n,c):"SDD"==d?a.applyDataSGroupInfoLine(n,c):"SCD"==d?a.applyDataSGroupDataLine(n,c,!1):"SED"==d&&a.applyDataSGroupDataLine(n,c,!0)}++r}return s},chem.Molfile.applyAtomProp=function(e,t,r){t.each(function(t,o){e.get(t)[r]=o})},chem.Molfile.parseCTabV2000=function(e,t){var r,o=new chem.Struct,n=chem.Molfile,i=n.parseDecimalInt(t[0]),a=n.parseDecimalInt(t[1]),s=n.parseDecimalInt(t[2]);o.isChiral=0!=n.parseDecimalInt(t[4]);var l=n.parseDecimalInt(t[5]),d=n.parseDecimalInt(t[10]),c=0,u=e.slice(c,c+i);c+=i;var h=e.slice(c,c+a);c+=a;var p=e.slice(c,c+s);c+=s+l;var f=u.map(n.parseAtomLine);for(r=0;r<f.length;++r)o.atoms.add(f[r]);var m=h.map(n.parseBondLine);for(r=0;r<m.length;++r)o.bonds.add(m[r]);var g=p.map(n.parseAtomListLine);g.each(function(e){o.atoms.get(e.aid).atomList=e.atomList,o.atoms.get(e.aid).label="L#"});var v={},b={},y=n.parsePropertyLines(o,e,c,Math.min(e.length,c+d),v,b);y.each(function(e,t){n.applyAtomProp(o.atoms,t,e)});var S,x={};for(S in v){var w=v[S];if("DAT"===w.type&&0===w.atoms.length){var A=v[S].parent;if(A>=0){var R=v[A-1];"GEN"===R.type&&(w.atoms=util.array(R.atoms))}}}for(S in v)chem.SGroup.addGroup(o,v[S],x);var C=[];for(S in v)chem.SGroup.filter(o,v[S],x),0!=v[S].atoms.length||v[S].allAtoms||C.push(S);for(r=0;r<C.length;++r)o.sGroupForest.remove(C[r]),o.sgroups.remove(C[r]);for(var O in b)o.rgroups.set(O,new chem.Struct.RGroup(b[O]));return o},chem.Molfile.spaceparsplit=function(e){var t,r,o=[],n=0,i=-1,a=e.toArray(),s=!1;for(r=0;r<e.length;++r)t=a[r],"("==t?n++:")"==t&&n--,'"'==t&&(s=!s),s||" "!=a[r]||0!=n||(r>i+1&&o.push(e.slice(i+1,r)),i=r);return r>i+1&&o.push(e.slice(i+1,r)),i=r,o},chem.Molfile.splitonce=function(e,t){var r=e.indexOf(t);return[e.slice(0,r),e.slice(r+1)]},chem.Molfile.splitSGroupDef=function(e){for(var t=[],r=0,o=!1,n=0;n<e.length;++n){var i=e.charAt(n);'"'==i?o=!o:o||("("==i?r++:")"==i?r--:" "==i&&0==r&&(t.push(e.slice(0,n)),e=e.slice(n+1).strip(),n=0))}if(0!=r)throw"Brace balance broken. S-group properies invalid!";return e.length>0&&t.push(e.strip()),t},chem.Molfile.parseBracedNumberList=function(e,t){if(!e)return null;var r=[];e=e.strip(),e=e.substr(1,e.length-2);var o=e.split(" ");t=t||0;for(var n=1;n<o.length;++n)r.push(o[n]-0+t);return r},chem.Molfile.v3000parseCollection=function(e,t,r){for(r++;"M  V30 END COLLECTION"!=t[r].strip();)r++;return r++,r},chem.Molfile.v3000parseSGroup=function(e,t,r,o,n){var i=chem.Molfile,a="";for(n++;n<t.length;){if(a=i.stripV30(t[n++]).strip(),"END SGROUP"==a.strip())return n;for(;"-"==a.charAt(a.length-1);)a=(a.substr(0,a.length-1)+i.stripV30(t[n++])).strip();var s=i.splitSGroupDef(a),l=s[1],d=new chem.SGroup(l);d.number=s[0]-0,d.type=l,d.label=s[2]-0,r[d.number]=d;for(var c={},u=3;u<s.length;++u){var h=i.splitonce(s[u],"=");if(2!=h.length)throw"A record of form AAA=BBB or AAA=(...) expected, got '"+s[u]+"'";var p=h[0];p in c||(c[p]=[]),c[p].push(h[1])}d.atoms=i.parseBracedNumberList(c.ATOMS[0],-1),c.PATOMS&&(d.patoms=i.parseBracedNumberList(c.PATOMS[0],-1)),d.bonds=c.BONDS?i.parseBracedNumberList(c.BONDS[0],-1):[];var f=c.BRKXYZ;if(d.brkxyz=[],f)for(var m=0;m<f.length;++m)d.brkxyz.push(i.parseBracedNumberList(f[m]));c.MULT&&(d.data.subscript=c.MULT[0]-0),c.LABEL&&(d.data.subscript=c.LABEL[0].strip()),c.CONNECT&&(d.data.connectivity=c.CONNECT[0].toLowerCase()),c.FIELDDISP&&i.applyDataSGroupInfo(d,util.stripQuotes(c.FIELDDISP[0])),c.FIELDDATA&&i.applyDataSGroupData(d,c.FIELDDATA[0],!0),c.FIELDNAME&&i.applyDataSGroupName(d,c.FIELDNAME[0]),c.QUERYTYPE&&i.applyDataSGroupQuery(d,c.QUERYTYPE[0]),c.QUERYOP&&i.applyDataSGroupQueryOp(d,c.QUERYOP[0]),chem.SGroup.addGroup(e,d,o)}throw new Error("S-group declaration incomplete.")},chem.Molfile.parseCTabV3000=function(e,t){var r=new chem.Struct,o=chem.Molfile,n=0;if("M  V30 BEGIN CTAB"!=e[n++].strip())throw Error("CTAB V3000 invalid");if("M  V30 COUNTS"!=e[n].slice(0,13))throw Error("CTAB V3000 invalid");var i=e[n].slice(14).split(" ");if(r.isChiral=1==o.parseDecimalInt(i[4]),n++,"M  V30 BEGIN ATOM"==e[n].strip()){n++;for(var a;n<e.length&&(a=o.stripV30(e[n++]).strip(),"END ATOM"!=a);){for(;"-"==a.charAt(a.length-1);)a=(a.substring(0,a.length-1)+o.stripV30(e[n++])).strip();r.atoms.add(o.parseAtomLineV3000(a))}if("M  V30 BEGIN BOND"==e[n].strip())for(n++;n<e.length&&(a=o.stripV30(e[n++]).strip(),"END BOND"!=a);){for(;"-"==a.charAt(a.length-1);)a=(a.substring(0,a.length-1)+o.stripV30(e[n++])).strip();r.bonds.add(o.parseBondLineV3000(a))}for(var s={},l={};"M  V30 END CTAB"!=e[n].strip();)if("M  V30 BEGIN COLLECTION"==e[n].strip())n=o.v3000parseCollection(r,e,n);else{if("M  V30 BEGIN SGROUP"!=e[n].strip())throw Error("CTAB V3000 invalid");n=o.v3000parseSGroup(r,e,s,l,n)}}if("M  V30 END CTAB"!=e[n++].strip())throw Error("CTAB V3000 invalid");return t||o.readRGroups3000(r,e.slice(n)),r},chem.Molfile.readRGroups3000=function(e,t){for(var r={},o={},n=0,i=chem.Molfile;n<t.length&&0==t[n].search("M  V30 BEGIN RGROUP");){var a=t[n++].split(" ").pop();for(r[a]=[],o[a]={};;){var s=t[n].strip();if(0!=s.search("M  V30 RLOGIC")){if("M  V30 BEGIN CTAB"!=s)throw Error("CTAB V3000 invalid");for(var l=0;l<t.length&&"M  V30 END CTAB"!=t[n+l].strip();++l);var d=t.slice(n,n+l+1),c=this.parseCTabV3000(d,!0);if(r[a].push(c),n=n+l+1,"M  V30 END RGROUP"==t[n].strip()){n++;break}}else{s=s.slice(13);var u=s.strip().split(/\s+/g),h=i.parseDecimalInt(u[0]),p=i.parseDecimalInt(u[1]),f=u.slice(2).join(" "),m={};h>0&&(m.ifthen=h),m.resth=1==p,m.range=f,o[a]=m,n++}}}for(var g in r)for(var v=0;v<r[g].length;++v){var b=r[g][v];b.rgroups.set(g,new chem.Struct.RGroup(o[g]));var y=b.frags.add(new chem.Struct.Fragment);b.rgroups.get(g).frags.add(y),b.atoms.each(function(e,t){t.fragment=y}),b.mergeInto(e)}},chem.Molfile.parseMol=function(e){if(0==e[0].search("\\$MDL"))return this.parseRg2000(e);var t=this.parseCTab(e.slice(3));return t.name=e[0].strip(),t},chem.Molfile.parseCTab=function(e){var t=chem.Molfile,r=t.partitionLine(e[0],t.fmtInfo.countsLinePartition),o=r[11].strip();if(e=e.slice(1),"V2000"==o)return this.parseCTabV2000(e,r);if("V3000"==o)return this.parseCTabV3000(e,!chem.Molfile.loadRGroupFragments);throw Error("Molfile version unknown: "+o)},chem.MolfileSaver=function(e){this.molecule=null,this.molfile=null,this.v3000=e||!1},chem.MolfileSaver.prototype.prepareSGroups=function(e,t){var r=this.molecule;r.sgroups;var o=[],n=0;util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(i){var a=r.sgroups.get(i),s=!1;try{a.prepareForSaving(r)}catch(l){if(!e||"number"!=typeof l.id)throw l;s=!0}(s||!t&&/^INDIGO_.+_DESC$/i.test(a.data.fieldName))&&(n+=s,o.push(a.id))},this),n&&alert("WARNING: "+n+" invalid S-groups were detected. They will be omitted.");for(var i=0;i<o.length;++i)r.sGroupDelete(o[i]);return r},chem.MolfileSaver.getComponents=function(e){var t=e.findConnectedComponents(!0),r=[],o=null;e.rxnArrows.each(function(e,t){o=t.pp.x}),e.rxnPluses.each(function(e,t){r.push(t.pp.x)}),null!=o&&r.push(o),r.sort(function(e,t){return e-t});var n,i=[];for(n=0;n<t.length;++n){for(var a=e.getCoordBoundingBox(t[n]),s=Vec2.lc2(a.min,.5,a.max,.5),l=0;s.x>r[l];)++l;i[l]=i[l]||{},Set.mergeIn(i[l],t[n])}var d=[],c=[],u=[];for(n=0;n<i.length;++n)i[n]?(a=e.getCoordBoundingBox(i[n]),s=Vec2.lc2(a.min,.5,a.max,.5),s.x<o?c.push(i[n]):u.push(i[n])):d.push("");return{reactants:c,products:u}},chem.MolfileSaver.prototype.getCTab=function(e,t){return this.molecule=e.clone(),this.molfile="",this.writeCTab2000(t),this.molfile},chem.MolfileSaver.prototype.saveMolecule=function(e,t,r,o){if(this.reaction=e.rxnArrows.count()>0,e.rxnArrows.count()>1)throw new Error("Reaction may not contain more than one arrow");if(this.molfile="",this.reaction){if(e.rgroups.count()>0)throw new Error("Unable to save the structure - reactions with r-groups are not supported at the moment");var n=chem.MolfileSaver.getComponents(e),i=n.reactants,a=n.products,s=i.concat(a);this.molfile="$RXN\n\n\n\n"+util.paddedInt(i.length,3)+util.paddedInt(a.length,3)+util.paddedInt(0,3)+"\n";for(var l=0;l<s.length;++l){var d=new chem.MolfileSaver(!1),c=e.clone(s[l],null,!0),u=d.saveMolecule(c,!1,!0);this.molfile+="$MOL\n"+u}return this.molfile}if(e.rgroups.count()>0){if(!r){var h=new chem.MolfileSaver(!1).getCTab(e.getScaffold(),e.rgroups);return this.molfile="$MDL  REV  1\n$MOL\n$HDR\n\n\n\n$END HDR\n",this.molfile+="$CTAB\n"+h+"$END CTAB\n",e.rgroups.each(function(t,r){this.molfile+="$RGP\n",this.writePaddedNumber(t,3),this.molfile+="\n",r.frags.each(function(t,r){var o=new chem.MolfileSaver(!1).getCTab(e.getFragment(r));this.molfile+="$CTAB\n"+o+"$END CTAB\n"},this),this.molfile+="$END RGP\n"},this),this.molfile+="$END MOL\n",this.molfile}e=e.getScaffold()}return this.molecule=e.clone(),this.prepareSGroups(t,o),this.writeHeader(),this.writeCTab2000(),this.molfile},chem.MolfileSaver.prototype.writeHeader=function(){var e=new Date;this.writeCR(),this.writeWhiteSpace(2),this.write("Ketcher"),this.writeWhiteSpace(),this.writeCR((e.getMonth()+1).toPaddedString(2)+e.getDate().toPaddedString(2)+(e.getFullYear()%100).toPaddedString(2)+e.getHours().toPaddedString(2)+e.getMinutes().toPaddedString(2)+"2D 1   1.00000     0.00000     0"),this.writeCR()},chem.MolfileSaver.prototype.write=function(e){this.molfile+=e},chem.MolfileSaver.prototype.writeCR=function(e){0==arguments.length&&(e=""),this.molfile+=e+"\n"},chem.MolfileSaver.prototype.writeWhiteSpace=function(e){0==arguments.length&&(e=1),e.times(function(){this.write(" ")},this)},chem.MolfileSaver.prototype.writePadded=function(e,t){this.write(e),this.writeWhiteSpace(t-e.length)},chem.MolfileSaver.prototype.writePaddedNumber=function(e,t){var r=(e-0).toString();this.writeWhiteSpace(t-r.length),this.write(r)},chem.MolfileSaver.prototype.writePaddedFloat=function(e,t,r){this.write(util.paddedFloat(e,t,r))},chem.MolfileSaver.prototype.writeCTab2000Header=function(){this.writePaddedNumber(this.molecule.atoms.count(),3),this.writePaddedNumber(this.molecule.bonds.count(),3),this.writePaddedNumber(0,3),this.writeWhiteSpace(3),this.writePaddedNumber(this.molecule.isChiral?1:0,3),this.writePaddedNumber(0,3),this.writeWhiteSpace(12),this.writePaddedNumber(999,3),this.writeCR(" V2000")},chem.MolfileSaver.prototype.writeCTab2000=function(e){this.writeCTab2000Header(),this.mapping={};var t=1,r=[],o=[];for(this.molecule.atoms.each(function(e,n){this.writePaddedFloat(n.pp.x,10,4),this.writePaddedFloat(-n.pp.y,10,4),this.writePaddedFloat(0,10,4),this.writeWhiteSpace();var i=n.label;null!=n.atomList?(i="L",r.push(e)):null==element.getElementByLabel(i)&&-1==["A","Q","X","*","R#"].indexOf(i)&&(i="C",o.push(e)),this.writePadded(i,3),this.writePaddedNumber(0,2),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(n.hCount)&&(n.hCount=0),this.writePaddedNumber(n.hCount,3),Object.isUndefined(n.stereoCare)&&(n.stereoCare=0),this.writePaddedNumber(n.stereoCare,3),this.writePaddedNumber(n.explicitValence<0?0:0==n.explicitValence?15:n.explicitValence,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(n.aam)&&(n.aam=0),this.writePaddedNumber(n.aam,3),Object.isUndefined(n.invRet)&&(n.invRet=0),this.writePaddedNumber(n.invRet,3),Object.isUndefined(n.exactChangeFlag)&&(n.exactChangeFlag=0),this.writePaddedNumber(n.exactChangeFlag,3),this.writeCR(),this.mapping[e]=t,t++},this),this.bondMapping={},t=1,this.molecule.bonds.each(function(e,r){this.bondMapping[e]=t++,this.writePaddedNumber(this.mapping[r.begin],3),this.writePaddedNumber(this.mapping[r.end],3),this.writePaddedNumber(r.type,3),Object.isUndefined(r.stereo)&&(r.stereo=0),this.writePaddedNumber(r.stereo,3),this.writeWhiteSpace(3),Object.isUndefined(r.topology)&&(r.topology=0),this.writePaddedNumber(r.topology,3),Object.isUndefined(r.reactingCenterStatus)&&(r.reactingCenterStatus=0),this.writePaddedNumber(r.reactingCenterStatus,3),this.writeCR()},this);o.length>0;)this.write("A  "),this.writePaddedNumber(o[0]+1,3),this.writeCR(),this.writeCR(this.molecule.atoms.get(o[0]).label),o.splice(0,1);var n=new Array,i=new Array,a=new Array,s=new Array,l=new Array,d=new Array,c=new Array,u=new Array,h=new Array;this.molecule.atoms.each(function(e,t){if(0!=t.charge&&n.push([e,t.charge]),0!=t.isotope&&i.push([e,t.isotope]),0!=t.radical&&a.push([e,t.radical]),null!=t.rglabel&&"R#"==t.label)for(var r=0;32>r;r++)t.rglabel&1<<r&&s.push([e,r+1]);null!=t.attpnt&&d.push([e,t.attpnt]),0!=t.ringBondCount&&c.push([e,t.ringBondCount]),0!=t.substitutionCount&&h.push([e,t.substitutionCount]),0!=t.unsaturatedAtom&&u.push([e,t.unsaturatedAtom])}),e&&e.each(function(e,t){if(t.resth||t.ifthen>0||t.range.length>0){var r="  1 "+util.paddedInt(e,3)+" "+util.paddedInt(t.ifthen,3)+" "+util.paddedInt(t.resth?1:0,3)+"   "+t.range;l.push(r)}});var p=function(e,t){for(;t.length>0;){for(var r=new Array;t.length>0&&r.length<8;)r.push(t[0]),t.splice(0,1);this.write(e),this.writePaddedNumber(r.length,3),r.each(function(e){this.writeWhiteSpace(),this.writePaddedNumber(this.mapping[e[0]],3),this.writeWhiteSpace(),this.writePaddedNumber(e[1],3)},this),this.writeCR()}};p.call(this,"M  CHG",n),p.call(this,"M  ISO",i),p.call(this,"M  RAD",a),p.call(this,"M  RGP",s);for(var f=0;f<l.length;++f)this.write("M  LOG"+l[f]+"\n");if(p.call(this,"M  APO",d),p.call(this,"M  RBC",c),p.call(this,"M  SUB",h),p.call(this,"M  UNS",u),r.length>0)for(f=0;f<r.length;++f){var m=r[f],g=this.molecule.atoms.get(m).atomList;this.write("M  ALS"),this.writePaddedNumber(m+1,4),this.writePaddedNumber(g.ids.length,3),this.writeWhiteSpace(),this.write(g.notList?"T":"F");for(var v=g.labelList(),b=0;b<v.length;++b)this.writeWhiteSpace(),this.writePadded(v[b],3);this.writeCR()}var y={},S=1,x={},w=this.molecule.sGroupForest.getSGroupsBFS();util.each(w,function(e){x[S]=e,y[e]=S++},this);for(var A=1;S>A;++A){var R=x[A],C=this.molecule.sgroups.get(R);this.write("M  STY"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(A,3),this.writeWhiteSpace(1),this.writePadded(C.type,3),this.writeCR(),this.write("M  SLB"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(A,3),this.writeWhiteSpace(1),this.writePaddedNumber(A,3),this.writeCR();var O=this.molecule.sGroupForest.parent.get(R);if(O>=0&&(this.write("M  SPL"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(A,3),this.writeWhiteSpace(1),this.writePaddedNumber(y[O],3),this.writeCR()),"SRU"==C.type&&C.data.connectivity){var E="";E+=" ",E+=util.stringPadded(A.toString(),3),E+=" ",E+=util.stringPadded(C.data.connectivity,3,!0),this.write("M  SCN"),this.writePaddedNumber(1,3),this.write(E.toUpperCase()),this.writeCR()}"SRU"==C.type&&(this.write("M  SMT "),this.writePaddedNumber(A,3),this.writeWhiteSpace(),this.write(C.data.subscript||"n"),this.writeCR()),this.writeCR(C.saveToMolfile(this.molecule,y,this.mapping,this.bondMapping))}this.writeCR("M  END")},chem.Molfile.parseRxn=function(e){var t=chem.Molfile,r=e[0].strip().split(" ");return r.length>1&&"V3000"==r[1]?t.parseRxn3000(e):t.parseRxn2000(e)},chem.Molfile.parseRxn2000=function(e){var t=chem.Molfile;e=e.slice(4);var r=t.partitionLine(e[0],t.fmtInfo.rxnItemsPartition),o=r[0]-0,n=r[1]-0,i=r[2]-0;e=e.slice(1);for(var a=[];e.length>0&&"$MOL"==e[0].substr(0,4);){e=e.slice(1);for(var s=0;s<e.length&&"$MOL"!=e[s].substr(0,4);)s++;a.push(chem.Molfile.parseMol(e.slice(0,s))),e=e.slice(s)}return t.rxnMerge(a,o,n,i)},chem.Molfile.parseRxn3000=function(e){var t=chem.Molfile;e=e.slice(4);for(var r=e[0].split(/\s+/g).slice(3),o=r[0]-0,n=r[1]-0,i=r.length>2?r[2]-0:0,a=function(e){util.assert(e,"CTab format invalid")},s=function(t){for(var r=t;r<e.length;++r)if("M  V30 END CTAB"==e[r].strip())return r;a(!1)},l=function(t){for(var r=t;r<e.length;++r)if("M  V30 END RGROUP"==e[r].strip())return r;a(!1)},d=[],c=[],u=null,h=[],p=0;p<e.length;++p){var f=e[p].strip();if(f.startsWith("M  V30 COUNTS"));else{if("M  END"==f)break;if("M  V30 BEGIN PRODUCT"==f)a(null==u),u=c;else if("M  V30 END PRODUCT"==f)a(u===c),u=null;else if("M  V30 BEGIN REACTANT"==f)a(null==u),u=d;else if("M  V30 END REACTANT"==f)a(u===d),u=null;else if(f.startsWith("M  V30 BEGIN RGROUP")){a(null==u);var m=l(p);h.push(e.slice(p,m+1)),p=m}else{if("M  V30 BEGIN CTAB"!=f)throw new Error("line unrecognized: "+f);var m=s(p);u.push(e.slice(p,m+1)),p=m}}}for(var g=[],v=d.concat(c),m=0;m<v.length;++m){var b=chem.Molfile.parseCTabV3000(v[m],r);g.push(b)}var y=t.rxnMerge(g,o,n,i);return t.readRGroups3000(y,function(e){for(var t=[],r=0;r<e.length;++r)t=t.concat(e[r]);return t}(h)),y},chem.Molfile.rxnMerge=function(e,t,r){chem.Molfile;var o,n=new chem.Struct,i=[],a=[],s=[],l=[],d=[],c=[],u={cnt:0,totalLength:0};for(o=0;o<e.length;++o){var h=e[o],p=h.getBondLengthData();u.cnt+=p.cnt,u.totalLength+=p.totalLength}var f=1/(0==u.cnt?1:u.totalLength/u.cnt);for(o=0;o<e.length;++o)h=e[o],h.scale(f);for(o=0;o<e.length;++o){h=e[o];var m=h.getCoordBoundingBoxObj();if(m){var g=t>o?chem.Struct.FRAGMENT.REACTANT:t+r>o?chem.Struct.FRAGMENT.PRODUCT:chem.Struct.FRAGMENT.AGENT;g==chem.Struct.FRAGMENT.REACTANT?(i.push(m),l.push(h)):g==chem.Struct.FRAGMENT.AGENT?(a.push(m),d.push(h)):g==chem.Struct.FRAGMENT.PRODUCT&&(s.push(m),c.push(h)),h.atoms.each(function(e,t){t.rxnFragmentType=g})}}var v=0,b=function(e,t,r,o,n){var i=new Vec2(o-r.min.x,n?1-r.min.y:-(r.min.y+r.max.y)/2);return t.atoms.each(function(e,t){t.pp.add_(i)}),t.sgroups.each(function(e,t){t.pp&&t.pp.add_(i)}),r.min.add_(i),r.max.add_(i),t.mergeInto(e),r.max.x-r.min.x};for(o=0;o<l.length;++o)v+=b(n,l[o],i[o],v,!1)+2;for(v+=2,o=0;o<d.length;++o)v+=b(n,d[o],a[o],v,!0)+2;for(v+=2,o=0;o<c.length;++o)v+=b(n,c[o],s[o],v,!1)+2;var y,S,x,w,A=null,R=null;for(o=0;o<i.length-1;++o)y=i[o],S=i[o+1],x=(y.max.x+S.min.x)/2,w=(y.max.y+y.min.y+S.max.y+S.min.y)/4,n.rxnPluses.add(new chem.Struct.RxnPlus({pp:new Vec2(x,w)}));for(o=0;o<i.length;++o)0==o?(A={},A.max=new Vec2(i[o].max),A.min=new Vec2(i[o].min)):(A.max=Vec2.max(A.max,i[o].max),A.min=Vec2.min(A.min,i[o].min));for(o=0;o<s.length-1;++o)y=s[o],S=s[o+1],x=(y.max.x+S.min.x)/2,w=(y.max.y+y.min.y+S.max.y+S.min.y)/4,n.rxnPluses.add(new chem.Struct.RxnPlus({pp:new Vec2(x,w)}));for(o=0;o<s.length;++o)0==o?(R={},R.max=new Vec2(s[o].max),R.min=new Vec2(s[o].min)):(R.max=Vec2.max(R.max,s[o].max),R.min=Vec2.min(R.min,s[o].min));if(y=A,S=R,y||S){var C=y?new Vec2(y.max.x,(y.max.y+y.min.y)/2):null,O=S?new Vec2(S.min.x,(S.max.y+S.min.y)/2):null,E=3;C||(C=new Vec2(O.x-E,O.y)),O||(O=new Vec2(C.x+E,C.y)),n.rxnArrows.add(new chem.Struct.RxnArrow({pp:Vec2.lc2(C,.5,O,.5)}))}else n.rxnArrows.add(new chem.Struct.RxnArrow({pp:new Vec2(0,0)}));return n.isReaction=!0,n},chem.Molfile.rgMerge=function(e,t){var r=new chem.Struct;e.mergeInto(r,null,null,!1,!0);for(var o in t)for(var n=0;n<t[o].length;++n){var i=t[o][n];i.rgroups.set(o,new chem.Struct.RGroup);var a=i.frags.add(new chem.Struct.Fragment);i.rgroups.get(o).frags.add(a),i.atoms.each(function(e,t){t.fragment=a}),i.mergeInto(r)}return r},chem.Molfile.parseRg2000=function(e){var t=chem.Molfile;if(e=e.slice(7),"$CTAB"!=e[0].strip())throw new Error("RGFile format invalid");for(var r=1;"$"!=e[r].charAt(0);)r++;if("$END CTAB"!=e[r].strip())throw new Error("RGFile format invalid");var o=e.slice(1,r);e=e.slice(r+1);for(var n={};;){if(0==e.length)throw new Error("Unexpected end of file");var i=e[0].strip();if("$END MOL"==i){e=e.slice(1);break}if("$RGP"!=i)throw new Error("RGFile format invalid");var a=e[1].strip()-0;for(n[a]=[],e=e.slice(2);;){if(0==e.length)throw new Error("Unexpected end of file");if(i=e[0].strip(),"$END RGP"==i){e=e.slice(1);break}if("$CTAB"!=i)throw new Error("RGFile format invalid");for(r=1;"$"!=e[r].charAt(0);)r++;if("$END CTAB"!=e[r].strip())throw new Error("RGFile format invalid");n[a].push(e.slice(1,r)),e=e.slice(r+1)}}var s=chem.Molfile.parseCTab(o),l={};if(chem.Molfile.loadRGroupFragments)for(var d in n){l[d]=[];for(var c=0;c<n[d].length;++c)l[d].push(chem.Molfile.parseCTab(n[d][c]))}return t.rgMerge(s,l)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/map":40,"../util/set":42,"../util/vec2":43,"./element":10}],13:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Map=require("../util/map"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util");require("./element"),require("../rnd/restruct_rendering");var chem=global.chem=global.chem||{},rnd=global.rnd;chem.SGroup=function(e){if(!(e&&e in chem.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=e,this.id=-1,chem.SGroup.equip(this,e),this.label=-1,this.bracketBox=null,this.bracketDir=new Vec2(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"n",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",fieldValue:"",units:"",query:"",queryOp:""}},chem.SGroup.prototype.getAttr=function(e){return this.data[e]},chem.SGroup.prototype.getAttrs=function(){var e={};for(var t in this.data)e[t]=this.data[t];return e},chem.SGroup.prototype.setAttr=function(e,t){var r=this.data[e];return this.data[e]=t,r},chem.SGroup.prototype.checkAttr=function(e,t){return this.data[e]==t},chem.SGroup.equip=function(e,t){var r=chem.SGroup.TYPES[t];for(var o in r)e[o]=r[o]},chem.SGroup.numberArrayToString=function(e,t){for(var r=util.stringPadded(e.length,3),o=0;o<e.length;++o)r+=" "+util.stringPadded(t[e[o]],3);return r},chem.SGroup.addGroup=function(e,t,r){t.id=e.sgroups.add(t),t.postLoad(e,r);for(var o=0;o<t.atoms.length;++o)e.atoms.has(t.atoms[o])&&Set.add(e.atoms.get(t.atoms[o]).sgs,t.id);return e.sGroupForest.insert(t.id),t.id},chem.SGroup.bracketsToMolfile=function(e,t,r){var o=[],n=[],i=Set.fromList(t.atoms);chem.SGroup.getCrossBonds(o,n,e,i),chem.SGroup.bracketPos(t,null,e,n);for(var a=t.bracketBox,s=t.bracketDir,l=s.rotateSC(1,0),d=chem.SGroup.getBracketParameters(e,n,i,a,s,l,null,t.id),c=[],u=0;u<d.length;++u){for(var h=d[u],p=h.c.addScaled(h.n,-.5*h.h).yComplement(),f=h.c.addScaled(h.n,.5*h.h).yComplement(),m="M  SDI "+r+util.paddedInt(4,3),g=[p.x,p.y,f.x,f.y],v=0;v<g.length;++v)m+=util.paddedFloat(g[v],10,4);c.push(m)}return c},chem.SGroup.filterAtoms=function(e,t){for(var r=[],o=0;o<e.length;++o){var n=e[o];"number"!=typeof t[n]?r.push(n):t[n]>=0?r.push(t[n]):r.push(-1)}return r},chem.SGroup.removeNegative=function(e){for(var t=[],r=0;r<e.length;++r)e[r]>=0&&t.push(e[r]);return t},chem.SGroup.filter=function(e,t,r){t.atoms=chem.SGroup.removeNegative(chem.SGroup.filterAtoms(t.atoms,r))},chem.SGroup.clone=function(e,t){var r=new chem.SGroup(e.type);for(var o in e.data)r.data[o]=e.data[o];return r.atoms=util.mapArray(e.atoms,t),r.pp=e.pp,r.bracketBox=e.bracketBox,r.patoms=null,r.bonds=null,r.allAtoms=e.allAtoms,r},chem.SGroup.addAtom=function(e,t){e.atoms.push(t)},chem.SGroup.removeAtom=function(e,t){for(var r=0;r<e.atoms.length;++r)if(e.atoms[r]===t)return e.atoms.splice(r,1),void 0;throw new Error("The atom is not found in the given s-group")},chem.SGroup.getCrossBonds=function(e,t,r,o){r.bonds.each(function(r,n){Set.contains(o,n.begin)&&Set.contains(o,n.end)?util.isNull(e)||e.push(r):(Set.contains(o,n.begin)||Set.contains(o,n.end))&&(util.isNull(t)||t.push(r))},this)},chem.SGroup.bracketPos=function(e,t,r,o){var n=e.atoms;if(o&&2===o.length){var i=r.bonds.get(o[0]),a=r.bonds.get(o[1]),s=i.getCenter(r),l=a.getCenter(r);e.bracketDir=Vec2.diff(l,s).normalized()}else e.bracketDir=new Vec2(1,0);var d=e.bracketDir,c=d.rotateSC(1,0),u=null,h=[];util.each(n,function(e){var o=r.atoms.get(e),n=t?t.ctab.atoms.get(e).visel.boundingBox:null,i=new Vec2(o.pp);if(util.isNull(n)){n=new Box2Abs(i,i);var a=new Vec2(.05*3,.05*3);n=n.extend(a,a)}else n=n.translate((t.offset||new Vec2).negated()).transform(t.scaled2obj,t);h.push(n)},this),util.each(r.sGroupForest.children.get(e.id),function(e){var r=t?t.ctab.sgroups.get(e).visel.boundingBox:null;util.isNull(r)||(r=r.translate((t.offset||new Vec2).negated()).transform(t.scaled2obj,t),h.push(r))},this),util.each(h,function(e){var t=null;util.each([e.p0.x,e.p1.x],function(r){util.each([e.p0.y,e.p1.y],function(e){var o=new Vec2(r,e),n=new Vec2(Vec2.dot(o,d),Vec2.dot(o,c));t=util.isNull(t)?new Box2Abs(n,n):t.include(n)},this)},this),u=util.isNull(u)?t:Box2Abs.union(u,t)},this);var p=new Vec2(.2,.4);util.isNull(u)||(u=u.extend(p,p)),e.bracketBox=u},chem.SGroup.drawBrackets=function(e,t,r,o,n,i,a,s,l,d,c){for(var u=chem.SGroup.getBracketParameters(t.ctab.molecule,o,n,i,a,s,t,r.id),h=-1,p=0;p<u.length;++p){var f=u[p],m=chem.SGroup.drawBracket(t,t.paper,t.styles,f.d,f.n,f.c,f.w,f.h);e.push(m),(0>h||u[h].d.x<f.d.x||u[h].d.x==f.d.x&&u[h].d.y>f.d.y)&&(h=p)}var g=u[h],v=function(r,o){var n=t.ps(g.c.addScaled(g.n,o*g.h)),i=t.paper.text(n.x,n.y,r).attr({font:t.settings.font,"font-size":t.settings.fontszsub});c&&i.attr(c);var a=Box2Abs.fromRelBox(rnd.relBox(i.getBBox())),s=Math.max(Vec2.shiftRayBox(n,g.d.negated(),a),3)+2;i.translateAbs(s*g.d.x,s*g.d.y),e.push(i)};l&&v(l,.5),d&&v(d,-.5)},chem.SGroup.drawBracket=function(e,t,r,o,n,i,a,s){a=a||.25,s=s||1;var l=i.addScaled(n,-.5*s),d=i.addScaled(n,.5*s),c=l.addScaled(o,-a),u=d.addScaled(o,-a);return l=e.obj2scaled(l),d=e.obj2scaled(d),c=e.obj2scaled(c),u=e.obj2scaled(u),t.path("M {0}, {1} L {2} , {3} L {4} , {5} L {6} , {7}",c.x,c.y,l.x,l.y,d.x,d.y,u.x,u.y).attr(r.sgroupBracketStyle)},chem.SGroup.getBracketParameters=function(e,t,r,o,n,i,a,s){var l=function(e,t,r,o){this.c=e,this.d=t,this.n=t.rotateSC(1,0),this.w=r,this.h=o},d=[];return t.length<2?function(){n=n||new Vec2(1,0),i=i||n.rotateSC(1,0);var e=Math.min(.25,.3*o.sz().x),t=Vec2.lc2(n,o.p0.x,i,.5*(o.p0.y+o.p1.y)),r=Vec2.lc2(n,o.p1.x,i,.5*(o.p0.y+o.p1.y)),a=o.sz().y;d.push(new l(t,n.negated(),e,a),new l(r,n,e,a))}():2===t.length?function(){var r=e.bonds.get(t[0]),o=e.bonds.get(t[1]),n=r.getCenter(e),i=o.getCenter(e),c=-1,u=-1,h=-1,p=-1,f=Vec2.centre(n,i),m=Vec2.diff(i,n).normalized(),g=m.negated(),v=m.rotateSC(1,0),b=v.negated();util.each(e.sGroupForest.children.get(s),function(e){var t=a?a.ctab.sgroups.get(e).visel.boundingBox:null;util.isNull(t)||(t=t.translate((a.offset||new Vec2).negated()).transform(a.scaled2obj,a),c=Math.max(c,Vec2.shiftRayBox(n,g,t)),u=Math.max(u,Vec2.shiftRayBox(i,m,t)),h=Math.max(h,Vec2.shiftRayBox(f,v,t)),p=Math.max(p,Vec2.shiftRayBox(f,b,t)))},this),c=Math.max(c+.2,0),u=Math.max(u+.2,0),h=Math.max(Math.max(h,p)+.1,0);var S=.25,y=1.5+h;d.push(new l(n.addScaled(g,c),g,S,y),new l(i.addScaled(m,u),m,S,y))}():function(){for(var o=0;o<t.length;++o){var n=e.bonds.get(t[o]),i=n.getCenter(e),a=Set.contains(r,n.begin)?n.getDir(e):n.getDir(e).negated();d.push(new l(i,a,.2,1))}}(),d},chem.SGroup.getObjBBox=function(e,t){if(0==e.length)throw new Error("Atom list is empty");for(var r=t.atoms.get(e[0]).pp,o=new Box2Abs(r,r),n=1;n<e.length;++n){var i=e[n],a=t.atoms.get(i),s=a.pp;o=o.include(s)}return o},chem.SGroup.makeAtomBondLines=function(e,t,r,o){if(!r)return[];for(var n=[],i=0;i<Math.floor((r.length+14)/15);++i){for(var a=Math.min(r.length-15*i,15),s="M  "+e+" "+t+" "+util.paddedInt(a,2),l=0;a>l;++l)s+=" "+util.paddedInt(o[r[15*i+l]],3);n.push(s)}return n},chem.SGroup.getAtoms=function(e,t){if(!t.allAtoms)return t.atoms;var r=[];return e.atoms.each(function(e){r.push(e)}),r},chem.SGroup.getBonds=function(e,t){var r=chem.SGroup.getAtoms(e,t),o=[];return e.bonds.each(function(e,t){r.indexOf(t.begin)>=0&&r.indexOf(t.end)>=0&&o.push(e)}),o},chem.SGroup.GroupMul={draw:function(e){var t=e.render,r=t.paper.set(),o=[],n=[],i=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(o,n,e.molecule,i),chem.SGroup.bracketPos(this,t,e.molecule,n);var a=this.bracketBox,s=this.bracketDir,l=s.rotateSC(1,0);return this.areas=[a],chem.SGroup.drawBrackets(r,t,this,n,i,a,s,l,this.data.mul),r},saveToMolfile:function(e,t,r,o){var n=util.stringPadded(t[this.id],3),i=[];i=i.concat(chem.SGroup.makeAtomBondLines("SAL",n,util.idList(this.atomSet),r)),i=i.concat(chem.SGroup.makeAtomBondLines("SPA",n,util.idList(this.parentAtomSet),r)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",n,this.bonds,o));var a="M  SMT "+n+" "+this.data.mul;return i.push(a),i=i.concat(chem.SGroup.bracketsToMolfile(e,this,n)),i.join("\n")},prepareForSaving:function(e){var t;this.atoms.sort(),this.atomSet=Set.fromList(this.atoms),this.parentAtomSet=Set.clone(this.atomSet);var r=[],o=[];if(e.bonds.each(function(e,t){Set.contains(this.parentAtomSet,t.begin)&&Set.contains(this.parentAtomSet,t.end)?r.push(e):(Set.contains(this.parentAtomSet,t.begin)||Set.contains(this.parentAtomSet,t.end))&&o.push(e)},this),0!=o.length&&2!=o.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var n=-1,i=-1,a=null;if(2==o.length){var s=e.bonds.get(o[0]);n=Set.contains(this.parentAtomSet,s.begin)?s.begin:s.end;var l=e.bonds.get(o[1]);i=Set.contains(this.parentAtomSet,l.begin)?l.begin:l.end,a=l}var d=null,c=n,u=[];for(t=0;t<this.data.mul-1;++t)if(d={},util.each(this.atoms,function(t){var r=e.atoms.get(t),o=e.atoms.add(new chem.Struct.Atom(r));u.push(o),this.atomSet[o]=1,d[t]=o},this),util.each(r,function(t){var r=e.bonds.get(t),o=new chem.Struct.Bond(r);o.begin=d[o.begin],o.end=d[o.end],e.bonds.add(o)},this),null!=a){var h=new chem.Struct.Bond(a);h.begin=c,h.end=d[i],e.bonds.add(h),c=d[n]}if(util.each(u,function(t){util.each(e.sGroupForest.getPathToRoot(this.id).reverse(),function(r){e.atomAddToSGroup(r,t)},this)},this),c>=0){var p=e.bonds.get(o[0]);p.begin==n?p.begin=c:p.end=c}this.bonds=o},postLoad:function(e,t){this.data.mul=this.data.subscript-0;var r={};this.atoms=chem.SGroup.filterAtoms(this.atoms,t),this.patoms=chem.SGroup.filterAtoms(this.patoms,t);for(var o=1;o<this.data.mul;++o)for(var n=0;n<this.patoms.length;++n){var i=this.atoms[o*this.patoms.length+n];if(!(0>i)){if(this.patoms[n]<0)throw new Error("parent atom missing");r[i]=this.patoms[n]}}this.patoms=chem.SGroup.removeNegative(this.patoms);var a=util.identityMap(this.patoms),s=[];e.bonds.each(function(e,t){var o=t.begin in r,n=t.end in r;o&&n||o&&t.end in a||n&&t.begin in a?s.push(e):o?t.begin=r[t.begin]:n&&(t.end=r[t.end])},this);for(var l=0;l<s.length;++l)e.bonds.remove(s[l]);for(var d in r)e.atoms.remove(d),t[d]=-1;this.atoms=this.patoms,this.patoms=null}},chem.SGroup.GroupSru={draw:function(e){var t=e.render,r=t.paper.set(),o=[],n=[],i=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(o,n,e.molecule,i),chem.SGroup.bracketPos(this,t,e.molecule,n);var a=this.bracketBox,s=this.bracketDir,l=s.rotateSC(1,0);this.areas=[a];var d=this.data.connectivity||"eu";"ht"==d&&(d="");var c=this.data.subscript||"n";return chem.SGroup.drawBrackets(r,t,this,n,i,a,s,l,c,d),r},saveToMolfile:function(e,t,r,o){var n=util.stringPadded(t[this.id],3),i=[];return i=i.concat(chem.SGroup.makeAtomBondLines("SAL",n,this.atoms,r)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",n,this.bonds,o)),i=i.concat(chem.SGroup.bracketsToMolfile(e,this,n)),i.join("\n")},prepareForSaving:function(e){var t=[];if(e.bonds.each(function(r,o){var n=e.atoms.get(o.begin),i=e.atoms.get(o.end);(Set.contains(n.sgs,this.id)&&!Set.contains(i.sgs,this.id)||Set.contains(i.sgs,this.id)&&!Set.contains(n.sgs,this.id))&&t.push(r)},this),0!=t.length&&2!=t.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};this.bonds=t},postLoad:function(){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},chem.SGroup.GroupSup={draw:function(e){var t=e.render,r=t.paper.set(),o=[],n=[],i=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(o,n,e.molecule,i),chem.SGroup.bracketPos(this,t,e.molecule,n);var a=this.bracketBox,s=this.bracketDir,l=s.rotateSC(1,0);return this.areas=[a],chem.SGroup.drawBrackets(r,t,this,n,i,a,s,l,this.data.name,null,{"font-style":"italic"}),r},saveToMolfile:function(e,t,r,o){var n=util.stringPadded(t[this.id],3),i=[];return i=i.concat(chem.SGroup.makeAtomBondLines("SAL",n,this.atoms,r)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",n,this.bonds,o)),this.data.name&&""!=this.data.name&&i.push("M  SMT "+n+" "+this.data.name),i.join("\n")},prepareForSaving:function(e){var t=[];e.bonds.each(function(r,o){var n=e.atoms.get(o.begin),i=e.atoms.get(o.end);(Set.contains(n.sgs,this.id)&&!Set.contains(i.sgs,this.id)||Set.contains(i.sgs,this.id)&&!Set.contains(n.sgs,this.id))&&t.push(r)},this),this.bonds=t},postLoad:function(){this.data.name=(this.data.subscript||"").strip(),this.data.subscript=""}},chem.SGroup.GroupGen={draw:function(e){var t=e.render;t.settings,t.styles;var r=t.paper,o=r.set(),n=[],i=[],a=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(n,i,e.molecule,a),chem.SGroup.bracketPos(this,t,e.molecule,i);var s=this.bracketBox,l=this.bracketDir,d=l.rotateSC(1,0);return this.areas=[s],chem.SGroup.drawBrackets(o,t,this,i,a,s,l,d),o},saveToMolfile:function(e,t,r,o){var n=util.stringPadded(t[this.id],3),i=[];return i=i.concat(chem.SGroup.makeAtomBondLines("SAL",n,this.atoms,r)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",n,this.bonds,o)),i=i.concat(chem.SGroup.bracketsToMolfile(e,this,n)),i.join("\n")},prepareForSaving:function(){},postLoad:function(){}},chem.SGroup.getMassCentre=function(e,t){for(var r=new Vec2,o=0;o<t.length;++o)r=r.addScaled(e.atoms.get(t[o]).pp,1/t.length);return r},chem.SGroup.setPos=function(e,t,r){t.pp=r},chem.SGroup.GroupDat={showValue:function(e,t,r,o){var n=e.text(t.x,t.y,r.data.fieldValue).attr({font:o.font,"font-size":o.fontsz}),i=n.getBBox(),a=e.rect(i.x-1,i.y-1,i.width+2,i.height+2,3,3).attr({fill:"#fff",stroke:"#fff"}),s=e.set();return s.push(a,n.toFront()),s},draw:function(e){var t,r=e.render,o=r.settings,n=r.paper,i=n.set(),a=chem.SGroup.getAtoms(e,this);chem.SGroup.bracketPos(this,r,e.molecule),this.areas=this.bracketBox?[this.bracketBox]:[],null==this.pp&&chem.SGroup.setPos(e,this,this.bracketBox.p1.add(new Vec2(.5,.5)));var s=this.pp.scaled(o.scaleFactor);if(this.data.attached)for(t=0;t<a.length;++t){var l=e.atoms.get(a[t]),d=r.ps(l.a.pp),c=l.visel.boundingBox;null!=c&&(d.x=Math.max(d.x,c.p1.x)),d.x+=o.lineWidth;var u=this.showValue(n,d,this,o),h=rnd.relBox(u.getBBox());u.translateAbs(.5*h.width,-.3*h.height),i.push(u);var p=Box2Abs.fromRelBox(rnd.relBox(u.getBBox()));p=p.transform(r.scaled2obj,r),this.areas.push(p)}else{var f=this.showValue(n,s,this,o),m=rnd.relBox(f.getBBox());f.translateAbs(.5*m.width,-.5*m.height),i.push(f);var g=Box2Abs.fromRelBox(rnd.relBox(f.getBBox()));this.dataArea=g.transform(r.scaled2obj,r),e.sgroupData.has(this.id)||e.sgroupData.set(this.id,new rnd.ReDataSGroupData(this))}return i},saveToMolfile:function(e,t,r){var o=util.stringPadded(t[this.id],3),n=this.data,i=this.pp;n.absolute||(i=i.sub(chem.SGroup.getMassCentre(e,this.atoms)));var a=[];a=a.concat(chem.SGroup.makeAtomBondLines("SAL",o,this.atoms,r));var s="M  SDT "+o+" "+util.stringPadded(n.fieldName,30,!0)+util.stringPadded(n.fieldType,2)+util.stringPadded(n.units,20,!0)+util.stringPadded(n.query,2)+util.stringPadded(n.queryOp,3);a.push(s);var l="M  SDD "+o+" "+util.paddedFloat(i.x,10,4)+util.paddedFloat(-i.y,10,4)+"    "+(n.attached?"A":"D")+(n.absolute?"A":"R")+(n.showUnits?"U":" ")+"   "+(n.nCharnCharsToDisplay>=0?util.paddedInt(n.nCharnCharsToDisplay,3):"ALL")+"  1   "+util.stringPadded(n.tagChar,1)+"  "+util.paddedInt(n.daspPos,1)+"  ";a.push(l);var d=util.normalizeNewlines(n.fieldValue).replace(/\n*$/,""),c=69;return d.split("\n").each(function(e){for(;e.length>c;)a.push("M  SCD "+o+" "+e.slice(0,c)),e=e.slice(c);a.push("M  SED "+o+" "+e)}),a.join("\n")},prepareForSaving:function(e){this.atoms=chem.SGroup.getAtoms(e,this)},postLoad:function(e){this.data.absolute||(this.pp=this.pp.add(chem.SGroup.getMassCentre(e,this.atoms)))}},chem.SGroup.TYPES={MUL:chem.SGroup.GroupMul,SRU:chem.SGroup.GroupSru,SUP:chem.SGroup.GroupSup,DAT:chem.SGroup.GroupDat,GEN:chem.SGroup.GroupGen},chem.SGroupForest=function(e){this.parent=new Map,this.children=new Map,this.children.set(-1,[]),this.molecule=e},chem.SGroupForest.prototype.getSGroupsBFS=function(){var e=[],t=[],r=-1;for(t=util.array(this.children.get(-1));t.length>0;){var r=t.shift();t=t.concat(this.children.get(r)),e.push(r)}return e},chem.SGroupForest.prototype.getAtomSets=function(){return this.molecule.sgroups.map(function(e,t){return Set.fromList(t.atoms)})},chem.SGroupForest.prototype.getAtomSetRelations=function(e,t,r){var o=new Map,n=new Map,r=this.getAtomSets();r.unset(e),r.each(function(e,r){n.set(e,Set.subset(t,r)),o.set(e,Set.subset(r,t)&&!Set.eq(r,t))},this);var i=r.findAll(function(e){return n.get(e)?util.findIndex(this.children.get(e),function(e){return n.get(e)},this)>=0?!1:!0:!1},this);util.assert(i.length<=1);var a=r.findAll(function(e){return o.get(e)&&!o.get(this.parent.get(e))},this);return{children:a,parent:0===i.length?-1:i[0]}},chem.SGroupForest.prototype.getPathToRoot=function(e){for(var t=[],r=e;r>=0;r=this.parent.get(r))util.assert(t.indexOf(r)<0,"SGroupForest: loop detected"),t.push(r);return t},chem.SGroupForest.prototype.validate=function(){var e=this.getAtomSets();this.molecule.sgroups.each(function(e){this.getPathToRoot(e)},this);var t=!0;return this.parent.each(function(r,o){o>=0&&!Set.subset(e.get(r),e.get(o))&&(t=!1)},this),this.children.each(function(r){for(var o=this.children.get(r),n=0;n<o.length;++n)for(var i=n+1;i<o.length;++i)Set.disjoint(e.get(o[n]),e.get(o[i]))||(t=!1)},this),t},chem.SGroupForest.prototype.insert=function(e,t,r){util.assert(!this.parent.has(e),"sgid already present in the forest"),util.assert(!this.children.has(e),"sgid already present in the forest"),util.assert(this.validate(),"s-group forest invalid");var o=this.getAtomSets(),n=Set.fromList(this.molecule.sgroups.get(e).atoms);if(util.isUndefined(t)||util.isUndefined(r)){var i=this.getAtomSetRelations(e,n,o);t=i.parent,r=i.children}return util.each(r,function(t){util.assert(1===util.arrayRemoveByValue(this.children.get(this.parent.get(t)),t)),this.parent.set(t,e)},this),this.children.set(e,r),this.parent.set(e,t),this.children.get(t).push(e),util.assert(this.validate(),"s-group forest invalid"),{parent:t,children:r}},chem.SGroupForest.prototype.remove=function(e){util.assert(this.parent.has(e),"sgid is not in the forest"),util.assert(this.children.has(e),"sgid is not in the forest"),util.assert(this.validate(),"s-group forest invalid");var t=this.parent.get(e);util.each(this.children.get(e),function(e){this.parent.set(e,t),this.children.get(t).push(e)},this),util.assert(1===util.arrayRemoveByValue(this.children.get(t),e)),this.children.unset(e),this.parent.unset(e),util.assert(this.validate(),"s-group forest invalid")};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../rnd/restruct_rendering":24,"../util":39,"../util/box2abs":38,"../util/map":40,"../util/set":42,"../util/vec2":43,"./element":10}],14:[function(require,module,exports){
(function (global){
var Set=require("../util/set");require("./struct");var util=require("../util"),chem=global.chem=global.chem||{};chem.SmilesSaver=function(){this.smiles="",this._written_atoms=[],this._written_components=0,this.ignore_errors=!1},chem.SmilesSaver._Atom=function(e){this.neighbours=[],this.aromatic=!1,this.lowercase=!1,this.chirality=0,this.branch_cnt=0,this.paren_written=!1,this.h_count=e,this.parent=-1},chem.SmilesSaver.prototype.isBondInRing=function(e){if(util.isUndefined(this.inLoop)||util.isNull(this.inLoop))throw new Error("Init this.inLoop prior to calling this method");return this.inLoop[e]},chem.SmilesSaver.prototype.saveMolecule=function(e,t){var r,o,n;Object.isUndefined(t)||(this.ignore_errors=t),e=e.clone(),e.initHalfBonds(),e.initNeighbors(),e.sortNeighbors(),e.setImplicitHydrogen(),e.sgroups.each(function(t,r){if("MUL"==r.type)try{r.prepareForSaving(e)}catch(o){throw{message:"Bad s-group ("+o.message+")"}}else if(!this.ignore_errors)throw new Error("SMILES data format doesn't support s-groups")},this),this.atoms=new Array(e.atoms.count()),e.atoms.each(function(e,t){this.atoms[e]=new chem.SmilesSaver._Atom(t.implicitH)},this);var i=["B","C","N","O","P","S","Se","As"];e.bonds.each(function(t,r){r.type==chem.Struct.BOND.TYPE.AROMATIC&&(this.atoms[r.begin].aromatic=!0,-1!=i.indexOf(e.atoms.get(r.begin).label)&&(this.atoms[r.begin].lowercase=!0),this.atoms[r.end].aromatic=!0,-1!=i.indexOf(e.atoms.get(r.end).label)&&(this.atoms[r.end].lowercase=!0)),this.atoms[r.begin].neighbours.push({aid:r.end,bid:t}),this.atoms[r.end].neighbours.push({aid:r.begin,bid:t})},this),this.inLoop=function(){e.prepareLoopStructure();var t=Set.empty();e.loops.each(function(r,o){o.hbs.length<=6&&Set.mergeIn(t,Set.fromList(util.map(o.hbs,function(t){return e.halfBonds.get(t).bid},this)))},this);var r={};return Set.each(t,function(e){r[e]=1},this),r}(),this._touched_cistransbonds=0,this._markCisTrans(e);var a=chem.MolfileSaver.getComponents(e),s=a.reactants.concat(a.products),l=new chem.Dfs(e,this.atoms,s,a.reactants.length);for(l.walk(),this.atoms.each(function(e){e.neighbours.clear()},this),r=0;r<l.v_seq.length;r++){var d=l.v_seq[r],c=d.idx,u=d.parent_edge,h=d.parent_vertex;if(u>=0){var p=this.atoms[c],m=l.numOpeningCycles(u);for(o=0;m>o;o++)this.atoms[h].neighbours.push({aid:-1,bid:-1});if(l.edgeClosingCycle(u)){for(n=0;n<p.neighbours.length;n++)if(-1==p.neighbours[n].aid){p.neighbours[n].aid=h,p.neighbours[n].bid=u;break}if(n==p.neighbours.length)throw new Error("internal: can not put closing bond to its place")}else p.neighbours.push({aid:h,bid:u}),p.parent=h;this.atoms[h].neighbours.push({aid:c,bid:u})}}try{var f=new chem.Stereocenters(e,function(e){return this.atoms[e].neighbours},this);f.buildFromBonds(this.ignore_errors),f.each(function(e,t){var r=-1;-1==t.pyramid[3]&&(r=3);var i=new Array(4),a=0,s=this.atoms[e];if(-1!=s.parent)for(n=0;4>n;n++)if(t.pyramid[n]==s.parent){i[a++]=n;break}for(-1!=r&&(i[a++]=r),o=0;o!=s.neighbours.length;o++)if(s.neighbours[o].aid!=s.parent)for(n=0;4>n;n++)if(s.neighbours[o].aid==t.pyramid[n]){if(a>=4)throw new Error("internal: pyramid overflow");i[a++]=n;break}if(4==a)a=i[0],i[0]=i[1],i[1]=i[2],i[2]=i[3],i[3]=a;else if(3!=a)throw new Error("cannot calculate chirality");this.atoms[e].chirality=chem.Stereocenters.isPyramidMappingRigid(i)?1:2},this)}catch(g){alert("Warning: "+g.message)}var b=[];b.push(0);var v=!0;for(r=0;r<l.v_seq.length;r++){d=l.v_seq[r],c=d.idx,u=d.parent_edge,h=d.parent_vertex;var S=!0;if(h>=0){for(l.numBranches(h)>1&&this.atoms[h].branch_cnt>0&&this.atoms[h].paren_written&&(this.smiles+=")"),m=l.numOpeningCycles(u),o=0;m>o;o++){for(n=1;n<b.length&&-1!=b[n];n++);n==b.length?b.push(h):b[n]=h,this._writeCycleNumber(n)}if(h>=0){var y=l.numBranches(h);if(y>1&&this.atoms[h].branch_cnt<y-1&&(l.edgeClosingCycle(u)?this.atoms[h].paren_written=!1:(this.smiles+="(",this.atoms[h].paren_written=!0)),this.atoms[h].branch_cnt++,this.atoms[h].branch_cnt>y)throw new Error("unexpected branch")}var x=e.bonds.get(u),w=!0,A=0;if(x.type==chem.Struct.BOND.TYPE.SINGLE&&(A=this._calcBondDirection(e,u,h)),1==A&&c==x.end||2==A&&c==x.begin?this.smiles+="/":2==A&&c==x.end||1==A&&c==x.begin?this.smiles+="\\":x.type==chem.Struct.BOND.TYPE.ANY?this.smiles+="~":x.type==chem.Struct.BOND.TYPE.DOUBLE?this.smiles+="=":x.type==chem.Struct.BOND.TYPE.TRIPLE?this.smiles+="#":x.type!=chem.Struct.BOND.TYPE.AROMATIC||this.atoms[x.begin].lowercase&&this.atoms[x.end].lowercase&&this.isBondInRing(u)?x.type==chem.Struct.BOND.TYPE.SINGLE&&this.atoms[x.begin].aromatic&&this.atoms[x.end].aromatic?this.smiles+="-":w=!1:this.smiles+=":",l.edgeClosingCycle(u)){for(o=1;o<b.length&&b[o]!=c;o++);if(o==b.length)throw new Error("cycle number not found");this._writeCycleNumber(o),b[o]=-1,S=!1}}else v||(this.smiles+=this._written_components==l.nComponentsInReactants?">>":"."),v=!1,this._written_components++;S&&(this._writeAtom(e,c,this.atoms[c].aromatic,this.atoms[c].lowercase,this.atoms[c].chirality),this._written_atoms.push(d.idx))}return this.comma=!1,this._writeRadicals(e),this.comma&&(this.smiles+="|"),this.smiles},chem.SmilesSaver.prototype._writeCycleNumber=function(e){if(e>0&&10>e)this.smiles+=e;else if(e>=10&&100>e)this.smiles+="%"+e;else{if(!(e>=100&&1e3>e))throw new Error("bad cycle number: "+e);this.smiles+="%%"+e}},chem.SmilesSaver.prototype._writeAtom=function(e,t,r,o,n){var i=e.atoms.get(t),a=!1,s=-1,l=0;if("A"==i.label)return this.smiles+="*",void 0;if("R"==i.label||"R#"==i.label)return this.smiles+="[*]",void 0;l=i.aam,"C"!=i.label&&"P"!=i.label&&"N"!=i.label&&"S"!=i.label&&"O"!=i.label&&"Cl"!=i.label&&"F"!=i.label&&"Br"!=i.label&&"B"!=i.label&&"I"!=i.label&&(a=!0),(i.explicitValence>=0||0!=i.radical||n>0||r&&"C"!=i.label&&"O"!=i.label||r&&"C"==i.label&&this.atoms[t].neighbours.length<3&&0==this.atoms[t].h_count)&&(s=this.atoms[t].h_count);var d=i.label;if(i.atomList&&!i.atomList.notList?(d=i.atomList.label(),a=!1):i.isPseudo()||i.atomList&&i.atomList.notList?(d="*",a=!0):(n||0!=i.charge||i.isotope>0||s>=0||l>0)&&(a=!0),a&&(-1==s&&(s=this.atoms[t].h_count),this.smiles+="["),i.isotope>0&&(this.smiles+=i.isotope),this.smiles+=o?d.toLowerCase():d,n>0&&(this.smiles+=1==n?"@":"@@",i.implicitH>1))throw new Error(i.implicitH+" implicit H near stereocenter");"H"!=i.label&&(s>1||0==s&&!a?this.smiles+="H"+s:1==s&&(this.smiles+="H")),i.charge>1?this.smiles+="+"+i.charge:i.charge<-1?this.smiles+=i.charge:1==i.charge?this.smiles+="+":-1==i.charge&&(this.smiles+="-"),l>0&&(this.smiles+=":"+l),a&&(this.smiles+="]")},chem.SmilesSaver.prototype._markCisTrans=function(e){this.cis_trans=new chem.CisTrans(e,function(e){return this.atoms[e].neighbours},this),this.cis_trans.build(),this._dbonds=new Array(e.bonds.count()),e.bonds.each(function(e){this._dbonds[e]={ctbond_beg:-1,ctbond_end:-1,saved:0}},this),this.cis_trans.each(function(t,r){var o=e.bonds.get(t);if(0!=r.parity&&!this.isBondInRing(t)){var n=this.atoms[o.begin].neighbours,i=this.atoms[o.end].neighbours,a=!0,s=!0;if(n.each(function(r){r.bid!=t&&e.bonds.get(r.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(a=!1)},this),i.each(function(r){r.bid!=t&&e.bonds.get(r.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(s=!1)},this),a||s)return;n.each(function(r){r.bid!=t&&(e.bonds.get(r.bid).begin==o.begin?this._dbonds[r.bid].ctbond_beg=t:this._dbonds[r.bid].ctbond_end=t)},this),i.each(function(r){r.bid!=t&&(e.bonds.get(r.bid).begin==o.end?this._dbonds[r.bid].ctbond_beg=t:this._dbonds[r.bid].ctbond_end=t)},this)}},this)},chem.SmilesSaver.prototype._updateSideBonds=function(e,t){var r=e.bonds.get(t),o=this.cis_trans.getSubstituents(t),n=this.cis_trans.getParity(t),i=[-1,-1,-1,-1];i[0]=e.findBondId(o[0],r.begin),-1!=o[1]&&(i[1]=e.findBondId(o[1],r.begin)),i[2]=e.findBondId(o[2],r.end),-1!=o[3]&&(i[3]=e.findBondId(o[3],r.end));var a=0,s=0,l=0,d=0;if(0!=this._dbonds[i[0]].saved&&(1==this._dbonds[i[0]].saved&&e.bonds.get(i[0]).begin==r.begin||2==this._dbonds[i[0]].saved&&e.bonds.get(i[0]).end==r.begin?a++:s++),-1!=i[1]&&0!=this._dbonds[i[1]].saved&&(2==this._dbonds[i[1]].saved&&e.bonds.get(i[1]).begin==r.begin||1==this._dbonds[i[1]].saved&&e.bonds.get(i[1]).end==r.begin?a++:s++),0!=this._dbonds[i[2]].saved&&(1==this._dbonds[i[2]].saved&&e.bonds.get(i[2]).begin==r.end||2==this._dbonds[i[2]].saved&&e.bonds.get(i[2]).end==r.end?l++:d++),-1!=i[3]&&0!=this._dbonds[i[3]].saved&&(2==this._dbonds[i[3]].saved&&e.bonds.get(i[3]).begin==r.end||1==this._dbonds[i[3]].saved&&e.bonds.get(i[3]).end==r.end?l++:d++),n==chem.CisTrans.PARITY.CIS?(a+=l,s+=d):(a+=d,s+=l),a>0&&s>0)throw new Error("incompatible cis-trans configuration");return 0==a&&0==s?!1:(a>0&&(this._dbonds[i[0]].saved=e.bonds.get(i[0]).begin==r.begin?1:2,-1!=i[1]&&(this._dbonds[i[1]].saved=e.bonds.get(i[1]).begin==r.begin?2:1),this._dbonds[i[2]].saved=e.bonds.get(i[2]).begin==r.end==(n==chem.CisTrans.PARITY.CIS)?1:2,-1!=i[3]&&(this._dbonds[i[3]].saved=e.bonds.get(i[3]).begin==r.end==(n==chem.CisTrans.PARITY.CIS)?2:1)),s>0&&(this._dbonds[i[0]].saved=e.bonds.get(i[0]).begin==r.begin?2:1,-1!=i[1]&&(this._dbonds[i[1]].saved=e.bonds.get(i[1]).begin==r.begin?1:2),this._dbonds[i[2]].saved=e.bonds.get(i[2]).begin==r.end==(n==chem.CisTrans.PARITY.CIS)?2:1,-1!=i[3]&&(this._dbonds[i[3]].saved=e.bonds.get(i[3]).begin==r.end==(n==chem.CisTrans.PARITY.CIS)?1:2)),!0)},chem.SmilesSaver.prototype._calcBondDirection=function(e,t,r){var o;if(-1==this._dbonds[t].ctbond_beg&&-1==this._dbonds[t].ctbond_end)return 0;if(e.bonds.get(t).type!=chem.Struct.BOND.TYPE.SINGLE)throw new Error("internal: directed bond type "+e.bonds.get(t).type);for(;;){if(o=0,this.cis_trans.each(function(t,r){0==r.parity||this.isBondInRing(t)||this._updateSideBonds(e,t)&&o++},this),o==this._touched_cistransbonds)break;this._touched_cistransbonds=o}return 0==this._dbonds[t].saved&&(this._dbonds[t].saved=r==e.bonds.get(t).begin?1:2),this._dbonds[t].saved},chem.SmilesSaver.prototype._writeRadicals=function(e){var t,r,o=new Array(this._written_atoms.length);for(t=0;t<this._written_atoms.size();t++)if(!o[t]){var n=e.atoms.get(this._written_atoms[t]).radical;if(0!=n)for(this.comma?this.smiles+=",":(this.smiles+=" |",this.comma=!0),this.smiles+=n==chem.Struct.ATOM.RADICAL.SINGLET?"^3:":n==chem.Struct.ATOM.RADICAL.DOUPLET?"^1:":"^4:",this.smiles+=t,r=t+1;r<this._written_atoms.length;r++)e.atoms.get(this._written_atoms[r]).radical==n&&(o[r]=!0,this.smiles+=","+r)}};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/set":42,"./struct":16}],15:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util");require("./struct");var chem=global.chem=global.chem||{};chem.Stereocenters=function(e,t,r){this.molecule=e,this.atoms=new Map,this.getNeighbors=t,this.context=r},chem.Stereocenters.prototype.each=function(e,t){this.atoms.each(e,t)},chem.Stereocenters.prototype.buildFromBonds=function(e){var t=this.molecule.atoms,r=this.molecule.bonds,n=Set.empty();t.each(function(e){var o=this.getNeighbors.call(this.context,e);if(2!=o.length)return!1;var i=o[0],a=o[1];if(util.findIndex([e,i.aid,a.aid],function(e){return["C","Si"].indexOf(t.get(e).label)<0},this)>=0)return!1;if(util.findIndex([i.bid,a.bid],function(e){return r.get(e).type!=chem.Struct.BOND.TYPE.DOUBLE},this)>=0)return!1;var s=util.findAll(this.getNeighbors.call(this.context,i.aid),function(t){return t.aid!=e},this),l=util.findAll(this.getNeighbors.call(this.context,a.aid),function(t){return t.aid!=e},this);return s.length<1||s.length>2||l.length<1||l.length>2?!1:util.findIndex(s.concat(l),function(e){return r.get(e.bid).type!=chem.Struct.BOND.TYPE.SINGLE},this)>=0?!1:util.findIndex(s.concat(l),function(e){return r.get(e.bid).stereo==chem.Struct.BOND.STEREO.EITHER},this)>=0?!1:(Set.add(n,i.aid),Set.add(n,a.aid),void 0)},this),Set.size(n)>0&&alert("This structure may contain allenes, which cannot be represented in the SMILES notation. Relevant stereo-information will be discarded."),t.each(function(t){if(!Set.contains(n,t)){var r=this.getNeighbors.call(this.context,t),o=!1;r.find(function(e){var r=this.molecule.bonds.get(e.bid);return r.type!=chem.Struct.BOND.TYPE.SINGLE||r.begin!=t||r.stereo!=chem.Struct.BOND.STEREO.UP&&r.stereo!=chem.Struct.BOND.STEREO.DOWN?!1:(o=!0,!0)},this),o&&(e?this._buildOneCenter(t):this._buildOneCenter(t))}},this)},chem.Stereocenters.allowed_stereocenters=[{elem:"C",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"C",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:4,n_double_bonds:2,implicit_degree:4},{elem:"S",charge:1,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:3,n_double_bonds:1,implicit_degree:3},{elem:"P",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"P",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"P",charge:0,degree:4,n_double_bonds:1,implicit_degree:4}],chem.Stereocenters.prototype._buildOneCenter=function(e){var t=this.molecule.atoms.get(e),r=this.getNeighbors.call(this.context,e),n=r.length,o=-1,i={group:0,type:0,pyramid:new Array(4)},a=0,s=new Array(4),l=0,d=0;i.pyramid[0]=-1,i.pyramid[1]=-1,i.pyramid[2]=-1,i.pyramid[3]=-1;var c=0;if(n>4)throw new Error("stereocenter with %d bonds are not supported"+n);if(r.each(function(e){var r=this.molecule.atoms.get(e.aid),n=this.molecule.bonds.get(e.bid);if(s[a]={edge_idx:e.bid,nei_idx:e.aid,rank:e.aid,vec:Vec2.diff(r.pp,t.pp).yComplement()},r.pureHydrogen()?(c++,s[a].rank=1e4):"H"==r.label&&(s[a].rank=5e3),!s[a].vec.normalize())throw new Error("zero bond length");if(n.type==chem.Struct.BOND.TYPE.TRIPLE)throw new Error("non-single bonds not allowed near stereocenter");if(n.type==chem.Struct.BOND.TYPE.AROMATIC)throw new Error("aromatic bonds not allowed near stereocenter");n.type==chem.Struct.BOND.TYPE.DOUBLE&&d++,a++},this),chem.Stereocenters.allowed_stereocenters.find(function(e){return e.elem==t.label&&e.charge==t.charge&&e.degree==n&&e.n_double_bonds==d?(o=e.implicit_degree,!0):!1},this),-1==o)throw new Error("unknown stereocenter configuration: "+t.label+", charge "+t.charge+", "+n+" bonds ("+d+" double)");if(4==n&&c>1)throw new Error(c+" hydrogens near stereocenter");if(3==n&&4==o&&c>0)throw new Error("have hydrogen(s) besides implicit hydrogen near stereocenter");if(4==n){s[0].rank>s[1].rank&&s.swap(0,1),s[1].rank>s[2].rank&&s.swap(1,2),s[2].rank>s[3].rank&&s.swap(2,3),s[1].rank>s[2].rank&&s.swap(1,2),s[0].rank>s[1].rank&&s.swap(0,1),s[1].rank>s[2].rank&&s.swap(1,2);var u=-1,h=-1,p=-1,m=-1,f=0;for(a=0;4>a;a++){var g=this._getBondStereo(e,s[a].edge_idx);if(g==chem.Struct.BOND.STEREO.UP||g==chem.Struct.BOND.STEREO.DOWN){u=a,f=g;break}}if(-1==u)throw new Error("none of 4 bonds going from stereocenter is stereobond");var b,v;if(-1==h&&(b=chem.Stereocenters._xyzzy(s[u].vec,s[(u+1)%4].vec,s[(u+2)%4].vec),v=chem.Stereocenters._xyzzy(s[u].vec,s[(u+1)%4].vec,s[(u+3)%4].vec),(3==b+v||12==b+v)&&(h=(u+1)%4,p=(u+2)%4,m=(u+3)%4)),-1==h&&(b=chem.Stereocenters._xyzzy(s[u].vec,s[(u+2)%4].vec,s[(u+1)%4].vec),v=chem.Stereocenters._xyzzy(s[u].vec,s[(u+2)%4].vec,s[(u+3)%4].vec),(3==b+v||12==b+v)&&(h=(u+2)%4,p=(u+1)%4,m=(u+3)%4)),-1==h&&(b=chem.Stereocenters._xyzzy(s[u].vec,s[(u+3)%4].vec,s[(u+1)%4].vec),v=chem.Stereocenters._xyzzy(s[u].vec,s[(u+3)%4].vec,s[(u+2)%4].vec),(3==b+v||12==b+v)&&(h=(u+3)%4,p=(u+2)%4,m=(u+1)%4)),-1==h)throw new Error("internal error: can not find opposite bond");if(f==chem.Struct.BOND.STEREO.UP&&this._getBondStereo(e,s[h].edge_idx)==chem.Struct.BOND.STEREO.DOWN)throw new Error("stereo types of the opposite bonds mismatch");if(f==chem.Struct.BOND.STEREO.DOWN&&this._getBondStereo(e,s[h].edge_idx)==chem.Struct.BOND.STEREO.UP)throw new Error("stereo types of the opposite bonds mismatch");if(f==this._getBondStereo(e,s[p].edge_idx))throw new Error("stereo types of non-opposite bonds match");if(f==this._getBondStereo(e,s[m].edge_idx))throw new Error("stereo types of non-opposite bonds match");l=3==u||3==h?f:f==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP,C=chem.Stereocenters._sign(s[0].vec,s[1].vec,s[2].vec),l==chem.Struct.BOND.STEREO.UP&&C>0||l==chem.Struct.BOND.STEREO.DOWN&&0>C?(i.pyramid[0]=s[0].nei_idx,i.pyramid[1]=s[1].nei_idx,i.pyramid[2]=s[2].nei_idx):(i.pyramid[0]=s[0].nei_idx,i.pyramid[1]=s[2].nei_idx,i.pyramid[2]=s[1].nei_idx),i.pyramid[3]=s[3].nei_idx}else if(3==n){s[0].rank>s[1].rank&&s.swap(0,1),s[1].rank>s[2].rank&&s.swap(1,2),s[0].rank>s[1].rank&&s.swap(0,1);var S=this._getBondStereo(e,s[0].edge_idx),y=this._getBondStereo(e,s[1].edge_idx),x=this._getBondStereo(e,s[2].edge_idx),w=0,A=0;if(w+=S==chem.Struct.BOND.STEREO.UP?1:0,w+=y==chem.Struct.BOND.STEREO.UP?1:0,w+=x==chem.Struct.BOND.STEREO.UP?1:0,A+=S==chem.Struct.BOND.STEREO.DOWN?1:0,A+=y==chem.Struct.BOND.STEREO.DOWN?1:0,A+=x==chem.Struct.BOND.STEREO.DOWN?1:0,4==o){if(3==w)throw new Error("all 3 bonds up near stereoatom");if(3==A)throw new Error("all 3 bonds down near stereoatom");if(0==w&&0==A)throw new Error("no up/down bonds near stereoatom -- indefinite case");if(1==w&&1==A)throw new Error("one bond up, one bond down -- indefinite case");if(f=0,2==w)l=chem.Struct.BOND.STEREO.DOWN;else if(2==A)l=chem.Struct.BOND.STEREO.UP;else{for(u=-1,p=-1,m=-1,a=0;3>a;a++)if(B=this._getBondStereo(e,s[a].edge_idx),B==chem.Struct.BOND.STEREO.UP||B==chem.Struct.BOND.STEREO.DOWN){u=a,f=B,p=(a+1)%3,m=(a+2)%3;break}if(-1==u)throw new Error("internal error: can not find up or down bond");var R=chem.Stereocenters._xyzzy(s[p].vec,s[m].vec,s[u].vec);if(3==R||4==R)throw new Error("degenerate case for 3 bonds near stereoatom");l=1==R?f:f==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP}var C=chem.Stereocenters._sign(s[0].vec,s[1].vec,s[2].vec);l==chem.Struct.BOND.STEREO.UP&&C>0||l==chem.Struct.BOND.STEREO.DOWN&&0>C?(i.pyramid[0]=s[0].nei_idx,i.pyramid[1]=s[1].nei_idx,i.pyramid[2]=s[2].nei_idx):(i.pyramid[0]=s[0].nei_idx,i.pyramid[1]=s[2].nei_idx,i.pyramid[2]=s[1].nei_idx),i.pyramid[3]=-1}else{var B;if(A>0&&w>0)throw new Error("one bond up, one bond down -- indefinite case");if(0==A&&0==w)throw new Error("no up-down bonds attached to stereocenter");B=w>0?1:-1,(1==chem.Stereocenters._xyzzy(s[0].vec,s[1].vec,s[2].vec)||1==chem.Stereocenters._xyzzy(s[0].vec,s[2].vec,s[1].vec)||1==chem.Stereocenters._xyzzy(s[2].vec,s[1].vec,s[0].vec))&&(B=-B),C=chem.Stereocenters._sign(s[0].vec,s[1].vec,s[2].vec),C==B?(i.pyramid[0]=s[0].nei_idx,i.pyramid[1]=s[2].nei_idx,i.pyramid[2]=s[1].nei_idx):(i.pyramid[0]=s[0].nei_idx,i.pyramid[1]=s[1].nei_idx,i.pyramid[2]=s[2].nei_idx),i.pyramid[3]=-1}}this.atoms.set(e,i)},chem.Stereocenters.prototype._getBondStereo=function(e,t){var r=this.molecule.bonds.get(t);return e!=r.begin?0:r.stereo},chem.Stereocenters._xyzzy=function(e,t,r){var n=.001,o=Vec2.cross(e,t),i=Vec2.dot(e,t),a=Vec2.cross(e,r),s=Vec2.dot(e,r);if(Math.abs(o)<n){if(Math.abs(a)<n)throw new Error("degenerate case -- bonds overlap");return a>0?4:8}return-n*n>o*a?2:i>s?2:1},chem.Stereocenters._sign=function(e,t,r){var n=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x),o=.001;if(n>o)return 1;if(-o>n)return-1;throw new Error("degenerate triangle")},chem.Stereocenters.isPyramidMappingRigid=function(e){var t=e.clone(),r=!0;return t[0]>t[1]&&(t.swap(0,1),r=!r),t[1]>t[2]&&(t.swap(1,2),r=!r),t[2]>t[3]&&(t.swap(2,3),r=!r),t[1]>t[2]&&(t.swap(1,2),r=!r),t[0]>t[1]&&(t.swap(0,1),r=!r),t[1]>t[2]&&(t.swap(1,2),r=!r),r};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/map":40,"../util/set":42,"../util/vec2":43,"./struct":16}],16:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Pool=require("../util/pool"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),element=require("./element"),chem=global.chem=global.chem||{};chem.Struct=function(){this.atoms=new Pool,this.bonds=new Pool,this.sgroups=new Pool,this.halfBonds=new Map,this.loops=new Pool,this.isChiral=!1,this.isReaction=!1,this.rxnArrows=new Pool,this.rxnPluses=new Pool,this.frags=new Pool,this.rgroups=new Map,this.name="",this.sGroupForest=new chem.SGroupForest(this)},chem.Struct.prototype.hasRxnProps=function(){return this.atoms.find(function(e,t){return t.hasRxnProps()},this)>=0||this.bonds.find(function(e,t){return t.hasRxnProps()},this)>=0},chem.Struct.prototype.hasRxnArrow=function(){return this.rxnArrows.count()>0},chem.Struct.prototype.addRxnArrowIfNecessary=function(){var e=!this.hasRxnArrow()&&this.hasRxnProps();return e&&this.rxnArrows.add(new chem.Struct.RxnArrow),e},chem.Struct.prototype.getSGroupsInAtomSet=function(e){var t=new Hash;util.each(e,function(e){var r=Set.list(this.atoms.get(e).sgs);r.each(function(e){var r=t.get(e);Object.isUndefined(r)?r=1:r++,t.set(e,r)},this)},this);var r=[];return t.each(function(e){var t=parseInt(e.key,10),n=this.sgroups.get(t),o=chem.SGroup.getAtoms(this,n);e.value==o.length&&r.push(t)},this),r},chem.Struct.prototype.isBlank=function(){return 0===this.atoms.count()&&0===this.rxnArrows.count()&&0===this.rxnPluses.count()&&!this.isChiral},chem.Struct.prototype.toLists=function(){var e={},t=[];this.atoms.each(function(r,n){e[r]=t.length,t.push(n)});var r=[];return this.bonds.each(function(t,n){var o=new chem.Struct.Bond(n);o.begin=e[n.begin],o.end=e[n.end],r.push(o)}),{atoms:t,bonds:r}},chem.Struct.prototype.clone=function(e,t,r,n){var o=new chem.Struct;return this.mergeInto(o,e,t,r,!1,n)},chem.Struct.prototype.getScaffold=function(){var e=Set.empty();return this.atoms.each(function(t){Set.add(e,t)},this),this.rgroups.each(function(t,r){r.frags.each(function(t,r){this.atoms.each(function(t,n){n.fragment==r&&Set.remove(e,t)},this)},this)},this),this.clone(e)},chem.Struct.prototype.getFragmentIds=function(e){var t=Set.empty();return this.atoms.each(function(r,n){n.fragment==e&&Set.add(t,r)},this),t},chem.Struct.prototype.getFragment=function(e){return this.clone(this.getFragmentIds(e))},chem.Struct.prototype.mergeInto=function(e,t,r,n,o,i){t=t||Set.keySetInt(this.atoms),r=r||Set.keySetInt(this.bonds),r=Set.filter(r,function(e){var r=this.bonds.get(e);return Set.contains(t,r.begin)&&Set.contains(t,r.end)},this);var a={};this.atoms.each(function(e,r){Set.contains(t,e)&&(a[r.fragment]=1)});var s={};this.frags.each(function(t,r){a[t]&&(s[t]=e.frags.add(r.clone()))}),this.rgroups.each(function(t,r){var n=o;if(n||(r.frags.each(function(e,t){a[t]&&(n=!0)}),n)){var i=e.rgroups.get(t);i?r.frags.each(function(e,t){a[t]&&i.frags.add(s[t])}):e.rgroups.set(t,r.clone(s))}}),("undefined"==typeof i||null===i)&&(i={}),this.atoms.each(function(r,n){Set.contains(t,r)&&(i[r]=e.atoms.add(n.clone(s)))});var l={};return this.bonds.each(function(t,n){Set.contains(r,t)&&(l[t]=e.bonds.add(n.clone(i)))}),this.sgroups.each(function(r,n){var o;for(o=0;o<n.atoms.length;++o)if(!Set.contains(t,n.atoms[o]))return;n=chem.SGroup.clone(n,i,l);var a=e.sgroups.add(n);for(n.id=a,o=0;o<n.atoms.length;++o)Set.add(e.atoms.get(n.atoms[o]).sgs,a);e.sGroupForest.insert(n.id)}),e.isChiral=this.isChiral,n||(e.isReaction=this.isReaction,this.rxnArrows.each(function(t,r){e.rxnArrows.add(r.clone())}),this.rxnPluses.each(function(t,r){e.rxnPluses.add(r.clone())})),e},chem.Struct.prototype.findBondId=function(e,t){var r=-1;return this.bonds.find(function(n,o){return o.begin==e&&o.end==t||o.begin==t&&o.end==e?(r=n,!0):!1},this),r},chem.Struct.ATOM={RADICAL:{NONE:0,SINGLET:1,DOUPLET:2,TRIPLET:3}},chem.Struct.radicalElectrons=function(e){if(e-=0,e==chem.Struct.ATOM.RADICAL.NONE)return 0;if(e==chem.Struct.ATOM.RADICAL.DOUPLET)return 1;if(e==chem.Struct.ATOM.RADICAL.SINGLET||e==chem.Struct.ATOM.RADICAL.TRIPLET)return 2;throw new Error("Unknown radical value")},chem.Struct.BOND={TYPE:{SINGLE:1,DOUBLE:2,TRIPLE:3,AROMATIC:4,SINGLE_OR_DOUBLE:5,SINGLE_OR_AROMATIC:6,DOUBLE_OR_AROMATIC:7,ANY:8},STEREO:{NONE:0,UP:1,EITHER:4,DOWN:6,CIS_TRANS:3},TOPOLOGY:{EITHER:0,RING:1,CHAIN:2},REACTING_CENTER:{NOT_CENTER:-1,UNMARKED:0,CENTER:1,UNCHANGED:2,MADE_OR_BROKEN:4,ORDER_CHANGED:8,MADE_OR_BROKEN_AND_CHANGED:12}},chem.Struct.FRAGMENT={NONE:0,REACTANT:1,PRODUCT:2,AGENT:3},chem.Struct.Atom=function(e){var t=chem.Struct.Atom.attrGetDefault;if(!(e&&"label"in e))throw new Error("label must be specified!");this.label=e.label,this.fragment=Object.isUndefined(e.fragment)?-1:e.fragment,util.ifDef(this,e,"isotope",t("isotope")),util.ifDef(this,e,"radical",t("radical")),util.ifDef(this,e,"charge",t("charge")),util.ifDef(this,e,"rglabel",t("rglabel")),util.ifDef(this,e,"attpnt",t("attpnt")),util.ifDef(this,e,"explicitValence",t("explicitValence")),this.valence=0,this.implicitH=0,this.pp=Object.isUndefined(e.pp)?new Vec2:new Vec2(e.pp),this.sgs={},util.ifDef(this,e,"ringBondCount",t("ringBondCount")),util.ifDef(this,e,"substitutionCount",t("substitutionCount")),util.ifDef(this,e,"unsaturatedAtom",t("unsaturatedAtom")),util.ifDef(this,e,"hCount",t("hCount")),util.ifDef(this,e,"aam",t("aam")),util.ifDef(this,e,"invRet",t("invRet")),util.ifDef(this,e,"exactChangeFlag",t("exactChangeFlag")),util.ifDef(this,e,"rxnFragmentType",-1),this.atomList=Object.isUndefined(e.atomList)||null==e.atomList?null:new chem.Struct.AtomList(e.atomList),this.neighbors=[],this.badConn=!1},chem.Struct.Atom.getAttrHash=function(e){var t=new Hash;for(var r in chem.Struct.Atom.attrlist)"undefined"!=typeof e[r]&&t.set(r,e[r]);return t},chem.Struct.Atom.attrGetDefault=function(e){if(e in chem.Struct.Atom.attrlist)return chem.Struct.Atom.attrlist[e];throw new Error("Attribute unknown")},chem.Struct.Atom.attrlist={label:"C",isotope:0,radical:0,charge:0,explicitValence:-1,ringBondCount:0,substitutionCount:0,unsaturatedAtom:0,hCount:0,atomList:null,invRet:0,exactChangeFlag:0,rglabel:null,attpnt:null,aam:0},chem.Struct.Atom.prototype.clone=function(e){var t=new chem.Struct.Atom(this);return e&&this.fragment in e&&(t.fragment=e[this.fragment]),t},chem.Struct.Atom.prototype.isQuery=function(){return null!=this.atomList||"A"==this.label||this.attpnt||this.hCount},chem.Struct.Atom.prototype.pureHydrogen=function(){return"H"==this.label&&0==this.isotope},chem.Struct.Atom.prototype.isPlainCarbon=function(){return"C"==this.label&&0==this.isotope&&0==this.radical&&0==this.charge&&this.explicitValence<0&&0==this.ringBondCount&&0==this.substitutionCount&&0==this.unsaturatedAtom&&0==this.hCount&&!this.atomList},chem.Struct.Atom.prototype.isPseudo=function(){return!this.atomList&&!this.rglabel&&!element.getElementByLabel(this.label)},chem.Struct.Atom.prototype.hasRxnProps=function(){return!(!this.invRet&&!this.exactChangeFlag&&util.isNull(this.attpnt)&&!this.aam)},chem.Struct.AtomList=function(e){if(!(e&&"notList"in e&&"ids"in e))throw new Error("'notList' and 'ids' must be specified!");this.notList=e.notList,this.ids=e.ids},chem.Struct.AtomList.prototype.labelList=function(){for(var e=[],t=0;t<this.ids.length;++t)e.push(element.get(this.ids[t]).label);return e},chem.Struct.AtomList.prototype.label=function(){var e="["+this.labelList().join(",")+"]";return this.notList&&(e="!"+e),e},chem.Struct.AtomList.prototype.equals=function(e){return this.notList==e.notList&&(this.ids||[]).sort().toString()==(e.ids||[]).sort().toString()},chem.Struct.Bond=function(e){if(!(e&&"begin"in e&&"end"in e&&"type"in e))throw new Error("'begin', 'end' and 'type' properties must be specified!");this.begin=e.begin,this.end=e.end,this.type=e.type,util.ifDef(this,e,"stereo",chem.Struct.BOND.STEREO.NONE),util.ifDef(this,e,"topology",chem.Struct.BOND.TOPOLOGY.EITHER),util.ifDef(this,e,"reactingCenterStatus",0),this.hb1=null,this.hb2=null,this.len=0,this.center=new Vec2,this.sb=0,this.sa=0,this.angle=0},chem.Struct.Bond.attrlist={type:chem.Struct.BOND.TYPE.SINGLE,stereo:chem.Struct.BOND.STEREO.NONE,topology:chem.Struct.BOND.TOPOLOGY.EITHER,reactingCenterStatus:0},chem.Struct.Bond.getAttrHash=function(e){var t=new Hash;for(var r in chem.Struct.Bond.attrlist)"undefined"!=typeof e[r]&&t.set(r,e[r]);return t},chem.Struct.Bond.attrGetDefault=function(e){if(e in chem.Struct.Bond.attrlist)return chem.Struct.Bond.attrlist[e];throw new Error("Attribute unknown")},chem.Struct.Bond.prototype.hasRxnProps=function(){return!!this.reactingCenterStatus},chem.Struct.Bond.prototype.getCenter=function(e){var t=e.atoms.get(this.begin).pp,r=e.atoms.get(this.end).pp;return Vec2.lc2(t,.5,r,.5)},chem.Struct.Bond.prototype.getDir=function(e){var t=e.atoms.get(this.begin).pp,r=e.atoms.get(this.end).pp;return r.sub(t).normalized()},chem.Struct.Bond.prototype.clone=function(e){var t=new chem.Struct.Bond(this);return e&&(t.begin=e[t.begin],t.end=e[t.end]),t},chem.Struct.Bond.prototype.findOtherEnd=function(e){if(e==this.begin)return this.end;if(e==this.end)return this.begin;throw new Error("bond end not found")},chem.HalfBond=function(e,t,r){if(3!=arguments.length)throw new Error("Invalid parameter number!");this.begin=e-0,this.end=t-0,this.bid=r-0,this.dir=new Vec2,this.norm=new Vec2,this.ang=0,this.p=new Vec2,this.loop=-1,this.contra=-1,this.next=-1,this.leftSin=0,this.leftCos=0,this.leftNeighbor=0,this.rightSin=0,this.rightCos=0,this.rightNeighbor=0},chem.Struct.prototype.initNeighbors=function(){this.atoms.each(function(e,t){t.neighbors=[]}),this.bonds.each(function(e,t){var r=this.atoms.get(t.begin),n=this.atoms.get(t.end);r.neighbors.push(t.hb1),n.neighbors.push(t.hb2)},this)},chem.Struct.prototype.bondInitHalfBonds=function(e,t){t=t||this.bonds.get(e),t.hb1=2*e,t.hb2=2*e+1,this.halfBonds.set(t.hb1,new chem.HalfBond(t.begin,t.end,e)),this.halfBonds.set(t.hb2,new chem.HalfBond(t.end,t.begin,e));var r=this.halfBonds.get(t.hb1),n=this.halfBonds.get(t.hb2);r.contra=t.hb2,n.contra=t.hb1},chem.Struct.prototype.halfBondUpdate=function(e){var t=this.halfBonds.get(e),r=this.atoms.get(t.begin).pp,n=this.atoms.get(t.end).pp,o=Vec2.diff(n,r).normalized();t.dir=Vec2.dist(n,r)>1e-4?o:new Vec2(1,0),t.norm=t.dir.turnLeft(),t.ang=t.dir.oxAngle(),t.loop<0&&(t.loop=-1)},chem.Struct.prototype.initHalfBonds=function(){this.halfBonds.clear(),this.bonds.each(this.bondInitHalfBonds,this)},chem.Struct.prototype.setHbNext=function(e,t){this.halfBonds.get(this.halfBonds.get(e).contra).next=t},chem.Struct.prototype.halfBondSetAngle=function(e,t){var r=this.halfBonds.get(e),n=this.halfBonds.get(t);n.rightCos=r.leftCos=Vec2.dot(n.dir,r.dir),n.rightSin=r.leftSin=Vec2.cross(n.dir,r.dir),r.leftNeighbor=t,n.rightNeighbor=e},chem.Struct.prototype.atomAddNeighbor=function(e){var t=this.halfBonds.get(e),r=this.atoms.get(t.begin),n=0;for(n=0;n<r.neighbors.length&&!(this.halfBonds.get(r.neighbors[n]).ang>t.ang);++n);r.neighbors.splice(n,0,e);var o=r.neighbors[(n+1)%r.neighbors.length],i=r.neighbors[(n+r.neighbors.length-1)%r.neighbors.length];this.setHbNext(i,e),this.setHbNext(e,o),this.halfBondSetAngle(e,i),this.halfBondSetAngle(o,e)},chem.Struct.prototype.atomSortNeighbors=function(e){var t=this.atoms.get(e);t.neighbors=t.neighbors.sortBy(function(e){return this.halfBonds.get(e).ang},this);var r;for(r=0;r<t.neighbors.length;++r)this.halfBonds.get(this.halfBonds.get(t.neighbors[r]).contra).next=t.neighbors[(r+1)%t.neighbors.length];for(r=0;r<t.neighbors.length;++r)this.halfBondSetAngle(t.neighbors[(r+1)%t.neighbors.length],t.neighbors[r])},chem.Struct.prototype.sortNeighbors=function(e){var t=function(e){this.atomSortNeighbors(e)};util.isNullOrUndefined(e)?this.atoms.each(t,this):util.each(e,t,this)},chem.Struct.prototype.atomUpdateHalfBonds=function(e){for(var t=this.atoms.get(e).neighbors,r=0;r<t.length;++r){var n=t[r];this.halfBondUpdate(n),this.halfBondUpdate(this.halfBonds.get(n).contra)}},chem.Struct.prototype.updateHalfBonds=function(e){var t=function(e){this.atomUpdateHalfBonds(e)};util.isNullOrUndefined(e)?this.atoms.each(t,this):util.each(e,t,this)},chem.Struct.prototype.sGroupsRecalcCrossBonds=function(){this.sgroups.each(function(e,t){t.xBonds=[],t.neiAtoms=[]},this),this.bonds.each(function(e,t){var r=this.atoms.get(t.begin),n=this.atoms.get(t.end);Set.each(r.sgs,function(r){if(!Set.contains(n.sgs,r)){var o=this.sgroups.get(r);o.xBonds.push(e),util.arrayAddIfMissing(o.neiAtoms,t.end)}},this),Set.each(n.sgs,function(n){if(!Set.contains(r.sgs,n)){var o=this.sgroups.get(n);o.xBonds.push(e),util.arrayAddIfMissing(o.neiAtoms,t.begin)}},this)},this)},chem.Struct.prototype.sGroupDelete=function(e){for(var t=this.sgroups.get(e),r=0;r<t.atoms.length;++r)Set.remove(this.atoms.get(t.atoms[r]).sgs,e);this.sGroupForest.remove(e),this.sgroups.remove(e)},chem.Struct.itemSetPos=function(e,t){e.pp=t},chem.Struct.prototype._itemSetPos=function(e,t,r,n){chem.Struct.itemSetPos(this[e].get(t),r,n)},chem.Struct.prototype._atomSetPos=function(e,t,r){this._itemSetPos("atoms",e,t,r)},chem.Struct.prototype._rxnPlusSetPos=function(e,t,r){this._itemSetPos("rxnPluses",e,t,r)},chem.Struct.prototype._rxnArrowSetPos=function(e,t,r){this._itemSetPos("rxnArrows",e,t,r)},chem.Struct.prototype.getCoordBoundingBox=function(e){var t=null,r=function(e){t?(t.min=Vec2.min(t.min,e),t.max=Vec2.max(t.max,e)):t={min:e,max:e}},n="undefined"==typeof e;return this.atoms.each(function(t,o){(n||Set.contains(e,t))&&r(o.pp)}),n&&(this.rxnPluses.each(function(e,t){r(t.pp)}),this.rxnArrows.each(function(e,t){r(t.pp)})),!t&&n&&(t={min:new Vec2(0,0),max:new Vec2(1,1)}),t},chem.Struct.prototype.getCoordBoundingBoxObj=function(){var e=null,t=function(t){e?(e.min=Vec2.min(e.min,t),e.max=Vec2.max(e.max,t)):e={min:new Vec2(t),max:new Vec2(t)}};return this.atoms.each(function(e,r){t(r.pp)}),e},chem.Struct.prototype.getBondLengthData=function(){var e=0,t=0;return this.bonds.each(function(r,n){e+=Vec2.dist(this.atoms.get(n.begin).pp,this.atoms.get(n.end).pp),t++},this),{cnt:t,totalLength:e}},chem.Struct.prototype.getAvgBondLength=function(){var e=this.getBondLengthData();return e.cnt>0?e.totalLength/e.cnt:-1},chem.Struct.prototype.getAvgClosestAtomDistance=function(){var e,t,r,n=0,o=0,i=this.atoms.keys();for(t=0;t<i.length;++t){for(e=-1,r=0;r<i.length;++r)r!=t&&(o=Vec2.dist(this.atoms.get(i[r]).pp,this.atoms.get(i[t]).pp),(0>e||e>o)&&(e=o));n+=e}return i.length>0?n/i.length:-1},chem.Struct.prototype.checkBondExists=function(e,t){var r=!1;return this.bonds.each(function(n,o){(o.begin==e&&o.end==t||o.end==e&&o.begin==t)&&(r=!0)},this),r},chem.Loop=function(e,t,r){this.hbs=e,this.dblBonds=0,this.aromatic=!0,this.convex=r||!1,e.each(function(e){var r=t.bonds.get(t.halfBonds.get(e).bid);r.type!=chem.Struct.BOND.TYPE.AROMATIC&&(this.aromatic=!1),r.type==chem.Struct.BOND.TYPE.DOUBLE&&this.dblBonds++},this)},chem.Struct.RxnPlus=function(e){e=e||{},this.pp=e.pp?new Vec2(e.pp):new Vec2},chem.Struct.RxnPlus.prototype.clone=function(){return new chem.Struct.RxnPlus(this)},chem.Struct.RxnArrow=function(e){e=e||{},this.pp=e.pp?new Vec2(e.pp):new Vec2},chem.Struct.RxnArrow.prototype.clone=function(){return new chem.Struct.RxnArrow(this)},chem.Struct.prototype.findConnectedComponent=function(e){for(var t={},r=[e],n=Set.empty();r.length>0;)!function(){var e=r.pop();t[e]=1,Set.add(n,e);for(var o=this.atoms.get(e),i=0;i<o.neighbors.length;++i){var a=this.halfBonds.get(o.neighbors[i]).end;Set.contains(n,a)||r.push(a)}}.apply(this);return n},chem.Struct.prototype.findConnectedComponents=function(e){this.halfBonds.count()||(this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()));var t={};this.atoms.each(function(e){t[e]=-1},this);var r=[];return this.atoms.each(function(n,o){if((e||o.fragment<0)&&t[n]<0){var i=this.findConnectedComponent(n);r.push(i),Set.each(i,function(e){t[e]=1},this)}},this),r},chem.Struct.prototype.markFragment=function(e){var t=this.frags.add(new chem.Struct.Fragment);Set.each(e,function(e){this.atoms.get(e).fragment=t},this)},chem.Struct.prototype.markFragmentByAtomId=function(e){this.markFragment(this.findConnectedComponent(e))},chem.Struct.prototype.markFragments=function(){for(var e=this.findConnectedComponents(),t=0;t<e.length;++t)this.markFragment(e[t])},chem.Struct.Fragment=function(){},chem.Struct.Fragment.prototype.clone=function(){return Object.clone(this)},chem.Struct.Fragment.getAtoms=function(e,t){var r=[];return e.atoms.each(function(e,n){n.fragment==t&&r.push(e)},this),r},chem.Struct.RGroup=function(e){e=e||{},this.frags=new Pool,this.resth=e.resth||!1,this.range=e.range||"",this.ifthen=e.ifthen||0},chem.Struct.RGroup.prototype.getAttrs=function(){return{resth:this.resth,range:this.range,ifthen:this.ifthen}},chem.Struct.RGroup.findRGroupByFragment=function(e,t){var r;return e.each(function(e,n){Object.isUndefined(n.frags.keyOf(t))||(r=e)}),r},chem.Struct.RGroup.prototype.clone=function(e){var t=new chem.Struct.RGroup(this);return this.frags.each(function(r,n){t.frags.add(e?e[n]:n)}),t},chem.Struct.prototype.scale=function(e){1!=e&&(this.atoms.each(function(t,r){r.pp=r.pp.scaled(e)},this),this.rxnPluses.each(function(t,r){r.pp=r.pp.scaled(e)},this),this.rxnArrows.each(function(t,r){r.pp=r.pp.scaled(e)},this),this.sgroups.each(function(t,r){r.pp=r.pp?r.pp.scaled(e):null},this))},chem.Struct.prototype.rescale=function(){var e=this.getAvgBondLength();0>e&&!this.isReaction&&(e=this.getAvgClosestAtomDistance()),.001>e&&(e=1);var t=1/e;this.scale(t)},chem.Struct.prototype.loopHasSelfIntersections=function(e){for(var t=0;t<e.length;++t)for(var r=this.halfBonds.get(e[t]),n=this.atoms.get(r.begin).pp,o=this.atoms.get(r.end).pp,i=Set.fromList([r.begin,r.end]),a=t+2;a<e.length;++a){var s=this.halfBonds.get(e[a]);if(!Set.contains(i,s.begin)&&!Set.contains(i,s.end)){var l=this.atoms.get(s.begin).pp,c=this.atoms.get(s.end).pp;if(Vec2.segmentIntersection(n,o,l,c))return!0}}return!1},chem.Struct.prototype.partitionLoop=function(e){var t=[],r=!0;e:for(;r;){for(var n={},o=0;o<e.length;++o){var i=e[o],a=this.halfBonds.get(i).begin,s=this.halfBonds.get(i).end;if(s in n){var l=n[s],c=e.slice(l,o+1);t.push(c),o<e.length&&e.splice(l,o-l+1);continue e}n[a]=o}r=!1,t.push(e)}return t},chem.Struct.prototype.halfBondAngle=function(e,t){var r=this.halfBonds.get(e),n=this.halfBonds.get(t);return Math.atan2(Vec2.cross(r.dir,n.dir),Vec2.dot(r.dir,n.dir))},chem.Struct.prototype.loopIsConvex=function(e){for(var t=0;t<e.length;++t){var r=this.halfBondAngle(e[t],e[(t+1)%e.length]);if(r>0)return!1}return!0},chem.Struct.prototype.loopIsInner=function(e){for(var t=2*Math.PI,r=0;r<e.length;++r){var n=e[r],o=e[(r+1)%e.length],i=this.halfBonds.get(o),a=this.halfBondAngle(n,o);t+=i.contra==e[r]?Math.PI:a}return Math.abs(t)<Math.PI},chem.Struct.prototype.findLoops=function(){var e,t,r,n,o=[],i=Set.empty();return this.halfBonds.each(function(a,s){if(-1==s.loop)for(e=a,t=0,r=[];t<=this.halfBonds.count();e=this.halfBonds.get(e).next,++t){if(t>0&&e==a){var l=this.partitionLoop(r);util.each(l,function(e){this.loopIsInner(e)&&!this.loopHasSelfIntersections(e)?(n=util.arrayMin(e),this.loops.set(n,new chem.Loop(e,this,this.loopIsConvex(e)))):n=-2,e.each(function(e){this.halfBonds.get(e).loop=n,Set.add(i,this.halfBonds.get(e).bid)},this),n>=0&&o.push(n)},this);break}r.push(e)}},this),{newLoops:o,bondsToMark:Set.list(i)}},chem.Struct.prototype.prepareLoopStructure=function(){this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()),this.findLoops()},chem.Struct.prototype.atomAddToSGroup=function(e,t){chem.SGroup.addAtom(this.sgroups.get(e),t),Set.add(this.atoms.get(t).sgs,e)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/map":40,"../util/pool":41,"../util/set":42,"../util/vec2":43,"./element":10}],17:[function(require,module,exports){
(function (global){
var util=require("../util"),element=require("./element");require("./struct");var chem=global.chem=global.chem||{};chem.Struct.prototype.calcConn=function(e){for(var t=0,r=this.atoms.get(e),o=!1,n=0;n<r.neighbors.length;++n){var i=this.halfBonds.get(r.neighbors[n]),a=this.bonds.get(i.bid);switch(a.type){case chem.Struct.BOND.TYPE.SINGLE:t+=1;break;case chem.Struct.BOND.TYPE.DOUBLE:t+=2;break;case chem.Struct.BOND.TYPE.TRIPLE:t+=3;break;case chem.Struct.BOND.TYPE.AROMATIC:t+=1,o=!0;break;default:return-1}}return o&&(t+=1),t},chem.Struct.Atom.prototype.calcValence=function(e){var t=this,r=t.charge,o=t.label;if(t.isQuery())return this.implicitH=0,!0;var n=element.getElementByLabel(o);if(null==n)return this.implicitH=0,!0;var i=element.get(n).group,a=chem.Struct.radicalElectrons(t.radical),s=e,l=0,d=Math.abs(r);return 1==i?("H"==o||"Li"==o||"Na"==o||"K"==o||"Rb"==o||"Cs"==o||"Fr"==o)&&(s=1,l=1-a-e-d):3==i?"B"==o||"Al"==o||"Ga"==o||"In"==o?-1==r?(s=4,l=4-a-e):(s=3,l=3-a-e-d):"Tl"==o&&(-1==r?2>=a+e?(s=2,l=2-a-e):(s=4,l=4-a-e):-2==r?3>=a+e?(s=3,l=3-a-e):(s=5,l=5-a-e):1>=a+e+d?(s=1,l=1-a-e-d):(s=3,l=3-a-e-d)):4==i?"C"==o||"Si"==o||"Ge"==o?(s=4,l=4-a-e-d):("Sn"==o||"Pb"==o)&&(2>=e+a+d?(s=2,l=2-a-e-d):(s=4,l=4-a-e-d)):5==i?"N"==o||"P"==o?1==r?(s=4,l=4-a-e):2==r?(s=3,l=3-a-e):"N"==o||3>=a+e+d?(s=3,l=3-a-e-d):(s=5,l=5-a-e-d):("Bi"==o||"Sb"==o||"As"==o)&&(1==r?2>=a+e&&"As"!=o?(s=2,l=2-a-e):(s=4,l=4-a-e):2==r?(s=3,l=3-a-e):3>=a+e?(s=3,l=3-a-e-d):(s=5,l=5-a-e-d)):6==i?"O"==o?r>=1?(s=3,l=3-a-e):(s=2,l=2-a-e-d):"S"==o||"Se"==o||"Po"==o?1==r?3>=e?(s=3,l=3-a-e):(s=5,l=5-a-e):2>=e+a+d?(s=2,l=2-a-e-d):4>=e+a+d?(s=4,l=4-a-e-d):(s=6,l=6-a-e-d):"Te"==o&&(-1==r?2>=e&&(s=2,l=2-a-e-d):(0==r||2==r)&&(2>=e?(s=2,l=2-a-e-d):4>=e?(s=4,l=4-a-e-d):0==r&&6>=e?(s=6,l=6-a-e-d):l=-1)):7==i&&("F"==o?(s=1,l=1-a-e-d):("Cl"==o||"Br"==o||"I"==o||"At"==o)&&(1==r?2>=e?(s=2,l=2-a-e):(3==e||5==e||e>=7)&&(l=-1):0==r&&(1>=e?(s=1,l=1-a-e):2==e||4==e||6==e?1==a?(s=e,l=0):l=-1:e>7&&(l=-1)))),this.valence=s,this.implicitH=l,this.implicitH<0?(this.valence=e,this.implicitH=0,this.badConn=!0,!1):!0},chem.Struct.Atom.prototype.calcValenceMinusHyd=function(e){var t=this,r=t.charge,o=t.label,n=element.getElementByLabel(o);if(null==n)throw new Error("Element "+o+" unknown");if(0>n)return this.implicitH=0,null;var i=element.get(n).group,a=chem.Struct.radicalElectrons(t.radical);if(3==i){if(("B"==o||"Al"==o||"Ga"==o||"In"==o)&&-1==r&&4>=a+e)return a+e}else if(5==i){if("N"==o||"P"==o){if(1==r)return a+e;if(2==r)return a+e}else if("Sb"==o||"Bi"==o||"As"==o){if(1==r)return a+e;if(2==r)return a+e}}else if(6==i){if("O"==o){if(r>=1)return a+e}else if(("S"==o||"Se"==o||"Po"==o)&&1==r)return a+e}else if(7==i&&("Cl"==o||"Br"==o||"I"==o||"At"==o)&&1==r)return a+e;return a+e+Math.abs(r)},chem.Struct.prototype.calcImplicitHydrogen=function(e){var t=this.calcConn(e),r=this.atoms.get(e);if(r.badConn=!1,0>t||r.isQuery())return r.implicitH=0,void 0;if(r.explicitValence>=0){var o=element.getElementByLabel(r.label);r.implicitH=0,null!=o&&(r.implicitH=r.explicitValence-r.calcValenceMinusHyd(t),r.implicitH<0&&(r.implicitH=0,r.badConn=!0))}else r.calcValence(t)},chem.Struct.prototype.setImplicitHydrogen=function(e){var t=function(e){this.calcImplicitHydrogen(e)};util.isNullOrUndefined(e)?this.atoms.each(t,this):util.each(e,t,this)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"./element":10,"./struct":16}],18:[function(require,module,exports){
(function (global){
function getSmiles(e){var t=ui.standalone||e,i=t?new chem.SmilesSaver:new chem.MolfileSaver,r=i.saveMolecule(ui.ctab,!0);return t?r:ketcher.server.smiles.sync({moldata:r})}function getMolfile(){var e=new chem.MolfileSaver;return e.saveMolecule(ui.ctab,!0)}function setMolecule(e){Object.isString(e)&&ui.loadMolecule(e)}function addFragment(e){Object.isString(e)&&ui.loadFragment(e)}function showMolfile(e,t,i){var r=util.extend({bondLength:75,showSelectionRegions:!1,showBondIds:!1,showHalfBondIds:!1,showLoopIds:!1,showAtomIds:!1,autoScale:!1,autoScaleMargin:4,hideImplicitHydrogen:!1},i),n=new rnd.Render(e,r.bondLength,r);if(t){var l=chem.Molfile.parseCTFile(t);n.setMolecule(l)}return n.update(),n}function onStructChange(e){util.assert(e),ui.render.addStructChangeHandler(e)}var queryString=require("query-string"),util=require("./util"),api=require("./api.js");require("./ui"),require("./chem"),require("./rnd");var ui=global.ui,chem=global.chem,rnd=global.rnd;window.onload=function(){var e=queryString.parse(document.location.search);e.api_path&&(ketcher.api_path=e.api_path),ketcher.server=api(ketcher.api_path),ui.init(util.extend({},e),ketcher.server)};var ketcher=module.exports={version:"2.0.0",api_path:"",build_date:"2018-02-07 15-11-09",build_number:null,build_options:"__BUILD_NUMBER__",getSmiles:getSmiles,getMolfile:getMolfile,setMolecule:setMolecule,addFragment:addFragment,showMolfile:showMolfile,onStructChange:onStructChange};
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./api.js":7,"./chem":11,"./rnd":21,"./ui":34,"./util":39,"query-string":4}],19:[function(require,module,exports){
(function (global){
var Raphael=(typeof window !== "undefined" ? window['Raphael'] : typeof global !== "undefined" ? global['Raphael'] : null),Vec2=require("./util/vec2");Raphael.el.translateAbs=function(e,t){this.delta=this.delta||new Vec2,this.delta.x+=e-0,this.delta.y+=t-0,this.transform("t"+this.delta.x.toString()+","+this.delta.y.toString())},Raphael.st.translateAbs=function(e,t){this.forEach(function(r){r.translateAbs(e,t)})},module.exports=Raphael;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./util/vec2":43}],20:[function(require,module,exports){
(function (global){
function bondFlipRequired(e,t){return t.type==chem.Struct.BOND.TYPE.SINGLE&&e.stereo==chem.Struct.BOND.STEREO.NONE&&t.stereo!=chem.Struct.BOND.STEREO.NONE&&ui.ctab.atoms.get(e.begin).neighbors.length<ui.ctab.atoms.get(e.end).neighbors.length}var Set=require("../util/set"),Vec2=require("../util/vec2"),Action=require("../ui/action"),element=require("../chem/element"),util=require("../util");require("../chem"),require("./restruct"),require("../ui");var rnd=global.rnd=global.rnd||{},chem=global.chem=global.chem||{},ui=global.ui;rnd.Editor=function(e){this.render=e,this._selectionHelper=new rnd.Editor.SelectionHelper(this)},rnd.Editor.prototype.selectAll=function(){var e={};for(var t in rnd.ReStruct.maps)e[t]=ui.render.ctab[t].ikeys();this._selectionHelper.setSelection(e)},rnd.Editor.prototype.deselectAll=function(){this._selectionHelper.setSelection()},rnd.Editor.prototype.hasSelection=function(e){if("selection"in this._selectionHelper)for(var t in this._selectionHelper.selection)if(this._selectionHelper.selection[t].length>0&&(!e||"sgroupData"!==t))return!0;return!1},rnd.Editor.prototype.getSelection=function(e){var t={};if("selection"in this._selectionHelper)for(var o in this._selectionHelper.selection)t[o]=this._selectionHelper.selection[o].slice(0);if(e){var n=this.render.ctab.molecule;"bonds"in t&&t.bonds.each(function(e){var o=n.bonds.get(e);t.atoms=t.atoms||[],t.atoms.indexOf(o.begin)<0&&t.atoms.push(o.begin),t.atoms.indexOf(o.end)<0&&t.atoms.push(o.end)},this),"atoms"in t&&"bonds"in t&&n.bonds.each(function(e){if(!("bonds"in t)||t.bonds.indexOf(e)<0){var o=n.bonds.get(e);t.atoms.indexOf(o.begin)>=0&&t.atoms.indexOf(o.end)>=0&&(t.bonds=t.bonds||[],t.bonds.push(e))}},this)}return t},rnd.Editor.prototype.getSelectionStruct=function(){console.assert(ui.ctab==this.render.ctab.molecule,"Another ctab");var e=ui.ctab,t=this.getSelection(!0),o=e.clone(Set.fromList(t.atoms),Set.fromList(t.bonds),!0);return e.rxnArrows.each(function(e,n){-1!=t.rxnArrows.indexOf(e)&&o.rxnArrows.add(n.clone())}),e.rxnPluses.each(function(e,n){-1!=t.rxnPluses.indexOf(e)&&o.rxnPluses.add(n.clone())}),o.isReaction=e.isReaction&&(o.rxnArrows.count()||o.rxnPluses.count()),o},rnd.Editor.SelectionHelper=function(e){this.editor=e},rnd.Editor.SelectionHelper.prototype.setSelection=function(e,t){if(!("selection"in this&&t)){this.selection={};for(var o in rnd.ReStruct.maps)this.selection[o]=[]}if(e&&"id"in e&&"map"in e&&(e[e.map]=e[e.map]||[]).push(e.id),e)for(var n in this.selection)if(n in e)for(var r=0;r<e[n].length;r++)this.selection[n].indexOf(e[n][r])<0&&this.selection[n].push(e[n][r]);this.editor.render.setSelection(this.selection),this.editor.render.update(),ui.updateClipboardButtons()},rnd.Editor.SelectionHelper.prototype.isSelected=function(e){var t=this.editor.render,o=t.ctab;if("frags"==e.map||"rgroups"==e.map){var n="frags"==e.map?o.frags.get(e.id).fragGetAtoms(t,e.id):o.rgroups.get(e.id).getAtoms(t);return!Object.isUndefined(this.selection.atoms)&&Set.subset(Set.fromList(n),Set.fromList(this.selection.atoms))}return"selection"in this&&!Object.isUndefined(this.selection[e.map])&&this.selection[e.map].indexOf(e.id)>-1},rnd.Editor.EditorTool=function(e){this.editor=e},rnd.Editor.EditorTool.prototype.processEvent=function(e,t,o){if("touches"in t&&1!=t.touches.length){if("lastEvent"in this.OnMouseDown0)return this.OnMouseUp0(t,o)}else{if(e+"0"in this)return this[e+"0"](t,o);if(e in this)return this[e](t,o);console.log("EditorTool.dispatchEvent: event '"+e+"' is not handled.")}},rnd.Editor.EditorTool.prototype.OnMouseDown=function(){},rnd.Editor.EditorTool.prototype.OnMouseMove=function(){},rnd.Editor.EditorTool.prototype.OnMouseUp=function(){},rnd.Editor.EditorTool.prototype.OnClick=function(){},rnd.Editor.EditorTool.prototype.OnDblClick=function(){},rnd.Editor.EditorTool.prototype.OnMouseLeave=function(){this.OnCancel()},rnd.Editor.EditorTool.prototype.OnKeyPress=function(){},rnd.Editor.EditorTool.prototype.OnCancel=function(){},rnd.Editor.EditorTool.prototype.OnMouseDown0=function(e){return ui.hideBlurredControls()?!0:(this.OnMouseDown0.lastEvent=e,this.OnMouseMove0.lastEvent=e,"OnMouseDown"in this?this.OnMouseDown(e):void 0)},rnd.Editor.EditorTool.prototype.OnMouseMove0=function(e){return this.OnMouseMove0.lastEvent=e,"OnMouseMove"in this?this.OnMouseMove(e):void 0},rnd.Editor.EditorTool.prototype.OnMouseUp0=function(e){if(!("lastEvent"in this.OnMouseDown0))return!0;"lastEvent"in this.OnMouseMove0&&(e=Object.clone(e),e.pageX=this.OnMouseMove0.lastEvent.pageX,e.pageY=this.OnMouseMove0.lastEvent.pageY);try{if("OnMouseUp"in this)return this.OnMouseUp(e)}finally{delete this.OnMouseDown0.lastEvent}},rnd.Editor.EditorTool.atom_label_map={atom_tool_any:"A",atom_tool_h:"H",atom_tool_c:"C",atom_tool_n:"N",atom_tool_o:"O",atom_tool_s:"S",atom_tool_p:"P",atom_tool_f:"F",atom_tool_br:"Br",atom_tool_cl:"Cl",atom_tool_i:"I"},rnd.Editor.EditorTool.prototype.OnKeyPress0=function(e,t){if("rgroup_tool_label"===t&&"lastEvent"in this.OnMouseMove0)return rnd.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,this.OnMouseMove0.lastEvent);if(t in rnd.Editor.EditorTool.atom_label_map){var o=rnd.Editor.EditorTool.atom_label_map[t],n=this.editor.getSelection();if(n&&"atoms"in n&&n.atoms.length>0)return ui.addUndoAction(Action.fromAtomsAttrs(n.atoms,{label:o},!0),!0),ui.render.update(),!0;var r=this.editor.render.findItem(this.OnMouseMove0.lastEvent);if(r)return r.label={label:o},"atoms"===r.map?ui.addUndoAction(Action.fromAtomsAttrs(r.id,r.label,!0),!0):-1==r.id&&ui.addUndoAction(Action.fromAtomAddition(ui.page2obj(this.OnMouseMove0.lastEvent),r.label),!0),ui.render.update(),!0}return"OnKeyPress"in this?this.OnKeyPress(e):!1},rnd.Editor.EditorTool.prototype._calcAngle=function(e,t){var o=Vec2.diff(t,e),n=Math.atan2(o.y,o.x),r=0>n?-1:1,i=Math.floor(Math.abs(n)/(Math.PI/12))*(Math.PI/12);return n=r*(i+(Math.abs(n)-i<Math.PI/24?0:Math.PI/12))},rnd.Editor.EditorTool.prototype._calcNewAtomPos=function(e,t){var o=new Vec2(1,0).rotate(this._calcAngle(e,t));return o.add_(e),o},rnd.Editor.EditorTool.HoverHelper=function(e){this.editorTool=e},rnd.Editor.EditorTool.HoverHelper.prototype.hover=function(e){e&&"Canvas"==e.type&&(e=null),"ci"in this&&(!e||this.ci.type!=e.type||this.ci.id!=e.id)&&(this.editorTool.editor.render.highlightObject(this.ci,!1),delete this.ci),e&&this.editorTool.editor.render.highlightObject(e,!0)&&(this.ci=e)},rnd.Editor.LassoTool=function(e,t,o){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(t||0,e,o),this._sGroupHelper=new rnd.Editor.SGroupTool.SGroupHelper(e)},rnd.Editor.LassoTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.LassoTool.prototype.OnMouseDown=function(e){var t=this.editor.render,o=t.ctab,n=o.molecule;this._hoverHelper.hover(null);var r=this._lassoHelper.fragment||e.ctrlKey,i=this.editor.render.findItem(e,r?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]);if(i&&"Canvas"!=i.type){if(this._hoverHelper.hover(null),"onShowLoupe"in this.editor.render&&this.editor.render.onShowLoupe(!0),!this.editor._selectionHelper.isSelected(i))if("frags"==i.map){var s=o.frags.get(i.id);this.editor._selectionHelper.setSelection({atoms:s.fragGetAtoms(t,i.id),bonds:s.fragGetBonds(t,i.id)},e.shiftKey)}else if("sgroups"==i.map){var a=o.sgroups.get(i.id).item;this.editor._selectionHelper.setSelection({atoms:chem.SGroup.getAtoms(n,a),bonds:chem.SGroup.getBonds(n,a)},e.shiftKey)}else if("rgroups"==i.map){var l=o.rgroups.get(i.id);this.editor._selectionHelper.setSelection({atoms:l.getAtoms(t),bonds:l.getBonds(t)},e.shiftKey)}else this.editor._selectionHelper.setSelection(i,e.shiftKey);if(this.dragCtx={item:i,xy0:ui.page2obj(e)},"atoms"==i.map&&!ui.is_touch){var d=this;this.dragCtx.timeout=setTimeout(function(){delete d.dragCtx,d.editor._selectionHelper.setSelection(null),ui.showLabelEditor(i.id)},750),this.dragCtx.stopTapping=function(){"timeout"in d.dragCtx&&(clearTimeout(d.dragCtx.timeout),delete d.dragCtx.timeout)}}}else this._lassoHelper.fragment||this._lassoHelper.begin(e);return!0},rnd.Editor.LassoTool.prototype.OnMouseMove=function(e){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),this.dragCtx.action&&(this.dragCtx.action.perform(),this.editor.render.update()),this.dragCtx.action=Action.fromMultipleMove(this.editor.getSelection(!0),ui.page2obj(e).sub(this.dragCtx.xy0)),["atoms"].indexOf(this.dragCtx.item.map)>=0){var t=this.editor.render.findItem(e,[this.dragCtx.item.map],this.dragCtx.item);this._hoverHelper.hover(t.map==this.dragCtx.item.map?t:null)}this.editor.render.update()}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(e),e.shiftKey):this._hoverHelper.hover(this.editor.render.findItem(e,this._lassoHelper.fragment||e.ctrlKey?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]));return!0},rnd.Editor.LassoTool.prototype.OnMouseUp=function(e){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),["atoms"].indexOf(this.dragCtx.item.map)>=0){var t=this.editor.render.findItem(e,[this.dragCtx.item.map],this.dragCtx.item);t.map==this.dragCtx.item.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(),this.dragCtx.action=this.dragCtx.action?Action.fromAtomMerge(this.dragCtx.item.id,t.id).mergeWith(this.dragCtx.action):Action.fromAtomMerge(this.dragCtx.item.id,t.id))}ui.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.end(),e.shiftKey):this._lassoHelper.fragment&&this.editor._selectionHelper.setSelection();return!0},rnd.Editor.LassoTool.prototype.OnDblClick=function(e){var t=this.editor.render.findItem(e);if("atoms"==t.map){this.editor._selectionHelper.setSelection(t);var o=ui.ctab.atoms.get(t.id);"R#"==o.label?rnd.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,e):"L#"==o.label?ui.showElemTable({selection:o,onOk:function(e){return o.label==e.label&&o.atomList.equals(e.atomList)||(ui.addUndoAction(Action.fromAtomsAttrs(t.id,e)),ui.render.update()),!0}.bind(this)}):(element.getElementByLabel(o.label)||121)<120?ui.showAtomProperties(t.id):ui.showReaGenericsTable({values:[o.label],onOk:function(e){var n=e.values[0];return o.label!=n&&(ui.addUndoAction(Action.fromAtomsAttrs(t.id,{label:n})),ui.render.update()),!0}.bind(this)})}else"bonds"==t.map?(this.editor._selectionHelper.setSelection(t),ui.showBondProperties(t.id)):"sgroups"==t.map&&(this.editor._selectionHelper.setSelection(t),this._sGroupHelper.showPropertiesDialog(t.id));return!0},rnd.Editor.LassoTool.prototype.OnCancel=function(){"dragCtx"in this?("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),ui.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx):this._lassoHelper.running()&&this.editor._selectionHelper.setSelection(this._lassoHelper.end()),this._hoverHelper.hover(null)},rnd.Editor.LassoTool.LassoHelper=function(e,t,o){this.mode=e,this.fragment=o,this.editor=t},rnd.Editor.LassoTool.LassoHelper.prototype.getSelection=function(){if(0==this.mode)return ui.render.getElementsInPolygon(this.points);if(1==this.mode)return ui.render.getElementsInRectangle(this.points[0],this.points[1]);throw new Error("Selector mode unknown")},rnd.Editor.LassoTool.LassoHelper.prototype.begin=function(e){this.points=[ui.page2obj(e)],1==this.mode&&this.points.push(this.points[0])},rnd.Editor.LassoTool.LassoHelper.prototype.running=function(){return"points"in this},rnd.Editor.LassoTool.LassoHelper.prototype.addPoint=function(e){return this.running()?(0==this.mode?(this.points.push(ui.page2obj(e)),this.editor.render.drawSelectionPolygon(this.points)):1==this.mode&&(this.points=[this.points[0],ui.page2obj(e)],this.editor.render.drawSelectionRectangle(this.points[0],this.points[1])),this.getSelection()):!1},rnd.Editor.LassoTool.LassoHelper.prototype.end=function(){var e=this.getSelection();return"points"in this&&(this.editor.render.drawSelectionPolygon(null),delete this.points),e},rnd.Editor.EraserTool=function(e,t){this.editor=e,this.maps=["atoms","bonds","rxnArrows","rxnPluses","sgroups","sgroupData","chiralFlags"],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(t||0,e)},rnd.Editor.EraserTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.EraserTool.prototype.OnMouseDown=function(e){var t=this.editor.render.findItem(e,this.maps);t&&"Canvas"!=t.type||this._lassoHelper.begin(e)},rnd.Editor.EraserTool.prototype.OnMouseMove=function(e){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(e)):this._hoverHelper.hover(this.editor.render.findItem(e,this.maps))},rnd.Editor.EraserTool.prototype.OnMouseUp=function(e){if(this._lassoHelper.running())ui.addUndoAction(Action.fromFragmentDeletion(this._lassoHelper.end(e))),this.editor.deselectAll(),ui.render.update();else{var t=this.editor.render.findItem(e,this.maps);if(t&&"Canvas"!=t.type){if(this._hoverHelper.hover(null),"atoms"==t.map)ui.addUndoAction(Action.fromAtomDeletion(t.id));else if("bonds"==t.map)ui.addUndoAction(Action.fromBondDeletion(t.id));else if("sgroups"==t.map||"sgroupData"==t.map)ui.addUndoAction(Action.fromSgroupDeletion(t.id));else if("rxnArrows"==t.map)ui.addUndoAction(Action.fromArrowDeletion(t.id));else if("rxnPluses"==t.map)ui.addUndoAction(Action.fromPlusDeletion(t.id));else{if("chiralFlags"!=t.map)return console.log("EraserTool: unable to delete the object "+t.map+"["+t.id+"]"),void 0;ui.addUndoAction(Action.fromChiralFlagDeletion())}this.editor.deselectAll(),ui.render.update()}}},rnd.Editor.AtomTool=function(e,t){this.editor=e,this.atomProps=t,this.bondProps={type:1,stereo:chem.Struct.BOND.STEREO.NONE},this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.AtomTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.AtomTool.prototype.OnMouseDown=function(e){this._hoverHelper.hover(null);var t=this.editor.render.findItem(e,["atoms"]);t&&"Canvas"!=t.type?"atoms"==t.map&&(this.dragCtx={item:t,xy0:ui.page2obj(e)}):this.dragCtx={xy0:ui.page2obj(e)}},rnd.Editor.AtomTool.prototype.OnMouseMove=function(e){var t=this.editor,o=t.render;if("dragCtx"in this&&"item"in this.dragCtx){var n=this.dragCtx,r=this._calcNewAtomPos(o.atomGetPos(n.item.id),ui.page2obj(e));"action"in n&&n.action.perform();var i=Action.fromBondAddition(this.bondProps,n.item.id,Object.clone(this.atomProps),r,r);n.action=i[0],n.aid2=i[2],o.update()}else this._hoverHelper.hover(o.findItem(e,["atoms"]))},rnd.Editor.AtomTool.prototype.OnMouseUp=function(e){if("dragCtx"in this){var t=this.dragCtx;ui.addUndoAction("action"in t?t.action:"item"in t?Action.fromAtomsAttrs(t.item.id,this.atomProps,!0):Action.fromAtomAddition(ui.page2obj(e),this.atomProps),!0),this.editor.render.update(),delete this.dragCtx}},rnd.Editor.BondTool=function(e,t){this.editor=e,this.atomProps={label:"C"},this.bondProps=t,this.plainBondTypes=[chem.Struct.BOND.TYPE.SINGLE,chem.Struct.BOND.TYPE.DOUBLE,chem.Struct.BOND.TYPE.TRIPLE],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.BondTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.BondTool.prototype.OnMouseDown=function(e){return this._hoverHelper.hover(null),this.dragCtx={xy0:ui.page2obj(e),item:this.editor.render.findItem(e,["atoms","bonds"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},rnd.Editor.BondTool.prototype.OnMouseMove=function(e){var t=this.editor,o=t.render;if("dragCtx"in this){var n=this.dragCtx;if(!("item"in n)||"atoms"==n.item.map){"action"in n&&n.action.perform();var r,i,s,a;"item"in n&&"atoms"==n.item.map?(r=n.item.id,i=o.findItem(e,["atoms"],n.item)):(r=this.atomProps,s=n.xy0,i=o.findItem(e,["atoms"]));var l=Number.MAX_VALUE;if(i&&"atoms"==i.map)i=i.id;else{i=this.atomProps;var d=ui.page2obj(e);l=Vec2.dist(n.xy0,d),s?a=this._calcNewAtomPos(s,d):s=this._calcNewAtomPos(o.atomGetPos(r),d)}return l>.3?n.action=Action.fromBondAddition(this.bondProps,r,i,s,a)[0]:delete n.action,o.update(),!0}}return this._hoverHelper.hover(o.findItem(e,["atoms","bonds"])),!0},rnd.Editor.BondTool.prototype.OnMouseUp=function(e){if("dragCtx"in this){var t=this.dragCtx;if("action"in t)ui.addUndoAction(t.action);else if("item"in t){if("atoms"==t.item.map)ui.addUndoAction(Action.fromBondAddition(this.bondProps,t.item.id)[0]);else if("bonds"==t.item.map){var o=Object.clone(this.bondProps),n=ui.ctab.bonds.get(t.item.id);if(o.stereo!=chem.Struct.BOND.STEREO.NONE&&n.type==chem.Struct.BOND.TYPE.SINGLE&&o.type==chem.Struct.BOND.TYPE.SINGLE&&n.stereo==o.stereo)ui.addUndoAction(Action.fromBondFlipping(t.item.id));else{if(o.type===chem.Struct.BOND.TYPE.SINGLE&&n.stereo===chem.Struct.BOND.STEREO.NONE&&o.stereo===chem.Struct.BOND.STEREO.NONE){var r=this.plainBondTypes.indexOf(o.type)>=0?this.plainBondTypes:null;r&&(o.type=r[(r.indexOf(n.type)+1)%r.length])}ui.addUndoAction(Action.fromBondAttrs(t.item.id,o,bondFlipRequired(n,o)),!0)}}}else{var i=ui.page2obj(e),s=new Vec2(.5,0).rotate(this.bondProps.type==chem.Struct.BOND.TYPE.SINGLE?-Math.PI/6:0),a=Action.fromBondAddition(this.bondProps,{label:"C"},{label:"C"},{x:i.x-s.x,y:i.y-s.y},{x:i.x+s.x,y:i.y+s.y});ui.addUndoAction(a[0])}this.editor.render.update(),delete this.dragCtx}return!0},rnd.Editor.ChainTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ChainTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ChainTool.prototype.OnMouseDown=function(e){return this._hoverHelper.hover(null),this.dragCtx={xy0:ui.page2obj(e),item:this.editor.render.findItem(e,["atoms"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},rnd.Editor.ChainTool.prototype.OnMouseMove=function(e){var t=this.editor,o=t.render;if("dragCtx"in this){var n=this.dragCtx;"action"in n&&n.action.perform();var r="item"in n?o.atomGetPos(n.item.id):n.xy0,i=ui.page2obj(e);return n.action=Action.fromChain(r,this._calcAngle(r,i),Math.ceil(Vec2.diff(i,r).length()),"item"in n?n.item.id:null),o.update(),!0}return this._hoverHelper.hover(o.findItem(e,["atoms"])),!0},rnd.Editor.ChainTool.prototype.OnMouseUp=function(){return"dragCtx"in this&&("action"in this.dragCtx&&ui.addUndoAction(this.dragCtx.action),delete this.dragCtx),!0},rnd.Editor.ChainTool.prototype.OnCancel=function(){this.OnMouseUp()},rnd.Editor.TemplateTool=function(e,t){if(this.editor=e,this.template=t,!this.template.molecule){var o=chem.Molfile.parseCTFile(this.template.molfile);o.rescale();var n=new Vec2;o.atoms.each(function(e,t){n.add_(t.pp)}),this.template.molecule=o,this.template.xy0=n.scaled(1/o.atoms.count()),this.template.angle0=this._calcAngle(o.atoms.get(this.template.aid).pp,this.template.xy0);var r=o.bonds.get(this.template.bid);this.template.sign=this._getSign(o,r,this.template.xy0)}this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.TemplateTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.TemplateTool.prototype._getSign=function(e,t,o){var n=e.atoms.get(t.begin).pp,r=e.atoms.get(t.end).pp,i=Vec2.cross(Vec2.diff(n,r),Vec2.diff(o,r));return i>0?1:0>i?-1:0},rnd.Editor.TemplateTool.prototype.OnMouseDown=function(e){var t=this.editor,o=t.render;this._hoverHelper.hover(null),this.dragCtx={xy0:ui.page2obj(e),item:o.findItem(e,["atoms","bonds"])};var n=this.dragCtx,r=n.item;if(r&&"Canvas"!=r.type){if("bonds"==r.map){var i=o.ctab.molecule,s=new Vec2,a=i.bonds.get(r.id),l=o.atomGetAttr(a.begin,"fragment"),d=i.getFragmentIds(l),c=0,u=i.halfBonds.get(a.hb1).loop;if(0>u&&(u=i.halfBonds.get(a.hb2).loop),u>=0){var p=i.loops.get(u).hbs;p.each(function(e){s.add_(i.atoms.get(i.halfBonds.get(e).begin).pp),c++})}else Set.each(d,function(e){s.add_(i.atoms.get(e).pp),c++});n.v0=s.scaled(1/c);var h=this._getSign(i,a,n.v0);n.sign1=h||1,n.sign2=this.template.sign}}else delete n.item;return!0},rnd.Editor.TemplateTool.prototype.OnMouseMove=function(e){var t=this.editor,o=t.render;if("dragCtx"in this){var n,r,i,s=this.dragCtx,a=s.item,l=ui.page2obj(e);if(s.mouse_moved=!0,a&&"Canvas"!=a.type){if("atoms"==a.map)n=o.atomGetPos(a.id),i=Vec2.dist(n,l)>1;else if("bonds"==a.map){var d=o.ctab.molecule,c=d.bonds.get(a.id),u=this._getSign(d,c,l);return s.sign1*this.template.sign>0&&(u=-u),u==s.sign2&&s.action||("action"in s&&s.action.perform(),s.sign2=u,s.action=Action.fromTemplateOnBond(a.id,this.template,this._calcAngle,s.sign1*s.sign2>0),o.update()),!0}}else n=s.xy0;r=this._calcAngle(n,l);var p=Math.round(180/Math.PI*r);if("angle"in s&&s.angle==p){if(!("extra_bond"in s))return!0;if(s.extra_bond==i)return!0}return"action"in s&&s.action.perform(),s.angle=p,a&&"Canvas"!=a.type?"atoms"==a.map&&(s.action=Action.fromTemplateOnAtom(a.id,r,i,this.template,this._calcAngle),s.extra_bond=i):s.action=Action.fromTemplateOnCanvas(n,r,this.template),o.update(),!0}return this._hoverHelper.hover(o.findItem(e,["atoms","bonds"])),!0},rnd.Editor.TemplateTool.prototype.OnMouseUp=function(){var e=this.editor,t=e.render;if("dragCtx"in this){var o=this.dragCtx,n=o.item;if(!o.action){if(n&&"Canvas"!=n.type)if("atoms"==n.map){var r=t.atomGetDegree(n.id);if(r>1)o.action=Action.fromTemplateOnAtom(n.id,null,!0,this.template,this._calcAngle);else if(1==r){var i=t.ctab.molecule,s=i.halfBonds.get(i.atoms.get(n.id).neighbors[0]).end,a=i.atoms.get(n.id),l=i.atoms.get(s);o.action=Action.fromTemplateOnAtom(n.id,this._calcAngle(l.pp,a.pp),!1,this.template,this._calcAngle)}else o.action=Action.fromTemplateOnAtom(n.id,0,!1,this.template,this._calcAngle)}else"bonds"==n.map&&(o.action=Action.fromTemplateOnBond(n.id,this.template,this._calcAngle,o.sign1*o.sign2>0));else o.action=Action.fromTemplateOnCanvas(o.xy0,0,this.template);t.update()}"action"in this.dragCtx&&(this.dragCtx.action.isDummy()||ui.addUndoAction(this.dragCtx.action)),delete this.dragCtx}},rnd.Editor.TemplateTool.prototype.OnCancel=function(){this.OnMouseUp()},rnd.Editor.ChargeTool=function(e,t){this.editor=e,this.charge=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ChargeTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ChargeTool.prototype.OnMouseMove=function(e){var t=this.editor.render.findItem(e,["atoms"]);return t&&"atoms"==t.map&&null!=element.getElementByLabel(ui.ctab.atoms.get(t.id).label)?this._hoverHelper.hover(t):this._hoverHelper.hover(null),!0},rnd.Editor.ChargeTool.prototype.OnMouseUp=function(e){var t=this.editor,o=t.render,n=o.findItem(e,["atoms"]);return n&&"atoms"==n.map&&null!=element.getElementByLabel(ui.ctab.atoms.get(n.id).label)&&(this._hoverHelper.hover(null),ui.addUndoAction(Action.fromAtomsAttrs(n.id,{charge:o.ctab.molecule.atoms.get(n.id).charge+this.charge})),o.update()),!0},rnd.Editor.RGroupAtomTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.RGroupAtomTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RGroupAtomTool.prototype.OnMouseMove=function(e){this._hoverHelper.hover(this.editor.render.findItem(e,["atoms"]))},rnd.Editor.RGroupAtomTool.prototype.OnMouseUp=function(e){function t(e){for(var t=[],o=0;32>o;o++)if(e&1<<o){var n="R"+(o+1);t.push(n)}return t}function o(e){var t=0;return e.values.forEach(function(e){var o=e.substr(1)-1;t|=1<<o}),t}var n=this.editor.render.findItem(e,["atoms"]);if(!n||"Canvas"==n.type)return this._hoverHelper.hover(null),ui.showRGroupTable({mode:"multiple",onOk:function(e){e=o(e),e&&(ui.addUndoAction(Action.fromAtomAddition(ui.page2obj(this.OnMouseMove0.lastEvent),{label:"R#",rglabel:e}),!0),ui.render.update())}.bind(this)}),!0;if(n&&"atoms"==n.map){this._hoverHelper.hover(null);var r=this.editor.render.ctab.molecule.atoms.get(n.id),i=r.label,s=r.rglabel;return ui.showRGroupTable({mode:"multiple",values:t(s),onOk:function(e){if(e=o(e),s!=e||"R#"!=i){var t=Object.clone(chem.Struct.Atom.attrlist);e?(t.label="R#",t.rglabel=e,t.aam=r.aam):(t.label="C",t.aam=r.aam),ui.addUndoAction(Action.fromAtomsAttrs(n.id,t),!0),ui.render.update()}}.bind(this)}),!0}},rnd.Editor.RGroupFragmentTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.RGroupFragmentTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RGroupFragmentTool.prototype.OnMouseMove=function(e){this._hoverHelper.hover(this.editor.render.findItem(e,["frags","rgroups"]))},rnd.Editor.RGroupFragmentTool.prototype.OnMouseUp=function(e){var t=this.editor.render.findItem(e,["frags","rgroups"]);if(t&&"frags"==t.map){this._hoverHelper.hover(null);var o=chem.Struct.RGroup.findRGroupByFragment(this.editor.render.ctab.molecule.rgroups,t.id);return ui.showRGroupTable({values:o&&["R"+o],onOk:function(e){console.assert(e.values.length<=1,"Too much elements"),e=e.values.length?e.values[0].substr(1)-0:0,o!=e&&(ui.addUndoAction(Action.fromRGroupFragment(e,t.id),!0),ui.render.update())}.bind(this)}),!0}if(t&&"rgroups"==t.map){this._hoverHelper.hover(null);var n=this.editor.render.ctab.molecule.rgroups.get(t.id),r=0;this.editor.render.ctab.molecule.rgroups.each(function(e){r|=1<<e-1});var i={occurrence:n.range,resth:n.resth,ifthen:n.ifthen};return ui.showRLogicTable({rgid:t.id,rlogic:i,rgmask:r,onOk:function(e){var o={};if(i.occurrence!=e.occurrence){var n=e.occurrence.split(",").all(function(e){return e.match(/^[>,<,=]?[0-9]+$/g)||e.match(/^[0-9]+\-[0-9]+$/g)});if(!n)return alert("Bad occurrence value"),!1;o.range=e.occurrence}return i.resth!=e.resth&&(o.resth=e.resth),i.ifthen!=e.ifthen&&(o.ifthen=e.ifthen),("range"in o||"resth"in o||"ifthen"in o)&&(ui.addUndoAction(Action.fromRGroupAttrs(t.id,o)),this.editor.render.update()),!0}.bind(this)}),!0}},rnd.Editor.APointTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.APointTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.APointTool.prototype.OnMouseMove=function(e){this._hoverHelper.hover(this.editor.render.findItem(e,["atoms"]))},rnd.Editor.APointTool.prototype.OnMouseUp=function(e){var t=this.editor.render.findItem(e,["atoms"]);if(t&&"atoms"==t.map){this._hoverHelper.hover(null);var o=this.editor.render.ctab.molecule.atoms.get(t.id).attpnt;return ui.showAtomAttachmentPoints({selection:o,onOk:function(e){o!=e&&(ui.addUndoAction(Action.fromAtomsAttrs(t.id,{attpnt:e}),!0),ui.render.update())}.bind(this)}),!0}},rnd.Editor.ReactionArrowTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ReactionArrowTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionArrowTool.prototype.OnMouseDown=function(e){var t=this.editor.render.findItem(e,["rxnArrows"]);t&&"rxnArrows"==t.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(t),this.dragCtx={xy0:ui.page2obj(e)})},rnd.Editor.ReactionArrowTool.prototype.OnMouseMove=function(e){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=Action.fromMultipleMove(this.editor._selectionHelper.selection,ui.page2obj(e).sub(this.dragCtx.xy0)),ui.render.update()):this._hoverHelper.hover(this.editor.render.findItem(e,["rxnArrows"]))},rnd.Editor.ReactionArrowTool.prototype.OnMouseUp=function(e){"dragCtx"in this?(ui.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):this.editor.render.ctab.molecule.rxnArrows.count()<1&&(ui.addUndoAction(Action.fromArrowAddition(ui.page2obj(e))),this.editor.render.update())},rnd.Editor.ReactionPlusTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ReactionPlusTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionPlusTool.prototype.OnMouseDown=function(e){var t=this.editor.render.findItem(e,["rxnPluses"]);t&&"rxnPluses"==t.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(t),this.dragCtx={xy0:ui.page2obj(e)})},rnd.Editor.ReactionPlusTool.prototype.OnMouseMove=function(e){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=Action.fromMultipleMove(this.editor._selectionHelper.selection,ui.page2obj(e).sub(this.dragCtx.xy0)),ui.render.update()):this._hoverHelper.hover(this.editor.render.findItem(e,["rxnPluses"]))},rnd.Editor.ReactionPlusTool.prototype.OnMouseUp=function(e){"dragCtx"in this?(ui.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):(ui.addUndoAction(Action.fromPlusAddition(ui.page2obj(e))),this.editor.render.update())},rnd.Editor.ReactionMapTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null),this.rcs=chem.MolfileSaver.getComponents(this.editor.render.ctab.molecule)},rnd.Editor.ReactionMapTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionMapTool.prototype.OnMouseDown=function(e){var t=this.editor.render.findItem(e,["atoms"]);t&&"atoms"==t.map&&(this._hoverHelper.hover(null),this.dragCtx={item:t,xy0:ui.page2obj(e)})},rnd.Editor.ReactionMapTool.prototype.OnMouseMove=function(e){var t=this.editor.render;if("dragCtx"in this){var o=t.findItem(e,["atoms"],this.dragCtx.item);o&&"atoms"==o.map&&this._isValidMap(this.dragCtx.item.id,o.id)?(this._hoverHelper.hover(o),t.drawSelectionLine(t.atomGetPos(this.dragCtx.item.id),t.atomGetPos(o.id))):(this._hoverHelper.hover(null),t.drawSelectionLine(t.atomGetPos(this.dragCtx.item.id),ui.page2obj(e)))}else this._hoverHelper.hover(t.findItem(e,["atoms"]))},rnd.Editor.ReactionMapTool.prototype.OnMouseUp=function(e){if("dragCtx"in this){var t=this.editor.render,o=t.findItem(e,["atoms"],this.dragCtx.item);if(o&&"atoms"==o.map&&this._isValidMap(this.dragCtx.item.id,o.id)){var n=new Action,r=t.ctab.molecule.atoms,i=r.get(this.dragCtx.item.id),s=r.get(o.id),a=i.aam,l=s.aam;if(!a||a!=l){if((a&&a!=l||!a&&l)&&r.each(function(e,t){e!=this.dragCtx.item.id&&(a&&t.aam==a||l&&t.aam==l)&&n.mergeWith(Action.fromAtomsAttrs(e,{aam:0}))},this),a)n.mergeWith(Action.fromAtomsAttrs(o.id,{aam:a}));else{var d=0;r.each(function(e,t){d=Math.max(d,t.aam||0)}),n.mergeWith(Action.fromAtomsAttrs(this.dragCtx.item.id,{aam:d+1})),n.mergeWith(Action.fromAtomsAttrs(o.id,{aam:d+1}))}ui.addUndoAction(n,!0),t.update()}}t.drawSelectionLine(null),delete this.dragCtx}this._hoverHelper.hover(null)},rnd.Editor.ReactionMapTool.prototype._isValidMap=function(e,t){for(var o,n,r=0;(!o||!n)&&r<this.rcs.reactants.length;r++){var i=Set.list(this.rcs.reactants[r]);!o&&i.indexOf(e)>=0&&(o="r"),!n&&i.indexOf(t)>=0&&(n="r")}for(var s=0;(!o||!n)&&s<this.rcs.products.length;s++){var a=Set.list(this.rcs.products[s]);!o&&a.indexOf(e)>=0&&(o="p"),!n&&a.indexOf(t)>=0&&(n="p")}return o&&n&&o!=n},rnd.Editor.ReactionUnmapTool=function(e){this.editor=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null)},rnd.Editor.ReactionUnmapTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionUnmapTool.prototype.OnMouseMove=function(e){var t=this.editor.render.findItem(e,["atoms"]);t&&"atoms"==t.map?this._hoverHelper.hover(this.editor.render.ctab.molecule.atoms.get(t.id).aam?t:null):this._hoverHelper.hover(null)},rnd.Editor.ReactionUnmapTool.prototype.OnMouseUp=function(e){var t=this.editor.render.findItem(e,["atoms"]),o=this.editor.render.ctab.molecule.atoms;if(t&&"atoms"==t.map&&o.get(t.id).aam){var n=new Action,r=o.get(t.id).aam;o.each(function(e,t){t.aam==r&&n.mergeWith(Action.fromAtomsAttrs(e,{aam:0}))},this),ui.addUndoAction(n,!0),this.editor.render.update()}this._hoverHelper.hover(null)},rnd.Editor.SGroupTool=function(e){this.editor=e,this.maps=["atoms","bonds","sgroups","sgroupData"],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(1,e),this._sGroupHelper=new rnd.Editor.SGroupTool.SGroupHelper(e);var t=this.editor.getSelection();
t.atoms&&t.atoms.length>0?this._sGroupHelper.showPropertiesDialog(null,t):this.editor.deselectAll()},rnd.Editor.SGroupTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.SGroupTool.prototype.OnMouseDown=function(e){var t=this.editor.render.findItem(e,this.maps);t&&"Canvas"!=t.type||this._lassoHelper.begin(e)},rnd.Editor.SGroupTool.prototype.OnMouseMove=function(e){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(e)):this._hoverHelper.hover(this.editor.render.findItem(e,this.maps))},rnd.Editor.SGroupTool.SGroupHelper=function(e){this.editor=e,this.selection=null},rnd.Editor.SGroupTool.SGroupHelper.prototype.showPropertiesDialog=function(e,t){this.selection=t;var o=this.editor.render;if(null==e){var n={},r={};if(t.atoms.each(function(e){r[e]=!0},this),!Object.isUndefined(t.atoms.detect(function(e){var i=o.atomGetSGroups(e);return!Object.isUndefined(i.detect(function(e){if(e in n)return!1;var i=o.sGroupGetAtoms(e);if(i.length<t.atoms.length){if(!Object.isUndefined(i.detect(function(e){return!(e in r)},this)))return!0}else if(!Object.isUndefined(t.atoms.detect(function(e){return-1==i.indexOf(e)},this)))return!0;return!1},this))},this)))return alert("Partial S-group overlapping is not allowed."),void 0}ui.showSGroupProperties({type:null!==e?ui.render.sGroupGetType(e):null,attrs:null!==e?ui.render.sGroupGetAttrs(e):{},onCancel:function(){this.editor.deselectAll()}.bind(this),onOk:function(t){null==e?(e=ui.render.ctab.molecule.sgroups.newId(),ui.addUndoAction(Action.fromSgroupAddition(t.type,this.selection.atoms,t.attrs,e),!0)):ui.addUndoAction(Action.fromSgroupType(e,t.type).mergeWith(Action.fromSgroupAttrs(e,t.attrs)),!0),this.editor.deselectAll(),this.editor.render.update()}.bind(this)})},rnd.Editor.SGroupTool.prototype.OnMouseUp=function(e){var t=null,o=null;if(this._lassoHelper.running())o=this._lassoHelper.end(e);else{var n=this.editor.render.findItem(e,this.maps);if(!n||"Canvas"==n.type)return;if(this._hoverHelper.hover(null),"atoms"==n.map)o={atoms:[n.id]};else if("bonds"==n.map){var r=this.editor.render.ctab.bonds.get(n.id);o={atoms:[r.b.begin,r.b.end]}}else{if("sgroups"!=n.map)return;t=n.id}}(null!=t||o&&o.atoms&&o.atoms.length>0)&&this._sGroupHelper.showPropertiesDialog(t,o)},rnd.Editor.PasteTool=function(e,t){this.editor=e,this.struct=t,this.action=Action.fromPaste(this.struct,"lastEvent"in this.OnMouseMove0?ui.page2obj(this.OnMouseMove0.lastEvent):void 0),this.editor.render.update()},rnd.Editor.PasteTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.PasteTool.prototype.OnMouseMove=function(e){"action"in this&&this.action.perform(this.editor),this.action=Action.fromPaste(this.struct,ui.page2obj(e)),this.editor.render.update()},rnd.Editor.PasteTool.prototype.OnMouseUp=function(){ui.addUndoAction(this.action),delete this.action,ui.selectAction(null)},rnd.Editor.PasteTool.prototype.OnCancel=function(){"action"in this&&(this.action.perform(this.editor),delete this.action)},rnd.Editor.RotateTool=function(e){this.editor=e,this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(1,e);var t=this.editor._selectionHelper.selection;t.atoms&&t.atoms.length||this.editor._selectionHelper.setSelection(null)},rnd.Editor.RotateTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RotateTool.prototype.OnMouseDown=function(e){var t=this.editor._selectionHelper.selection;if(t.atoms&&t.atoms.length){var o=this.editor.render.ctab.molecule,n=new Vec2;if(!t.atoms||!t.atoms.length)return!0;var r=null,i=!1;t.atoms.each(function(e){var s=o.atoms.get(e);n.add_(s.pp),i||s.neighbors.find(function(n){var s=o.halfBonds.get(n);if(-1==t.atoms.indexOf(s.end)){if(s.loop>=0){var a=o.atoms.get(e);if(!Object.isUndefined(a.neighbors.find(function(e){var n=o.halfBonds.get(e);return n.loop>=0&&-1!=t.atoms.indexOf(n.end)})))return i=!0,!0}if(null==r)r=e;else if(r!=e)return i=!0,!0}return!1})}),n=i||null==r?n.scaled(1/t.atoms.length):o.atoms.get(r).pp,this.dragCtx={xy0:n,angle1:this._calcAngle(n,ui.page2obj(e)),all:i}}else this._lassoHelper.begin(e);return!0},rnd.Editor.RotateTool.prototype.OnMouseMove=function(e){if(this._lassoHelper.running())this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(e));else if("dragCtx"in this){var t=this.editor,o=t.render,n=this.dragCtx,r=ui.page2obj(e),i=this._calcAngle(n.xy0,r)-n.angle1,s=Math.round(180*(i/Math.PI));if(s>180?s-=360:-180>=s&&(s+=360),"angle"in n&&n.angle==s)return!0;"action"in n&&n.action.perform(),n.angle=s,n.action=Action.fromRotate(n.all?o.ctab.molecule:this.editor.getSelection(),n.xy0,i),$("toolText").update(s+"º"),o.update()}return!0},rnd.Editor.RotateTool.prototype.OnMouseUp=function(e){var t=null;return this._lassoHelper.running()?t=this._lassoHelper.end(e):"dragCtx"in this&&("action"in this.dragCtx?(ui.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")):this.editor._selectionHelper.setSelection(),delete this.dragCtx),!0},rnd.Editor.RotateTool.prototype.OnCancel=function(){"dragCtx"in this&&("action"in this.dragCtx&&(ui.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")),delete this.dragCtx)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../chem/element":10,"../ui":34,"../ui/action":26,"../util":39,"../util/set":42,"../util/vec2":43,"./restruct":23}],21:[function(require,module,exports){
(function (global){
require("./visel"),require("./restruct"),require("./editor"),require("./render"),require("./restruct_rendering"),global.rnd=global.rnd||{};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./editor":20,"./render":22,"./restruct":23,"./restruct_rendering":24,"./visel":25}],22:[function(require,module,exports){
(function (global){
var Raphael=require("../raphael-ext.js"),Box2Abs=require("../util/box2abs"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util");require("./restruct"),require("../ui"),require("../chem"),require("./restruct_rendering");var rnd=global.rnd=global.rnd||{},chem=global.chem=global.chem||{},ui=global.ui,tfx=util.tfx;rnd.DEBUG=!1,rnd.logcnt=0,rnd.logmouse=!1,rnd.hl=!1;var EventMap={mousemove:"mousemove",mousedown:"mousedown",mouseup:"mouseup"};rnd.logMethod=function(){},rnd.RenderDummy=function(e){this.clientArea=e=$(e),e.innerHTML="",this.paper=new Raphael(e),this.paper.rect(0,0,100,100).attr({fill:"#0F0",stroke:"none"}),this.setMolecule=function(){},this.update=function(){}},rnd.RenderOptions=function(e){e=e||{},this.showSelectionRegions=e.showSelectionRegions||!1,this.showAtomIds=e.showAtomIds||!1,this.showBondIds=e.showBondIds||!1,this.showHalfBondIds=e.showHalfBondIds||!1,this.showLoopIds=e.showLoopIds||!1,this.hideChiralFlag=e.hideChiralFlag||!1,this.showValenceWarnings=Object.isUndefined(e.showValenceWarnings)?!0:e.showValenceWarnings,this.autoScale=e.autoScale||!1,this.autoScaleMargin=e.autoScaleMargin||0,this.maxBondLength=e.maxBondLength||0,this.atomColoring=e.atomColoring||0,this.hideImplicitHydrogen=e.hideImplicitHydrogen||!1,this.hideTerminalLabels=e.hideTerminalLabels||!1,this.ignoreMouseEvents=e.ignoreMouseEvents||!1,this.selectionDistanceCoefficient=(e.selectionDistanceCoefficient||.4)-0},rnd.Render=function(e,t,n,r){this.opt=new rnd.RenderOptions(n),this.useOldZoom=Prototype.Browser.IE,this.scale=t||100,this.baseScale=this.scale,this.offset=new Vec2,this.clientArea=e=$(e),e.innerHTML="",this.paper=new Raphael(e),this.size=new Vec2,this.viewSz=r||new Vec2(e.clientWidth||100,e.clientHeight||100),this.bb=new Box2Abs(new Vec2,this.viewSz),this.dirty=!0,this.selectionRect=null,this.rxnArrow=null,this.rxnMode=!1,this.zoom=1,this.structChangeHandlers=[];var o=this,i=0,a=0,s=e;do i+=s.offsetTop||0,a+=s.offsetLeft||0,s=s.offsetParent;while(s);this.clientAreaPos=new Vec2(a,i);var l=this;l.longTapFlag=!1,l.longTapTimeout=null,l.longTapTouchstart=null,l.setLongTapTimeout=function(e){l.longTapFlag=!1,l.longTapTouchstart=e,l.longTapTimeout=setTimeout(function(){l.longTapFlag=!0,l.longTapTimeout=null},500)},l.resetLongTapTimeout=function(e){clearTimeout(l.longTapTimeout),l.longTapTimeout=null,e&&(l.longTapTouchstart=null,l.longTapFlag=!1)},"hiddenPaths"in rnd.ReStruct.prototype&&e.observe("touchend",function(e){if(0==e.touches.length)for(;rnd.ReStruct.prototype.hiddenPaths.length>0;)rnd.ReStruct.prototype.hiddenPaths.pop().remove()}),this.opt.ignoreMouseEvents||(e.observe("selectstart",function(e){return util.stopEventPropagation(e),util.preventDefault(e)}),e.observe("touchstart",function(e){l.resetLongTapTimeout(!0),2==e.touches.length?(this._tui=this._tui||{},this._tui.center={pageX:(e.touches[0].pageX+e.touches[1].pageX)/2,pageY:(e.touches[0].pageY+e.touches[1].pageY)/2},ui.setZoomStaticPointInit(ui.page2obj(this._tui.center))):1==e.touches.length&&l.setLongTapTimeout(e)}),e.observe("touchmove",function(e){l.resetLongTapTimeout(!0),"_tui"in this&&2==e.touches.length&&(this._tui.center={pageX:(e.touches[0].pageX+e.touches[1].pageX)/2,pageY:(e.touches[0].pageY+e.touches[1].pageY)/2})}),e.observe("gesturestart",function(e){this._tui=this._tui||{},this._tui.scale0=ui.render.zoom,e.preventDefault()}),e.observe("gesturechange",function(e){ui.setZoomStaticPoint(this._tui.scale0*e.scale,ui.page2canvas2(this._tui.center)),ui.render.update(),e.preventDefault()}),e.observe("gestureend",function(e){delete this._tui,e.preventDefault()}),e.observe("onresize",function(){o.onResize()}),["Click","DblClick","MouseDown","MouseMove","MouseUp","MouseLeave"].each(function(t){var n=t.toLowerCase();n=EventMap[n]||n,e.observe(n,function(r){if(!("MouseLeave"==t||ui&&ui.is_touch)){var o=e.cumulativeOffset();o=new Vec2(o[0],o[1]);var i=new Vec2(r.clientX,r.clientY).sub(o),a=new Vec2(e.clientWidth,e.clientHeight);if(!(i.x>0&&i.y>0&&i.x<a.x&&i.y<a.y))return"MouseMove"==t&&ui.render.current_tool.processEvent("OnMouseLeave",r),util.preventDefault(r)}return ui.render.current_tool.processEvent("On"+t,r),"MouseUp"!=t&&util.stopEventPropagation(r),"touchstart"==n||"touchmove"==n&&2==r.touches.length?void 0:util.preventDefault(r)})},this)),this.ctab=new rnd.ReStruct(new chem.Struct,this),this.settings=null,this.styles=null,this.onCanvasOffsetChanged=null,this.onCanvasSizeChanged=null},rnd.Render.prototype.addStructChangeHandler=function(e){if(e in this.structChangeHandlers)throw new Error("handler already present");this.structChangeHandlers.push(e)},rnd.Render.prototype.view2scaled=function(e,t){var n=ui.scrollPos();return this.useOldZoom||(e=e.scaled(1/this.zoom),n=n.scaled(1/this.zoom)),e=t?e:e.add(n).sub(this.offset)},rnd.Render.prototype.scaled2view=function(e,t){return e=t?e:e.add(this.offset).sub(ui.scrollPos().scaled(1/this.zoom)),this.useOldZoom||(e=e.scaled(this.zoom)),e},rnd.Render.prototype.scaled2obj=function(e){return e.scaled(1/this.settings.scaleFactor)},rnd.Render.prototype.obj2scaled=function(e){return e.scaled(this.settings.scaleFactor)},rnd.Render.prototype.view2obj=function(e,t){return this.scaled2obj(this.view2scaled(e,t))},rnd.Render.prototype.obj2view=function(e,t){return this.scaled2view(this.obj2scaled(e,t))},rnd.Render.prototype.findItem=function(e,t,n){var r=this.findClosestItem("ui"in window&&"page2obj"in ui?new Vec2(ui.page2obj(e)):new Vec2(e.pageX,e.pageY).sub(this.clientAreaPos),t,n);return"Atom"==r.type?r.map="atoms":"Bond"==r.type?r.map="bonds":"SGroup"==r.type?r.map="sgroups":"DataSGroupData"==r.type?r.map="sgroupData":"RxnArrow"==r.type?r.map="rxnArrows":"RxnPlus"==r.type?r.map="rxnPluses":"Fragment"==r.type?r.map="frags":"RGroup"==r.type?r.map="rgroups":"ChiralFlag"==r.type&&(r.map="chiralFlags"),r},rnd.Render.prototype.client2Obj=function(e){return new Vec2(e).sub(this.offset)},rnd.Render.prototype.setMolecule=function(e,t){rnd.logMethod("setMolecule"),this.paper.clear(),this.ctab=new rnd.ReStruct(e,this,t),this.offset=null,this.size=null,this.bb=null,this.rxnMode=e.isReaction},rnd.Render.prototype.atomGetAttr=function(e,t){return rnd.logMethod("atomGetAttr"),this.ctab.molecule.atoms.get(e)[t]},rnd.Render.prototype.invalidateAtom=function(e,t){var n=this.ctab.atoms.get(e);this.ctab.markAtom(e,t?1:0);for(var r=this.ctab.molecule.halfBonds,o=0;o<n.a.neighbors.length;++o){var i=n.a.neighbors[o];if(r.has(i)){var a=r.get(i);this.ctab.markBond(a.bid,1),this.ctab.markAtom(a.end,0),t&&this.invalidateLoop(a.bid)}}},rnd.Render.prototype.invalidateLoop=function(e){var t=this.ctab.bonds.get(e),n=this.ctab.molecule.halfBonds.get(t.b.hb1).loop,r=this.ctab.molecule.halfBonds.get(t.b.hb2).loop;n>=0&&this.ctab.loopRemove(n),r>=0&&this.ctab.loopRemove(r)},rnd.Render.prototype.invalidateBond=function(e){var t=this.ctab.bonds.get(e);this.invalidateLoop(e),this.invalidateAtom(t.b.begin,0),this.invalidateAtom(t.b.end,0)},rnd.Render.prototype.invalidateItem=function(e,t,n){"atoms"==e?this.invalidateAtom(t,n):"bonds"==e?(this.invalidateBond(t),n>0&&this.invalidateLoop(t)):this.ctab.markItem(e,t,n)},rnd.Render.prototype.atomGetDegree=function(e){return rnd.logMethod("atomGetDegree"),this.ctab.atoms.get(e).a.neighbors.length},rnd.Render.prototype.isBondInRing=function(e){var t=this.ctab.bonds.get(e);return this.ctab.molecule.halfBonds.get(t.b.hb1).loop>=0||this.ctab.molecule.halfBonds.get(t.b.hb2).loop>=0},rnd.Render.prototype.atomGetNeighbors=function(e){for(var t=this.ctab.atoms.get(e),n=[],r=0;r<t.a.neighbors.length;++r){var o=this.ctab.molecule.halfBonds.get(t.a.neighbors[r]);n.push({aid:o.end-0,bid:o.bid-0})}return n},rnd.Render.prototype.atomGetSGroups=function(e){rnd.logMethod("atomGetSGroups");var t=this.ctab.atoms.get(e);return Set.list(t.a.sgs)},rnd.Render.prototype.sGroupGetAttr=function(e,t){return rnd.logMethod("sGroupGetAttr"),this.ctab.sgroups.get(e).item.getAttr(t)},rnd.Render.prototype.sGroupGetAttrs=function(e){return rnd.logMethod("sGroupGetAttrs"),this.ctab.sgroups.get(e).item.getAttrs()},rnd.Render.prototype.sGroupGetAtoms=function(e){rnd.logMethod("sGroupGetAtoms");var t=this.ctab.sgroups.get(e).item;return chem.SGroup.getAtoms(this.ctab.molecule,t)},rnd.Render.prototype.sGroupGetType=function(e){rnd.logMethod("sGroupGetType");var t=this.ctab.sgroups.get(e).item;return t.type},rnd.Render.prototype.sGroupsFindCrossBonds=function(){rnd.logMethod("sGroupsFindCrossBonds"),this.ctab.molecule.sGroupsRecalcCrossBonds()},rnd.Render.prototype.sGroupGetNeighborAtoms=function(e){rnd.logMethod("sGroupGetNeighborAtoms");var t=this.ctab.sgroups.get(e).item;return t.neiAtoms},rnd.Render.prototype.atomIsPlainCarbon=function(e){return rnd.logMethod("atomIsPlainCarbon"),this.ctab.atoms.get(e).a.isPlainCarbon()},rnd.Render.prototype.highlightObject=function(e,t){if(!(["atoms","bonds","rxnArrows","rxnPluses","chiralFlags","frags","rgroups","sgroups","sgroupData"].indexOf(e.map)>-1))return!1;var n=this.ctab[e.map].get(e.id);if(null==n)return!0;if("sgroups"==e.map&&"DAT"==n.item.type||"sgroupData"==e.map){var r=this.ctab.sgroups.get(e.id),o=this.ctab.sgroupData.get(e.id);null!=r&&r.setHighlight(t,this),null!=o&&o.setHighlight(t,this)}else n.setHighlight(t,this);return!0},rnd.Render.prototype.itemGetPos=function(e,t){return this.ctab.molecule[e].get(t).pp},rnd.Render.prototype.atomGetPos=function(e){return rnd.logMethod("atomGetPos"),this.itemGetPos("atoms",e)},rnd.Render.prototype.rxnArrowGetPos=function(e){return rnd.logMethod("rxnArrowGetPos"),this.itemGetPos("rxnArrows",e)},rnd.Render.prototype.rxnPlusGetPos=function(e){return rnd.logMethod("rxnPlusGetPos"),this.itemGetPos("rxnPluses",e)},rnd.Render.prototype.getAdjacentBonds=function(e){for(var t=Set.fromList(e),n=Set.empty(),r=Set.empty(),o=0;o<e.length;++o)for(var i=e[o],a=this.ctab.atoms.get(i),s=0;s<a.a.neighbors.length;++s){var l=a.a.neighbors[s],c=this.ctab.molecule.halfBonds.get(l),u=c.end,d=Set.contains(t,u)?n:r;Set.add(d,c.bid)}return{inner:n,cross:r}},rnd.Render.prototype.bondGetAttr=function(e,t){return rnd.logMethod("bondGetAttr"),this.ctab.bonds.get(e).b[t]},rnd.Render.prototype.setSelection=function(e){rnd.logMethod("setSelection");for(var t in rnd.ReStruct.maps)if(rnd.ReStruct.maps[t].isSelectable()){var n=e?e[t]?util.identityMap(e[t]):{}:null;this.ctab[t].each(function(e,t){var r=n?n[e]===e:t.selected;t.selected=r,this.ctab.showItemSelection(e,t,r)},this)}},rnd.Render.prototype.initStyles=function(){var e=this.settings;this.styles={},this.styles.lineattr={stroke:"#000","stroke-width":e.lineWidth,"stroke-linecap":"round","stroke-linejoin":"round"},this.styles.selectionStyle={fill:"#7f7",stroke:"none"},this.styles.selectionZoneStyle={fill:"#000",stroke:"none",opacity:0},this.styles.highlightStyle={stroke:"#0c0","stroke-width":.6*e.lineWidth},this.styles.sGroupHighlightStyle={stroke:"#9900ff","stroke-width":.6*e.lineWidth},this.styles.sgroupBracketStyle={stroke:"darkgray","stroke-width":.5*e.lineWidth},this.styles.atomSelectionPlateRadius=1.2*e.labelFontSize},rnd.Render.prototype.initSettings=function(){var e=this.settings={};e.delta=this.ctab.molecule.getCoordBoundingBox(),e.margin=.1,e.scaleFactor=this.scale,e.lineWidth=e.scaleFactor/20,e.bondShift=e.scaleFactor/6,e.bondSpace=e.scaleFactor/7,e.labelFontSize=Math.ceil(1.9*(e.scaleFactor/6)),e.subFontSize=Math.ceil(.7*e.labelFontSize),e.font='30px "Arial"',e.fontsz=this.settings.labelFontSize,e.fontszsub=this.settings.subFontSize,e.fontRLabel=1.2*this.settings.labelFontSize,e.fontRLogic=.7*this.settings.labelFontSize},rnd.Render.prototype.getStructCenter=function(e){var t=this.ctab.getVBoxObj(e);return Vec2.lc2(t.p0,.5,t.p1,.5)},rnd.Render.prototype.onResize=function(){this.setViewSize(new Vec2(this.clientArea.clientWidth,this.clientArea.clientHeight))},rnd.Render.prototype.setViewSize=function(e){this.viewSz=new Vec2(e)},rnd.Render.prototype._setPaperSize=function(e){var t=this.zoom;this.paper.setSize(e.x*t,e.y*t),this.setViewBox(t)},rnd.Render.prototype.setPaperSize=function(e){rnd.logMethod("setPaperSize");var t=this.sz;this.sz=e,this._setPaperSize(e),this.onCanvasSizeChanged&&this.onCanvasSizeChanged(e,t)},rnd.Render.prototype.setOffset=function(e){rnd.logMethod("setOffset"),this.onCanvasOffsetChanged&&this.onCanvasOffsetChanged(e,this.offset),this.offset=e},rnd.Render.prototype.getElementPos=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return new Vec2(t,n)},rnd.Render.prototype.drawSelectionLine=function(e,t){rnd.logMethod("drawSelectionLine"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),e&&t&&(e=this.obj2scaled(e).add(this.offset),t=this.obj2scaled(t).add(this.offset),this.selectionRect=this.paper.path(rnd.ReStruct.makeStroke(e,t)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.drawSelectionRectangle=function(e,t){rnd.logMethod("drawSelectionRectangle"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),e&&t&&(e=this.obj2scaled(e).add(this.offset),t=this.obj2scaled(t).add(this.offset),this.selectionRect=this.paper.rect(Math.min(e.x,t.x),Math.min(e.y,t.y),Math.abs(t.x-e.x),Math.abs(t.y-e.y)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.getElementsInRectangle=function(e,t){rnd.logMethod("getElementsInRectangle");var n=[],r=[],o=Math.min(e.x,t.x),i=Math.max(e.x,t.x),a=Math.min(e.y,t.y),s=Math.max(e.y,t.y);this.ctab.bonds.each(function(e,t){var r=Vec2.lc2(this.ctab.atoms.get(t.b.begin).a.pp,.5,this.ctab.atoms.get(t.b.end).a.pp,.5);r.x>o&&r.x<i&&r.y>a&&r.y<s&&n.push(e)},this),this.ctab.atoms.each(function(e,t){t.a.pp.x>o&&t.a.pp.x<i&&t.a.pp.y>a&&t.a.pp.y<s&&r.push(e)},this);var l=[],c=[];this.ctab.rxnArrows.each(function(e,t){t.item.pp.x>o&&t.item.pp.x<i&&t.item.pp.y>a&&t.item.pp.y<s&&l.push(e)},this),this.ctab.rxnPluses.each(function(e,t){t.item.pp.x>o&&t.item.pp.x<i&&t.item.pp.y>a&&t.item.pp.y<s&&c.push(e)},this);var u=[];this.ctab.chiralFlags.each(function(e,t){t.pp.x>o&&t.pp.x<i&&t.pp.y>a&&t.pp.y<s&&u.push(e)},this);var d=[];return this.ctab.sgroupData.each(function(e,t){t.sgroup.pp.x>o&&t.sgroup.pp.x<i&&t.sgroup.pp.y>a&&t.sgroup.pp.y<s&&d.push(e)},this),{atoms:r,bonds:n,rxnArrows:l,rxnPluses:c,chiralFlags:u,sgroupData:d}},rnd.Render.prototype.drawSelectionPolygon=function(e){if(rnd.logMethod("drawSelectionPolygon"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),e&&e.length>1){for(var t=this.obj2scaled(e[e.length-1]).add(this.offset),n="M"+tfx(t.x)+","+tfx(t.y),r=0;r<e.length;++r)t=this.obj2scaled(e[r]).add(this.offset),n+="L"+tfx(t.x)+","+tfx(t.y);this.selectionRect=this.paper.path(n).attr({stroke:"gray","stroke-width":"1px"})}},rnd.Render.prototype.isPointInPolygon=function(e,t){for(var n=new Vec2(0,1),r=n.rotate(Math.PI/2),o=Vec2.diff(e[e.length-1],t),i=Vec2.dot(r,o),a=Vec2.dot(n,o),s=null,l=0,c=1e-5,u=!1,d=!1,p=0;p<e.length;++p){var h=Vec2.diff(e[p],t),f=Vec2.diff(h,o),m=Vec2.dot(r,h),g=Vec2.dot(n,h);u=!1,0>m*i&&(g*a>-c?a>-c&&(u=!0):(Math.abs(i)*Math.abs(g)-Math.abs(m)*Math.abs(a))*g>0&&(u=!0)),u&&d&&Vec2.dot(f,r)*Vec2(s,r)>=0&&(u=!1),u&&l++,o=h,i=m,a=g,s=f,d=u}return 0!=l%2},rnd.Render.prototype.ps=function(e){return e.scaled(this.settings.scaleFactor)},rnd.Render.prototype.getElementsInPolygon=function(e){rnd.logMethod("getElementsInPolygon");for(var t=[],n=[],r=[],o=0;o<e.length;++o)r[o]=new Vec2(e[o].x,e[o].y);this.ctab.bonds.each(function(e,n){var o=Vec2.lc2(this.ctab.atoms.get(n.b.begin).a.pp,.5,this.ctab.atoms.get(n.b.end).a.pp,.5);this.isPointInPolygon(r,o)&&t.push(e)},this),this.ctab.atoms.each(function(e,t){this.isPointInPolygon(r,t.a.pp)&&n.push(e)},this);var i=[],a=[];this.ctab.rxnArrows.each(function(e,t){this.isPointInPolygon(r,t.item.pp)&&i.push(e)},this),this.ctab.rxnPluses.each(function(e,t){this.isPointInPolygon(r,t.item.pp)&&a.push(e)},this);var s=[];this.ctab.chiralFlags.each(function(e,t){this.isPointInPolygon(r,t.pp)&&s.push(e)},this);var l=[];return this.ctab.sgroupData.each(function(e,t){this.isPointInPolygon(r,t.sgroup.pp)&&l.push(e)},this),{atoms:n,bonds:t,rxnArrows:i,rxnPluses:a,chiralFlags:s,sgroupData:l}},rnd.Render.prototype.testPolygon=function(e){if(e=e||[{x:50,y:10},{x:20,y:90},{x:90,y:30},{x:10,y:30},{x:90,y:80}],!(e.length<3)){for(var t=e[0],n=e[0],r=1;r<e.length;++r)t=Vec2.min(t,e[r]),n=Vec2.max(n,e[r]);this.drawSelectionPolygon(e);for(var o=10,i=0;1e3>i;++i){var a=new Vec2(Math.random()*o,Math.random()*o),s=this.isPointInPolygon(e,a),l=s?"#0f0":"#f00";this.paper.circle(a.x,a.y,2).attr({fill:l,stroke:"none"})}this.drawSelectionPolygon(e)}},rnd.Render.prototype.update=function(e){if(rnd.logMethod("update"),!this.settings||this.dirty){if(this.opt.autoScale){var t=this.ctab.molecule.getCoordBoundingBox(),n=t.max.y-t.min.y>0?.8*this.viewSz.y/(t.max.y-t.min.y):100,r=t.max.x-t.min.x>0?.8*this.viewSz.x/(t.max.x-t.min.x):100;this.scale=Math.min(n,r),this.opt.maxBondLength>0&&this.scale>this.opt.maxBondLength&&(this.scale=this.opt.maxBondLength)}this.initSettings(),this.initStyles(),this.dirty=!1,e=!0}var o=(new Date).getTime(),i=this.ctab.update(e);this.setSelection(null);var a=(new Date).getTime()-o;if(e&&$("log")&&($("log").innerHTML=a.toString()+"\n"),i){var s=this.settings.scaleFactor,l=this.ctab.getVBoxObj().transform(this.obj2scaled,this).translate(this.offset||new Vec2);if(this.opt.autoScale){var c=l.sz(),u=this.opt.autoScaleMargin,d=new Vec2(u,u),p=this.viewSz;if(p.x<2*u+1||p.y<2*u+1)throw new Error("View box too small for the given margin");var h=Math.max(c.x/(p.x-2*u),c.y/(p.y-2*u));this.opt.maxBondLength/h>1&&(h=1);var f=c.add(d.scaled(2*h));this.paper.setViewBox(l.pos().x-u*h-(p.x*h-f.x)/2,l.pos().y-u*h-(p.y*h-f.y)/2,p.x*h,p.y*h)}else{var m=Vec2.UNIT.scaled(s),g=l.sz().length()>0?l.extend(m,m):l;console.assert(ui.zoom==this.zoom);var b=new Box2Abs(ui.scrollPos(),this.viewSz.scaled(1/ui.zoom).sub(Vec2.UNIT.scaled(20))),v=Box2Abs.union(b,g);this.oldCb||(this.oldCb=new Box2Abs);var y=v.sz().floor(),w=this.oldCb.p0.sub(v.p0).ceil();this.oldBb=l,this.sz&&y.x==this.sz.x&&y.y==this.sz.y||this.setPaperSize(y),this.offset=this.offset||new Vec2,(0!=w.x||0!=w.y)&&(this.setOffset(this.offset.add(w)),this.ctab.translate(w))}}},rnd.Render.prototype.checkBondExists=function(e,t){return this.ctab.molecule.checkBondExists(e,t)},rnd.Render.prototype.findClosestAtom=function(e,t,n){var r=null,o=this.opt.selectionDistanceCoefficient;return t=t||o,t=Math.min(t,o),this.ctab.atoms.each(function(o,i){if(o!=n){var a=Vec2.dist(e,i.a.pp);t>a&&(r=o,t=a)}},this),null!=r?{id:r,dist:t}:null},rnd.Render.prototype.findClosestBond=function(e,t){var n=null,r=null,o=this.opt.selectionDistanceCoefficient;t=t||o,t=Math.min(t,o);var i=t;return this.ctab.bonds.each(function(t,n){var o=this.ctab.atoms.get(n.b.begin).a.pp,a=this.ctab.atoms.get(n.b.end).a.pp,s=Vec2.lc2(o,.5,a,.5),l=Vec2.dist(e,s);i>l&&(i=l,r=t)},this),this.ctab.bonds.each(function(r,o){var i=this.ctab.molecule.halfBonds.get(o.b.hb1),a=i.dir,s=i.norm,l=this.ctab.atoms.get(o.b.begin).a.pp,c=this.ctab.atoms.get(o.b.end).a.pp,u=Vec2.dot(e.sub(l),a)*Vec2.dot(e.sub(c),a)<0;if(u){var d=Math.abs(Vec2.dot(e.sub(l),s));t>d&&(n=r,t=d)}},this),null!==n||null!==r?{id:n,dist:t,cid:r,cdist:i}:null},rnd.Render.prototype.findClosestItem=function(e,t,n){var r=null,o=function(e,t,n){null!=t&&(null==r||r.dist>t.dist||n)&&(r={type:e,id:t.id,dist:t.dist})};if(!t||t.indexOf("atoms")>=0){var i=this.findClosestAtom(e,void 0,Object.isUndefined(n)||"atoms"!=n.map?void 0:n.id);o("Atom",i)}if(!t||t.indexOf("bonds")>=0){var a=this.findClosestBond(e);a&&(null!==a.cid&&o("Bond",{id:a.cid,dist:a.cdist}),(null==r||r.dist>.4*this.scale)&&o("Bond",a))}if(!t||t.indexOf("chiralFlags")>=0){var s=rnd.ReChiralFlag.findClosest(this,e);o("ChiralFlag",s)}if(!t||t.indexOf("sgroupData")>=0){var l=rnd.ReDataSGroupData.findClosest(this,e);o("DataSGroupData",l)}if(!t||t.indexOf("sgroups")>=0){var c=rnd.ReSGroup.findClosest(this,e);o("SGroup",c)}if(!t||t.indexOf("rxnArrows")>=0){var u=rnd.ReRxnArrow.findClosest(this,e);o("RxnArrow",u)}if(!t||t.indexOf("rxnPluses")>=0){var d=rnd.ReRxnPlus.findClosest(this,e);o("RxnPlus",d)}if(!t||t.indexOf("frags")>=0){var p=rnd.ReFrag.findClosest(this,e,n&&"atoms"==n.map?n.id:void 0);o("Fragment",p)}if(!t||t.indexOf("rgroups")>=0){var h=rnd.ReRGroup.findClosest(this,e);o("RGroup",h)}return r=r||{type:"Canvas",id:-1}},rnd.Render.prototype.setZoom=function(e){this.zoom=e,this._setPaperSize(this.sz)},rnd.Render.prototype.extendCanvas=function(e,t,n,r){var o=0,i=0,a=0,s=0;e-=0,n-=0,t-=0,r-=0,0>e&&(o+=-e,a+=-e),0>t&&(i+=-t,s+=-t);var l=this.sz.x*this.zoom,c=this.sz.y*this.zoom;n>l&&(o+=n-l),r>c&&(i+=r-c);var u=new Vec2(a,s).scaled(1/this.zoom);if(i>0||o>0){var d=new Vec2(o,i).scaled(1/this.zoom),p=this.sz.add(d);this.setPaperSize(p),(u.x>0||u.y>0)&&(this.ctab.translate(u),this.setOffset(this.offset.add(u)))}return u},rnd.Render.prototype.setScale=function(e){this.offset&&(this.offset=this.offset.scaled(1/e).scaled(this.zoom)),this.scale=this.baseScale*this.zoom,this.settings=null,this.update(!0)},rnd.Render.prototype.setViewBox=function(e){this.useOldZoom?this.setScale(e):this.paper.canvas.setAttribute("viewBox","0 0 "+this.sz.x+" "+this.sz.y)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../raphael-ext.js":19,"../ui":34,"../util":39,"../util/box2abs":38,"../util/set":42,"../util/vec2":43,"./restruct":23,"./restruct_rendering":24}],23:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Map=require("../util/map"),Pool=require("../util/pool"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),element=require("../chem/element");require("../chem");var rnd=global.rnd=global.rnd||{},chem=global.chem,tfx=util.tfx;rnd.ReObject=function(){this.__ext=new Vec2(.05*3,.05*3)},rnd.ReObject.prototype.init=function(e){this.visel=new rnd.Visel(e),this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null},rnd.ReObject.prototype.getVBoxObj=function(e){var t=this.visel.boundingBox;return util.isNull(t)?null:(e.offset&&(t=t.translate(e.offset.negated())),t.transform(e.scaled2obj,e))},rnd.ReObject.prototype.drawHighlight=function(){console.log("ReObject.drawHighlight is not overridden")},rnd.ReObject.prototype.setHighlight=function(e,t){if(e){var n="highlighting"in this&&null!=this.highlighting;n&&(n="set"==this.highlighting.type?!this.highlighting[0].removed:!this.highlighting.removed),n=n&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(this.highlighting)<0),n?this.highlighting.show():(t.paper.setStart(),this.drawHighlight(t),this.highlighting=t.paper.setFinish())}else this.highlighting&&this.highlighting.hide();this.highlight=e},rnd.ReObject.prototype.makeSelectionPlate=function(){console.log("ReObject.makeSelectionPlate is not overridden")},rnd.ReAtom=function(e){this.init(rnd.Visel.TYPE.ATOM),this.a=e,this.showLabel=!1,this.hydrogenOnTheLeft=!1,this.component=-1},rnd.ReAtom.prototype=new rnd.ReObject,rnd.ReAtom.isSelectable=function(){return!0},rnd.ReAtom.prototype.getVBoxObj=function(e){return this.visel.boundingBox?rnd.ReObject.prototype.getVBoxObj.call(this,e):new Box2Abs(this.a.pp,this.a.pp)},rnd.ReAtom.prototype.drawHighlight=function(e){var t=this.makeHighlightPlate(e);return e.ctab.addReObjectPath("highlighting",this.visel,t),t},rnd.ReAtom.prototype.makeHighlightPlate=function(e){var t=e.paper,n=e.styles,r=e.ps(this.a.pp);return t.circle(r.x,r.y,n.atomSelectionPlateRadius).attr(n.highlightStyle)},rnd.ReAtom.prototype.makeSelectionPlate=function(e,t,n){var r=e.render.ps(this.a.pp);return t.circle(r.x,r.y,n.atomSelectionPlateRadius).attr(n.selectionStyle)},rnd.ReBond=function(e){this.init(rnd.Visel.TYPE.BOND),this.b=e,this.doubleBondShift=0},rnd.ReBond.prototype=new rnd.ReObject,rnd.ReBond.isSelectable=function(){return!0},rnd.ReBond.prototype.drawHighlight=function(e){var t=this.makeHighlightPlate(e);return e.ctab.addReObjectPath("highlighting",this.visel,t),t},rnd.ReBond.prototype.makeHighlightPlate=function(e){e.ctab.bondRecalc(e.settings,this);var t=e.ps(this.b.center);return e.paper.circle(t.x,t.y,.8*e.styles.atomSelectionPlateRadius).attr(e.styles.highlightStyle)},rnd.ReBond.prototype.makeSelectionPlate=function(e,t,n){e.bondRecalc(e.render.settings,this);var r=e.render.ps(this.b.center);return t.circle(r.x,r.y,.8*n.atomSelectionPlateRadius).attr(n.selectionStyle)},rnd.ReStruct=function(e,t,n){this.render=t,this.atoms=new Map,this.bonds=new Map,this.reloops=new Map,this.rxnPluses=new Map,this.rxnArrows=new Map,this.frags=new Map,this.rgroups=new Map,this.sgroups=new Map,this.sgroupData=new Map,this.chiralFlags=new Map,this.molecule=e||new chem.Struct,this.initialized=!1,this.layers=[],this.initLayers(),this.connectedComponents=new Pool,this.ccFragmentType=new Map;for(var r in rnd.ReStruct.maps)this[r+"Changed"]={};if(this.structChanged=!1,e.atoms.each(function(e,t){this.atoms.set(e,new rnd.ReAtom(t))},this),e.bonds.each(function(e,t){this.bonds.set(e,new rnd.ReBond(t))},this),e.loops.each(function(e,t){this.reloops.set(e,new rnd.ReLoop(t))},this),e.rxnPluses.each(function(e,t){this.rxnPluses.set(e,new rnd.ReRxnPlus(t))},this),e.rxnArrows.each(function(e,t){this.rxnArrows.set(e,new rnd.ReRxnArrow(t))},this),e.frags.each(function(e,t){this.frags.set(e,new rnd.ReFrag(t))},this),e.rgroups.each(function(e,t){this.rgroups.set(e,new rnd.ReRGroup(t))},this),e.sgroups.each(function(e,t){this.sgroups.set(e,new rnd.ReSGroup(t)),"DAT"!=t.type||t.data.attached||this.sgroupData.set(e,new rnd.ReDataSGroupData(t))},this),e.isChiral&&!this.render.opt.hideChiralFlag){var o=e.getCoordBoundingBox();this.chiralFlags.set(0,new rnd.ReChiralFlag(new Vec2(o.max.x,o.min.y-1)))}this.coordProcess(n)},rnd.ReStruct.prototype.connectedComponentRemoveAtom=function(e,t){if(t=t||this.atoms.get(e),!(t.component<0)){var n=this.connectedComponents.get(t.component);Set.remove(n,e),Set.size(n)<1&&this.connectedComponents.remove(t.component),t.component=-1}},rnd.ReStruct.prototype.printConnectedComponents=function(){var e=[];this.connectedComponents.each(function(t,n){e.push(" "+t+":["+Set.list(n).toString()+"]."+Set.size(n).toString())},this),console.log(e.toString())},rnd.ReStruct.prototype.clearConnectedComponents=function(){this.connectedComponents.clear(),this.atoms.each(function(e,t){t.component=-1})},rnd.ReStruct.prototype.getConnectedComponent=function(e,t){for(var n="number"==typeof e.length?util.array(e):[e],r=Set.empty();n.length>0;)!function(){var e=n.pop();Set.add(r,e);var o=this.atoms.get(e);o.component>=0&&Set.add(t,o.component);for(var i=0;i<o.a.neighbors.length;++i){var a=this.molecule.halfBonds.get(o.a.neighbors[i]).end;Set.contains(r,a)||n.push(a)}}.apply(this);return r},rnd.ReStruct.prototype.addConnectedComponent=function(e){var t=this.connectedComponents.add(e),n=Set.empty(),r=this.getConnectedComponent(Set.list(e),n);Set.remove(n,t);var o=-1;return Set.each(r,function(e){var n=this.atoms.get(e);if(n.component=t,-1!=n.a.rxnFragmentType){if(-1!=o&&n.a.rxnFragmentType!=o)throw new Error("reaction fragment type mismatch");o=n.a.rxnFragmentType}},this),this.ccFragmentType.set(t,o),t},rnd.ReStruct.prototype.removeConnectedComponent=function(e){return Set.each(this.connectedComponents.get(e),function(e){this.atoms.get(e).component=-1},this),this.connectedComponents.remove(e)},rnd.ReStruct.prototype.connectedComponentMergeIn=function(e,t){Set.each(t,function(t){this.atoms.get(t).component=e},this),Set.mergeIn(this.connectedComponents.get(e),t)},rnd.ReStruct.prototype.assignConnectedComponents=function(){this.atoms.each(function(e,t){if(!(t.component>=0)){var n=Set.empty(),r=this.getConnectedComponent(e,n);Set.each(n,function(e){this.removeConnectedComponent(e)},this),this.addConnectedComponent(r)}},this)},rnd.ReStruct.prototype.connectedComponentGetBoundingBox=function(e,t,n){return t=t||this.connectedComponents.get(e),n=n||{min:null,max:null},Set.each(t,function(e){var t=this.render.ps(this.atoms.get(e).a.pp);null==n.min?n.min=n.max=t:(n.min=n.min.min(t),n.max=n.max.max(t))},this),n},rnd.ReStruct.prototype.initLayers=function(){for(var e in rnd.ReStruct.layerMap)this.layers[rnd.ReStruct.layerMap[e]]=this.render.paper.rect(0,0,10,10).attr({fill:"#000",opacity:"0.0"}).toFront()},rnd.ReStruct.prototype.insertInLayer=function(e,t){t.insertBefore(this.layers[e])},rnd.ReStruct.prototype.clearMarks=function(){for(var e in rnd.ReStruct.maps)this[e+"Changed"]={};this.structChanged=!1},rnd.ReStruct.prototype.markItemRemoved=function(){this.structChanged=!0},rnd.ReStruct.prototype.markBond=function(e,t){this.markItem("bonds",e,t)},rnd.ReStruct.prototype.markAtom=function(e,t){this.markItem("atoms",e,t)},rnd.ReStruct.prototype.markItem=function(e,t,n){var r=this[e+"Changed"];r[t]="undefined"!=typeof r[t]?Math.max(n,r[t]):n,this[e].has(t)&&this.clearVisel(this[e].get(t).visel)},rnd.ReStruct.prototype.eachVisel=function(e,t){for(var n in rnd.ReStruct.maps)this[n].each(function(n,r){e.call(t,r.visel)},this)},rnd.ReStruct.prototype.getVBoxObj=function(e){if(e=e||{},this.selectionIsEmpty(e))for(var t in rnd.ReStruct.maps)e[t]=this[t].keys();var n=null;for(var t in rnd.ReStruct.maps)e[t]&&util.each(e[t],function(e){var r=this[t].get(e).getVBoxObj(this.render);r&&(n=n?Box2Abs.union(n,r):r.clone())},this);return n=n||new Box2Abs(0,0,0,0)},rnd.ReStruct.prototype.selectionIsEmpty=function(e){if(util.assert(!util.isUndefined(e),"'selection' is not defined"),util.isNull(e))return!0;for(var t in rnd.ReStruct.maps)if(e[t]&&e[t].length>0)return!1;return!0},rnd.ReStruct.prototype.translate=function(e){this.eachVisel(function(t){t.translate(e)},this)},rnd.ReStruct.prototype.scale=function(e){this.eachVisel(function(t){this.scaleVisel(t,e)},this)},rnd.ReStruct.prototype.scaleRPath=function(e,t){if("set"==e.type)for(var n=0;n<e.length;++n)this.scaleRPath(e[n],t);else Object.isUndefined(e.attrs)||("font-size"in e.attrs?e.attr("font-size",e.attrs["font-size"]*t):"stroke-width"in e.attrs&&e.attr("stroke-width",e.attrs["stroke-width"]*t)),e.scale(t,t,0,0)},rnd.ReStruct.prototype.scaleVisel=function(e,t){for(var n=0;n<e.paths.length;++n)this.scaleRPath(e.paths[n],t)},rnd.ReStruct.prototype.clearVisels=function(){this.eachVisel(function(e){this.clearVisel(e)},this)},rnd.ReStruct.prototype.findIncomingStereoUpBond=function(e,t,n){return util.findIndex(e.neighbors,function(e){var r=this.molecule.halfBonds.get(e),o=r.bid;if(o===t)return!1;var i=this.bonds.get(o);return i.b.type===chem.Struct.BOND.TYPE.SINGLE&&i.b.stereo===chem.Struct.BOND.STEREO.UP?i.b.end===r.begin||i.boldStereo&&n:i.b.type===chem.Struct.BOND.TYPE.DOUBLE&&i.b.stereo===chem.Struct.BOND.STEREO.NONE&&n&&i.boldStereo?!0:!1},this)},rnd.ReStruct.prototype.checkStereoBold=function(e,t){var n=util.map([t.b.begin,t.b.end],function(t){var n=this.molecule.atoms.get(t),r=this.findIncomingStereoUpBond(n,e,!1);return 0>r?-1:n.neighbors[r]},this);util.assert(2===n.length),t.boldStereo=n[0]>=0&&n[1]>=0},rnd.ReStruct.prototype.findIncomingUpBonds=function(e,t){var n=util.map([t.b.begin,t.b.end],function(t){var n=this.molecule.atoms.get(t),r=this.findIncomingStereoUpBond(n,e,!0);return 0>r?-1:n.neighbors[r]},this);util.assert(2===n.length),t.neihbid1=this.atoms.get(t.b.begin).showLabel?-1:n[0],t.neihbid2=this.atoms.get(t.b.end).showLabel?-1:n[1]},rnd.ReStruct.prototype.checkStereoBoldBonds=function(){this.bonds.each(this.checkStereoBold,this)},rnd.ReStruct.prototype.update=function(e){e=e||!this.initialized;var t;e?function(){for(var e in rnd.ReStruct.maps){var t=this[e+"Changed"];this[e].each(function(e){t[e]=1},this)}}.call(this):function(){for(var e in rnd.ReStruct.maps){var n=this[e+"Changed"];for(t in n)this[e].has(t)||delete n[t]}}.call(this);for(t in this.atomsChanged)this.connectedComponentRemoveAtom(t);for(var n=this.frags.findAll(function(e,t){return!t.calcBBox(this.render,e)},this),r=0;r<n.length;++r){var o=n[r];this.clearVisel(this.frags.get(o).visel),this.frags.unset(o),this.molecule.frags.remove(o)}!function(){for(var e in rnd.ReStruct.maps){var n=this[e+"Changed"];for(t in n)this.clearVisel(this[e].get(t).visel),this.structChanged|=n[t]>0}}.call(this),this.structChanged&&util.each(this.render.structChangeHandlers,function(e){e.call()}),this.sgroups.each(function(e,t){this.clearVisel(t.visel),t.highlighting=null,t.selectionPlate=null},this),this.frags.each(function(e,t){this.clearVisel(t.visel)},this),this.rgroups.each(function(e,t){this.clearVisel(t.visel)},this),e&&(this.clearConnectedComponents(),this.molecule.initHalfBonds(),this.molecule.initNeighbors()),this.molecule.updateHalfBonds(new Map(this.atomsChanged).findAll(function(e,t){return t>=0},this)),this.molecule.sortNeighbors(new Map(this.atomsChanged).findAll(function(e,t){return t>=1},this)),this.assignConnectedComponents(),this.setImplicitHydrogen(),this.setHydrogenPos(),this.initialized=!0,this.verifyLoops();var i=e||this.structChanged;return i&&this.updateLoops(),this.setDoubleBondShift(),this.checkLabelsToShow(),this.checkStereoBoldBonds(),this.showLabels(),this.showBonds(),i&&this.renderLoops(),this.drawReactionSymbols(),this.drawSGroups(),this.drawFragments(),this.drawRGroups(),this.chiralFlags.each(function(e,t){this.chiralFlagsChanged[e]>0&&t.draw(this.render)},this),this.clearMarks(),!0},rnd.ReStruct.prototype.drawReactionSymbols=function(){var e,t;for(t in this.rxnArrowsChanged)e=this.rxnArrows.get(t),this.drawReactionArrow(t,e);for(t in this.rxnPlusesChanged)e=this.rxnPluses.get(t),this.drawReactionPlus(t,e)},rnd.ReStruct.prototype.drawReactionArrow=function(e,t){var n=this.render.ps(t.item.pp),r=this.drawArrow(new Vec2(n.x-this.render.scale,n.y),new Vec2(n.x+this.render.scale,n.y));t.visel.add(r,Box2Abs.fromRelBox(rnd.relBox(r.getBBox())));var o=this.render.offset;null!=o&&r.translateAbs(o.x,o.y)},rnd.ReStruct.prototype.drawReactionPlus=function(e,t){var n=this.render.ps(t.item.pp),r=this.drawPlus(n);t.visel.add(r,Box2Abs.fromRelBox(rnd.relBox(r.getBBox())));var o=this.render.offset;null!=o&&r.translateAbs(o.x,o.y)},rnd.ReStruct.prototype.drawSGroups=function(){util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(e){var t=this.sgroups.get(e),n=t.draw(this.render);this.addReObjectPath("data",t.visel,n,null,!0),t.setHighlight(t.highlight,this.render)},this)},rnd.ReStruct.prototype.drawFragments=function(){this.frags.each(function(e,t){var n=t.draw(this.render,e);n&&this.addReObjectPath("data",t.visel,n,null,!0)},this)},rnd.ReStruct.prototype.drawRGroups=function(){this.rgroups.each(function(e,t){var n=t.draw(this.render);for(var r in n)for(;n[r].length>0;)this.addReObjectPath(r,t.visel,n[r].shift(),null,!0)},this)},rnd.ReStruct.prototype.eachCC=function(e,t,n){this.connectedComponents.each(function(r,o){t&&this.ccFragmentType.get(r)!=t||e.call(n||this,r,o)},this)},rnd.ReStruct.prototype.getGroupBB=function(e){var t={min:null,max:null};return this.eachCC(function(e,n){t=this.connectedComponentGetBoundingBox(e,n,t)},e,this),t},rnd.ReStruct.prototype.setHydrogenPos=function(){for(var e in this.atomsChanged){var t=this.atoms.get(e);if(0!=t.a.neighbors.length){for(var n=1,r=1,o=0,i=0,a=0;a<t.a.neighbors.length;++a){var s=this.molecule.halfBonds.get(t.a.neighbors[a]).dir;s.x<=0?(n=Math.min(n,Math.abs(s.y)),o++):(r=Math.min(r,Math.abs(s.y)),i++)}t.hydrogenOnTheLeft=.51>n||.51>r?n>r:i>o}else{var l=element.getElementByLabel(t.a.label);null!=l&&(t.hydrogenOnTheLeft=element.get(l).putHydrogenOnTheLeft)}}},rnd.ReStruct.prototype.setImplicitHydrogen=function(){this.molecule.setImplicitHydrogen(util.idList(this.atomsChanged))},rnd.ReLoop=function(e){this.loop=e,this.visel=new rnd.Visel(rnd.Visel.TYPE.LOOP),this.centre=new Vec2,this.radius=new Vec2},rnd.ReLoop.prototype=new rnd.ReObject,rnd.ReLoop.isSelectable=function(){return!1},rnd.ReStruct.prototype.coordProcess=function(e){e||this.molecule.rescale()},rnd.ReStruct.prototype.notifyAtomAdded=function(e){var t=new rnd.ReAtom(this.molecule.atoms.get(e));t.component=this.connectedComponents.add(Set.single(e)),this.atoms.set(e,t),this.markAtom(e,1)},rnd.ReStruct.prototype.notifyRxnPlusAdded=function(e){this.rxnPluses.set(e,new rnd.ReRxnPlus(this.molecule.rxnPluses.get(e)))},rnd.ReStruct.prototype.notifyRxnArrowAdded=function(e){this.rxnArrows.set(e,new rnd.ReRxnArrow(this.molecule.rxnArrows.get(e)))},rnd.ReStruct.prototype.notifyRxnArrowRemoved=function(e){this.markItemRemoved(),this.clearVisel(this.rxnArrows.get(e).visel),this.rxnArrows.unset(e)},rnd.ReStruct.prototype.notifyRxnPlusRemoved=function(e){this.markItemRemoved(),this.clearVisel(this.rxnPluses.get(e).visel),this.rxnPluses.unset(e)},rnd.ReStruct.prototype.notifyBondAdded=function(e){this.bonds.set(e,new rnd.ReBond(this.molecule.bonds.get(e))),this.markBond(e,1)},rnd.ReStruct.prototype.notifyAtomRemoved=function(e){var t=this.atoms.get(e),n=this.connectedComponents.get(t.component);Set.remove(n,e),0==Set.size(n)&&this.connectedComponents.remove(t.component),this.clearVisel(t.visel),this.atoms.unset(e),this.markItemRemoved()},rnd.ReStruct.prototype.notifyBondRemoved=function(e){var t=this.bonds.get(e);[t.b.hb1,t.b.hb2].each(function(e){var t=this.molecule.halfBonds.get(e);t.loop>=0&&this.loopRemove(t.loop)},this),this.clearVisel(t.visel),this.bonds.unset(e),this.markItemRemoved()},rnd.ReStruct.prototype.loopRemove=function(e){if(this.reloops.has(e)){var t=this.reloops.get(e);this.clearVisel(t.visel);for(var n=[],r=0;r<t.loop.hbs.length;++r){var o=t.loop.hbs[r];if(this.molecule.halfBonds.has(o)){var i=this.molecule.halfBonds.get(o);i.loop=-1,this.markBond(i.bid,1),this.markAtom(i.begin,1),n.push(i.bid)}}this.reloops.unset(e),this.molecule.loops.remove(e)}},rnd.ReStruct.prototype.loopIsValid=function(e,t){var n=this.molecule.halfBonds,r=t.loop,o=!1;return r.hbs.each(function(t){n.has(t)&&n.get(t).loop===e||(o=!0)},this),!o},rnd.ReStruct.prototype.verifyLoops=function(){var e=[];this.reloops.each(function(t,n){this.loopIsValid(t,n)||e.push(t)},this);for(var t=0;t<e.length;++t)this.loopRemove(e[t])},rnd.ReStruct.prototype.BFS=function(e,t,n){t-=0;var r=new Array,o={};for(r.push(t),o[t]=1;r.length>0;){var i=r.shift();e.call(n,i);for(var a=this.atoms.get(i),s=0;s<a.a.neighbors.length;++s){var l=a.a.neighbors[s],c=this.molecule.halfBonds.get(l);o[c.end]||(o[c.end]=1,r.push(c.end))}}},rnd.ReRxnPlus=function(e){this.init(rnd.Visel.TYPE.PLUS),this.item=e},rnd.ReRxnPlus.prototype=new rnd.ReObject,rnd.ReRxnPlus.isSelectable=function(){return!0},rnd.ReRxnPlus.findClosest=function(e,t){var n,r;return e.ctab.rxnPluses.each(function(e,o){var i=o.item.pp,a=Math.max(Math.abs(t.x-i.x),Math.abs(t.y-i.y));.5>a&&(!r||n>a)&&(n=a,r={id:e,dist:n})}),r},rnd.ReRxnPlus.prototype.highlightPath=function(e){var t=e.ps(this.item.pp),n=e.settings.scaleFactor;return e.paper.rect(t.x-n/4,t.y-n/4,n/2,n/2,n/8)},rnd.ReRxnPlus.prototype.drawHighlight=function(e){var t=this.highlightPath(e).attr(e.styles.highlightStyle);return e.ctab.addReObjectPath("highlighting",this.visel,t),t},rnd.ReRxnPlus.prototype.makeSelectionPlate=function(e,t,n){return this.highlightPath(e.render).attr(n.selectionStyle)},rnd.ReRxnArrow=function(e){this.init(rnd.Visel.TYPE.ARROW),this.item=e},rnd.ReRxnArrow.prototype=new rnd.ReObject,rnd.ReRxnArrow.isSelectable=function(){return!0},rnd.ReRxnArrow.findClosest=function(e,t){var n,r;return e.ctab.rxnArrows.each(function(e,o){var i=o.item.pp;if(Math.abs(t.x-i.x)<1){var a=Math.abs(t.y-i.y);.3>a&&(!r||n>a)&&(n=a,r={id:e,dist:n})}}),r},rnd.ReRxnArrow.prototype.highlightPath=function(e){var t=e.ps(this.item.pp),n=e.settings.scaleFactor;return e.paper.rect(t.x-n,t.y-n/4,2*n,n/2,n/8)},rnd.ReRxnArrow.prototype.drawHighlight=function(e){var t=this.highlightPath(e).attr(e.styles.highlightStyle);return e.ctab.addReObjectPath("highlighting",this.visel,t),t},rnd.ReRxnArrow.prototype.makeSelectionPlate=function(e,t,n){return this.highlightPath(e.render).attr(n.selectionStyle)},rnd.ReFrag=function(e){this.init(rnd.Visel.TYPE.FRAGMENT),this.item=e},rnd.ReFrag.prototype=new rnd.ReObject,rnd.ReFrag.isSelectable=function(){return!1},rnd.ReFrag.findClosest=function(e,t,n,r){r=Math.min(r||e.opt.selectionDistanceCoefficient,e.opt.selectionDistanceCoefficient);var o;return e.ctab.frags.each(function(i,a){if(i!=n){var s=a.calcBBox(e,i);if(s.p0.y<t.y&&s.p1.y>t.y&&s.p0.x<t.x&&s.p1.x>t.x){var l=Math.min(Math.abs(s.p0.x-t.x),Math.abs(s.p1.x-t.x));(!o||r>l)&&(r=l,o={id:i,dist:r})}}}),o},rnd.ReFrag.prototype.fragGetAtoms=function(e,t){var n=[];return e.ctab.atoms.each(function(e,r){r.a.fragment==t&&n.push(e)},this),n},rnd.ReFrag.prototype.fragGetBonds=function(e,t){var n=[];return e.ctab.bonds.each(function(r,o){e.ctab.atoms.get(o.b.begin).a.fragment==t&&e.ctab.atoms.get(o.b.end).a.fragment==t&&n.push(r)},this),n},rnd.ReFrag.prototype.calcBBox=function(e,t){var n;return e.ctab.atoms.each(function(r,o){if(o.a.fragment==t){var i=o.visel.boundingBox;if(i)i=i.translate((e.offset||new Vec2).negated()).transform(e.scaled2obj,e);else{i=new Box2Abs(o.a.pp,o.a.pp);var a=new Vec2(.05*3,.05*3);i=i.extend(a,a)}n=n?Box2Abs.union(n,i):i}},this),n},rnd.ReFrag.prototype._draw=function(e,t,n){var r=this.calcBBox(e,t);if(r){var o=e.obj2scaled(new Vec2(r.p0.x,r.p0.y)),i=e.obj2scaled(new Vec2(r.p1.x,r.p1.y));return e.paper.rect(o.x,o.y,i.x-o.x,i.y-o.y,0).attr(n)}},rnd.ReFrag.prototype.draw=function(){return null},rnd.ReFrag.prototype.drawHighlight=function(){},rnd.ReFrag.prototype.setHighlight=function(e,t){var n=t.ctab.frags.keyOf(this);Object.isUndefined(n)||(t.ctab.atoms.each(function(r,o){o.a.fragment==n&&o.setHighlight(e,t)},this),t.ctab.bonds.each(function(r,o){t.ctab.atoms.get(o.b.begin).a.fragment==n&&o.setHighlight(e,t)},this))},rnd.ReRGroup=function(e){this.init(rnd.Visel.TYPE.RGROUP),this.labelBox=null,this.item=e},rnd.ReRGroup.prototype=new rnd.ReObject,rnd.ReRGroup.isSelectable=function(){return!1},rnd.ReRGroup.prototype.getAtoms=function(e){var t=[];return this.item.frags.each(function(n,r){t=t.concat(e.ctab.frags.get(r).fragGetAtoms(e,r))}),t},rnd.ReRGroup.prototype.getBonds=function(e){var t=[];return this.item.frags.each(function(n,r){t=t.concat(e.ctab.frags.get(r).fragGetBonds(e,r))}),t},rnd.ReRGroup.findClosest=function(e,t,n,r){r=Math.min(r||e.opt.selectionDistanceCoefficient,e.opt.selectionDistanceCoefficient);var o;return e.ctab.rgroups.each(function(e,i){if(e!=n&&i.labelBox&&i.labelBox.contains(t,.5)){var a=Vec2.dist(i.labelBox.centre(),t);(!o||r>a)&&(r=a,o={id:e,dist:r})}}),o},rnd.ReRGroup.prototype.calcBBox=function(e){var t;return this.item.frags.each(function(n,r){var o=e.ctab.frags.get(r).calcBBox(e,r);o&&(t=t?Box2Abs.union(t,o):o)}),t=t.extend(this.__ext,this.__ext)},rnd.ReRGroup.drawBrackets=function(e,t,n,r){r=r||new Vec2(1,0);var o=Math.min(.25,.3*n.sz().x),i=n.p1.y-n.p0.y,a=.5*(n.p1.y+n.p0.y),s=chem.SGroup.drawBracket(t,t.paper,t.styles,r.negated(),r.negated().rotateSC(1,0),new Vec2(n.p0.x,a),o,i),l=chem.SGroup.drawBracket(t,t.paper,t.styles,r,r.rotateSC(1,0),new Vec2(n.p1.x,a),o,i);e.push(s,l)},rnd.ReRGroup.prototype.draw=function(e){var t=this.calcBBox(e),n=e.settings;if(t){var r={data:[]},o=e.obj2scaled(t.p0),i=e.obj2scaled(t.p1),a=e.paper.set();rnd.ReRGroup.drawBrackets(a,e,t),r.data.push(a);var s=e.ctab.rgroups.keyOf(this),l=e.paper.set(),c=e.paper.text(o.x,(o.y+i.y)/2,"R"+s+"=").attr({font:n.font,"font-size":n.fontRLabel,fill:"black"}),u=rnd.relBox(c.getBBox());c.translateAbs(-u.width/2-n.lineWidth,0),l.push(c);var d={font:n.font,"font-size":n.fontRLogic,fill:"black"},p=[];p.push((this.item.ifthen>0?"IF ":"")+"R"+s.toString()+(this.item.range.length>0?this.item.range.startsWith(">")||this.item.range.startsWith("<")||this.item.range.startsWith("=")?this.item.range:"="+this.item.range:">0")+(this.item.resth?" (RestH)":"")+(this.item.ifthen>0?"\nTHEN R"+this.item.ifthen.toString():""));for(var h=u.height/2+n.lineWidth/2,f=0;f<p.length;++f){var m=e.paper.text(o.x,(o.y+i.y)/2,p[f]).attr(d),g=rnd.relBox(m.getBBox());h+=g.height/2,m.translateAbs(-g.width/2-6*n.lineWidth,h),h+=g.height/2+n.lineWidth/2,r.data.push(m),l.push(m)}return r.data.push(c),this.labelBox=Box2Abs.fromRelBox(l.getBBox()).transform(e.scaled2obj,e),r}return{}},rnd.ReRGroup.prototype._draw=function(e,t,n){var r=this.getVBoxObj(e).extend(this.__ext,this.__ext);if(r){var o=e.obj2scaled(r.p0),i=e.obj2scaled(r.p1);return e.paper.rect(o.x,o.y,i.x-o.x,i.y-o.y,0).attr(n)}},rnd.ReRGroup.prototype.drawHighlight=function(e){var t=e.ctab.rgroups.keyOf(this);if(!Object.isUndefined(t)){var n=this._draw(e,t,e.styles.highlightStyle);return e.ctab.addReObjectPath("highlighting",this.visel,n),this.item.frags.each(function(t,n){e.ctab.frags.get(n).drawHighlight(e)},this),n}},rnd.ReSGroup=function(e){this.init(rnd.Visel.TYPE.SGROUP),this.item=e},rnd.ReSGroup.prototype=new rnd.ReObject,rnd.ReSGroup.isSelectable=function(){return!1},rnd.ReSGroup.findClosest=function(e,t){var n=null,r=e.opt.selectionDistanceCoefficient;return e.ctab.molecule.sgroups.each(function(e,o){for(var i=o.bracketDir,a=i.rotateSC(1,0),s=new Vec2(Vec2.dot(t,i),Vec2.dot(t,a)),l=0;l<o.areas.length;++l){var c=o.areas[l],u=c.p0.y<s.y&&c.p1.y>s.y&&c.p0.x<s.x&&c.p1.x>s.x,d=Math.min(Math.abs(c.p0.x-s.x),Math.abs(c.p1.x-s.x));u&&(null==n||r>d)&&(n=e,r=d)}},this),null!=n?{id:n,dist:r}:null},rnd.ReSGroup.prototype.draw=function(e){return this.item.draw(e.ctab)},rnd.ReSGroup.prototype.drawHighlight=function(e){var t=e.styles,n=e.settings,r=e.paper,o=this.item,i=o.bracketBox.transform(e.obj2scaled,e),a=n.lineWidth,s=new Vec2(4*a,6*a);i=i.extend(s,s);var l=o.bracketDir,c=l.rotateSC(1,0),u=Vec2.lc2(l,i.p0.x,c,i.p0.y),d=Vec2.lc2(l,i.p0.x,c,i.p1.y),p=Vec2.lc2(l,i.p1.x,c,i.p0.y),h=Vec2.lc2(l,i.p1.x,c,i.p1.y),f=r.set();o.highlighting=r.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}L{0},{1}",tfx(u.x),tfx(u.y),tfx(d.x),tfx(d.y),tfx(h.x),tfx(h.y),tfx(p.x),tfx(p.y)).attr(t.highlightStyle),f.push(o.highlighting),chem.SGroup.getAtoms(e.ctab.molecule,o).each(function(t){f.push(e.ctab.atoms.get(t).makeHighlightPlate(e))},this),chem.SGroup.getBonds(e.ctab.molecule,o).each(function(t){f.push(e.ctab.bonds.get(t).makeHighlightPlate(e))},this),e.ctab.addReObjectPath("highlighting",this.visel,f)},rnd.ReDataSGroupData=function(e){this.init(rnd.Visel.TYPE.SGROUP_DATA),this.sgroup=e},rnd.ReDataSGroupData.prototype=new rnd.ReObject,rnd.ReDataSGroupData.isSelectable=function(){return!0},rnd.ReDataSGroupData.findClosest=function(e,t){var n=null,r=null;return e.ctab.sgroupData.each(function(e,o){if("DAT"!=o.sgroup.type)throw new Error("Data group expected");var i=o.sgroup.dataArea,a=i.p0.y<t.y&&i.p1.y>t.y&&i.p0.x<t.x&&i.p1.x>t.x,s=Math.min(Math.abs(i.p0.x-t.x),Math.abs(i.p1.x-t.x));a&&(null==r||n>s)&&(r={id:e,dist:s},n=s)}),r},rnd.ReDataSGroupData.prototype.highlightPath=function(e){var t=this.sgroup.dataArea,n=e.obj2scaled(t.p0),r=e.obj2scaled(t.p1).sub(n);return e.paper.rect(n.x,n.y,r.x,r.y)},rnd.ReDataSGroupData.prototype.drawHighlight=function(e){var t=this.highlightPath(e).attr(e.styles.highlightStyle);return e.ctab.addReObjectPath("highlighting",this.visel,t),t},rnd.ReDataSGroupData.prototype.makeSelectionPlate=function(e,t,n){return this.highlightPath(e.render).attr(n.selectionStyle)},rnd.ReChiralFlag=function(e){this.init(rnd.Visel.TYPE.CHIRAL_FLAG),this.pp=e},rnd.ReChiralFlag.prototype=new rnd.ReObject,rnd.ReChiralFlag.isSelectable=function(){return!0},rnd.ReChiralFlag.findClosest=function(e,t){var n,r;return e.ctab.chiralFlags.each(function(e,o){var i=o.pp;if(Math.abs(t.x-i.x)<1){var a=Math.abs(t.y-i.y);.3>a&&(!r||n>a)&&(n=a,r={id:e,dist:n})}}),r},rnd.ReChiralFlag.prototype.highlightPath=function(e){var t=Box2Abs.fromRelBox(this.path.getBBox()),n=t.p1.sub(t.p0),r=t.p0.sub(e.offset);return e.paper.rect(r.x,r.y,n.x,n.y)},rnd.ReChiralFlag.prototype.drawHighlight=function(e){var t=this.highlightPath(e).attr(e.styles.highlightStyle);return e.ctab.addReObjectPath("highlighting",this.visel,t),t},rnd.ReChiralFlag.prototype.makeSelectionPlate=function(e,t,n){return this.highlightPath(e.render).attr(n.selectionStyle)},rnd.ReChiralFlag.prototype.draw=function(e){var t=e.paper,n=e.settings,r=e.ps(this.pp);this.path=t.text(r.x,r.y,"Chiral").attr({font:n.font,"font-size":n.fontsz,fill:"#000"}),e.ctab.addReObjectPath("data",this.visel,this.path,null,!0)},rnd.ReStruct.maps={atoms:rnd.ReAtom,bonds:rnd.ReBond,rxnPluses:rnd.ReRxnPlus,rxnArrows:rnd.ReRxnArrow,frags:rnd.ReFrag,rgroups:rnd.ReRGroup,sgroupData:rnd.ReDataSGroupData,chiralFlags:rnd.ReChiralFlag,sgroups:rnd.ReSGroup,reloops:rnd.ReLoop};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../chem/element":10,"../util":39,"../util/box2abs":38,"../util/map":40,"../util/pool":41,"../util/set":42,"../util/vec2":43}],24:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Vec2=require("../util/vec2"),util=require("../util"),element=require("../chem/element");require("./restruct");var rnd=global.rnd=global.rnd||{},tfx=util.tfx;rnd.relBox=function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}},rnd.ReStruct.prototype.drawArrow=function(t,e){var o=5,r=7,n=this.render.paper,i=this.render.styles;return n.path("M{0},{1}L{2},{3}L{4},{5}M{2},{3}L{4},{6}",tfx(t.x),tfx(t.y),tfx(e.x),tfx(e.y),tfx(e.x-r),tfx(e.y-o),tfx(e.y+o)).attr(i.lineattr)},rnd.ReStruct.prototype.drawPlus=function(t){var e=this.render.scale/5,o=this.render.paper,r=this.render.styles;return o.path("M{0},{4}L{0},{5}M{2},{1}L{3},{1}",tfx(t.x),tfx(t.y),tfx(t.x-e),tfx(t.x+e),tfx(t.y-e),tfx(t.y+e)).attr(r.lineattr)},rnd.ReStruct.prototype.drawBondSingle=function(t,e){var o=t.p,r=e.p,n=this.render.paper,i=this.render.styles;return n.path(rnd.ReStruct.makeStroke(o,r)).attr(i.lineattr)},rnd.ReStruct.prototype.drawBondSingleUp=function(t,e,o){var r=t.p,n=e.p,i=t.norm,a=this.render.settings,s=this.render.paper,d=this.render.styles,l=.7*a.bondSpace,c=n.addScaled(i,l),u=n.addScaled(i,-l);if(o.neihbid2>=0){var h=this.stereoUpBondGetCoordinates(e,o.neihbid2);c=h[0],u=h[1]}return s.path("M{0},{1}L{2},{3}L{4},{5}Z",tfx(r.x),tfx(r.y),tfx(c.x),tfx(c.y),tfx(u.x),tfx(u.y)).attr(d.lineattr).attr({fill:"#000"})},rnd.ReStruct.prototype.drawVec=function(t,e,o,r){var n=this.render.settings,i=this.render.paper,a=this.render.styles,s=n.bondSpace,d=t.addScaled(e,r||3*s);return i.path("M{0},{1}L{2},{3}",tfx(t.x),tfx(t.y),tfx(d.x),tfx(d.y)).attr(a.lineattr).attr({stroke:o||"#0F0"})},rnd.ReStruct.prototype.stereoUpBondGetCoordinates=function(t,e){var o=this.render.settings.bondSpace,r=this.molecule.halfBonds.get(e),n=Vec2.dot(t.dir,r.dir),i=Vec2.cross(t.dir,r.dir),a=Math.sqrt(.5*(1-n)),s=r.dir.rotateSC((i>=0?-1:1)*a,Math.sqrt(.5*(1+n))),d=.3,l=.7,c=t.p.addScaled(s,l*o/(a+d)),u=t.p.addScaled(s.negated(),l*o/(a+d));return i>0?[c,u]:[u,c]},rnd.ReStruct.prototype.drawBondSingleStereoBold=function(t,e,o,r){var n=this.render.paper,i=this.render.settings,a=this.render.styles,s=this.stereoUpBondGetCoordinates(t,o.neihbid1),d=this.stereoUpBondGetCoordinates(e,o.neihbid2),l=s[0],c=s[1],u=d[0],h=d[1],p=n.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}Z",tfx(l.x),tfx(l.y),tfx(c.x),tfx(c.y),tfx(u.x),tfx(u.y),tfx(h.x),tfx(h.y)).attr(a.lineattr).attr({stroke:"#000",fill:"#000"});if(r){var f=t.p,m=e.p,g=t.norm,b=o.doubleBondShift,v=1.5*i.bondSpace,y=f.addScaled(g,v*b),x=m.addScaled(g,v*b),S=!this.atoms.get(t.begin).showLabel,w=!this.atoms.get(e.begin).showLabel;return b>0?(S&&(y=y.addScaled(t.dir,v*this.getBondLineShift(t.rightCos,t.rightSin))),w&&(x=x.addScaled(t.dir,-v*this.getBondLineShift(e.leftCos,e.leftSin)))):0>b&&(S&&(y=y.addScaled(t.dir,v*this.getBondLineShift(t.leftCos,t.leftSin))),w&&(x=x.addScaled(t.dir,-v*this.getBondLineShift(e.rightCos,e.rightSin)))),n.set([p,n.path("M{0},{1}L{2},{3}",tfx(y.x),tfx(y.y),tfx(x.x),tfx(x.y)).attr(a.lineattr)])}return p},rnd.ReStruct.prototype.drawBondSingleDown=function(t,e){var o=t.p,r=e.p,n=t.norm,i=this.render.settings,a=this.render.paper,s=this.render.styles,d=.7*i.bondSpace,l=r.sub(o),c=l.length()+.2;l=l.normalized();for(var u,h,p=1.2*i.lineWidth,f=Math.max(Math.floor((c-i.lineWidth)/(i.lineWidth+p)),0)+2,m=c/(f-1),g="",b=o,v=0;f>v;++v)b=o.addScaled(l,m*v),u=b.addScaled(n,d*(v+.5)/(f-.5)),h=b.addScaled(n,-d*(v+.5)/(f-.5)),g+=rnd.ReStruct.makeStroke(u,h);return a.path(g).attr(s.lineattr)},rnd.ReStruct.prototype.drawBondSingleEither=function(t,e){var o=t.p,r=e.p,n=t.norm,i=this.render.settings,a=this.render.paper,s=this.render.styles,d=.7*i.bondSpace,l=r.sub(o),c=l.length();l=l.normalized();for(var u=.6*i.lineWidth,h=Math.max(Math.floor((c-i.lineWidth)/(i.lineWidth+u)),0)+2,p=c/(h-.5),f="M"+tfx(o.x)+","+tfx(o.y),m=o,g=0;h>g;++g)m=o.addScaled(l,p*(g+.5)).addScaled(n,(1&g?-1:1)*d*(g+.5)/(h-.5)),f+="L"+tfx(m.x)+","+tfx(m.y);return a.path(f).attr(s.lineattr)},rnd.ReStruct.prototype.getBondLineShift=function(t,e){return 0>e||Math.abs(t)>.9?0:e/(1-t)},rnd.ReStruct.prototype.drawBondDouble=function(t,e,o,r){var n=t.p,i=e.p,a=t.norm,s=r?0:o.doubleBondShift,d=this.render.settings,l=this.render.paper,c=this.render.styles,u=d.bondSpace/2,h=u,p=-u;h+=s*u,p+=s*u;var f=n.addScaled(a,h),m=i.addScaled(a,h),g=n.addScaled(a,p),b=i.addScaled(a,p),v=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;return s>0?(v&&(f=f.addScaled(t.dir,d.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(m=m.addScaled(t.dir,-d.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):0>s&&(v&&(g=g.addScaled(t.dir,d.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(b=b.addScaled(t.dir,-d.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin)))),l.path(r?"M{0},{1}L{6},{7}M{4},{5}L{2},{3}":"M{0},{1}L{2},{3}M{4},{5}L{6},{7}",tfx(f.x),tfx(f.y),tfx(m.x),tfx(m.y),tfx(g.x),tfx(g.y),tfx(b.x),tfx(b.y)).attr(c.lineattr)},rnd.ReStruct.makeStroke=function(t,e){return"M"+tfx(t.x)+","+tfx(t.y)+"L"+tfx(e.x)+","+tfx(e.y)+"	"},rnd.ReStruct.prototype.drawBondSingleOrDouble=function(t,e){var o=t.p,r=e.p,n=t.norm,i=this.render,a=i.settings,s=i.paper,d=i.styles,l=a.bondSpace/2,c=(Vec2.dist(o,r)/(a.bondSpace+a.lineWidth)).toFixed()-0;1&c||(c+=1);for(var u="",h=o,p=1;c>=p;++p){var f=Vec2.lc2(o,(c-p)/c,r,p/c);1&p?u+=rnd.ReStruct.makeStroke(h,f):(u+=rnd.ReStruct.makeStroke(h.addScaled(n,l),f.addScaled(n,l)),u+=rnd.ReStruct.makeStroke(h.addScaled(n,-l),f.addScaled(n,-l))),h=f}return s.path(u).attr(d.lineattr)},rnd.ReStruct.prototype.drawBondTriple=function(t,e){var o=t.p,r=e.p,n=t.norm,i=this.render,a=i.settings,s=i.paper,d=i.styles,l=o.addScaled(n,a.bondSpace),c=r.addScaled(n,a.bondSpace),u=o.addScaled(n,-a.bondSpace),h=r.addScaled(n,-a.bondSpace);return s.path(rnd.ReStruct.makeStroke(o,r)+rnd.ReStruct.makeStroke(l,c)+rnd.ReStruct.makeStroke(u,h)).attr(d.lineattr)},rnd.dashedPath=function(t,e,o){for(var r=0,n=Vec2.dist(t,e),i=Vec2.diff(e,t).normalized(),a=!0,s="",d=0;n>r;){var l=o[d%o.length],c=r+Math.min(l,n-r);a&&(s+="M "+t.addScaled(i,r).coordStr()+" L "+t.addScaled(i,c).coordStr()),r+=l,a=!a,d++}return s},rnd.ReStruct.prototype.drawBondAromatic=function(t,e,o,r){if(!r)return this.drawBondSingle(t,e);var n=o.doubleBondShift,i=this.render.paper,a=this.preparePathsForAromaticBond(t,e,n),s=a[0],d=a[1];return(n>0?s:d).attr({"stroke-dasharray":"- "}),i.set([s,d])},rnd.dashdotPattern=[.125,.125,.005,.125],rnd.ReStruct.prototype.drawBondSingleOrAromatic=function(t,e,o){var r=o.doubleBondShift,n=this.render.paper,i=this.render.settings.scaleFactor,a=util.map(rnd.dashdotPattern,function(t){return t*i}),s=this.preparePathsForAromaticBond(t,e,r,r>0?1:2,a),d=s[0],l=s[1];return n.set([d,l])},rnd.ReStruct.prototype.preparePathsForAromaticBond=function(t,e,o,r,n){var i=this.render.settings,a=this.render.paper,s=this.render.styles,d=t.p,l=e.p,c=t.norm,u=i.bondSpace/2,h=u,p=-u;h+=o*u,p+=o*u;var f=d.addScaled(c,h),m=l.addScaled(c,h),g=d.addScaled(c,p),b=l.addScaled(c,p),v=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;o>0?(v&&(f=f.addScaled(t.dir,i.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(m=m.addScaled(t.dir,-i.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):0>o&&(v&&(g=g.addScaled(t.dir,i.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(b=b.addScaled(t.dir,-i.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin))));var x=a.path(n&&1&r?rnd.dashedPath(f,m,n):rnd.ReStruct.makeStroke(f,m)).attr(s.lineattr),S=a.path(n&&2&r?rnd.dashedPath(g,b,n):rnd.ReStruct.makeStroke(g,b)).attr(s.lineattr);return[x,S]},rnd.ReStruct.prototype.drawBondDoubleOrAromatic=function(t,e,o){var r=o.doubleBondShift,n=this.render.paper,i=this.render.settings.scaleFactor,a=util.map(rnd.dashdotPattern,function(t){return t*i}),s=this.preparePathsForAromaticBond(t,e,r,3,a),d=s[0],l=s[1];return n.set([d,l])},rnd.ReStruct.prototype.drawBondAny=function(t,e){var o=t.p,r=e.p,n=this.render.paper,i=this.render.styles;return n.path(rnd.ReStruct.makeStroke(o,r)).attr(i.lineattr).attr({"stroke-dasharray":"- "})},rnd.ReStruct.prototype.drawReactingCenter=function(t,e,o){var r=e.p,n=o.p,i=n.add(r).scaled(.5),a=n.sub(r).normalized(),s=a.rotateSC(1,0),d=this.render.paper,l=this.render.styles,c=this.render.settings,u=[],h=c.lineWidth,p=c.bondSpace/2,f=h,m=2*h,g=1.5*p,b=1.5*p,v=3*p,y=.2;switch(t.b.reactingCenterStatus){case chem.Struct.BOND.REACTING_CENTER.NOT_CENTER:u.push(i.addScaled(s,v).addScaled(a,y*v)),u.push(i.addScaled(s,-v).addScaled(a,-y*v)),u.push(i.addScaled(s,v).addScaled(a,-y*v)),u.push(i.addScaled(s,-v).addScaled(a,y*v));break;case chem.Struct.BOND.REACTING_CENTER.CENTER:u.push(i.addScaled(s,v).addScaled(a,y*v).addScaled(a,f)),u.push(i.addScaled(s,-v).addScaled(a,-y*v).addScaled(a,f)),u.push(i.addScaled(s,v).addScaled(a,y*v).addScaled(a,-f)),u.push(i.addScaled(s,-v).addScaled(a,-y*v).addScaled(a,-f)),u.push(i.addScaled(a,g).addScaled(s,b)),u.push(i.addScaled(a,-g).addScaled(s,b)),u.push(i.addScaled(a,g).addScaled(s,-b)),u.push(i.addScaled(a,-g).addScaled(s,-b));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN:u.push(i.addScaled(s,v).addScaled(a,m)),u.push(i.addScaled(s,-v).addScaled(a,m)),u.push(i.addScaled(s,v).addScaled(a,-m)),u.push(i.addScaled(s,-v).addScaled(a,-m));break;case chem.Struct.BOND.REACTING_CENTER.ORDER_CHANGED:u.push(i.addScaled(s,v)),u.push(i.addScaled(s,-v));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:u.push(i.addScaled(s,v).addScaled(a,m)),u.push(i.addScaled(s,-v).addScaled(a,m)),u.push(i.addScaled(s,v).addScaled(a,-m)),u.push(i.addScaled(s,-v).addScaled(a,-m)),u.push(i.addScaled(s,v)),u.push(i.addScaled(s,-v));break;default:return null}for(var x="",S=0;S<u.length/2;++S)x+=rnd.ReStruct.makeStroke(u[2*S],u[2*S+1]);return d.path(x).attr(l.lineattr)},rnd.ReStruct.prototype.drawTopologyMark=function(t,e,o){var r=null;if(t.b.topology==chem.Struct.BOND.TOPOLOGY.RING)r="rng";else{if(t.b.topology!=chem.Struct.BOND.TOPOLOGY.CHAIN)return null;r="chn"}var n=this.render.paper,i=this.render.settings,a=e.p,s=o.p,d=s.add(a).scaled(.5),l=s.sub(a).normalized(),c=l.rotateSC(1,0),u=i.lineWidth;t.doubleBondShift>0?c=c.scaled(-t.doubleBondShift):0==t.doubleBondShift&&(u+=i.bondSpace/2);var h=new Vec2(2,1).scaled(i.bondSpace);t.b.type==chem.Struct.BOND.TYPE.TRIPLE&&(u+=i.bondSpace);var p=d.add(new Vec2(c.x*(h.x+u),c.y*(h.y+u))),f=n.text(p.x,p.y,r).attr({font:i.font,"font-size":i.fontszsub,fill:"#000"}),m=rnd.relBox(f.getBBox());return this.centerText(f,m),f},rnd.ReStruct.prototype.drawBond=function(t,e,o){var r=null,n=this.molecule;switch(t.b.type){case chem.Struct.BOND.TYPE.SINGLE:switch(t.b.stereo){case chem.Struct.BOND.STEREO.UP:this.findIncomingUpBonds(e.bid,t),r=t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,o,t):this.drawBondSingleUp(e,o,t);break;case chem.Struct.BOND.STEREO.DOWN:r=this.drawBondSingleDown(e,o,t);break;case chem.Struct.BOND.STEREO.EITHER:r=this.drawBondSingleEither(e,o,t);break;default:r=this.drawBondSingle(e,o)}break;case chem.Struct.BOND.TYPE.DOUBLE:this.findIncomingUpBonds(e.bid,t),r=t.b.stereo===chem.Struct.BOND.STEREO.NONE&&t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,o,t,!0):this.drawBondDouble(e,o,t,t.b.stereo===chem.Struct.BOND.STEREO.CIS_TRANS);break;case chem.Struct.BOND.TYPE.TRIPLE:r=this.drawBondTriple(e,o,t);break;case chem.Struct.BOND.TYPE.AROMATIC:var i=e.loop>=0&&n.loops.get(e.loop).aromatic||o.loop>=0&&n.loops.get(o.loop).aromatic;r=this.drawBondAromatic(e,o,t,!i);break;case chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE:r=this.drawBondSingleOrDouble(e,o,t);break;case chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC:r=this.drawBondSingleOrAromatic(e,o,t);break;case chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC:r=this.drawBondDoubleOrAromatic(e,o,t);break;case chem.Struct.BOND.TYPE.ANY:r=this.drawBondAny(e,o,t);break;default:throw new Error("Bond type "+t.b.type+" not supported")}return r},rnd.ReStruct.prototype.radicalCap=function(t){var e=this.render.settings,o=this.render.paper,r=.9*e.lineWidth,n=r,i=2*r;return o.path("M{0},{1}L{2},{3}L{4},{5}",tfx(t.x-n),tfx(t.y+i),tfx(t.x),tfx(t.y),tfx(t.x+n),tfx(t.y+i)).attr({stroke:"#000","stroke-width":.7*e.lineWidth,"stroke-linecap":"square","stroke-linejoin":"miter"})},rnd.ReStruct.prototype.radicalBullet=function(t){var e=this.render.settings,o=this.render.paper;return o.circle(t.x,t.y,e.lineWidth).attr({stroke:null,fill:"#000"})},rnd.ReStruct.prototype.centerText=function(t,e){this.render.paper.raphael.vml&&this.pathAndRBoxTranslate(t,e,0,.16*e.height)},rnd.ReStruct.prototype.showItemSelection=function(t,e,o){var r=null!=e.selectionPlate&&!e.selectionPlate.removed;if(r=r&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(e.selectionPlate)<0),o){if(!r){var n=this.render,i=n.styles,a=n.paper;e.selectionPlate=e.makeSelectionPlate(this,a,i),this.addReObjectPath("selection-plate",e.visel,e.selectionPlate)}e.selectionPlate&&e.selectionPlate.show()}else r&&e.selectionPlate&&e.selectionPlate.hide()},rnd.ReStruct.prototype.pathAndRBoxTranslate=function(t,e,o,r){t.translateAbs(o,r),e.x+=o,e.y+=r};var markerColors=["black","cyan","magenta","red","green","blue","green"];rnd.ReStruct.prototype.showLabels=function(){var t=this.render,e=t.settings,o=t.styles,r=t.opt,n=t.paper,i=.5*e.lineWidth;for(var a in this.atomsChanged){var s=this.atoms.get(a),d=t.ps(s.a.pp),l=null;r.showAtomIds&&(l={},l.text=a.toString(),l.path=n.text(d.x,d.y,l.text).attr({font:e.font,"font-size":e.fontszsub,fill:"#070"}),l.rbb=rnd.relBox(l.path.getBBox()),this.centerText(l.path,l.rbb),this.addReObjectPath("indices",s.visel,l.path,d)),s.setHighlight(s.highlight,t);var c="#000000";if(s.showLabel){var u=0,h=0,p={};if(null!=s.a.atomList)p.text=s.a.atomList.label();else if("R#"==s.a.label&&null!=s.a.rglabel){p.text="";for(var f=0;32>f;f++)s.a.rglabel&1<<f&&(p.text+="R"+(f+1).toString());""==p.text&&(p="R#")}else if(p.text=s.a.label,r.atomColoring){var m=element.getElementByLabel(p.text);m&&(c=element.get(m).color)}p.path=n.text(d.x,d.y,p.text).attr({font:e.font,"font-size":e.fontsz,fill:c}),p.rbb=rnd.relBox(p.path.getBBox()),this.centerText(p.path,p.rbb),null!=s.a.atomList&&this.pathAndRBoxTranslate(p.path,p.rbb,(s.hydrogenOnTheLeft?-1:1)*(p.rbb.width-p.rbb.height)/2,0),this.addReObjectPath("data",s.visel,p.path,d,!0),u=p.rbb.width/2,h=-p.rbb.width/2;var g=Math.floor(s.a.implicitH),b="H"==p.text,v={},y=null,x=s.hydrogenOnTheLeft;b&&g>0&&(y={},y.text=(g+1).toString(),y.path=n.text(d.x,d.y,y.text).attr({font:e.font,"font-size":e.fontszsub,fill:c}),y.rbb=rnd.relBox(y.path.getBBox()),this.centerText(y.path,y.rbb),this.pathAndRBoxTranslate(y.path,y.rbb,u+.5*y.rbb.width+i,.2*p.rbb.height),u+=y.rbb.width+i,this.addReObjectPath("data",s.visel,y.path,d,!0));var S={};if(0!=s.a.radical){var w;switch(s.a.radical){case 1:S.path=n.set(),w=1.6*e.lineWidth,S.path.push(this.radicalBullet(d.add(new Vec2(-w,0))),this.radicalBullet(d.add(new Vec2(w,0)))),S.path.attr("fill",c);break;case 2:S.path=this.radicalBullet(d).attr("fill",c);break;case 3:S.path=n.set(),w=1.6*e.lineWidth,S.path.push(this.radicalCap(d.add(new Vec2(-w,0))),this.radicalCap(d.add(new Vec2(w,0)))),S.path.attr("stroke",c)}S.rbb=rnd.relBox(S.path.getBBox());var A=-.5*(p.rbb.height+S.rbb.height);3==s.a.radical&&(A-=e.lineWidth/2),this.pathAndRBoxTranslate(S.path,S.rbb,0,A),this.addReObjectPath("data",s.visel,S.path,d,!0)}var R={};0!=s.a.isotope&&(R.text=s.a.isotope.toString(),R.path=n.text(d.x,d.y,R.text).attr({font:e.font,"font-size":e.fontszsub,fill:c}),R.rbb=rnd.relBox(R.path.getBBox()),this.centerText(R.path,R.rbb),this.pathAndRBoxTranslate(R.path,R.rbb,h-.5*R.rbb.width-i,-.3*p.rbb.height),h-=R.rbb.width+i,this.addReObjectPath("data",s.visel,R.path,d,!0)),!b&&g>0&&!t.opt.hideImplicitHydrogen&&(v.text="H",v.path=n.text(d.x,d.y,v.text).attr({font:e.font,"font-size":e.fontsz,fill:c}),v.rbb=rnd.relBox(v.path.getBBox()),this.centerText(v.path,v.rbb),x||(this.pathAndRBoxTranslate(v.path,v.rbb,u+.5*v.rbb.width+i,0),u+=v.rbb.width+i),g>1&&(y={},y.text=g.toString(),y.path=n.text(d.x,d.y,y.text).attr({font:e.font,"font-size":e.fontszsub,fill:c}),y.rbb=rnd.relBox(y.path.getBBox()),this.centerText(y.path,y.rbb),x||(this.pathAndRBoxTranslate(y.path,y.rbb,u+.5*y.rbb.width+i,.2*p.rbb.height),u+=y.rbb.width+i)),x&&(null!=y&&(this.pathAndRBoxTranslate(y.path,y.rbb,h-.5*y.rbb.width-i,.2*p.rbb.height),h-=y.rbb.width+i),this.pathAndRBoxTranslate(v.path,v.rbb,h-.5*v.rbb.width-i,0),h-=v.rbb.width+i),this.addReObjectPath("data",s.visel,v.path,d,!0),null!=y&&this.addReObjectPath("data",s.visel,y.path,d,!0));var O={};if(0!=s.a.charge){O.text="";var C=Math.abs(s.a.charge);1!=C&&(O.text=C.toString()),O.text+=s.a.charge<0?"–":"+",O.path=n.text(d.x,d.y,O.text).attr({font:e.font,"font-size":e.fontszsub,fill:c}),O.rbb=rnd.relBox(O.path.getBBox()),this.centerText(O.path,O.rbb),this.pathAndRBoxTranslate(O.path,O.rbb,u+.5*O.rbb.width+i,-.3*p.rbb.height),u+=O.rbb.width+i,this.addReObjectPath("data",s.visel,O.path,d,!0)}var B={},E={0:"0",1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI",7:"VII",8:"VIII",9:"IX",10:"X",11:"XI",12:"XII",13:"XIII",14:"XIV"};if(s.a.explicitValence>=0){if(B.text=E[s.a.explicitValence],!B.text)throw new Error("invalid valence "+s.a.explicitValence.toString());B.text="("+B.text+")",B.path=n.text(d.x,d.y,B.text).attr({font:e.font,"font-size":e.fontszsub,fill:c}),B.rbb=rnd.relBox(B.path.getBBox()),this.centerText(B.path,B.rbb),this.pathAndRBoxTranslate(B.path,B.rbb,u+.5*B.rbb.width+i,-.3*p.rbb.height),u+=B.rbb.width+i,this.addReObjectPath("data",s.visel,B.path,d,!0)}if(s.a.badConn&&r.showValenceWarnings){var T={},M=d.y+p.rbb.height/2+i;T.path=n.path("M{0},{1}L{2},{3}",tfx(d.x+h),tfx(M),tfx(d.x+u),tfx(M)).attr(this.render.styles.lineattr).attr({stroke:"#F00"}),T.rbb=rnd.relBox(T.path.getBBox()),this.addReObjectPath("warnings",s.visel,T.path,d,!0)}l&&this.pathAndRBoxTranslate(l.path,l.rbb,-.5*p.rbb.width-.5*l.rbb.width-i,.3*p.rbb.height)}var P=this.bisectLargestSector(s),D=Prototype.Browser.IE?"*":"∗";if(s.a.attpnt){var _,G,V;for(_=0,G=0;4>_;++_){var H="";if(s.a.attpnt&1<<_){for(H.length>0&&(H+=" "),H+=D,V=0;(0==_?0:_+1)>V;++V)H+="'";var k=new Vec2(d),L=d.addScaled(P,.7*e.scaleFactor),I=n.text(L.x,L.y,H).attr({font:e.font,"font-size":e.fontsz,fill:c}),N=rnd.relBox(I.getBBox());this.centerText(I,N);var F=P.negated();L=L.addScaled(F,Vec2.shiftRayBox(L,F,Box2Abs.fromRelBox(N))+e.lineWidth/2),k=this.shiftBondEnd(s,k,P,e.lineWidth);var j=P.rotateSC(1,0),U=L.addScaled(j,.05*e.scaleFactor).addScaled(F,.09*e.scaleFactor),z=L.addScaled(j,-.05*e.scaleFactor).addScaled(F,.09*e.scaleFactor),W=n.set();W.push(I,n.path("M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}",tfx(k.x),tfx(k.y),tfx(L.x),tfx(L.y),tfx(U.x),tfx(U.y),tfx(z.x),tfx(z.y)).attr(o.lineattr).attr({"stroke-width":e.lineWidth/2})),this.addReObjectPath("indices",s.visel,W,d),P=P.rotate(Math.PI/6)}}}var q="";if(s.a.aam>0&&(q+=s.a.aam),s.a.invRet>0)if(q.length>0&&(q+=","),1==s.a.invRet)q+="Inv";else{if(2!=s.a.invRet)throw new Error("Invalid value for the invert/retain flag");q+="Ret"}var Y="";if(0!=s.a.ringBondCount)if(s.a.ringBondCount>0)Y+="rb"+s.a.ringBondCount.toString();else if(-1==s.a.ringBondCount)Y+="rb0";else{if(-2!=s.a.ringBondCount)throw new Error("Ring bond count invalid");Y+="rb*"}if(0!=s.a.substitutionCount)if(Y.length>0&&(Y+=","),s.a.substitutionCount>0)Y+="s"+s.a.substitutionCount.toString();else if(-1==s.a.substitutionCount)Y+="s0";else{if(-2!=s.a.substitutionCount)throw new Error("Substitution count invalid");Y+="s*"}if(s.a.unsaturatedAtom>0){if(Y.length>0&&(Y+=","),1!=s.a.unsaturatedAtom)throw new Error("Unsaturated atom invalid value");Y+="u"}if(s.a.hCount>0&&(Y.length>0&&(Y+=","),Y+="H"+(s.a.hCount-1).toString()),s.a.exactChangeFlag>0){if(q.length>0&&(q+=","),1!=s.a.exactChangeFlag)throw new Error("Invalid value for the exact change flag");q+="ext"}if(q=(Y.length>0?Y+"\n":"")+(q.length>0?"."+q+".":""),q.length>0){var Z=n.text(d.x,d.y,q).attr({font:e.font,"font-size":e.fontszsub,fill:c}),$=rnd.relBox(Z.getBBox());this.centerText(Z,$);var K=this.bisectLargestSector(s),X=s.visel,Q=3;for(_=0;_<X.exts.length;++_)Q=Math.max(Q,Vec2.shiftRayBox(d,K,X.exts[_].translate(d)));Q+=Vec2.shiftRayBox(d,K.negated(),Box2Abs.fromRelBox($)),K=K.scaled(8+Q),this.pathAndRBoxTranslate(Z,$,K.x,K.y),this.addReObjectPath("data",s.visel,Z,d,!0)}}},rnd.ReStruct.prototype.shiftBondEnd=function(t,e,o,r){for(var n=0,i=t.visel,a=0;a<i.exts.length;++a){var s=i.exts[a].translate(e);n=Math.max(n,Vec2.shiftRayBox(e,o,s))}return n>0&&(e=e.addScaled(o,n+r)),e},rnd.ReStruct.prototype.bisectLargestSector=function(t){var e=[];t.a.neighbors.each(function(t){var o=this.molecule.halfBonds.get(t);e.push(o.ang)},this),e=e.sort(function(t,e){return t-e});for(var o=[],r=0;r<e.length-1;++r)o.push(e[(r+1)%e.length]-e[r]);o.push(e[0]-e[e.length-1]+2*Math.PI);var n=0,i=-Math.PI/2;for(r=0;r<e.length;++r)o[r]>n&&(n=o[r],i=e[r]+o[r]/2);return new Vec2(Math.cos(i),Math.sin(i))},rnd.ReStruct.prototype.bondRecalc=function(t,e){var o=this.render,r=this.atoms.get(e.b.begin),n=this.atoms.get(e.b.end),i=o.ps(r.a.pp),a=o.ps(n.a.pp),s=this.molecule.halfBonds.get(e.b.hb1),d=this.molecule.halfBonds.get(e.b.hb2);s.p=this.shiftBondEnd(r,i,s.dir,2*t.lineWidth),d.p=this.shiftBondEnd(n,a,d.dir,2*t.lineWidth),e.b.center=Vec2.lc2(r.a.pp,.5,n.a.pp,.5),e.b.len=Vec2.dist(i,a),e.b.sb=5*t.lineWidth,e.b.sa=Math.max(e.b.sb,e.b.len/2-2*t.lineWidth),e.b.angle=180*Math.atan2(s.dir.y,s.dir.x)/Math.PI},rnd.ReStruct.prototype.showBonds=function(){var t=this.render,e=t.settings,o=t.paper,r=t.opt;for(var n in this.bondsChanged){var i=this.bonds.get(n),a=this.molecule.halfBonds.get(i.b.hb1),s=this.molecule.halfBonds.get(i.b.hb2);this.bondRecalc(e,i),i.path=this.drawBond(i,a,s),i.rbb=rnd.relBox(i.path.getBBox()),this.addReObjectPath("data",i.visel,i.path,null,!0);var d={};d.path=this.drawReactingCenter(i,a,s),d.path&&(d.rbb=rnd.relBox(d.path.getBBox()),this.addReObjectPath("data",i.visel,d.path,null,!0));var l={};l.path=this.drawTopologyMark(i,a,s),l.path&&(l.rbb=rnd.relBox(l.path.getBBox()),this.addReObjectPath("data",i.visel,l.path,null,!0)),i.setHighlight(i.highlight,t);var c=.6*e.subFontSize,u=null,h=null;if(r.showBondIds){var p=Vec2.lc(a.p,.5,s.p,.5,a.norm,c);u=o.text(p.x,p.y,n.toString()),h=rnd.relBox(u.getBBox()),this.centerText(u,h),this.addReObjectPath("indices",i.visel,u)}if(r.showHalfBondIds){var f=Vec2.lc(a.p,.8,s.p,.2,a.norm,c);u=o.text(f.x,f.y,i.b.hb1.toString()),h=rnd.relBox(u.getBBox()),this.centerText(u,h),this.addReObjectPath("indices",i.visel,u);var m=Vec2.lc(a.p,.2,s.p,.8,s.norm,c);u=o.text(m.x,m.y,i.b.hb2.toString()),h=rnd.relBox(u.getBBox()),this.centerText(u,h),this.addReObjectPath("indices",i.visel,u)}if(r.showLoopIds&&!r.showBondIds){var g=Vec2.lc(a.p,.5,s.p,.5,s.norm,c);u=o.text(g.x,g.y,a.loop.toString()),h=rnd.relBox(u.getBBox()),this.centerText(u,h),this.addReObjectPath("indices",i.visel,u);var b=Vec2.lc(a.p,.5,s.p,.5,a.norm,c);u=o.text(b.x,b.y,s.loop.toString()),h=rnd.relBox(u.getBBox()),this.centerText(u,h),this.addReObjectPath("indices",i.visel,u)}}},rnd.ReStruct.prototype.labelIsVisible=function(t,e){if(0==e.a.neighbors.length||e.a.neighbors.length<2&&!this.render.opt.hideTerminalLabels||"c"!=e.a.label.toLowerCase()||e.a.badConn&&this.render.opt.showValenceWarnings||0!=e.a.isotope||0!=e.a.radical||0!=e.a.charge||e.a.explicitValence>=0||null!=e.a.atomList||null!=e.a.rglabel)return!0;if(2==e.a.neighbors.length){var o=e.a.neighbors[0],r=e.a.neighbors[1],n=this.molecule.halfBonds.get(o),i=this.molecule.halfBonds.get(r),a=this.bonds.get(n.bid),s=this.bonds.get(i.bid);if(a.b.type==s.b.type&&a.b.stereo==chem.Struct.BOND.STEREO.NONE&&s.b.stereo==chem.Struct.BOND.STEREO.NONE&&Math.abs(Vec2.cross(n.dir,i.dir))<.2)return!0}return!1},rnd.ReStruct.prototype.checkLabelsToShow=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);e.showLabel=this.labelIsVisible(t,e)}},rnd.ReStruct.layerMap={background:0,"selection-plate":1,highlighting:2,warnings:3,data:4,indices:5},rnd.ReStruct.prototype.addReObjectPath=function(t,e,o,r,n){if(o){var i=this.render.offset,a=n?Box2Abs.fromRelBox(rnd.relBox(o.getBBox())):null,s=r&&a?a.translate(r.negated()):null;null!==i&&(o.translateAbs(i.x,i.y),a=a?a.translate(i):null),e.add(o,a,s),this.insertInLayer(rnd.ReStruct.layerMap[t],o)}},rnd.ReStruct.prototype.clearVisel=function(t){for(var e=0;e<t.paths.length;++e)t.paths[e].remove();t.clear()},rnd.ReStruct.prototype.selectDoubleBondShift=function(t,e,o,r){return 6==t&&6!=e&&(o>1||1==r)?-1:6==e&&6!=t&&(r>1||1==o)?1:e*o>t*r?-1:t*r>e*o?1:e>t?-1:1},rnd.ReStruct.prototype.selectDoubleBondShift_Chain=function(t){var e=this.molecule,o=e.halfBonds.get(t.b.hb1),r=e.halfBonds.get(t.b.hb2),n=(o.leftSin>.3?1:0)+(r.rightSin>.3?1:0),i=(r.leftSin>.3?1:0)+(o.rightSin>.3?1:0);return n>i?-1:i>n?1:1==(o.leftSin>.3?1:0)+(o.rightSin>.3?1:0)?1:0},rnd.ReStruct.prototype.setDoubleBondShift=function(){var t=this.molecule;for(var e in this.bondsChanged){var o,r,n=this.bonds.get(e);if(o=t.halfBonds.get(n.b.hb1).loop,r=t.halfBonds.get(n.b.hb2).loop,o>=0&&r>=0){var i=t.loops.get(o).dblBonds,a=t.loops.get(r).dblBonds,s=t.loops.get(o).hbs.length,d=t.loops.get(r).hbs.length;n.doubleBondShift=this.selectDoubleBondShift(s,d,i,a)}else n.doubleBondShift=o>=0?-1:r>=0?1:this.selectDoubleBondShift_Chain(n)}},rnd.ReStruct.prototype.updateLoops=function(){this.reloops.each(function(t,e){this.clearVisel(e.visel)},this);var t=this.molecule.findLoops();util.each(t.bondsToMark,function(t){this.markBond(t,1)},this),util.each(t.newLoops,function(t){this.reloops.set(t,new rnd.ReLoop(this.molecule.loops.get(t)))},this)},rnd.ReStruct.prototype.renderLoops=function(){var t=this.render,e=t.settings,o=t.paper,r=this.molecule;this.reloops.each(function(n,i){var a=i.loop;i.centre=new Vec2,a.hbs.each(function(e){var o=r.halfBonds.get(e),n=this.bonds.get(o.bid),s=t.ps(this.atoms.get(o.begin).a.pp);n.b.type!=chem.Struct.BOND.TYPE.AROMATIC&&(a.aromatic=!1),i.centre.add_(s)},this),a.convex=!0;for(var s=0;s<i.loop.hbs.length;++s){var d=r.halfBonds.get(a.hbs[s]),l=r.halfBonds.get(a.hbs[(s+1)%a.hbs.length]),c=Math.atan2(Vec2.cross(d.dir,l.dir),Vec2.dot(d.dir,l.dir));c>0&&(a.convex=!1)}if(i.centre=i.centre.scaled(1/a.hbs.length),i.radius=-1,a.hbs.each(function(e){var o=r.halfBonds.get(e),n=t.ps(this.atoms.get(o.begin).a.pp),a=t.ps(this.atoms.get(o.end).a.pp),s=Vec2.diff(a,n).rotateSC(1,0).normalized(),d=Vec2.dot(Vec2.diff(n,i.centre),s);i.radius=i.radius<0?d:Math.min(i.radius,d)},this),i.radius*=.7,a.aromatic){var u=null;if(a.convex)u=o.circle(i.centre.x,i.centre.y,i.radius).attr({stroke:"#000","stroke-width":e.lineWidth});else{var h="";for(s=0;s<a.hbs.length;++s){d=r.halfBonds.get(a.hbs[s]),l=r.halfBonds.get(a.hbs[(s+1)%a.hbs.length]),c=Math.atan2(Vec2.cross(d.dir,l.dir),Vec2.dot(d.dir,l.dir));var p=(Math.PI-c)/2,f=l.dir.rotate(p),m=t.ps(this.atoms.get(l.begin).a.pp),g=Math.sin(p),b=.1;Math.abs(g)<b&&(g=g*b/Math.abs(g));var v=e.bondSpace/g,y=m.addScaled(f,-v);h+=0==s?"M":"L",h+=tfx(y.x)+","+tfx(y.y)}h+="Z",u=o.path(h).attr({stroke:"#000","stroke-width":e.lineWidth,"stroke-dasharray":"- "})}this.addReObjectPath("data",i.visel,u,null,!0)}},this)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem/element":10,"../util":39,"../util/box2abs":38,"../util/vec2":43,"./restruct":23}],25:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Vec2=require("../util/vec2"),rnd=global.rnd=global.rnd||{};rnd.Visel=function(e){this.type=e,this.paths=[],this.boxes=[],this.boundingBox=null},rnd.Visel.TYPE={ATOM:1,BOND:2,LOOP:3,ARROW:4,PLUS:5,SGROUP:6,TMP:7,FRAGMENT:8,RGROUP:9,CHIRAL_FLAG:10},rnd.Visel.prototype.add=function(e,t,n){this.paths.push(e),t&&(this.boxes.push(t),this.boundingBox=null==this.boundingBox?t:Box2Abs.union(this.boundingBox,t)),n&&this.exts.push(n)},rnd.Visel.prototype.clear=function(){this.paths=[],this.boxes=[],this.exts=[],this.boundingBox=null},rnd.Visel.prototype.translate=function(e,t){if(arguments.length>2)throw new Error("One vector or two scalar arguments expected");if(void 0===t)this.translate(e.x,e.y);else{for(var n=new Vec2(e,t),r=0;r<this.paths.length;++r)this.paths[r].translateAbs(e,t);for(var o=0;o<this.boxes.length;++o)this.boxes[o]=this.boxes[o].translate(n);null!==this.boundingBox&&(this.boundingBox=this.boundingBox.translate(n))}};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util/box2abs":38,"../util/vec2":43}],26:[function(require,module,exports){
(function (global){
function Action(){this.operations=[]}function fromMultipleMove(e,t){t=new Vec2(t);var r,o=new Action,n=ui.render,i=n.ctab,a=i.molecule,u=[],l=Set.empty(),d=Set.empty();if(e.atoms){var s=Set.fromList(e.atoms);for(i.bonds.each(function(e,t){Set.contains(s,t.b.begin)&&Set.contains(s,t.b.end)?(u.push(e),util.each(["hb1","hb2"],function(e){var r=a.halfBonds.get(t.b[e]).loop;r>=0&&Set.add(l,r)},this)):Set.contains(s,t.b.begin)?Set.add(d,t.b.begin):Set.contains(s,t.b.end)&&Set.add(d,t.b.end)},this),r=0;r<u.length;++r)o.addOp(new op.BondMove(u[r],t));for(Set.each(l,function(e){i.reloops.get(e)&&i.reloops.get(e).visel&&o.addOp(new op.LoopMove(e,t))},this),r=0;r<e.atoms.length;++r){var c=e.atoms[r];o.addOp(new op.AtomMove(c,t,!Set.contains(d,c)))}}if(e.rxnArrows)for(r=0;r<e.rxnArrows.length;++r)o.addOp(new op.RxnArrowMove(e.rxnArrows[r],t,!0));if(e.rxnPluses)for(r=0;r<e.rxnPluses.length;++r)o.addOp(new op.RxnPlusMove(e.rxnPluses[r],t,!0));if(e.sgroupData)for(r=0;r<e.sgroupData.length;++r)o.addOp(new op.SGroupDataMove(e.sgroupData[r],t));if(e.chiralFlags)for(r=0;r<e.chiralFlags.length;++r)o.addOp(new op.ChiralFlagMove(t));return o.perform()}function fromAtomsAttrs(e,t,r){var o=new Action;return("number"==typeof e?[e]:e).each(function(e){for(var n in chem.Struct.Atom.attrlist){var i;if(n in t)i=t[n];else{if(!r)continue;i=chem.Struct.Atom.attrGetDefault(n)}o.addOp(new op.AtomAttr(e,n,i))}!r&&"label"in t&&null!=t.label&&"L#"!=t.label&&!t.atomList&&o.addOp(new op.AtomAttr(e,"atomList",null))},this),o.perform()}function fromBondAttrs(e,t,r,o){var n=new Action;for(var i in chem.Struct.Bond.attrlist){var a;if(i in t)a=t[i];else{if(!o)continue;a=chem.Struct.Bond.attrGetDefault(i)}n.addOp(new op.BondAttr(e,i,a))}return r&&n.mergeWith(toBondFlipping(e)),n.perform()}function fromSelectedBondsAttrs(e,t){var r=new Action;return e=new Hash(e),ui.editor.getSelection().bonds.each(function(t){e.each(function(e){r.addOp(new op.BondAttr(t,e.key,e.value))},this)},this),t&&t.each(function(e){r.mergeWith(toBondFlipping(e))},this),r.perform()}function fromAtomAddition(e,t){t=Object.clone(t);var r=new Action;return t.fragment=r.addOp((new op.FragmentAdd).perform(ui.editor)).frid,r.addOp(new op.AtomAdd(t,e).perform(ui.editor)),r}function mergeFragments(e,t,r){if(r!=t&&Object.isNumber(r)){var o=chem.Struct.RGroup.findRGroupByFragment(ui.render.ctab.molecule.rgroups,r);Object.isUndefined(o)||e.mergeWith(fromRGroupFragment(null,r)),ui.render.ctab.molecule.atoms.each(function(o,n){n.fragment==r&&e.addOp(new op.AtomAttr(o,"fragment",t).perform(ui.editor))}),e.addOp(new op.FragmentDelete(r).perform(ui.editor))}}function atomForNewBond(e){var t=[],r=ui.render.atomGetPos(e);ui.render.atomGetNeighbors(e).each(function(e){var o=ui.render.atomGetPos(e.aid);Vec2.dist(r,o)<.1||t.push({id:e.aid,v:Vec2.diff(o,r)})}),t.sort(function(e,t){return Math.atan2(e.v.y,e.v.x)-Math.atan2(t.v.y,t.v.x)});var o,n,i=0,a=0;for(o=0;o<t.length;o++)n=Vec2.angle(t[o].v,t[(o+1)%t.length].v),0>n&&(n+=2*Math.PI),n>a&&(i=o,a=n);var u=new Vec2(1,0);if(t.length>0){if(1==t.length){a=-(4*Math.PI/3);var l=ui.render.atomGetNeighbors(e)[0];if(ui.render.atomGetDegree(l.aid)>1){var d=[],s=ui.render.atomGetPos(l.aid),c=Vec2.diff(r,s),p=Math.atan2(c.y,c.x);ui.render.atomGetNeighbors(l.aid).each(function(e){var t=ui.render.atomGetPos(e.aid);if(!(e.bid==l.bid||Vec2.dist(s,t)<.1)){var r=Vec2.diff(t,s),o=Math.atan2(r.y,r.x)-p;0>o&&(o+=2*Math.PI),d.push(o)}}),d.sort(function(e,t){return e-t}),d[0]<=1.01*Math.PI&&d[d.length-1]<=1.01*Math.PI&&(a*=-1)}}n=a/2+Math.atan2(t[i].v.y,t[i].v.x),u=u.rotate(n)}u.add_(r);var m=ui.render.findClosestAtom(u,.1);return m=null==m?{label:"C"}:m.id,{atom:m,pos:u}}function fromBondAddition(e,t,r,o,n){if(void 0===r){var i=atomForNewBond(t);r=i.atom,o=i.pos}var a=new Action,u=null;if(Object.isNumber(t)){if(u=ui.render.atomGetAttr(t,"fragment"),Object.isNumber(r)){var l=ui.render.atomGetAttr(r,"fragment");mergeFragments(a,u,l)}}else Object.isNumber(r)&&(u=ui.render.atomGetAttr(r,"fragment"));null==u&&(u=a.addOp((new op.FragmentAdd).perform(ui.editor)).frid),Object.isNumber(t)?"*"==ui.render.atomGetAttr(t,"label")&&a.addOp(new op.AtomAttr(t,"label","C").perform(ui.editor)):(t.fragment=u,t=a.addOp(new op.AtomAdd(t,o).perform(ui.editor)).data.aid,o=n),Object.isNumber(r)?"*"==ui.render.atomGetAttr(r,"label")&&a.addOp(new op.AtomAttr(r,"label","C").perform(ui.editor)):(r.fragment=u,r=a.addOp(new op.AtomAdd(r,o).perform(ui.editor)).data.aid,Object.isNumber(t)&&ui.render.atomGetSGroups(t).each(function(e){a.addOp(new op.SGroupAtomAdd(e,r).perform(ui.editor))},this));var d=a.addOp(new op.BondAdd(t,r,e).perform(ui.editor)).data.bid;return a.operations.reverse(),[a,t,r,d]}function fromArrowAddition(e){var t=new Action;return ui.ctab.rxnArrows.count()<1&&t.addOp(new op.RxnArrowAdd(e).perform(ui.editor)),t}function fromArrowDeletion(e){var t=new Action;return t.addOp(new op.RxnArrowDelete(e)),t.perform()}function fromChiralFlagAddition(e){var t=new Action;return ui.render.ctab.chiralFlags.count()<1&&t.addOp(new op.ChiralFlagAdd(e).perform(ui.editor)),t}function fromChiralFlagDeletion(){var e=new Action;return e.addOp(new op.ChiralFlagDelete),e.perform()}function fromPlusAddition(e){var t=new Action;return t.addOp(new op.RxnPlusAdd(e).perform(ui.editor)),t}function fromPlusDeletion(e){var t=new Action;return t.addOp(new op.RxnPlusDelete(e)),t.perform()}function fromAtomDeletion(e){var t=new Action,r=new Array,o=ui.ctab.atoms.get(e).fragment;return ui.render.atomGetNeighbors(e).each(function(e){t.addOp(new op.BondDelete(e.bid)),1==ui.render.atomGetDegree(e.aid)&&(t.removeAtomFromSgroupIfNeeded(e.aid)&&r.push(e.aid),t.addOp(new op.AtomDelete(e.aid)))},this),t.removeAtomFromSgroupIfNeeded(e)&&r.push(e),t.addOp(new op.AtomDelete(e)),t.removeSgroupIfNeeded(r),t=t.perform(),t.mergeWith(fromFragmentSplit(o)),t}function fromBondDeletion(e){var t=new Action,r=ui.ctab.bonds.get(e),o=ui.ctab.atoms.get(r.begin).fragment,n=new Array;return t.addOp(new op.BondDelete(e)),1==ui.render.atomGetDegree(r.begin)&&(t.removeAtomFromSgroupIfNeeded(r.begin)&&n.push(r.begin),t.addOp(new op.AtomDelete(r.begin))),1==ui.render.atomGetDegree(r.end)&&(t.removeAtomFromSgroupIfNeeded(r.end)&&n.push(r.end),t.addOp(new op.AtomDelete(r.end))),t.removeSgroupIfNeeded(n),t=t.perform(),t.mergeWith(fromFragmentSplit(o)),t}function fromFragmentSplit(e){var t=new Action,r=chem.Struct.RGroup.findRGroupByFragment(ui.ctab.rgroups,e);return ui.ctab.atoms.each(function(o,n){if(n.fragment==e){var i=t.addOp((new op.FragmentAdd).perform(ui.editor)).frid,a=function(r){t.addOp(new op.AtomAttr(r,"fragment",i).perform(ui.editor)),ui.render.atomGetNeighbors(r).each(function(t){ui.ctab.atoms.get(t.aid).fragment==e&&a(t.aid)})};a(o),r&&t.mergeWith(fromRGroupFragment(r,i))}}),-1!=e&&(t.mergeWith(fromRGroupFragment(0,e)),t.addOp(new op.FragmentDelete(e).perform(ui.editor))),t}function fromFragmentAddition(e,t,r,o,n){var i=new Action;return r.each(function(e){i.addOp(new op.SGroupRemoveFromHierarchy(e)),i.addOp(new op.SGroupDelete(e))},this),t.each(function(e){i.addOp(new op.BondDelete(e))},this),e.each(function(e){i.addOp(new op.AtomDelete(e))},this),o.each(function(e){i.addOp(new op.RxnArrowDelete(e))},this),n.each(function(e){i.addOp(new op.RxnPlusDelete(e))},this),i.mergeWith(new fromFragmentSplit(-1)),i}function fromFragmentDeletion(e){e=e||ui.editor.getSelection();var t=new Action,r=new Array,o=[],n=new Action;for(e.sgroupData&&e.sgroupData.each(function(e){n.mergeWith(fromSgroupDeletion(e))},this),e.atoms.each(function(t){ui.render.atomGetNeighbors(t).each(function(t){-1==e.bonds.indexOf(t.bid)&&(e.bonds=e.bonds.concat([t.bid]))},this)},this),e.bonds.each(function(n){t.addOp(new op.BondDelete(n));var i=ui.ctab.bonds.get(n);if(-1==e.atoms.indexOf(i.begin)&&1==ui.render.atomGetDegree(i.begin)){var a=ui.ctab.atoms.get(i.begin).fragment;o.indexOf(a)<0&&o.push(a),t.removeAtomFromSgroupIfNeeded(i.begin)&&r.push(i.begin),t.addOp(new op.AtomDelete(i.begin))}if(-1==e.atoms.indexOf(i.end)&&1==ui.render.atomGetDegree(i.end)){var u=ui.ctab.atoms.get(i.end).fragment;o.indexOf(u)<0&&o.push(u),t.removeAtomFromSgroupIfNeeded(i.end)&&r.push(i.end),t.addOp(new op.AtomDelete(i.end))}},this),e.atoms.each(function(e){var n=ui.ctab.atoms.get(e).fragment;o.indexOf(n)<0&&o.push(n),t.removeAtomFromSgroupIfNeeded(e)&&r.push(e),t.addOp(new op.AtomDelete(e))},this),t.removeSgroupIfNeeded(r),e.rxnArrows.each(function(e){t.addOp(new op.RxnArrowDelete(e))},this),e.rxnPluses.each(function(e){t.addOp(new op.RxnPlusDelete(e))},this),e.chiralFlags.each(function(e){t.addOp(new op.ChiralFlagDelete(e))},this),t=t.perform();o.length>0;)t.mergeWith(new fromFragmentSplit(o.pop()));return t.mergeWith(n),t}function fromAtomMerge(e,t){var r=new Action,o=ui.render.atomGetAttr(e,"fragment"),n=ui.render.atomGetAttr(t,"fragment");o!=n&&mergeFragments(r,o,n);var i=new Action;ui.render.atomGetNeighbors(e).each(function(e){var r,o,n=ui.ctab.bonds.get(e.bid);n.begin==e.aid?(r=e.aid,o=t):(r=t,o=e.aid),t!=n.begin&&t!=n.end&&-1==ui.ctab.findBondId(r,o)&&i.addOp(new op.BondAdd(r,o,n)),i.addOp(new op.BondDelete(e.bid))},this);var a=chem.Struct.Atom.getAttrHash(ui.ctab.atoms.get(e));1==ui.render.atomGetDegree(e)&&"*"==a.get("label")&&a.set("label","C"),a.each(function(e){i.addOp(new op.AtomAttr(t,e.key,e.value))},this);var u=i.removeAtomFromSgroupIfNeeded(e);return i.addOp(new op.AtomDelete(e)),u&&i.removeSgroupIfNeeded([e]),i.perform().mergeWith(r)}function toBondFlipping(e){var t=ui.ctab.bonds.get(e),r=new Action;return r.addOp(new op.BondDelete(e)),r.addOp(new op.BondAdd(t.end,t.begin,t)).data.bid=e,r}function fromBondFlipping(e){return toBondFlipping(e).perform()}function fromTemplateOnCanvas(e,t,r){var o=new Action,n=r.molecule,i=(new op.FragmentAdd).perform(ui.editor),a={};return n.atoms.each(function(n,u){var l,d=chem.Struct.Atom.getAttrHash(u).toObject();d.fragment=i.frid,o.addOp(l=new op.AtomAdd(d,Vec2.diff(u.pp,r.xy0).rotate(t).add(e)).perform(ui.editor)),a[n]=l.data.aid}),n.bonds.each(function(e,t){o.addOp(new op.BondAdd(a[t.begin],a[t.end],t).perform(ui.editor))}),o.operations.reverse(),o.addOp(i),o}function atomAddToSGroups(e,t){var r=new Action;return util.each(e,function(e){r.addOp(new op.SGroupAtomAdd(e,t).perform(ui.editor))},this),r}function fromTemplateOnAtom(e,t,r,o,n){var i=new Action,a=o.molecule,u=ui.render,l=u.ctab,d=l.molecule,s=d.atoms.get(e),c=e,p=null,m=ui.render.atomGetSGroups(e),f=u.atomGetAttr(e,"fragment"),g={},h=a.atoms.get(o.aid).pp;if(r){if(null==t){var v=atomForNewBond(e),A=fromBondAddition({type:1},e,v.atom,v.pos);i=A[0],i.operations.reverse(),p=e=A[2]}else{var w;i.addOp(w=new op.AtomAdd({label:"C",fragment:f},new Vec2(1,0).rotate(t).add(s.pp)).perform(ui.editor)),i.addOp(new op.BondAdd(e,w.data.aid,{type:1}).perform(ui.editor)),p=e=w.data.aid,i.mergeWith(atomAddToSGroups(m,e))}var b=s;s=d.atoms.get(e);var S=n(b.pp,s.pp)-o.angle0}else null==t&&(v=atomForNewBond(e),t=n(s.pp,v.pos)),S=t-o.angle0;return a.atoms.each(function(t,r){var n=chem.Struct.Atom.getAttrHash(r).toObject();if(n.fragment=f,t==o.aid)i.mergeWith(fromAtomsAttrs(e,n,!0)),g[t]=e;else{var a;a=Vec2.diff(r.pp,h).rotate(S).add(s.pp),i.addOp(w=new op.AtomAdd(n,a).perform(ui.editor)),g[t]=w.data.aid}g[t]-0!==c-0&&g[t]-0!==p-0&&i.mergeWith(atomAddToSGroups(m,g[t]))}),a.bonds.each(function(e,t){i.addOp(new op.BondAdd(g[t.begin],g[t.end],t).perform(ui.editor))}),i.operations.reverse(),i}function fromTemplateOnBond(e,t,r,o){var n,i,a=new Action,u=t.molecule,l=ui.render,d=l.ctab,s=d.molecule,c=s.bonds.get(e),p=s.atoms.get(c.begin),m=s.atoms.get(c.end),f=Set.list(Set.intersection(Set.fromList(ui.render.atomGetSGroups(c.begin)),Set.fromList(ui.render.atomGetSGroups(c.end)))),g=u.bonds.get(t.bid),h=l.atomGetAttr(c.begin,"fragment"),v={};o?(n=u.atoms.get(g.end),i=u.atoms.get(g.begin),v[g.end]=c.begin,v[g.begin]=c.end):(n=u.atoms.get(g.begin),i=u.atoms.get(g.end),v[g.begin]=c.begin,v[g.end]=c.end);var A=r(p.pp,m.pp)-r(n.pp,i.pp),w=Vec2.dist(p.pp,m.pp)/Vec2.dist(n.pp,i.pp);return n.pp,u.atoms.each(function(e,t){var r=chem.Struct.Atom.getAttrHash(t).toObject();if(r.fragment=h,e==g.begin||e==g.end)return a.mergeWith(fromAtomsAttrs(v[e],r,!0)),void 0;var o;o=Vec2.diff(t.pp,n.pp).rotate(A).scaled(w).add(p.pp);var i=l.findClosestAtom(o,.1);if(null==i){var u;a.addOp(u=new op.AtomAdd(r,o).perform(ui.editor)),v[e]=u.data.aid,a.mergeWith(atomAddToSGroups(f,v[e]))}else v[e]=i.id,a.mergeWith(fromAtomsAttrs(v[e],r,!0))}),u.bonds.each(function(e,t){var r=s.findBondId(v[t.begin],v[t.end]);-1==r?a.addOp(new op.BondAdd(v[t.begin],v[t.end],t).perform(ui.editor)):a.mergeWith(fromBondAttrs(r,g,!1,!0))}),a.operations.reverse(),a}function fromChain(e,t,r,o){var n,i=Math.PI/6,a=Math.cos(i),u=Math.sin(i),l=new Action;n=null!=o?ui.render.atomGetAttr(o,"fragment"):l.addOp((new op.FragmentAdd).perform(ui.editor)).frid;var d=-1;return d=null!=o?o:l.addOp(new op.AtomAdd({label:"C",fragment:n},e).perform(ui.editor)).data.aid,l.operations.reverse(),r.times(function(r){var o=new Vec2(a*(r+1),1&r?0:u).rotate(t).add(e),n=ui.render.findClosestAtom(o,.1),i=fromBondAddition({},d,n?n.id:{},o);l=i[0].mergeWith(l),d=i[2]},this),l}function fromNewCanvas(e){var t=new Action;return t.addOp(new op.CanvasLoad(e)),t.perform()}function fromSgroupType(e,t){var r=ui.render,o=r.sGroupGetType(e);if(t&&t!=o){var n=util.array(r.sGroupGetAtoms(e)),i=r.sGroupGetAttrs(e),a=fromSgroupDeletion(e),u=fromSgroupAddition(t,n,i,e);return u.mergeWith(a)}return new Action}function fromSgroupAttrs(e,t){var r=new Action,o=ui.render,n=o.ctab;return n.sgroups.get(e).item,new Hash(t).each(function(t){r.addOp(new op.SGroupAttr(e,t.key,t.value))},this),r.perform()}function sGroupAttributeAction(e,t){var r=new Action;return new Hash(t).each(function(t){r.addOp(new op.SGroupAttr(e,t.key,t.value))},this),r}function fromSgroupDeletion(e){var t=new Action,r=ui.render,o=r.ctab,n=o.molecule;if("SRU"==ui.render.sGroupGetType(e)){ui.render.sGroupsFindCrossBonds();var i=ui.render.sGroupGetNeighborAtoms(e);i.each(function(e){"*"==ui.render.atomGetAttr(e,"label")&&t.addOp(new op.AtomAttr(e,"label","C"))},this)}var a=n.sgroups.get(e),u=chem.SGroup.getAtoms(n,a),l=a.getAttrs();t.addOp(new op.SGroupRemoveFromHierarchy(e));for(var d=0;d<u.length;++d)t.addOp(new op.SGroupAtomRemove(e,u[d]));return t.addOp(new op.SGroupDelete(e)),t=t.perform(),t.mergeWith(sGroupAttributeAction(e,l)),t}function fromSgroupAddition(e,t,r,o,n){var i,a=new Action;for(o=o-0===o?o:ui.render.ctab.molecule.sgroups.newId(),a.addOp(new op.SGroupCreate(o,e,n)),i=0;i<t.length;i++)a.addOp(new op.SGroupAtomAdd(o,t[i]));if(a.addOp(new op.SGroupAddToHierarchy(o)),a=a.perform(),"SRU"==e){ui.render.sGroupsFindCrossBonds();var u=new Action;ui.render.sGroupGetNeighborAtoms(o).each(function(e){1==ui.render.atomGetDegree(e)&&ui.render.atomIsPlainCarbon(e)&&u.addOp(new op.AtomAttr(e,"label","*"))},this),u=u.perform(),u.mergeWith(a),a=u}return fromSgroupAttrs(o,r).mergeWith(a)}function fromRGroupAttrs(e,t){var r=new Action;return new Hash(t).each(function(t){r.addOp(new op.RGroupAttr(e,t.key,t.value))},this),r.perform()}function fromRGroupFragment(e,t){var r=new Action;return r.addOp(new op.RGroupFragment(e,t)),r.perform()}function getAnchorPosition(e){if(e.atoms.length){for(var t=1e50,r=t,o=-t,n=-r,i=0;i<e.atoms.length;i++)t=Math.min(t,e.atoms[i].pp.x),r=Math.min(r,e.atoms[i].pp.y),o=Math.max(o,e.atoms[i].pp.x),n=Math.max(n,e.atoms[i].pp.y);return new Vec2((t+o)/2,(r+n)/2)}return e.rxnArrows.length?e.rxnArrows[0].pp:e.rxnPluses.length?e.rxnPluses[0].pp:e.chiralFlags.length?e.chiralFlags[0].pp:null}function struct2Clipboard(e){console.assert(!e.isBlank(),"Empty struct");var t={atoms:e.atoms.keys(),bonds:e.bonds.keys(),rxnArrows:e.rxnArrows.keys(),rxnPluses:e.rxnPluses.keys()},r={atoms:[],bonds:[],sgroups:[],rxnArrows:[],rxnPluses:[],chiralFlags:[],rgmap:{},rgroups:{}},o={};t.atoms.each(function(t){var n=new chem.Struct.Atom(e.atoms.get(t));n.pos=n.pp,o[t]=r.atoms.push(new chem.Struct.Atom(n))-1}),t.bonds.each(function(t){var n=new chem.Struct.Bond(e.bonds.get(t));n.begin=o[n.begin],n.end=o[n.end],r.bonds.push(new chem.Struct.Bond(n))});var n=e.getSGroupsInAtomSet(t.atoms);util.each(n,function(t){for(var n=e.sgroups.get(t),i=chem.SGroup.getAtoms(e,n),a={type:n.type,attrs:n.getAttrs(),atoms:util.array(i),pp:n.pp},u=0;u<a.atoms.length;u++)a.atoms[u]=o[a.atoms[u]];r.sgroups.push(a)},this),t.rxnArrows.each(function(t){var o=new chem.Struct.RxnArrow(e.rxnArrows.get(t));o.pos=o.pp,r.rxnArrows.push(o)}),t.rxnPluses.each(function(t){var o=new chem.Struct.RxnPlus(e.rxnPluses.get(t));o.pos=o.pp,r.rxnPluses.push(o)});var i={},a=Set.empty();t.atoms.each(function(t){var r=e.atoms.get(t),o=r.fragment;i[t]=o,Set.add(a,o)});var u=Set.empty();return Set.each(a,function(t){for(var o=chem.Struct.Fragment.getAtoms(e,t),n=0;n<o.length;++n)if(!Set.contains(i,o[n]))return;var a=chem.Struct.RGroup.findRGroupByFragment(e.rgroups,t);r.rgmap[t]=a,Set.add(u,a)},this),Set.each(u,function(t){r.rgroups[t]=e.rgroups.get(t).getAttrs()},this),r}function fromPaste(e,t){for(var r=struct2Clipboard(e),o=t?Vec2.diff(t,getAnchorPosition(r)):new Vec2,n=new Action,i={},a={},u=0;u<r.atoms.length;u++){var l=Object.clone(r.atoms[u]);l.fragment in a||(a[l.fragment]=n.addOp((new op.FragmentAdd).perform(ui.editor)).frid),l.fragment=a[l.fragment],i[u]=n.addOp(new op.AtomAdd(l,l.pp.add(o)).perform(ui.editor)).data.aid}var d=[];for(var s in r.rgroups)ui.ctab.rgroups.has(s)||d.push(s);for(var c in r.rgmap)n.addOp(new op.RGroupFragment(r.rgmap[c],a[c]).perform(ui.editor));for(var p=0;p<d.length;++p)n.mergeWith(fromRGroupAttrs(d[p],r.rgroups[d[p]]));for(var m=0;m<r.bonds.length;m++){var f=Object.clone(r.bonds[m]);n.addOp(new op.BondAdd(i[f.begin],i[f.end],f).perform(ui.editor))}for(var g=0;g<r.sgroups.length;g++){for(var h=r.sgroups[g],v=h.atoms,A=[],w=0;w<v.length;w++)A.push(i[v[w]]);for(var b=ui.render.ctab.molecule.sgroups.newId(),S=fromSgroupAddition(h.type,A,h.attrs,b,h.pp?h.pp.add(o):null),O=S.operations.length-1;O>=0;O--)n.addOp(S.operations[O])}if(ui.editor.render.ctab.rxnArrows.count()<1)for(var y=0;y<r.rxnArrows.length;y++)n.addOp(new op.RxnArrowAdd(r.rxnArrows[y].pp.add(o)).perform(ui.editor));for(var x=0;x<r.rxnPluses.length;x++)n.addOp(new op.RxnPlusAdd(r.rxnPluses[x].pp.add(o)).perform(ui.editor));return n.operations.reverse(),n}function fromFlip(e,t){var r,o=ui.render,n=o.ctab,i=n.molecule,a=new Action,u={};if(e.atoms){for(r=0;r<e.atoms.length;r++){var l=e.atoms[r],d=i.atoms.get(l);d.fragment in u?u[d.fragment].push(l):u[d.fragment]=[l]}if(u=new Hash(u),u.detect(function(e){return!Set.eq(i.getFragmentIds(e[0]),Set.fromList(e[1]))}))return a;if(u.each(function(e){var r=Set.fromList(e[1]),o=i.getCoordBoundingBox(r);Set.each(r,function(e){var r=i.atoms.get(e),n=new Vec2;"horizontal"==t?n.x=o.min.x+o.max.x-2*r.pp.x:n.y=o.min.y+o.max.y-2*r.pp.y,a.addOp(new op.AtomMove(e,n))})}),e.bonds)for(r=0;r<e.bonds.length;r++){var s=e.bonds[r],c=i.bonds.get(s);c.type==chem.Struct.BOND.TYPE.SINGLE&&(c.stereo==chem.Struct.BOND.STEREO.UP?a.addOp(new op.BondAttr(s,"stereo",chem.Struct.BOND.STEREO.DOWN)):c.stereo==chem.Struct.BOND.STEREO.DOWN&&a.addOp(new op.BondAttr(s,"stereo",chem.Struct.BOND.STEREO.UP)))}}return a.perform()}function fromRotate(e,t,r){function o(e){var o=e.sub(t);return o=o.rotate(r),o.add_(t),o.sub(e)}var n=ui.render,i=n.ctab,a=i.molecule,u=new Action;return e.atoms&&e.atoms.each(function(e){var t=a.atoms.get(e);u.addOp(new op.AtomMove(e,o(t.pp)))}),e.rxnArrows&&e.rxnArrows.each(function(e){var t=a.rxnArrows.get(e);u.addOp(new op.RxnArrowMove(e,o(t.pp)))}),e.rxnPluses&&e.rxnPluses.each(function(e){var t=a.rxnPluses.get(e);u.addOp(new op.RxnPlusMove(e,o(t.pp)))}),e.sgroupData&&e.sgroupData.each(function(e){var t=a.sgroups.get(e);u.addOp(new op.SGroupDataMove(e,o(t.pp)))}),e.chiralFlags&&e.chiralFlags.each(function(e){var t=a.chiralFlags.get(e);u.addOp(new op.ChiralFlagMove(e,o(t.pp)))}),u.perform()}var Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),op=require("./op");require("../chem");var ui=global.ui,chem=global.chem;Action.prototype.addOp=function(e){return e.isDummy(ui.editor)||this.operations.push(e),e},Action.prototype.mergeWith=function(e){return this.operations=this.operations.concat(e.operations),this},Action.prototype.perform=function(){var e=new Action,t=0;return this.operations.each(function(r){e.addOp(r.perform(ui.editor)),t++},this),e.operations.reverse(),e},Action.prototype.isDummy=function(){return null==this.operations.detect(function(e){return!e.isDummy(ui.editor)},this)},Action.prototype.removeAtomFromSgroupIfNeeded=function(e){var t=ui.render.atomGetSGroups(e);return t.length>0?(t.each(function(t){this.addOp(new op.SGroupAtomRemove(t,e))},this),!0):!1},Action.prototype.removeSgroupIfNeeded=function(e){var t=ui.render,r=t.ctab,o=r.molecule,n=new Hash;e.each(function(e){var t=ui.render.atomGetSGroups(e);t.each(function(e){var t=n.get(e);Object.isUndefined(t)?t=1:t++,n.set(e,t)},this)},this),n.each(function(e){var t=parseInt(e.key),r=ui.render.sGroupGetAtoms(t);if(r.length==e.value){var n=o.sgroups.get(t);this.mergeWith(sGroupAttributeAction(t,n.getAttrs())),this.addOp(new op.SGroupRemoveFromHierarchy(t)),this.addOp(new op.SGroupDelete(t))}},this)},module.exports=util.extend(Action,{fromMultipleMove:fromMultipleMove,fromAtomAddition:fromAtomAddition,fromArrowAddition:fromArrowAddition,fromArrowDeletion:fromArrowDeletion,fromChiralFlagDeletion:fromChiralFlagDeletion,fromPlusAddition:fromPlusAddition,fromPlusDeletion:fromPlusDeletion,fromAtomDeletion:fromAtomDeletion,fromBondDeletion:fromBondDeletion,fromFragmentDeletion:fromFragmentDeletion,fromAtomMerge:fromAtomMerge,fromBondFlipping:fromBondFlipping,fromTemplateOnCanvas:fromTemplateOnCanvas,fromTemplateOnAtom:fromTemplateOnAtom,fromTemplateOnBond:fromTemplateOnBond,fromAtomsAttrs:fromAtomsAttrs,fromBondAttrs:fromBondAttrs,fromChain:fromChain,fromBondAddition:fromBondAddition,fromNewCanvas:fromNewCanvas,fromSgroupType:fromSgroupType,fromSgroupDeletion:fromSgroupDeletion,fromSgroupAttrs:fromSgroupAttrs,fromRGroupFragment:fromRGroupFragment,fromPaste:fromPaste,fromRGroupAttrs:fromRGroupAttrs,fromSgroupAddition:fromSgroupAddition,fromFlip:fromFlip,fromRotate:fromRotate});

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../util":39,"../util/set":42,"../util/vec2":43,"./op":35}],27:[function(require,module,exports){
(function (global){
function initDialogs(){$("input_label").observe("blur",function(){keymage.setScope("editor"),this.hide()}),$("input_label").observe("keypress",onKeyPress_InputLabel),$("input_label").observe("keyup",onKeyUp_InputLabel),$("atom_label").observe("change",onChange_AtomLabel),$("atom_charge").observe("change",onChange_AtomCharge),$("atom_isotope").observe("change",onChange_AtomIsotope),$("atom_valence").observe("change",onChange_AtomValence),$("atom_prop_cancel").observe("click",function(){ui.hideDialog("atom_properties")}),$("atom_prop_ok").observe("click",function(){applyAtomProperties()}),$("bond_prop_cancel").observe("click",function(){ui.hideDialog("bond_properties")}),$("bond_prop_ok").observe("click",function(){applyBondProperties()})}function showAtomAttachmentPoints(e){$("atom_ap1").checked=(1&(e.selection||0))>0,$("atom_ap2").checked=(2&(e.selection||0))>0,ui.showDialog("atom_attpoints");var t=new Event.Handler("atom_attpoints_ok","click",void 0,function(){t.stop(),o.stop(),ui.hideDialog("atom_attpoints"),"onOk"in e&&e.onOk(($("atom_ap1").checked?1:0)+($("atom_ap2").checked?2:0))}).start(),o=new Event.Handler("atom_attpoints_cancel","click",void 0,function(){t.stop(),o.stop(),ui.hideDialog("atom_attpoints"),"onCancel"in e&&e.onCancel()}).start();$("atom_attpoints_ok").focus()}function showAtomProperties(e){$("atom_properties").atom_id=e,$("atom_label").value=ui.render.atomGetAttr(e,"label"),onChange_AtomLabel.call($("atom_label"));var t=ui.render.atomGetAttr(e,"charge")-0;$("atom_charge").value=0==t?"":t,t=ui.render.atomGetAttr(e,"isotope")-0,$("atom_isotope").value=0==t?"":t,t=ui.render.atomGetAttr(e,"explicitValence")-0,$("atom_valence").value=0>t?"":t,$("atom_radical").value=ui.render.atomGetAttr(e,"radical"),$("atom_inversion").value=ui.render.atomGetAttr(e,"invRet"),$("atom_exactchange").value=ui.render.atomGetAttr(e,"exactChangeFlag")?1:0,$("atom_ringcount").value=ui.render.atomGetAttr(e,"ringBondCount"),$("atom_substitution").value=ui.render.atomGetAttr(e,"substitutionCount"),$("atom_unsaturation").value=ui.render.atomGetAttr(e,"unsaturatedAtom"),$("atom_hcount").value=ui.render.atomGetAttr(e,"hCount"),ui.showDialog("atom_properties"),$("atom_label").activate()}function applyAtomProperties(){ui.hideDialog("atom_properties");var e=$("atom_properties").atom_id;ui.addUndoAction(Action.fromAtomsAttrs(e,{label:$("atom_label").value,charge:""==$("atom_charge").value?0:parseInt($("atom_charge").value,10),isotope:""==$("atom_isotope").value?0:parseInt($("atom_isotope").value,10),explicitValence:""==$("atom_valence").value?-1:parseInt($("atom_valence").value,10),radical:parseInt($("atom_radical").value,10),invRet:parseInt($("atom_inversion").value,10),exactChangeFlag:parseInt($("atom_exactchange").value,10)?!0:!1,ringBondCount:parseInt($("atom_ringcount").value,10),substitutionCount:parseInt($("atom_substitution").value,10),unsaturatedAtom:parseInt($("atom_unsaturation").value,10),hCount:parseInt($("atom_hcount").value,10)}),!0),ui.render.update()}function onChange_AtomLabel(){this.value=this.value.strip().capitalize();var e=element.getElementByLabel(this.value);null==e&&"A"!==this.value&&"*"!==this.value&&"Q"!==this.value&&"X"!==this.value&&"R"!==this.value&&(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"label"),"A"!==this.value&&"*"!==this.value&&(e=element.getElementByLabel(this.value))),$("atom_number").value="A"==this.value||"*"==this.value?"any":e?e.toString():""}function onChange_AtomCharge(){""===this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,1}[-+]$/)?this.value=(this.value.endsWith("-")?"-":"")+this.value.substr(0,this.value.length-1):this.value.match(/^[+-]?[1-9][0-9]{0,1}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"charge"))}function onChange_AtomIsotope(){this.value==util.getElementTextContent($("atom_number"))||""==this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"isotope"))}function onChange_AtomValence(){}function showBondProperties(e){var t;$("bond_properties").bond_id=e;var o=ui.render.bondGetAttr(e,"type"),r=ui.render.bondGetAttr(e,"stereo");for(t in ui.bondTypeMap)if(ui.bondTypeMap[t].type==o&&ui.bondTypeMap[t].stereo==r)break;$("bond_type").value=t,$("bond_topology").value=ui.render.bondGetAttr(e,"topology")||0,$("bond_center").value=ui.render.bondGetAttr(e,"reactingCenterStatus")||0,ui.showDialog("bond_properties"),$("bond_type").activate()}function applyBondProperties(){ui.hideDialog("bond_properties");var e=$("bond_properties").bond_id,t=Object.clone(ui.bondTypeMap[$("bond_type").value]);t.topology=parseInt($("bond_topology").value,10),t.reactingCenterStatus=parseInt($("bond_center").value,10),ui.addUndoAction(Action.fromBondAttrs(e,t),!0),ui.render.update()}function showAutomapProperties(e){ui.showDialog("automap_properties");var t,o;t=new Event.Handler("automap_ok","click",void 0,function(){t.stop(),o.stop(),e&&"onOk"in e&&e.onOk($("automap_mode").value),ui.hideDialog("automap_properties")}).start(),o=new Event.Handler("automap_cancel","click",void 0,function(){t.stop(),o.stop(),ui.hideDialog("automap_properties"),e&&"onCancel"in e&&e.onCancel()}).start(),$("automap_mode").activate()}function showRLogicTable(e){var t=e||{};t.rlogic=t.rlogic||{},$("rlogic_occurrence").value=t.rlogic.occurrence||">0",$("rlogic_resth").value=t.rlogic.resth?"1":"0";for(var o='<option value="0">Always</option>',r=1;32>=r;r++)r!=t.rgid&&0!=(t.rgmask&1<<r-1)&&(o+='<option value="'+r+'">IF R'+t.rgid+" THEN R"+r+"</option>");$("rlogic_if").outerHTML='<select id="rlogic_if">'+o+"</select>",$("rlogic_if").value=t.rlogic.ifthen,ui.showDialog("rlogic_table");var n=new Event.Handler("rlogic_ok","click",void 0,function(){var e={occurrence:$("rlogic_occurrence").value.replace(/\s*/g,"").replace(/,+/g,",").replace(/^,/,"").replace(/,$/,""),resth:"1"==$("rlogic_resth").value,ifthen:parseInt($("rlogic_if").value,10)};t&&"onOk"in t&&!t.onOk(e)||(n.stop(),i.stop(),ui.hideDialog("rlogic_table"))}).start(),i=new Event.Handler("rlogic_cancel","click",void 0,function(){n.stop(),i.stop(),ui.hideDialog("rlogic_table"),t&&"onCancel"in t&&t.onCancel()}).start();$("rlogic_occurrence").activate()}function onKeyPress_Dialog(e){return util.stopEventPropagation(e),27===e.keyCode?(ui.hideDialog(this.id),util.preventDefault(e)):void 0}function onKeyPress_InputLabel(e){if(util.stopEventPropagation(e),13==e.keyCode){keymage.setScope("editor"),this.hide();var t="",o=0,r=this.value.toArray();if("*"==this.value)t="A";else if(this.value.match(/^[*][1-9]?[+-]$/i))t="A",o=2==this.value.length?1:parseInt(r[1]),"-"==r[2]&&(o*=-1);else if(this.value.match(/^[A-Z]{1,2}$/i))t=this.value.capitalize();else if(this.value.match(/^[A-Z]{1,2}[0][+-]?$/i))t=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():r[0].capitalize();else if(this.value.match(/^[A-Z]{1,2}[1-9]?[+-]$/i)){t=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():r[0].capitalize();var n=this.value.match(/[0-9]/i);o=null!=n?parseInt(n[0]):1,"-"==r[this.value.length-1]&&(o*=-1)}return("A"==t||"Q"==t||"X"==t||"R"==t||null!=element.getElementByLabel(t))&&(ui.addUndoAction(Action.fromAtomsAttrs(this.atom_id,{label:t,charge:o}),!0),ui.render.update()),util.preventDefault(e)}return 27==e.keyCode?(this.hide(),keymage.setScope("editor"),util.preventDefault(e)):void 0}function onKeyUp_InputLabel(e){return util.stopEventPropagation(e),27==e.keyCode?(this.hide(),keymage.setScope("editor"),util.preventDefault(e)):void 0}function showLabelEditor(e){var t=$("input_label");keymage.setScope("label");var o=Math.min(7*ui.render.zoom,16);t.atom_id=e,t.value=ui.render.atomGetAttr(e,"label"),t.style.fontSize=2*o+"px",t.show();var r=ui.render.obj2view(ui.render.atomGetPos(e)),n={left:0,top:0},i=Element.cumulativeOffset(t.offsetParent),a=0;t.style.left=r.x+n.left-i.left-o-a+"px",t.style.top=r.y+n.top-i.top-o-a+"px",t.activate()}var keymage=require("keymage"),element=require("../../chem/element"),util=require("../../util"),Action=require("../action"),ui=global.ui;module.exports={initDialogs:initDialogs,showAtomAttachmentPoints:showAtomAttachmentPoints,showAtomProperties:showAtomProperties,showBondProperties:showBondProperties,showAutomapProperties:showAutomapProperties,showRLogicTable:showRLogicTable,showLabelEditor:showLabelEditor};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../chem/element":10,"../../util":39,"../action":26,"keymage":2}],28:[function(require,module,exports){
(function (global){
function dialog(t){var e,o=ui.showDialog("open-file"),r=o.select("input[value=OK]")[0],n=o.select("textarea")[0],i=o.select("input[type=file]")[0],a=o.select("input[name=fragment]")[0],s=[];s[0]=o.on("click","input[type=button]",function(e,o){s.forEach(function(t){t.stop()}),ui.hideDialog("open-file");var r="on"+o.value.capitalize();t&&r in t&&t[r]({fragment:a.checked,value:n.value})}),s[1]=i.on("change",function(t,r){console.assert(e,"No valid file opener"),r.files.length&&(o.select("input").each(function(t){t.disabled=!0}),e(r.files[0]).then(function(t){n.value=t,o.select("input").each(function(t){t.disabled=!1})},ui.echo))}),s[2]=n.on("input",function(){var t=n.value.trim();r.disabled=!t}),n.value="",a.checked=!1,r.disabled=!0,i.disabled=!0,i.parentNode.addClassName("disabled"),fileOpener().then(function(t){e=t,i.disabled=!1,i.parentNode.removeClassName("disabled")})}function fileOpener(){function t(t){return new Promise(function(e,o){var r=new FileReader;r.onload=function(t){e(t.target.result)},r.onerror=function(t){o(t)},r.readAsText(t,"UTF-8")})}function e(t,e){var o=t.OpenTextFile(e.name,1),r=o.ReadAll();return o.Close(),r}function o(){}return new Promise(function(r,n){if(global.FileReader)return r(t);if(global.ActiveXObject)try{var i=new global.ActiveXObject("Scripting.FileSystemObject");return r(function(t){return Promise.resolve(e(i,t))})}catch(a){}return ui.standalone?n("Standalone mode!"):r(o)})}function loadHook(){}var Promise=require("promise-polyfill"),ui=global.ui;dialog.loadHook=loadHook,module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"promise-polyfill":3}],29:[function(require,module,exports){
(function (global){
function saveDialog(t,e){function o(t,e){e=e||"mol",i.value=t,i.className=e,i.activate()}var r,n=ui.showDialog("save-file"),i=n.select("textarea")[0],a=n.select("select")[0],s=n.select(".save")[0],d=[];d[0]=n.on("click","input[type=button]",function(e,o){d.forEach(function(t){t.stop()}),ui.hideDialog("save-file");var r="on"+o.value.capitalize();t&&r in t&&t[r]({})}),d[1]=a.on("change",function(){var r=a.value;convertMolecule(e,t.molecule,r).then(function(t){o(t,r)},ui.echo)}),d[2]=s.on("click",function(t){r&&(r(i.value,a.value),n.select("input[type=button]")[0].click()),t.preventDefault()}),o((new chem.MolfileSaver).saveMolecule(t.molecule)),s.addClassName("disabled"),fileSaver(e).then(function(t){r=t,s.removeClassName("disabled")}),a.select("[value=inchi]")[0].disabled=ui.standalone}function fileSaver(t){var e={smi:"chemical/x-daylight-smiles",mol:"chemical/x-mdl-molfile",rxn:"chemical/x-mdl-rxnfile",inchi:"chemical/x-inchi"};return new Promise(function(o,r){global.Blob&&fs.saveAs?o(function(t,o){"mol"==o&&0==t.indexOf("$RXN")&&(o="rxn"),console.assert(e[o],"Unknown chemical file type");var r=new Blob([t],{type:e[o]});fs.saveAs(r,"ketcher."+o)}):ui.standalone?r("Standalone mode!"):o(function(e,o){t.save({filedata:[o,e].join("\n")})})})}function convertMolecule(t,e,o){return new Promise(function(r){var n=(new chem.MolfileSaver).saveMolecule(e);if("mol"==o)r(n);else if("smi"==o)r(ui.standalone?(new chem.SmilesSaver).saveMolecule(e):t.smiles({moldata:n}));else if("inchi"==o){if(ui.standalone)throw Error("InChI is not supported in the standalone mode");0!==e.rgroups.count()&&ui.echo("R-group fragments are not supported and will be discarded"),e=e.getScaffold(),0===e.atoms.count()?r(""):(e=e.clone(),e.sgroups.each(function(t,e){if("MUL"!=e.type&&!/^INDIGO_.+_DESC$/i.test(e.data.fieldName))throw Error("InChi data format doesn't support s-groups")}),r(t.inchi({moldata:n})))}})}var Promise=require("promise-polyfill"),fs=require("filesaver.js");require("../../chem");var chem=global.chem,ui=global.ui;module.exports=saveDialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../chem":11,"filesaver.js":1,"promise-polyfill":3}],30:[function(require,module,exports){
(function (global){
function dialog(e,t){function o(e){n.select(".selected").each(function(e){e.removeClassName("selected")}),e?n.select("button").each(function(t){var o=t.value||t.textContent||t.innerText;e.indexOf(o)>=0&&t.addClassName("selected")}):t.required&&(i.disabled=!0)}function r(){var e=[];return n.select(".selected").each(function(t){var o=t.value||t.textContent||t.innerText;e.push(o)}),e}var n=ui.showDialog(e),i=n.select("input[value=OK]")[0],a=t.mode||"single",s=[];s[0]=n.on("click","input[type=button]",function(o,n){s.forEach(function(e){e.stop()}),ui.hideDialog(e);var i="on"+n.value.capitalize();console.assert("onOk"!=i||!t.required||0!=r().length,"No elements selected"),t&&i in t&&t[i]({mode:a,values:r()})}),s[1]=n.on("click","button",function(e,r){"single"===a&&(r.hasClassName("selected")?t.required&&i.click():o(null)),r.toggleClassName("selected"),t.required&&(i.disabled=0===n.select(".selected").length),e.stop()}),s[2]=n.on("click","input[name=mode]",function(e,t){t.value!=a&&("single"==t.value&&o(null),a=t.value)}),o(t.values),n.select("input[name=mode]").each(function(e){e.value==a&&(e.checked=!0)})}var ui=global.ui;module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],31:[function(require,module,exports){
(function (global){
function dialog(e){var t=ui.showDialog("sgroup_special"),o={},n=[];console.assert(!e.type||"DAT"==e.type),console.assert(!e.type||e.attrs.fieldName);var r=e.type&&matchContext(e.attrs.fieldName,e.attrs.fieldValue)||e.context||"Fragment";setContext(r,o,!0),e.attrs.fieldName&&setField(e.attrs.fieldName,o,!0),$("sgroup_special_value").value=e.attrs.fieldValue,e.attrs.attached?$("sgroup_special_attached").checked=!0:e.attrs.absolute?$("sgroup_special_absolute").checked=!0:$("sgroup_special_relative").checked=!0,n[0]=t.on("click","input[type=button]",function(t,o){var r="on"+o.value.capitalize(),i="onOk"!=r||getValidateAttrs();i&&(n.forEach(function(e){e.stop()}),ui.hideDialog("sgroup_special"),r in e&&i&&e[r](i))}),n[1]=t.on("change","select",function(e,t){"sgroup_context"==t.id&&setContext($("sgroup_context").value,o),"sgroup_special_name"==t.id&&setField($("sgroup_special_name").value,o)})}function getValidateAttrs(){var e={mul:null,connectivity:"",name:"",subscript:""};return e.fieldName=$("sgroup_special_name").value.strip(),e.fieldValue=$("sgroup_special_value").value.strip(),e.absolute=$("sgroup_special_absolute").checked,e.attached=$("sgroup_special_attached").checked,""==e.fieldValue?(alert("Please, specify data field value."),null):{type:"DAT",attrs:e}}function setContext(e,t,o){if(console.info("set context:",e,t),console.assert(t.context||o,"Field setup should be forced"),o||e!=t.context.name){t.context=util.find(special_choices,function(t){return t.name==e}),console.assert(t.context,"Can't find such context");var n=t.context.value.reduce(function(e,t){return e+'<option value="'+t.name+'">'+t.name+"</option>"},"");$("sgroup_special_name").update(n),setField(t.context.value[0].name,t,!0),o&&($("sgroup_context").value=e)}}function setField(e,t,o){if(console.info("set field:",e,t),console.assert(t.field||o,"Field setup should be forced"),e||e!=t.field.name){if(t.field=util.find(t.context.value,function(t){return t.name==e}),console.assert(t.field,"Can't find such field"),t.field.value){var n=t.field.value.reduce(function(e,t){return e+'<option value="'+t+'">'+t+"</option>"},"");$("sgroup_special_value").outerHTML='<select size="10" id="sgroup_special_value">'+n+"</select>"}else $("sgroup_special_value").outerHTML='<textarea id="sgroup_special_value"></textarea>';$("sgroup_special_name").value=e}}function matchContext(e,t){console.info("search:",util.unicodeLiteral(e),util.unicodeLiteral(t));var o=util.find(special_choices,function(o){var n=util.find(o.value,function(t){return t.name==e});return n?!t||!n.value||!!util.find(n.value,function(e){return e==t}):!1});return o&&o.name}var util=require("../../util"),ui=global.ui,special_choices=[{name:"Fragment",value:[{name:"MDLBG_FRAGMENT_STEREO",value:["abs","(+)-enantiomer","(-)-enantiomer","steric","rel","R(a)","S(a)","R(p)","S(p)"]},{name:"MDLBG_FRAGMENT_COEFFICIENT",value:null},{name:"MDLBG_FRAGMENT_CHARGE",value:null},{name:"MDLBG_FRAGMENT_RADICALS",value:null}]},{name:"Single Bond",value:[{name:"MDLBG_STEREO_KEY",value:["erythro","threo","alpha","beta","endo","exo","anti","syn","ECL","STG"]},{name:"MDLBG_BOND_KEY",value:["Value=4"]}]},{name:"Atom",value:[{name:"MDLBG_STEREO_KEY",value:["RS","SR","P-3","P-3-PI","SP-4","SP-4-PI","T-4","T-4-PI","SP-5","SP-5-PI","TB-5","TB-5-PI","OC-6","TB-5-PI","TP-6","PB-7","CU-8","SA-8","DD-8","HB-9","TPS-9","HB-9"]}]},{name:"Group",value:[{name:"MDLBG_STEREO_KEY",value:["cis","trans"]}]}];dialog.match=function(e){return!e.type||"DAT"==e.type&&!!matchContext(e.attrs.fieldName,e.attrs.fieldValue)},module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../util":39}],32:[function(require,module,exports){
(function (global){
function dialog(e){var t=ui.showDialog("sgroup_properties"),o=e.type||"GEN";switch($("sgroup_type").value=o,$("sgroup_type").activate(),onChange_SGroupType.call($("sgroup_type")),o){case"SRU":$("sgroup_connection").value=e.attrs.connectivity,$("sgroup_label").value=e.attrs.subscript;break;case"MUL":$("sgroup_label").value=e.attrs.mul;break;case"SUP":$("sgroup_label").value=e.attrs.name;break;case"DAT":$("sgroup_field_name").value=e.attrs.fieldName,$("sgroup_field_value").value=e.attrs.fieldValue,e.attrs.attached?$("sgroup_pos_attached").checked=!0:e.attrs.absolute?$("sgroup_pos_absolute").checked=!0:$("sgroup_pos_relative").checked=!0}"DAT"!=o&&($("sgroup_field_name").value="",$("sgroup_field_value").value="");var r=[];r[0]=t.on("click","input[type=button]",function(t,o){var n="on"+o.value.capitalize(),i="onOk"!=n||getValidateAttrs();i&&(r.forEach(function(e){e.stop()}),ui.hideDialog("sgroup_properties"),n in e&&i&&e[n](i))}),r[1]=$("sgroup_type").on("change",onChange_SGroupType),r[2]=$("sgroup_label").on("change",onChange_SGroupLabel)}function getValidateAttrs(){var e=$("sgroup_type").value,t={mul:null,connectivity:"",name:"",subscript:"",fieldName:"",fieldValue:"",attached:!1,absolute:!1};switch(e){case"SRU":if(t.connectivity=$("sgroup_connection").value.strip(),t.subscript=$("sgroup_label").value.strip(),1!=t.subscript.length||!t.subscript.match(/^[a-zA-Z]$/))return alert(t.subscript.length?"SRU subscript should consist of a single letter.":"Please provide an SRU subscript."),null;break;case"MUL":t.mul=parseInt($("sgroup_label").value);break;case"SUP":if(t.name=$("sgroup_label").value.strip(),!t.name)return alert("Please provide a name for the superatom."),null;break;case"DAT":if(t.fieldName=$("sgroup_field_name").value.strip(),t.fieldValue=$("sgroup_field_value").value.strip(),t.absolute=$("sgroup_pos_absolute").checked,t.attached=$("sgroup_pos_attached").checked,""==t.fieldName||""==t.fieldValue)return alert("Please, specify data field name and value."),null}return{type:e,attrs:t}}function onChange_SGroupLabel(){"MUL"!=$("sgroup_type").value||this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value="1")}function onChange_SGroupType(){var e=$("sgroup_type").value;return"DAT"==e?($$("#sgroup_properties .base")[0].hide(),$$("#sgroup_properties .data")[0].show(),void 0):($$("#sgroup_properties .base")[0].show(),$$("#sgroup_properties .data")[0].hide(),$("sgroup_label").disabled="SRU"!=e&&"MUL"!=e&&"SUP"!=e,$("sgroup_connection").disabled="SRU"!=e,"MUL"!=e||$("sgroup_label").value.match(/^[1-9][0-9]{0,2}$/)?"SRU"==e?$("sgroup_label").value="n":("GEN"==e||"SUP"==e)&&($("sgroup_label").value=""):$("sgroup_label").value="1",void 0)}var ui=global.ui;module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],33:[function(require,module,exports){
(function (global){
function parseSdf(e){var t=e.split(/^[$][$][$][$]$/m),o=[];return t.each(function(e){e=e.replace(/\r/g,""),e=e.strip();var t=e.indexOf("M  END");if(-1!=t){var r={};r.molfile=e.substring(0,t+6),r.name=e.substring(0,e.indexOf("\n")).strip(),e=e.substr(t+7).strip();var n=e.split(/^$/m);n.each(function(e){if(e=e.strip(),e.startsWith("> <")){var t=e.split("\n"),o=t[0].strip().substring(3,t[0].lastIndexOf(">")).strip();r[o]=parseInt(t[1].strip())||t[1].strip()}}),o.push(r)}}),o}function fetchTemplateCustom(e){return ajax(e+"templates.sdf").then(function(e){var t=parseSdf(e.responseText),o=[],r=0;return t.each(function(e){o.push({name:(e.name||"customtemplate "+ ++r).capitalize(),molfile:e.molfile,aid:(e.atomid||1)-1,bid:(e.bondid||1)-1})}),o})}function initTemplateCustom(e,t){return fetchTemplateCustom(t).then(function(t){return custom_templates=t,eachAsync(t,function(t){var o=new Element("li");o.title=t.name,e.insert({bottom:o});var r=chem.Molfile.parseCTFile(t.molfile),n=new rnd.Render(o,0,{autoScale:!0,autoScaleMargin:0,ignoreMouseEvents:!0,hideChiralFlag:!0,maxBondLength:30});n.setMolecule(r),n.update()},50)})}function eachAsync(e,t,o,r){return new Promise(function(n){function i(){s>a?(t(e[a],a++),setTimeout(i,o)):n()}var a=0,s=e.length;setTimeout(i,r||o)})}function dialog(e,t){var o=ui.showDialog("custom_templates"),r=o.select(".selected")[0],n=o.select("[value=OK]")[0],i=o.select("ul")[0];if(0===i.children.length){$("loading").style.display="",o.addClassName("loading");var a=initTemplateCustom(i,e).then(function(){$("loading").style.display="none",o.removeClassName("loading")});a.then(function(){n.disabled=!0,o.on("click","li",function(e,t){r==t?n.click():(r?r.removeClassName("selected"):n.disabled=!1,t.addClassName("selected"),r=t)}),o.on("click","input",function(e,o){var n,i=o.value,a="on"+o.value.capitalize();if("OK"==i){console.assert(r,"No element selected");var s=r.previousSiblings().size();n=custom_templates[s]}ui.hideDialog("custom_templates"),t&&a in t&&t[a](n)})})}}var Promise=require("promise-polyfill");require("../../chem"),require("../../rnd");var ajax=require("../../util/ajax.js"),ui=global.ui,rnd=global.rnd,chem=global.chem,custom_templates;module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../chem":11,"../../rnd":21,"../../util/ajax.js":37,"promise-polyfill":3}],34:[function(require,module,exports){
(function (global){
function init(e,t){ketcherWindow=$$("[role=application]")[0]||$$("body")[0],toolbar=ketcherWindow.select("[role=toolbar]")[0],clientArea=$("canvas"),server=t,updateServerButtons(),server&&server.knocknock().then(function(){ui.standalone=!1,updateServerButtons()},function(){document.title+=" (standalone)"}).then(function(){e.mol&&loadMolecule(e.mol)}),obsolete.initDialogs();var o={};toolbar.select("button").each(function(e){var t=e.textContent||e.innerText,n=e.dataset?e.dataset.keys:e.getAttribute("data-keys");if(n){var r=n.split(",").map(function(e){return e.strip()}),i=shortcutStr(r[0]),a=e.parentNode.id;e.title=(e.title||t)+" ("+i+")",e.innerHTML+=" <kbd>"+i+"</kbd>",r.forEach(function(e){var t=e.toLowerCase();Array.isArray(o[t])?o[t].push(a):o[t]=[a]})}else e.title=e.title||t}),o=util.extend(o,{a:["atom-any"],"defmod-a":["select-all"],"defmod-shift-a":["deselect-all"],"ctrl-alt-r":["force-update"]}),Object.keys(o).forEach(function(e){keymage("editor",e,1==o[e].length?function(t){var n=o[e][0];-1==clipActions.indexOf(n)&&(selectAction(o[e][0]),t.preventDefault())}:function(){console.info("actions",o[e])})}),keymage.setScope("editor"),toolbar.select("li").each(function(e){e.on("click",function(e){"BUTTON"==e.target.tagName&&e.target.parentNode==this&&(this.hasClassName("selected")||e.stop(),selectAction(this.id)),hideBlurredControls()?e.stop():"hidden"==this.getStyle("overflow")&&(this.addClassName("opened"),dropdownOpened=this,e.stop())})}),initCliparea(ketcherWindow),initZoom(),updateHistoryButtons(),clientArea.on("scroll",onScroll_ClientArea),clientArea.on("mousedown",function(){keymage.setScope("editor")});var n=new rnd.RenderOptions(e);n.atomColoring=!0,ui.render=new rnd.Render(clientArea,SCALE,n),ui.editor=new rnd.Editor(ui.render),ui.render.onCanvasOffsetChanged=onOffsetChanged,selectAction("select-lasso"),setScrollOffset(0,0),ui.render.setMolecule(ui.ctab),ui.render.update()}function shortcutStr(e){var t=navigator.platform.toUpperCase().indexOf("MAC")>=0;return e.replace(/Defmod/g,t?"⌘":"Ctrl").replace(/-(?!$)/g,"+")}function subEl(e){return $(e).children[0]}function hideBlurredControls(){if(!dropdownOpened)return!1;dropdownOpened.removeClassName("opened");var e=dropdownOpened.select(".selected");if(1==e.length){var t=subEl(dropdownOpened);t.style.marginTop=-e[0].offsetTop+t.offsetTop+"px"}return clientArea.style.visibility="hidden",setTimeout(function(){clientArea.style.visibility="visible"},0),dropdownOpened=null,!0}function selectAction(e){e=e||lastSelected;var t=$(e),o=[].slice.call(arguments,1);if(console.assert(e.startsWith,"id is not a string",e),-1!=clipActions.indexOf(e)&&0==o.length)return delegateCliparea(e);if(!t||!subEl(t).disabled){o.unshift(e);var n=mapTool.apply(null,o);if(n instanceof rnd.Editor.EditorTool){var r=toolbar.select(".selected")[0];t==r&&t||(ui.render.current_tool&&ui.render.current_tool.OnCancel(),ui.render.current_tool=n,e.startsWith("select-")&&(lastSelected=e),t&&t.addClassName("selected"),r&&r.removeClassName("selected"))}return n}return null}function delegateCliparea(e){var t=document.queryCommandSupported(e);if(t)try{document.execCommand(e)}catch(o){t=!1}if(!t){var n=subEl(e),r=n.dataset?n.dataset.keys:n.getAttribute("data-keys");echo("These action is unavailble via menu.\nInstead, use "+shortcutStr(r)+" to "+e+".")}return null}function initCliparea(e){var t=new Element("input",{type:"text","class":"cliparea",autofocus:!0}),o=window.clipboardData,n=["chemical/x-mdl-molfile","chemical/x-mdl-rxnfile","chemical/x-cml","text/plain","chemical/x-daylight-smiles","chemical/x-inchi"],r=function(){return"editor"==keymage.getScope()?(t.value=" ",t.focus(),t.select(),!0):!1},i=function(e,t){var n=(new chem.MolfileSaver).saveMolecule(e);if(!t&&o)o.setData("text",n);else{t.setData("text/plain",n);try{t.setData(e.isReaction?"chemical/x-mdl-rxnfile":"chemical/x-mdl-molfile",n),t.setData("chemical/x-daylight-smiles",(new chem.SmilesSaver).saveMolecule(e))}catch(r){console.info("Could not write exact type",r)}}},a=function(e){var t="";if(!e&&o)t=o.getData("text");else for(var r=0;r<n.length&&!(t=e.getData(n[r]));r++);return console.info("paste",r>=0&&n[r],t.slice(0,50),".."),t};e.insert(t),e.on("mouseup",r),["copy","cut"].forEach(function(t){e.on(t,function(e){if(r()){var o=selectAction(t,!0);o&&i(o,e.clipboardData),e.preventDefault()}})}),e.on("paste",function(e){if(r()){var t=a(e.clipboardData);t&&loadFragment(t),e.preventDefault()}})}function updateClipboardButtons(){subEl("copy").disabled=subEl("cut").disabled=!ui.editor.hasSelection(!0)}function updateHistoryButtons(){subEl("undo").disabled=0==undoStack.length,subEl("redo").disabled=0==redoStack.length}function updateServerButtons(){serverActions.forEach(function(e){subEl(e).disabled=ui.standalone})}function transitionEndEvent(){var e,t=document.createElement("transitionTest"),o={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(e in o)if(void 0!==t.style[e])return o[e];return!1}function animateToggle(e,t){ketcherWindow.addClassName("animate");var o=transitionEndEvent(),n=function(e){setTimeout(function(){e&&e(),ketcherWindow.removeClassName("animate")},0)};if(t&&o){var r=function(){n(t),e.removeEventListener(o,r,!1)};e.addEventListener(o,r,!1)}else n(t),t||e()}function showDialog(e){var t=$(e);return keymage.setScope("dialog"),animateToggle(function(){$$(".overlay")[0].show(),t.style.display=""}),t}function hideDialog(e){var t=$$(".overlay")[0];animateToggle(t,function(){$(e).style.display="none",t.hide(),keymage.setScope("editor")})}function showElemTable(e){e.required=!0,selectDialog("elem-table",e)}function showRGroupTable(e){selectDialog("rgroup-table",e)}function showReaGenericsTable(e){e.required=!0,selectDialog("generics-table",e)}function echo(e){alert(e)}function updateMolecule(e){if("undefined"!=typeof e&&null!=e){ui.editor.deselectAll(),addUndoAction(Action.fromNewCanvas(e)),showDialog("loading");try{ui.render.onResize(),ui.render.update(),setZoomCentered(null,ui.render.getStructCenter())}catch(t){alert(t.message)}finally{hideDialog("loading")}}}function addUndoAction(e,t){null!=e&&(1==t&&e.isDummy()||(undoStack.push(e),redoStack.clear(),undoStack.length>HISTORY_LENGTH&&undoStack.splice(0,1),updateHistoryButtons()))}function onClick_NewFile(){selectAction(null),ui.ctab.isBlank()||(addUndoAction(Action.fromNewCanvas(new chem.Struct)),ui.render.update())}function onClick_OpenFile(){openDialog({onOk:function(e){e.fragment?loadFragment(e.value,!0):loadMolecule(e.value,!0)}})}function onClick_SaveFile(){saveDialog({molecule:ui.ctab},server)}function aromatize(e,t){e=e.clone();var o=e.addRxnArrowIfNecessary(),n=(new chem.MolfileSaver).saveMolecule(e);if(ui.standalone)throw new Error("Aromatization and dearomatization are not supported in the standalone mode.");var r=t?"aromatize":"dearomatize",i=server[r]({moldata:n});i.then(function(e){var t=parseMayBeCorruptedCTFile(e);o&&t.rxnArrows.clear(),updateMolecule(t)},echo)}function calculateCip(){util.assert(!ui.standalone,"Can't calculate in standalone mode!");var e=ui.ctab.clone(),t=e.addRxnArrowIfNecessary(),o=(new chem.MolfileSaver).saveMolecule(e),n=server.calculateCip({moldata:o});n.then(function(e){var o=parseMayBeCorruptedCTFile(e);t&&o.rxnArrows.clear(),updateMolecule(o)},echo)}function initZoom(){var e=subEl("zoom-list");e.on("focus",function(){keymage.pushScope("zoom")}),e.on("blur",function(){keymage.popScope("zoom")}),e.on("change",updateZoom),updateZoom(!0)}function onClick_ZoomIn(){subEl("zoom-list").selectedIndex++,updateZoom()}function onClick_ZoomOut(){subEl("zoom-list").selectedIndex--,updateZoom()}function updateZoom(e){var t=subEl("zoom-list"),o=t.selectedIndex,n=t.length;console.assert(o>=0&&n>o,"Zoom out of range"),subEl("zoom-in").disabled=o==n-1,subEl("zoom-out").disabled=0==o;var r=parseFloat(t.options[o].innerHTML)/100;ui.zoom=r,e||(setZoomCentered(r,ui.render.getStructCenter(ui.editor.getSelection())),ui.render.update())}function setZoomRegular(e){.1>e||e>10||(ui.zoom=e,ui.render.setZoom(ui.zoom))}function getViewSz(){return new Vec2(ui.render.viewSz)}function setZoomCentered(e,t){if(!t)throw new Error("Center point not specified");e&&setZoomRegular(e),setScrollOffset(0,0);var o=ui.render.obj2view(t).sub(ui.render.viewSz.scaled(.5));setScrollOffset(o.x,o.y)}function setZoomStaticPointInit(e){zspObj=new Vec2(e)}function setZoomStaticPoint(e,t){setZoomRegular(e),setScrollOffset(0,0);var o=ui.render.obj2view(zspObj),n=o.sub(t);setScrollOffset(n.x,n.y)}function setScrollOffset(e,t){var o=clientArea.clientWidth,n=clientArea.clientHeight;ui.render.extendCanvas(e,t,o+e,n+t),clientArea.scrollLeft=e,clientArea.scrollTop=t,scrollLeft=clientArea.scrollLeft,scrollTop=clientArea.scrollTop}function setScrollOffsetRel(e,t){setScrollOffset(clientArea.scrollLeft+e,clientArea.scrollTop+t)}function onClick_CleanUp(){var e=util.array(ui.editor.getSelection(!0).atoms),t=e.length>0;if(t){var o=Set.fromList(e),n=Set.empty();ui.ctab.loops.each(function(e,t){util.findIndex(t.hbs,function(e){return Set.contains(o,ui.ctab.halfBonds.get(e).begin)})>=0&&util.each(t.hbs,function(e){Set.add(n,ui.ctab.halfBonds.get(e).begin)},this)},this),Set.mergeIn(n,o),e=Set.list(n)}ui.editor.deselectAll();try{var r={},i=ui.ctab.clone(null,null,!1,r);t&&util.each(e,function(e){e=r[e];var t=new chem.SGroup("DAT"),o=i.sgroups.add(t);t.id=o,t.pp=new Vec2,t.data.fieldName="_ketcher_selective_layout",t.data.fieldValue="1",i.atomAddToSGroup(o,e)},this);var a=i.addRxnArrowIfNecessary(),l=server.layout({moldata:(new chem.MolfileSaver).saveMolecule(i)},t?{selective:1}:null);l.then(function(e){var t=parseMayBeCorruptedCTFile(e);a&&t.rxnArrows.clear(),updateMolecule(t)})}catch(c){alert("ERROR: "+c.message)}}function onClick_Aromatize(){try{aromatize(ui.ctab,!0)}catch(e){alert("Molfile: "+e.message)}}function onClick_Dearomatize(){try{aromatize(ui.ctab,!1)}catch(e){alert("Molfile: "+e.message)}}function onClick_Automap(){obsolete.showAutomapProperties({onOk:function(e){var t=ui.ctab,o=t.addRxnArrowIfNecessary();if(0==t.rxnArrows.count())return echo("Auto-Mapping can only be applied to reactions"),void 0;var n=(new chem.MolfileSaver).saveMolecule(t,!0),r=server.automap({moldata:n,mode:e});r.then(function(e){var t=parseMayBeCorruptedCTFile(e);o&&t.rxnArrows.clear(),updateMolecule(t)},echo)}})}function loadMolecule(e,t){return getStruct(e,t).then(updateMolecule)}function loadFragment(e,t){return getStruct(e,t).then(function(e){e.rescale(),selectAction("paste",e)})}function guessType(e,t){var o=e.trim(),n=o.match(/^(M  END|\$END MOL)$/m);if(n){var r=n.index+n[0].length;if(r==o.length||-1!=o.slice(r,r+20).search(/^\$(MOL|END CTAB)$/m))return"mol"}return"<"==o[0]&&-1!=o.indexOf("<molecule")?"cml":"InChI"==o.slice(0,5)?"inchi":-1==o.indexOf("\n")?"smiles":t?null:"mol"}function getStruct(e,t){return new Promise(function(o){var n=guessType(e);if("mol"==n){var r=parseMayBeCorruptedCTFile(e,t);o(r)}else{if(ui.standalone)throw n?n.toUpperCase():"Format is not supported in a standalone mode.";var i="smiles"==n?server.layout_smiles(null,{smiles:e.trim()}):server.molfile({moldata:e});o(i.then(function(e){return parseMayBeCorruptedCTFile(e)}))}})}function page2canvas2(e){var t=clientArea.cumulativeOffset();return new Vec2(e.pageX-t.left,e.pageY-t.top)}function page2obj(e){return ui.render.view2obj(page2canvas2(e))}function scrollPos(){return new Vec2(clientArea.scrollLeft,clientArea.scrollTop)}function onScroll_ClientArea(e){scrollLeft=clientArea.scrollLeft,scrollTop=clientArea.scrollTop,util.stopEventPropagation(e)}function onOffsetChanged(e,t){if(null!=t){var o=new Vec2(e.x-t.x,e.y-t.y);clientArea.scrollLeft+=o.x,clientArea.scrollTop+=o.y}}function removeSelected(){addUndoAction(Action.fromFragmentDeletion()),ui.editor.deselectAll(),ui.render.update()}function undo(){ui.render.current_tool&&ui.render.current_tool.OnCancel(),ui.editor.deselectAll(),redoStack.push(undoStack.pop().perform()),ui.render.update(),updateHistoryButtons()}function redo(){ui.render.current_tool&&ui.render.current_tool.OnCancel(),ui.editor.deselectAll(),undoStack.push(redoStack.pop().perform()),ui.render.update(),updateHistoryButtons()}function onClick_ElemTableButton(){showElemTable({onOk:function(e){var t;return t="single"==e.mode?{label:element.get(e.values[0]).label}:{label:"L#",atomList:new chem.Struct.AtomList({notList:"not-list"==e.mode,ids:e.values})},current_elemtable_props=t,selectAction("atom-table"),!0},onCancel:function(){}})}function onClick_ReaGenericsTableButton(){showReaGenericsTable({onOk:function(e){return current_reagenerics={label:e.values[0]},selectAction("atom-reagenerics"),!0}})}function onClick_TemplateCustom(){templatesDialog("",{onOk:function(e){return current_template_custom=e,selectAction("template-custom-select"),!0}})}function showSgroupDialog(e){return sgroupDialog(e)}function parseMayBeCorruptedCTFile(e,t){var o=util.splitNewlines(e);try{return chem.Molfile.parseCTFile(o)}catch(n){if(t){try{return chem.Molfile.parseCTFile(o.slice(1))}catch(r){}try{return chem.Molfile.parseCTFile([""].concat(o))}catch(i){}}throw n}}function mapTool(e){console.assert(e,"The null tool");var t=[].slice.call(arguments,1);if(actionMap[e])return actionMap[e].apply(null,t);if(ui.editor.hasSelection()){if("erase"==e)return removeSelected(),null;if(e.startsWith("atom-"))return addUndoAction(Action.fromAtomsAttrs(ui.editor.getSelection().atoms,atomLabel(e)),!0),ui.render.update(),null;if(e.startsWith("transform-flip"))return addUndoAction(Action.fromFlip(ui.editor.getSelection(),e.endsWith("h")?"horizontal":"vertical"),!0),ui.render.update(),null}return"transform-rotate"!=e&&ui.editor.deselectAll(),"select-lasso"==e?new rnd.Editor.LassoTool(ui.editor,0):"select-rectangle"==e?new rnd.Editor.LassoTool(ui.editor,1):"select-fragment"==e?new rnd.Editor.LassoTool(ui.editor,1,!0):"erase"==e?new rnd.Editor.EraserTool(ui.editor,1):e.startsWith("atom-")?new rnd.Editor.AtomTool(ui.editor,atomLabel(e)):e.startsWith("bond-")?new rnd.Editor.BondTool(ui.editor,bondType(e)):"chain"==e?new rnd.Editor.ChainTool(ui.editor):e.startsWith("template-custom")?new rnd.Editor.TemplateTool(ui.editor,current_template_custom):e.startsWith("template")?new rnd.Editor.TemplateTool(ui.editor,templates[parseInt(e.split("-")[1])]):"charge-plus"==e?new rnd.Editor.ChargeTool(ui.editor,1):"charge-minus"==e?new rnd.Editor.ChargeTool(ui.editor,-1):"sgroup"==e?new rnd.Editor.SGroupTool(ui.editor):"reaction-arrow"==e?new rnd.Editor.ReactionArrowTool(ui.editor):"reaction-plus"==e?new rnd.Editor.ReactionPlusTool(ui.editor):"reaction-map"==e?new rnd.Editor.ReactionMapTool(ui.editor):"reaction-unmap"==e?new rnd.Editor.ReactionUnmapTool(ui.editor):"rgroup-label"==e?new rnd.Editor.RGroupAtomTool(ui.editor):"rgroup-fragment"==e?new rnd.Editor.RGroupFragmentTool(ui.editor):"rgroup-attpoints"==e?new rnd.Editor.APointTool(ui.editor):e.startsWith("transform-rotate")?new rnd.Editor.RotateTool(ui.editor):null}function bondType(e){var t=e.substr(5);return bondTypeMap[t]}function atomLabel(e){var t=e.substr(5);switch(t){case"table":return current_elemtable_props;case"reagenerics":return current_reagenerics;case"any":return{label:"A"};default:return t=t.capitalize(),console.assert(element.getElementByLabel(t),"No such atom exist"),{label:t}}}function clean(){Action.fromNewCanvas(new chem.Struct),ui.render.update(),undoStack.clear(),redoStack.clear(),updateHistoryButtons(),selectAction(null)}var ui=global.ui={};require("../chem"),require("../rnd");var chem=global.chem,rnd=global.rnd,Promise=require("promise-polyfill"),keymage=require("keymage"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),Action=require("./action.js"),templates=require("./templates"),element=require("../chem/element"),openDialog=require("./dialog/open.js"),saveDialog=require("./dialog/save.js"),selectDialog=require("./dialog/select"),templatesDialog=require("./dialog/templates"),sgroupDialog=require("./dialog/sgroup"),sgroupSpecialDialog=require("./dialog/sgroup-special"),obsolete=require("./dialog/obsolete"),SCALE=40,HISTORY_LENGTH=32,undoStack=[],redoStack=[],ketcherWindow,toolbar,lastSelected,clientArea=null,dropdownOpened,zspObj,server,serverActions=["cleanup","arom","dearom","calc-cip","reaction-automap","template-custom"],clipActions=["cut","copy","paste"],scrollLeft=null,scrollTop=null,current_elemtable_props=null,current_reagenerics=null,current_template_custom=null,actionMap={"new":onClick_NewFile,open:onClick_OpenFile,save:onClick_SaveFile,undo:undo,redo:redo,"zoom-in":onClick_ZoomIn,"zoom-out":onClick_ZoomOut,cleanup:onClick_CleanUp,arom:onClick_Aromatize,dearom:onClick_Dearomatize,"period-table":onClick_ElemTableButton,"generic-groups":onClick_ReaGenericsTableButton,"template-custom":onClick_TemplateCustom,cut:function(){var e=ui.editor.getSelectionStruct();return removeSelected(),e.isBlank()?null:e},copy:function(){var e=ui.editor.getSelectionStruct();return ui.editor.deselectAll(),e.isBlank()?null:e},paste:function(e){if(e.isBlank())throw"Not a valid structure to paste";return ui.editor.deselectAll(),new rnd.Editor.PasteTool(ui.editor,e)},info:function(){showDialog("about_dialog")},"select-all":function(){ui.editor.selectAll()},"deselect-all":function(){ui.editor.deselectAll()},"force-update":function(){ui.render.update(!0)},"reaction-automap":onClick_Automap,"calc-cip":calculateCip},bondTypeMap={single:{type:1,stereo:chem.Struct.BOND.STEREO.NONE},up:{type:1,stereo:chem.Struct.BOND.STEREO.UP},down:{type:1,stereo:chem.Struct.BOND.STEREO.DOWN},updown:{type:1,stereo:chem.Struct.BOND.STEREO.EITHER},"double":{type:2,stereo:chem.Struct.BOND.STEREO.NONE},crossed:{type:2,stereo:chem.Struct.BOND.STEREO.CIS_TRANS},triple:{type:3,stereo:chem.Struct.BOND.STEREO.NONE},aromatic:{type:4,stereo:chem.Struct.BOND.STEREO.NONE},singledouble:{type:5,stereo:chem.Struct.BOND.STEREO.NONE},singlearomatic:{type:6,stereo:chem.Struct.BOND.STEREO.NONE},doublearomatic:{type:7,stereo:chem.Struct.BOND.STEREO.NONE},any:{type:8,stereo:chem.Struct.BOND.STEREO.NONE}};module.exports={init:init,clean:clean,loadMolecule:loadMolecule,loadFragment:loadFragment},util.extend(ui,module.exports),util.extend(ui,{standalone:!0,ctab:new chem.Struct,render:null,editor:null,hideBlurredControls:hideBlurredControls,updateClipboardButtons:updateClipboardButtons,selectAction:selectAction,addUndoAction:addUndoAction,loadMoleculeFromFile:openDialog.loadHook,echo:echo,showDialog:showDialog,hideDialog:hideDialog,bondTypeMap:bondTypeMap,zoom:1,setZoomStaticPointInit:setZoomStaticPointInit,setZoomStaticPoint:setZoomStaticPoint,page2canvas2:page2canvas2,scrollPos:scrollPos,page2obj:page2obj,showSGroupProperties:showSgroupDialog,showRGroupTable:showRGroupTable,showElemTable:showElemTable,showReaGenericsTable:showReaGenericsTable,showAtomAttachmentPoints:obsolete.showAtomAttachmentPoints,showAtomProperties:obsolete.showAtomProperties,showBondProperties:obsolete.showBondProperties,showRLogicTable:obsolete.showRLogicTable,showLabelEditor:obsolete.showLabelEditor});

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../chem/element":10,"../rnd":21,"../util":39,"../util/set":42,"../util/vec2":43,"./action.js":26,"./dialog/obsolete":27,"./dialog/open.js":28,"./dialog/save.js":29,"./dialog/select":30,"./dialog/sgroup":32,"./dialog/sgroup-special":31,"./dialog/templates":33,"./templates":36,"keymage":2,"promise-polyfill":3}],35:[function(require,module,exports){
(function (global){
function Base(){this.type="OpBase",this._execute=function(){throw new Error("Operation._execute() is not implemented")},this._invert=function(){throw new Error("Operation._invert() is not implemented")},this.perform=function(t){return this._execute(t),this.__inverted||(this.__inverted=this._invert(),this.__inverted.__inverted=this),this.__inverted},this.isDummy=function(t){return this._isDummy?this._isDummy(t):!1}}function AtomAdd(t,e){this.data={aid:null,atom:t,pos:e},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i={};if(this.data.atom)for(var o in this.data.atom)i[o]=this.data.atom[o];i.label=i.label||"C",Object.isNumber(this.data.aid)?n.atoms.set(this.data.aid,new chem.Struct.Atom(i)):this.data.aid=n.atoms.add(new chem.Struct.Atom(i)),r.notifyAtomAdded(this.data.aid),n._atomSetPos(this.data.aid,new Vec2(this.data.pos))},this._invert=function(){var t=new AtomDelete;return t.data=this.data,t}}function AtomDelete(t){this.data={aid:t,atom:null,pos:null},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;this.data.atom||(this.data.atom=n.atoms.get(this.data.aid),this.data.pos=e.atomGetPos(this.data.aid)),r.notifyAtomRemoved(this.data.aid),n.atoms.remove(this.data.aid)},this._invert=function(){var t=new AtomAdd;return t.data=this.data,t}}function AtomAttr(t,e,r){this.data={aid:t,attribute:e,value:r},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.atoms.get(this.data.aid);this.data2||(this.data2={aid:this.data.aid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateAtom(this.data.aid)},this._isDummy=function(t){return t.render.ctab.molecule.atoms.get(this.data.aid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new AtomAttr;return t.data=this.data2,t.data2=this.data,t}}function AtomMove(t,e,r){this.data={aid:t,d:e,noinvalidate:r},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.aid,o=this.data.d;n.atoms.get(i).pp.add_(o),r.atoms.get(i).visel.translate(e.ps(o)),this.data.d=o.negated(),this.data.noinvalidate||e.invalidateAtom(i,1)},this._isDummy=function(){return 0==this.data.d.x&&0==this.data.d.y},this._invert=function(){var t=new AtomMove;return t.data=this.data,t}}function BondMove(t,e){this.data={bid:t,d:e},this._execute=function(t){var e=t.render,r=e.ctab;r.bonds.get(this.data.bid).visel.translate(e.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var t=new BondMove;return t.data=this.data,t}}function LoopMove(t,e){this.data={id:t,d:e},this._execute=function(t){var e=t.render,r=e.ctab;r.reloops.get(this.data.id)&&r.reloops.get(this.data.id).visel&&r.reloops.get(this.data.id).visel.translate(e.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var t=new LoopMove;return t.data=this.data,t}}function SGroupAtomAdd(t,e){this.type="OpSGroupAtomAdd",this.data={aid:e,sgid:t},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.aid,o=this.data.sgid,a=n.atoms.get(i),s=n.sgroups.get(o);if(s.atoms.indexOf(i)>=0)throw new Error("The same atom cannot be added to an S-group more than once");if(!a)throw new Error("OpSGroupAtomAdd: Atom "+i+" not found");n.atomAddToSGroup(o,i),e.invalidateAtom(i)},this._invert=function(){var t=new SGroupAtomRemove;return t.data=this.data,t}}function SGroupAtomRemove(t,e){this.type="OpSGroupAtomRemove",this.data={aid:e,sgid:t},this._execute=function(t){var e=this.data.aid,r=this.data.sgid,n=t.render,i=n.ctab,o=i.molecule,a=o.atoms.get(e),s=o.sgroups.get(r);chem.SGroup.removeAtom(s,e),Set.remove(a.sgs,r),n.invalidateAtom(e)},this._invert=function(){var t=new SGroupAtomAdd;return t.data=this.data,t}}function SGroupAttr(t,e,r){this.type="OpSGroupAttr",this.data={sgid:t,attr:e,value:r},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.sgid,o=n.sgroups.get(i);"DAT"==o.type&&r.sgroupData.has(i)&&(r.clearVisel(r.sgroupData.get(i).visel),r.sgroupData.unset(i)),this.data.value=o.setAttr(this.data.attr,this.data.value)},this._invert=function(){var t=new SGroupAttr;return t.data=this.data,t}}function SGroupCreate(t,e,r){this.type="OpSGroupCreate",this.data={sgid:t,type:e,pp:r},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=new chem.SGroup(this.data.type),o=this.data.sgid;i.id=o,n.sgroups.set(o,i),this.data.pp&&(n.sgroups.get(o).pp=new Vec2(this.data.pp)),r.sgroups.set(o,new rnd.ReSGroup(n.sgroups.get(o))),this.data.sgid=o},this._invert=function(){var t=new SGroupDelete;return t.data=this.data,t}}function SGroupDelete(t){this.type="OpSGroupDelete",this.data={sgid:t},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.sgid,o=r.sgroups.get(i);if(this.data.type=o.item.type,this.data.pp=o.item.pp,"DAT"==o.item.type&&r.sgroupData.has(i)&&(r.clearVisel(r.sgroupData.get(i).visel),r.sgroupData.unset(i)),r.clearVisel(o.visel),0!=o.item.atoms.length)throw new Error("S-Group not empty!");r.sgroups.unset(i),n.sgroups.remove(i)},this._invert=function(){var t=new SGroupCreate;return t.data=this.data,t}}function SGroupAddToHierarchy(t){this.type="OpSGroupAddToHierarchy",this.data={sgid:t},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.sgid,o=n.sGroupForest.insert(i,this.data.parent,this.data.children);this.data.parent=o.parent,this.data.children=o.children},this._invert=function(){var t=new SGroupRemoveFromHierarchy;return t.data=this.data,t}}function SGroupRemoveFromHierarchy(t){this.type="OpSGroupRemoveFromHierarchy",this.data={sgid:t},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.sgid;this.data.parent=n.sGroupForest.parent.get(i),this.data.children=n.sGroupForest.children.get(i),n.sGroupForest.remove(i)},this._invert=function(){var t=new SGroupAddToHierarchy;return t.data=this.data,t}}function BondAdd(t,e,r){this.data={bid:null,bond:r,begin:t,end:e},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;if(this.data.begin==this.data.end)throw new Error("Distinct atoms expected");if(rnd.DEBUG&&this.molecule.checkBondExists(this.data.begin,this.data.end))throw new Error("Bond already exists");e.invalidateAtom(this.data.begin,1),e.invalidateAtom(this.data.end,1);var i={};if(this.data.bond)for(var o in this.data.bond)i[o]=this.data.bond[o];i.type=i.type||chem.Struct.BOND.TYPE.SINGLE,i.begin=this.data.begin,i.end=this.data.end,Object.isNumber(this.data.bid)?n.bonds.set(this.data.bid,new chem.Struct.Bond(i)):this.data.bid=n.bonds.add(new chem.Struct.Bond(i)),n.bondInitHalfBonds(this.data.bid),n.atomAddNeighbor(n.bonds.get(this.data.bid).hb1),n.atomAddNeighbor(n.bonds.get(this.data.bid).hb2),r.notifyBondAdded(this.data.bid)},this._invert=function(){var t=new BondDelete;return t.data=this.data,t}}function BondDelete(t){this.data={bid:t,bond:null,begin:null,end:null},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;this.data.bond||(this.data.bond=n.bonds.get(this.data.bid),this.data.begin=this.data.bond.begin,this.data.end=this.data.bond.end),e.invalidateBond(this.data.bid),r.notifyBondRemoved(this.data.bid);var i=n.bonds.get(this.data.bid);[i.hb1,i.hb2].each(function(t){var e=n.halfBonds.get(t),r=n.atoms.get(e.begin),i=r.neighbors.indexOf(t),o=(i+r.neighbors.length-1)%r.neighbors.length,a=(i+1)%r.neighbors.length;n.setHbNext(r.neighbors[o],r.neighbors[a]),r.neighbors.splice(i,1)},this),n.halfBonds.unset(i.hb1),n.halfBonds.unset(i.hb2),n.bonds.remove(this.data.bid)},this._invert=function(){var t=new BondAdd;return t.data=this.data,t}}function BondAttr(t,e,r){this.data={bid:t,attribute:e,value:r},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.bonds.get(this.data.bid);this.data2||(this.data2={bid:this.data.bid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateBond(this.data.bid),"type"==this.data.attribute&&t.render.invalidateLoop(this.data.bid)},this._isDummy=function(t){return t.render.ctab.molecule.bonds.get(this.data.bid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new BondAttr;return t.data=this.data2,t.data2=this.data,t}}function FragmentAdd(t){this.frid=Object.isUndefined(t)?null:t,this._execute=function(t){var e=t.render.ctab,r=e.molecule,n=new chem.Struct.Fragment;null==this.frid?this.frid=r.frags.add(n):r.frags.set(this.frid,n),e.frags.set(this.frid,new rnd.ReFrag(n))},this._invert=function(){return new FragmentDelete(this.frid)}}function FragmentDelete(t){this.frid=t,this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;e.invalidateItem("frags",this.frid,1),r.frags.unset(this.frid),n.frags.remove(this.frid)},this._invert=function(){return new FragmentAdd(this.frid)}}function RGroupAttr(t,e,r){this.data={rgid:t,attribute:e,value:r},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.rgroups.get(this.data.rgid);this.data2||(this.data2={rgid:this.data.rgid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateItem("rgroups",this.data.rgid)},this._isDummy=function(t){return t.render.ctab.molecule.rgroups.get(this.data.rgid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new RGroupAttr;return t.data=this.data2,t.data2=this.data,t}}function RGroupFragment(t,e,r){this.rgid_new=t,this.rg_new=r,this.rgid_old=null,this.rg_old=null,this.frid=e,this._execute=function(t){var e=t.render.ctab,r=e.molecule;if(this.rgid_old=this.rgid_old||chem.Struct.RGroup.findRGroupByFragment(r.rgroups,this.frid),this.rg_old=this.rgid_old?r.rgroups.get(this.rgid_old):null,this.rg_old&&(this.rg_old.frags.remove(this.rg_old.frags.keyOf(this.frid)),e.clearVisel(e.rgroups.get(this.rgid_old).visel),0==this.rg_old.frags.count()?(e.rgroups.unset(this.rgid_old),r.rgroups.unset(this.rgid_old),e.markItemRemoved()):e.markItem("rgroups",this.rgid_old,1)),this.rgid_new){var n=r.rgroups.get(this.rgid_new);n?e.markItem("rgroups",this.rgid_new,1):(n=this.rg_new||new chem.Struct.RGroup,r.rgroups.set(this.rgid_new,n),e.rgroups.set(this.rgid_new,new rnd.ReRGroup(n))),n.frags.add(this.frid)}},this._invert=function(){return new RGroupFragment(this.rgid_old,this.frid,this.rg_old)}}function RxnArrowAdd(t){this.data={arid:null,pos:t},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;Object.isNumber(this.data.arid)?n.rxnArrows.set(this.data.arid,new chem.Struct.RxnArrow):this.data.arid=n.rxnArrows.add(new chem.Struct.RxnArrow),r.notifyRxnArrowAdded(this.data.arid),n._rxnArrowSetPos(this.data.arid,new Vec2(this.data.pos)),e.invalidateItem("rxnArrows",this.data.arid,1)},this._invert=function(){var t=new RxnArrowDelete;return t.data=this.data,t}}function RxnArrowDelete(t){this.data={arid:t,pos:null},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;this.data.pos||(this.data.pos=e.rxnArrowGetPos(this.data.arid)),r.notifyRxnArrowRemoved(this.data.arid),n.rxnArrows.remove(this.data.arid)},this._invert=function(){var t=new RxnArrowAdd;return t.data=this.data,t}}function RxnArrowMove(t,e,r){this.data={id:t,d:e,noinvalidate:r},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.id,o=this.data.d;n.rxnArrows.get(i).pp.add_(o),r.rxnArrows.get(i).visel.translate(e.ps(o)),this.data.d=o.negated(),this.data.noinvalidate||t.render.invalidateItem("rxnArrows",i,1)},this._invert=function(){var t=new RxnArrowMove;return t.data=this.data,t}}function RxnPlusAdd(t){this.data={plid:null,pos:t},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;Object.isNumber(this.data.plid)?n.rxnPluses.set(this.data.plid,new chem.Struct.RxnPlus):this.data.plid=n.rxnPluses.add(new chem.Struct.RxnPlus),r.notifyRxnPlusAdded(this.data.plid),n._rxnPlusSetPos(this.data.plid,new Vec2(this.data.pos)),e.invalidateItem("rxnPluses",this.data.plid,1)},this._invert=function(){var t=new RxnPlusDelete;return t.data=this.data,t}}function RxnPlusDelete(t){this.data={plid:t,pos:null},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;this.data.pos||(this.data.pos=e.rxnPlusGetPos(this.data.plid)),r.notifyRxnPlusRemoved(this.data.plid),n.rxnPluses.remove(this.data.plid)},this._invert=function(){var t=new RxnPlusAdd;return t.data=this.data,t}}function RxnPlusMove(t,e,r){this.data={id:t,d:e,noinvalidate:r},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule,i=this.data.id,o=this.data.d;n.rxnPluses.get(i).pp.add_(o),r.rxnPluses.get(i).visel.translate(e.ps(o)),this.data.d=o.negated(),this.data.noinvalidate||t.render.invalidateItem("rxnPluses",i,1)},this._invert=function(){var t=new RxnPlusMove;return t.data=this.data,t}}function SGroupDataMove(t,e){this.data={id:t,d:e},this._execute=function(t){ui.ctab.sgroups.get(this.data.id).pp.add_(this.data.d),this.data.d=this.data.d.negated(),t.render.invalidateItem("sgroupData",this.data.id,1)},this._invert=function(){var t=new SGroupDataMove;return t.data=this.data,t}}function CanvasLoad(t){this.data={ctab:t,norescale:!1},this._execute=function(t){var e=t.render;e.ctab.clearVisels();var r=ui.ctab;ui.ctab=this.data.ctab,e.setMolecule(ui.ctab,this.data.norescale),this.data.ctab=r,this.data.norescale=!0},this._invert=function(){var t=new CanvasLoad;return t.data=this.data,t}}function ChiralFlagAdd(t){this.data={pos:t},this._execute=function(e){var r=e.render,n=r.ctab,i=n.molecule;if(n.chiralFlags.count()>0)throw new Error("Cannot add more than one Chiral flag");n.chiralFlags.set(0,new rnd.ReChiralFlag(t)),i.isChiral=!0,r.invalidateItem("chiralFlags",0,1)},this._invert=function(){var t=new ChiralFlagDelete;return t.data=this.data,t}}function ChiralFlagDelete(){this.data={pos:null},this._execute=function(t){var e=t.render,r=e.ctab,n=r.molecule;if(r.chiralFlags.count()<1)throw new Error("Cannot remove chiral flag");r.clearVisel(r.chiralFlags.get(0).visel),this.data.pos=r.chiralFlags.get(0).pp,r.chiralFlags.unset(0),n.isChiral=!1},this._invert=function(){var t=new ChiralFlagAdd(this.data.pos);return t.data=this.data,t}}function ChiralFlagMove(t){this.data={d:t},this._execute=function(t){var e=t.render,r=e.ctab;r.chiralFlags.get(0).pp.add_(this.data.d),this.data.d=this.data.d.negated(),e.invalidateItem("chiralFlags",0,1)},this._invert=function(){var t=new ChiralFlagMove;return t.data=this.data,t}}var Vec2=require("../util/vec2"),Set=require("../util/set");require("../chem"),require("../rnd");var ui=global.ui,chem=global.chem,rnd=global.rnd;AtomAdd.prototype=new Base,AtomDelete.prototype=new Base,AtomAttr.prototype=new Base,AtomMove.prototype=new Base,BondMove.prototype=new Base,LoopMove.prototype=new Base,SGroupAtomAdd.prototype=new Base,SGroupAtomRemove.prototype=new Base,SGroupAttr.prototype=new Base,SGroupCreate.prototype=new Base,SGroupDelete.prototype=new Base,SGroupAddToHierarchy.prototype=new Base,SGroupRemoveFromHierarchy.prototype=new Base,BondAdd.prototype=new Base,BondDelete.prototype=new Base,BondAttr.prototype=new Base,FragmentAdd.prototype=new Base,FragmentDelete.prototype=new Base,RGroupAttr.prototype=new Base,RGroupFragment.prototype=new Base,RxnArrowAdd.prototype=new Base,RxnArrowDelete.prototype=new Base,RxnArrowMove.prototype=new Base,RxnPlusAdd.prototype=new Base,RxnPlusDelete.prototype=new Base,RxnPlusMove.prototype=new Base,SGroupDataMove.prototype=new Base,CanvasLoad.prototype=new Base,ChiralFlagAdd.prototype=new Base,ChiralFlagDelete.prototype=new Base,ChiralFlagMove.prototype=new Base,module.exports={AtomAdd:AtomAdd,AtomDelete:AtomDelete,AtomAttr:AtomAttr,AtomMove:AtomMove,BondMove:BondMove,LoopMove:LoopMove,SGroupAtomAdd:SGroupAtomAdd,SGroupAtomRemove:SGroupAtomRemove,SGroupAttr:SGroupAttr,SGroupCreate:SGroupCreate,SGroupDelete:SGroupDelete,SGroupAddToHierarchy:SGroupAddToHierarchy,SGroupRemoveFromHierarchy:SGroupRemoveFromHierarchy,BondAdd:BondAdd,BondDelete:BondDelete,BondAttr:BondAttr,FragmentAdd:FragmentAdd,FragmentDelete:FragmentDelete,RGroupAttr:RGroupAttr,RGroupFragment:RGroupFragment,RxnArrowAdd:RxnArrowAdd,RxnArrowDelete:RxnArrowDelete,RxnArrowMove:RxnArrowMove,RxnPlusAdd:RxnPlusAdd,RxnPlusDelete:RxnPlusDelete,RxnPlusMove:RxnPlusMove,SGroupDataMove:SGroupDataMove,CanvasLoad:CanvasLoad,ChiralFlagAdd:ChiralFlagAdd,ChiralFlagDelete:ChiralFlagDelete,ChiralFlagMove:ChiralFlagMove};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../rnd":21,"../util/set":42,"../util/vec2":43}],36:[function(require,module,exports){
module.exports=[{name:"benzene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  6  1  0     0  0\n  6  1  2  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentadiene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.0000    1.4257    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclohexane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  6  1  0     0  0\n  6  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.8090    1.5389    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.6180    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopropane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  3  3  0     0  0            999 V2000\n   -3.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.7250    0.5910    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  1  3  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclobutane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  4  4  0     0  0            999 V2000\n   -3.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -3.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  1  3  1  0     0  0\n  3  4  1  0     0  0\n  4  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cycloheptane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  7  7  0     0  0            999 V2000\n    0.0000    1.6293    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    2.2465    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7559    2.0242    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.1897    1.1289    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.6228    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7566    0.2224    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n  6  7  1  0     0  0\n  5  7  1  0     0  0\n  1  5  1  0     0  0\n  4  6  1  0     0  0\n  3  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclooctane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  8  8  0     0  0            999 V2000\n    0.0000    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7053    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7056    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n  8  3  1  0     0  0\n  7  8  1  0     0  0\n  6  7  1  0     0  0\n  5  6  1  0     0  0\n  4  5  1  0     0  0\n  1  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0}];

},{}],37:[function(require,module,exports){
function ajax(e,t){var n=getXHR(),r=e.headers||{};n.open(e.method,e.url,!!t,e.user,e.password);for(var o in r)r.hasOwnProperty(o)&&n.setRequestHeader(o,r[o]);if("function"==typeof e.config){var i=e.config(n,e);void 0!==i&&(n=i)}return e.timeout>0&&setTimeout(function(){n.status=-1,n.abort()},e.timeout),t&&(n.onreadystatechange=function(){4===n.readyState&&t(n)}),n.send(e.data),n}function successful(e){return e.status>=200&&e.status<300}function queryString(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function request(e){var t=util.extend({method:"GET",headers:{},timeout:6e3},util.isObject(e)?e:{url:e});if(util.isObject(t.data)&&(t.data=JSON.stringify(t.data),t.headers["Content-Type"]="application/json; charset=utf-8"),t.params&&(t.url=t.url+(t.url.indexOf("?")<0?"?":"&")+queryString(t.params)),!t.sync)return new Promise(function(e,n){ajax(t,function(t){var r=successful(t)?e:n;r(t)})});var n=ajax(t);if(!successful(n))throw n;return n}var getXHR=require("xhrpolyfill"),Promise=require("promise-polyfill"),util=require("./index.js");module.exports=request;

},{"./index.js":39,"promise-polyfill":3,"xhrpolyfill":6}],38:[function(require,module,exports){
var util=require("./index"),Vec2=require("./vec2"),Box2Abs=function(){1==arguments.length&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),2==arguments.length&&arguments[0]instanceof Vec2&&arguments[1]instanceof Vec2?(this.p0=arguments[0],this.p1=arguments[1]):4==arguments.length?(this.p0=new Vec2(arguments[0],arguments[1]),this.p1=new Vec2(arguments[2],arguments[3])):0==arguments.length?(this.p0=new Vec2,this.p1=new Vec2):new Error("Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")};Box2Abs.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},Box2Abs.fromRelBox=function(t){return util.assertDefined(t),new Box2Abs(t.x,t.y,t.x+t.width,t.y+t.height)},Box2Abs.prototype.clone=function(){return new Box2Abs(this.p0,this.p1)},Box2Abs.union=function(t,e){return util.assertDefined(t),util.assertDefined(e),new Box2Abs(Vec2.min(t.p0,e.p0),Vec2.max(t.p1,e.p1))},Box2Abs.prototype.extend=function(t,e){return util.assertDefined(t),e=e||t,new Box2Abs(this.p0.sub(t),this.p1.add(e))},Box2Abs.prototype.include=function(t){return util.assertDefined(t),new Box2Abs(this.p0.min(t),this.p1.max(t))},Box2Abs.prototype.contains=function(t,e){return e=(e||0)-0,util.assertDefined(t),t.x>=this.p0.x-e&&t.x<=this.p1.x+e&&t.y>=this.p0.y-e&&t.y<=this.p1.y+e},Box2Abs.prototype.translate=function(t){return util.assertDefined(t),new Box2Abs(this.p0.add(t),this.p1.add(t))},Box2Abs.prototype.transform=function(t,e){return util.assert(!util.isNullOrUndefined(t)),new Box2Abs(t.call(e,this.p0),t.call(e,this.p1))},Box2Abs.prototype.sz=function(){return this.p1.sub(this.p0)},Box2Abs.prototype.centre=function(){return Vec2.centre(this.p0,this.p1)},Box2Abs.prototype.pos=function(){return this.p0},module.exports=Box2Abs;

},{"./index":39,"./vec2":43}],39:[function(require,module,exports){
function find(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n,e))return e[n];return void 0}function findIndex(e,t,n){for(var o=0;o<e.length;++o)if(t.call(n,e[o],o))return o;return-1}function normalizeNewlines(e){return e.replace(nlRe,"\n")}function splitNewlines(e){return e.split(nlRe)}function unicodeLiteral(e){function t(e,t){for(var n=e.toString(16).toUpperCase();n.length<t;)n="0"+n;return n}var n,o="";for(n=0;n<e.length;++n)o+=e.charCodeAt(n)>126||e.charCodeAt(n)<32?"\\u"+t(e.charCodeAt(n),4):e[n];return o}Array.prototype.swap=function(e,t){var n=this[e];this[e]=this[t],this[t]=n};var tfx=function(e){return(e-0).toFixed(8)},each=function(e,t,n){assert(!isNullOrUndefined(e),"array must be defined");for(var o=0;o<e.length;++o)t.call(n,e[o],o)},map_each=function(e,t,n){assert(!isNullOrUndefined(e),"map must be defined");for(var o in e)e.hasOwnProperty(o)&&t.call(n,o,e[o])},findAll=function(e,t,n){var o,r=[];for(o=0;o<e.length;++o)t.call(n,e[o],o)&&r.push(e[o]);return r},array=function(e){for(var t=[],n=e.length;--n>=0;)t[n]=e[n];return t},isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},stopEventPropagation=function(e){if("stopPropagation"in e)e.stopPropagation();else{if(!("cancelBubble"in e))throw Error("Browser unrecognized");e.cancelBubble=!0}},preventDefault=function(e){return"preventDefault"in e&&e.preventDefault(),Prototype.Browser.IE&&(e.returnValue=!1,e.keyCode=0),!1},setElementTextContent=function(e,t){if("textContent"in e)e.textContent=t;else{if(!("innerText"in e))throw Error("Browser unrecognized");e.innerText=t}},getElementTextContent=function(e){if("textContent"in e)return e.textContent;if("innerText"in e)return e.innerText;throw Error("Browser unrecognized")},stringPadded=function(e,t,n){for(var o=e+"",r="";o.length+r.length<t;)r+=" ";return n?e+r:r+e},nlRe=/\r\n|[\n\r]/g,idList=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},mapArray=function(e,t){for(var n=[],o=0;o<e.length;++o)n.push(t[e[o]]);return n},arrayMax=function(e){return Math.max.apply(Math,e)},arrayMin=function(e){return Math.min.apply(Math,e)},map=function(e,t,n){for(var o=[],r=0;r<e.length;++r)o.push(t.call(n,e[r]));return o},apply=function(e,t){for(var n=0;n<e.length;++n)e[n]=t(e[n])},ifDef=function(e,t,n,o){e[n]=Object.isUndefined(t[n])?o:t[n]},ifDefList=function(e,t,n,o){e[n]=Object.isUndefined(t[n])||null===t[n]?o:array(t[n])},identityMap=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=e[n];return t},strip=function(e){return e.replace(/\s*$/,"").replace(/^\s*/,"")},stripRight=function(e){return e.replace(/\s*$/,"")},stripQuotes=function(e){return'"'===e[0]&&'"'===e[e.length-1]?e.substr(1,e.length-2):e},paddedFloat=function(e,t,n){var o=e.toFixed(n).replace(",",".");if(o.length>t)throw new Error("number does not fit");return stringPadded(o,t)},paddedInt=function(e,t){var n=e.toFixed(0);if(n.length>t)throw new Error("number does not fit");return stringPadded(n,t)},arrayAddIfMissing=function(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return!1;return e.push(t),!0},assert=function(e,t){if(!e)throw new Error(t?"Assertion failed: "+t:"Assertion failed")},assertDefined=function(e){assert(!isNullOrUndefined(e))},isUndefined=function(e){return Object.isUndefined(e)},isNull=function(e){return null===e},isNullOrUndefined=function(e){return isUndefined(e)||isNull(e)},arrayRemoveByValue=function(e,t){assert(!isUndefined(e)&&!isNull(e),"array must be defined");for(var n=e.indexOf(t),o=0;n>=0;)e.splice(n,1),o+=1,n=e.indexOf(t);return o},listNextRotate=function(e,t){return e[(e.indexOf(t)+1)%e.length]},extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},isObject=function(e){return e===Object(e)};module.exports={tfx:tfx,each:each,find:find,findIndex:findIndex,findAll:findAll,array:array,isEmpty:isEmpty,stopEventPropagation:stopEventPropagation,preventDefault:preventDefault,setElementTextContent:setElementTextContent,getElementTextContent:getElementTextContent,stringPadded:stringPadded,normalizeNewlines:normalizeNewlines,splitNewlines:splitNewlines,unicodeLiteral:unicodeLiteral,idList:idList,mapArray:mapArray,arrayMax:arrayMax,arrayMin:arrayMin,map:map,apply:apply,ifDef:ifDef,ifDefList:ifDefList,identityMap:identityMap,strip:strip,stripRight:stripRight,stripQuotes:stripQuotes,paddedFloat:paddedFloat,paddedInt:paddedInt,arrayAddIfMissing:arrayAddIfMissing,assert:assert,assertDefined:assertDefined,isUndefined:isUndefined,isNull:isNull,isNullOrUndefined:isNullOrUndefined,arrayRemoveByValue:arrayRemoveByValue,listNextRotate:listNextRotate,extend:extend,isObject:isObject};

},{}],40:[function(require,module,exports){
var util=require("./index"),Map=function(t){if("undefined"!=typeof t&&t.constructor!==Object)throw Error('Passed object is not an instance of "Object"!');this._obj=t||{},this._count=0};Map.prototype.each=function(t,e){var r,n,i;for(r in this._obj)i=parseInt(r,10),n=this._obj[r],isNaN(i)||(r=i),t.call(e,r,n)},Map.prototype.map=function(t,e){var r=new Map;return this.each(function(n,i){r.set(n,t.call(e,n,i))},this),r},Map.prototype.find=function(t,e){var r,n,i;for(r in this._obj)if(n=parseInt(r,10),i=this._obj[r],isNaN(n)||(r=n),t.call(e,r,i))return r},Map.prototype.findAll=function(t,e){var r,n,i,o=[];for(r in this._obj)n=parseInt(r,10),i=this._obj[r],isNaN(n)||(r=n),t.call(e,r,i)&&o.push(r);return o},Map.prototype.keys=function(){var t,e=[];for(t in this._obj)e.push(t);return e},Map.prototype.ikeys=function(){var t=[];for(var e in this._obj)t.push(e-0);return t},Map.prototype.set=function(t,e){var r;return this._count+=("undefined"!=typeof e?1:0)-("undefined"!=typeof this._obj[t]?1:0),"undefined"==typeof e?(r=this._obj[t],delete this._obj[t],r):(this._obj[t]=e,e)},Map.prototype.get=function(t){return this._obj[t]!==Object.prototype[t]?this._obj[t]:void 0},Map.prototype.has=function(t){return this._obj[t]!==Object.prototype[t]},Map.prototype.unset=function(t){return this.set(t,void 0)},Map.prototype.update=function(t){for(var e in t)this.set(e,t[e])},Map.prototype.clear=function(){this._obj={},this._count=0},Map.prototype.count=function(){return this._count},Map.prototype.idList=function(){return util.idList(this._obj)},Map.prototype.keyOf=function(t){for(var e in this._obj)if(this._obj[e]===t)return e},module.exports=Map;

},{"./index":39}],41:[function(require,module,exports){
var Map=require("./map.js"),Pool=function(){this._map=new Map,this._nextId=0};Pool.prototype.newId=function(){return this._nextId++},Pool.prototype.add=function(t){var e=this._nextId++;return this._map.set(e,t),e},Pool.prototype.set=function(t,e){this._map.set(t,e)},Pool.prototype.get=function(t){return this._map.get(t)},Pool.prototype.has=function(t){return this._map.has(t)},Pool.prototype.remove=function(t){return this._map.unset(t)},Pool.prototype.clear=function(){this._map.clear()},Pool.prototype.keys=function(){return this._map.keys()},Pool.prototype.ikeys=function(){return this._map.ikeys()},Pool.prototype.each=function(t,e){this._map.each(t,e)},Pool.prototype.map=function(t,e){return this._map.map(t,e)},Pool.prototype.find=function(t,e){return this._map.find(t,e)},Pool.prototype.count=function(){return this._map.count()},Pool.prototype.keyOf=function(t){return this._map.keyOf(t)},module.exports=Pool;

},{"./map.js":40}],42:[function(require,module,exports){
var Set={empty:function(){return{}},single:function(e){var t={};return Set.add(t,e),t},size:function(e){var t=0;for(var r in e)e[r]!==Object.prototype[r]&&t++;return t},contains:function(e,t){return"undefined"!=typeof e[t]&&e[t]!==Object.prototype[t]},subset:function(e,t){for(var r in e)if(e[r]!==Object.prototype[r]&&t[r]!==e[r])return!1;return!0},intersection:function(e,t){var r={};for(var o in e)e[o]!==Object.prototype[o]&&t[o]===e[o]&&Set.add(r,o);return r},disjoint:function(e,t){for(var r in e)if(e[r]!==Object.prototype[r]&&t[r]===e[r])return!1;return!0},eq:function(e,t){return Set.subset(e,t)&&Set.subset(t,e)},each:function(e,t,r){for(var o in e)e[o]!==Object.prototype[o]&&t.call(r,e[o])},filter:function(e,t,r){var o={};for(var n in e)e[n]!==Object.prototype[n]&&t.call(r,e[n])&&(o[e[n]]=e[n]);return o},pick:function(e){for(var t in e)if(e[t]!==Object.prototype[t])return e[t];return null},list:function(e){var t=[];for(var r in e)e[r]!==Object.prototype[r]&&t.push(e[r]);return t},add:function(e,t){e[t]=t},mergeIn:function(e,t){Set.each(t,function(t){Set.add(e,t)})},remove:function(e,t){var r=e[t];return delete e[t],r},clone:function(e){var t={};return Set.mergeIn(t,e),t},fromList:function(e){var t={};if(e)for(var r=0;r<e.length;++r)t[e[r]-0]=e[r]-0;return t},keySetInt:function(e){var t={};return e.each(function(e){t[e-0]=e-0}),t},find:function(e,t,r){for(var o in e)if(e[o]!==Object.prototype[o]&&t.call(r,e[o]))return o;return null}};module.exports=Set;

},{}],43:[function(require,module,exports){
var util=require("./index"),Vec2=function(e,t){if(0==arguments.length)this.x=0,this.y=0;else if(1==arguments.length)this.x=parseFloat(e.x),this.y=parseFloat(e.y);else{if(2!=arguments.length)throw new Error("Vec2(): invalid arguments");this.x=parseFloat(e),this.y=parseFloat(t)}};Vec2.ZERO=new Vec2(0,0),Vec2.UNIT=new Vec2(1,1),Vec2.segmentIntersection=function(e,t,r,n){var o=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x),i=(e.x-n.x)*(t.y-n.y)-(e.y-n.y)*(t.x-n.x),a=(r.x-e.x)*(n.y-e.y)-(r.y-e.y)*(n.x-e.x),l=(r.x-t.x)*(n.y-t.y)-(r.y-t.y)*(n.x-t.x);return 0>=o*i&&0>=a*l},Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vec2.prototype.equals=function(e){return util.assertDefined(e),this.x==e.x&&this.y==e.y},Vec2.prototype.add=function(e){return util.assertDefined(e),new Vec2(this.x+e.x,this.y+e.y)},Vec2.prototype.add_=function(e){util.assertDefined(e),this.x+=e.x,this.y+=e.y},Vec2.prototype.sub=function(e){return util.assertDefined(e),new Vec2(this.x-e.x,this.y-e.y)},Vec2.prototype.scaled=function(e){return util.assertDefined(e),new Vec2(this.x*e,this.y*e)},Vec2.prototype.negated=function(){return new Vec2(-this.x,-this.y)},Vec2.prototype.yComplement=function(e){return e=e||0,new Vec2(this.x,e-this.y)},Vec2.prototype.addScaled=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(this.x+e.x*t,this.y+e.y*t)},Vec2.prototype.normalized=function(){return this.scaled(1/this.length())},Vec2.prototype.normalize=function(){var e=this.length();return 1e-6>e?!1:(this.x/=e,this.y/=e,!0)},Vec2.prototype.turnLeft=function(){return new Vec2(-this.y,this.x)},Vec2.prototype.coordStr=function(){return this.x.toString()+" , "+this.y.toString()},Vec2.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},Vec2.dist=function(e,t){return util.assertDefined(e),util.assertDefined(t),Vec2.diff(e,t).length()},Vec2.max=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(Math.max(e.x,t.x),Math.max(e.y,t.y))},Vec2.min=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(Math.min(e.x,t.x),Math.min(e.y,t.y))},Vec2.prototype.max=function(e){return util.assertDefined(e),new Vec2.max(this,e)},Vec2.prototype.min=function(e){return util.assertDefined(e),new Vec2.min(this,e)},Vec2.prototype.ceil=function(){return new Vec2(Math.ceil(this.x),Math.ceil(this.y))},Vec2.prototype.floor=function(){return new Vec2(Math.floor(this.x),Math.floor(this.y))},Vec2.sum=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(e.x+t.x,e.y+t.y)},Vec2.dot=function(e,t){return util.assertDefined(e),util.assertDefined(t),e.x*t.x+e.y*t.y},Vec2.cross=function(e,t){return util.assertDefined(e),util.assertDefined(t),e.x*t.y-e.y*t.x},Vec2.prototype.rotate=function(e){util.assertDefined(e);var t=Math.sin(e),r=Math.cos(e);return this.rotateSC(t,r)},Vec2.prototype.rotateSC=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(this.x*t-this.y*e,this.x*e+this.y*t)},Vec2.angle=function(e,t){return util.assertDefined(e),util.assertDefined(t),Math.atan2(Vec2.cross(e,t),Vec2.dot(e,t))},Vec2.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},Vec2.diff=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(e.x-t.x,e.y-t.y)},Vec2.lc=function(){for(var e=new Vec2,t=0;t<arguments.length/2;++t)e=e.addScaled(arguments[2*t],arguments[2*t+1]);return e},Vec2.lc2=function(e,t,r,n){return util.assertDefined(e),util.assertDefined(r),util.assertDefined(t),util.assertDefined(n),new Vec2(e.x*t+r.x*n,e.y*t+r.y*n)},Vec2.centre=function(e,t){return new Vec2.lc2(e,.5,t,.5)},Vec2.shiftRayBox=function(e,t,r){util.assertDefined(e),util.assertDefined(t),util.assertDefined(r);var n=[r.p0,new Vec2(r.p1.x,r.p0.y),r.p1,new Vec2(r.p0.x,r.p1.y)],o=n.map(function(t){return t.sub(e)});t=t.normalized();for(var i=o.map(function(e){return Vec2.cross(e,t)}),a=o.map(function(e){return Vec2.dot(e,t)}),l=-1,u=-1,s=0;4>s;++s)i[s]>0?(0>l||a[l]<a[s])&&(l=s):(0>u||a[u]<a[s])&&(u=s);if(0>u||0>l)return 0;var d,c;return a[l]>a[u]?(d=u,c=l):(d=l,c=u),a[d]+Math.abs(i[d])*(a[c]-a[d])/(Math.abs(i[d])+Math.abs(i[c]))},module.exports=Vec2;

},{"./index":39}]},{},[18])(18)
});